<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="且将新火试新茶，诗酒趁年华">
    <meta name="author" content="Drunkbaby">
    
    <title>
        
            eBPF 运行原理 |
        
        Drunkbaby&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"drun1baby.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066cc","logo":"https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/logo.png","favicon":"https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png","avatar":"https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png","font_size":"15px","font_family":null,"hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"且将新火试新茶，诗酒趁年华","font_color":null,"hitokoto":false},"scroll":{"progress_bar":true,"percent":false}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":false},"comment":{"enable":true,"use":"valine","valine":{"enable":true,"appid":"mCIu9X4iLP3I0GikUoetB9bV-9Nh9j0Va","appkey":"ermlV1eoB1YODT088EdXjo6C","placeholder":"just go go","background":"/images/comment_bg.png","count":true},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/logo.png">
                </a>
            
            <a class="logo-title" href="/">
               Drunkbaby&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                友链
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">友链</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">eBPF 运行原理</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Drunkbaby</span>
                            
                                <span class="author-label">Lv6</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2023-08-03 22:48:30</span>
        <span class="mobile">2023-08-03 22:48</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-08-06 11:06:13</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/eBPF/">eBPF</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/eBPF/">eBPF</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>5k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>20 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <p>eBPF 运行原理，eBPF 学习（二）</p>
<span id="more"></span>

<h1 id="eBPF-运行原理篇"><a href="#eBPF-运行原理篇" class="headerlink" title="eBPF 运行原理篇"></a>eBPF 运行原理篇</h1><h2 id="0x01-eBPF-虚拟机是如何工作的"><a href="#0x01-eBPF-虚拟机是如何工作的" class="headerlink" title="0x01 eBPF 虚拟机是如何工作的"></a>0x01 eBPF 虚拟机是如何工作的</h2><h3 id="eBPF-的五个模块"><a href="#eBPF-的五个模块" class="headerlink" title="eBPF 的五个模块"></a>eBPF 的五个模块</h3><p>eBPF 是一个运行在内核中的虚拟机，很多人在初次接触它时，会把它跟系统虚拟化（比如 kvm）中的虚拟机弄混。其实，虽然都被称为“虚拟机”，系统虚拟化和 eBPF 虚拟机还是有着本质不同的。</p>
<p>系统虚拟化基于 x86 或 arm64 等通用指令集，这些指令集足以完成完整计算机的所有功能。而为了确保在内核中安全地执行，eBPF 只提供了非常有限的指令集。这些指令集可用于完成一部分内核的功能，但却远不足以模拟完整的计算机。为了更高效地与内核进行交互，eBPF 指令还有意采用了 C 调用约定，其提供的辅助函数可以在 C 语言中直接调用，极大地方便了 eBPF 程序的开发。</p>
<p>如下图（图片来自 BPF Internals）所示，eBPF 在内核中的运行时主要由 5 个模块组成：</p>
<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/RunningeBPF.png" class="">

<ul>
<li>第一个模块是  <strong>eBPF 辅助函数</strong>。它提供了一系列用于 eBPF 程序与内核其他模块进行交互的函数。这些函数并不是任意一个 eBPF 程序都可以调用的，具体可用的函数集由 BPF 程序类型决定。</li>
<li>第二个模块是  <strong>eBPF 验证器</strong>。它用于确保 eBPF 程序的安全。验证器会将待执行的指令创建为一个有向无环图（DAG），确保程序中不包含不可达指令；接着再模拟指令的执行过程，确保不会执行无效指令。</li>
<li>第三个模块是由  <strong>11 个 64 位寄存器、一个程序计数器和一个 512 字节的栈组成的存储模块</strong>。这个模块用于控制 eBPF 程序的执行。其中，R0 寄存器用于存储函数调用和 eBPF 程序的返回值，这意味着函数调用最多只能有一个返回值；R1-R5 寄存器用于函数调用的参数，因此函数调用的参数最多不能超过 5 个；而 R10 则是一个只读寄存器，用于从栈中读取数据。</li>
<li>第四个模块是即时编译器，它将 eBPF 字节码编译成本地机器指令，以便更高效地在内核中执行。</li>
<li>第五个模块是  BPF 映射（map），它用于提供大块的存储。这些存储可被用户空间程序用来进行访问，进而控制 eBPF 程序的运行状态。</li>
</ul>
<p>关于 BPF 辅助函数和 BPF 映射的具体内容我会放在后续的文章里面详细编写，现在我们先来看看 BPF 指令的具体格式，以及它是如何加载到内核中，又是何时运行的。</p>
<h3 id="BPF-指令是什么样的"><a href="#BPF-指令是什么样的" class="headerlink" title="BPF 指令是什么样的"></a>BPF 指令是什么样的</h3><p>用上一讲的 Hello World 作为例子，一起看下 BPF 指令到底是什么样子的。</p>
<p>它的逻辑其实很简单，先调用    bpf_trace_printk  输出一个 “Hello, World!” 字符串，然后就返回成功了：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">bpf_trace_printk</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后，我们通过 BCC 的 Python 库，加载并运行了这个 eBPF 程序：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># This is a Hello World example of BPF.</span>
<span class="token keyword">from</span> bcc <span class="token keyword">import</span> BPF

<span class="token comment"># load BPF program</span>
b <span class="token operator">=</span> BPF<span class="token punctuation">(</span>src_file<span class="token operator">=</span><span class="token string">"hello.c"</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span>attach_kprobe<span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">"do_sys_openat2"</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">"hello_world"</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span>trace_print<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在终端中运行下面的命令，就可以启动这个 eBPF 程序（注意， BCC 帮你完成了编译和加载的过程）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 hello.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>接下来我们使用一个新的工具 bpftool，用它可以查看 eBPF 程序的运行状态。</p>
<p>首先，打开一个新的终端，执行下面的命令，查询系统中正在运行的 eBPF 程序：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> bpftool prog list

<span class="token number">579</span>: kprobe  name hello_world  tag 38dd440716c4900f  gpl
        loaded_at <span class="token number">2023</span>-08-06T09:01:22+0800  uid <span class="token number">0</span>
        xlated 104B  jited 70B  memlock 4096B
        btf_id <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/RunningeBPF.png" class="">

<p>输出中，579 是这个 eBPF 程序的编号，kprobe 是程序的类型，而 hello_world 是程序的名字。</p>
<p>有了 eBPF 程序编号之后，执行下面的命令就可以导出这个 eBPF 程序的指令（注意把 579 替换成你查询到的编号）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> bpftool prog dump xlated <span class="token function">id</span> <span class="token number">579</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里有个小坑，需要自己手动编译 libelf-dev 的源码，具体见 输出结果</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> ctx<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token punctuation">;</span> <span class="token keyword">int</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
   <span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">(</span>b7<span class="token punctuation">)</span> r1 <span class="token operator">=</span> <span class="token number">33</span>
<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token keyword">char</span> _fmt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">;</span> <span class="token function">bpf_trace_printk_</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">6</span>b<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span>u16 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>r10 <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> r1
   <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">(</span>b7<span class="token punctuation">)</span> r1 <span class="token operator">=</span> <span class="token number">1684828783</span>
   <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span>u32 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>r10 <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> r1
   <span class="token number">4</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span> r1 <span class="token operator">=</span> <span class="token number">0x57202c6f6c6c6548</span>
   <span class="token number">6</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">7</span>b<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span>u64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>r10 <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">=</span> r1
   <span class="token number">7</span><span class="token operator">:</span> <span class="token punctuation">(</span>bf<span class="token punctuation">)</span> r1 <span class="token operator">=</span> r10
<span class="token punctuation">;</span> 
   <span class="token number">8</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">07</span><span class="token punctuation">)</span> r1 <span class="token operator">+=</span> <span class="token operator">-</span><span class="token number">16</span>
<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token keyword">char</span> _fmt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">;</span> <span class="token function">bpf_trace_printk_</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">9</span><span class="token operator">:</span> <span class="token punctuation">(</span>b7<span class="token punctuation">)</span> r2 <span class="token operator">=</span> <span class="token number">14</span>
  <span class="token number">10</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">)</span> call bpf_trace_printk#<span class="token operator">-</span><span class="token number">58800</span>
<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token number">11</span><span class="token operator">:</span> <span class="token punctuation">(</span>b7<span class="token punctuation">)</span> r0 <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token number">12</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">)</span> exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/outputOrder580.png" class="">

<p>其中，分号开头的部分，正是我们前面写的 C 代码，而其他行则是具体的 BPF 指令。具体每一行的 BPF 指令又分为三部分：</p>
<ul>
<li>第一部分，冒号前面的数字 0-12 ，代表 BPF 指令行数；</li>
<li>第二部分，括号中的 16 进制数值，表示 BPF 指令码。它的具体含义你可以参考 IOVisor BPF 文档，比如第 0 行的 0xb7 表示为 64 位寄存器赋值。</li>
<li>第三部分，括号后面的部分，就是 BPF 指令的伪代码。</li>
</ul>
<p>结合前面讲述的各个寄存器的作用，不难理解这些 BPF 指令的含义：</p>
<ul>
<li>第 0-8 行，借助 R10 寄存器从栈中把字符串 “Hello, World!” 读出来，并放入 R1 寄存器中；</li>
<li>第 9 行，向 R2 寄存器写入字符串的长度 14（即代码注释里面的  <code>sizeof(_fmt)</code> ）；</li>
<li>第 10 行，调用 BPF 辅助函数  <code>bpf_trace_printk</code>  输出字符串；</li>
<li>第 11 行，向 R0 寄存器写入 0，表示程序的返回值是 0；</li>
<li>最后一行，程序执行成功退出。</li>
</ul>
<p>总结起来，<strong>这些指令先通过 R1 和 R2 寄存器设置了 <code>bpf_trace_printk</code> 的参数，然后调用 <code>bpf_trace_printk</code> 函数输出字符串，最后再通过 R0 寄存器返回成功</strong>。</p>
<p>实际上我们也可以通过类似的 BPF 指令来开发 eBPF 程序，不过相对于一开始的 C 程序相比，BPF 指令的可读性和维护性明显差得多。所以还是建议使用 C 语言开发 eBPF 程序，而只把 BPF 指令作为排查 eBPF 程序疑难杂症时的参考。</p>
<p>这里，来简单看看  BPF 指令加载后是如何运行的。当这些 BPF 指令加载到内核后， BPF 即时编译器会将其编译成本地机器指令，最后才会执行编译后的机器指令：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">bpftool</span> <span class="token expression">prog dump jited id <span class="token number">580</span></span></span>
<span class="token keyword">int</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> ctx<span class="token punctuation">)</span><span class="token operator">:</span>
bpf_prog_38dd440716c4900f_hello_world<span class="token operator">:</span>
<span class="token punctuation">;</span> <span class="token keyword">int</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
   <span class="token number">0</span><span class="token operator">:</span>  nopl   <span class="token number">0x0</span><span class="token punctuation">(</span><span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token number">5</span><span class="token operator">:</span>  xchg   <span class="token operator">%</span>ax<span class="token punctuation">,</span><span class="token operator">%</span>ax
   <span class="token number">7</span><span class="token operator">:</span>  push   <span class="token operator">%</span>rbp
   <span class="token number">8</span><span class="token operator">:</span>  mov    <span class="token operator">%</span>rsp<span class="token punctuation">,</span><span class="token operator">%</span>rbp
   b<span class="token operator">:</span>  sub    $<span class="token number">0x10</span><span class="token punctuation">,</span><span class="token operator">%</span>rsp
  <span class="token number">12</span><span class="token operator">:</span>  mov    $<span class="token number">0x21</span><span class="token punctuation">,</span><span class="token operator">%</span>edi
<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token keyword">char</span> _fmt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">;</span> <span class="token function">bpf_trace_printk_</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">17</span><span class="token operator">:</span>  mov    <span class="token operator">%</span>di<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
  <span class="token number">1</span>b<span class="token operator">:</span>  mov    $<span class="token number">0x646c726f</span><span class="token punctuation">,</span><span class="token operator">%</span>edi
  <span class="token number">20</span><span class="token operator">:</span>  mov    <span class="token operator">%</span>edi<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
  <span class="token number">23</span><span class="token operator">:</span>  movabs $<span class="token number">0x57202c6f6c6c6548</span><span class="token punctuation">,</span><span class="token operator">%</span>rdi
  <span class="token number">2</span>d<span class="token operator">:</span>  mov    <span class="token operator">%</span>rdi<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
  <span class="token number">31</span><span class="token operator">:</span>  mov    <span class="token operator">%</span>rbp<span class="token punctuation">,</span><span class="token operator">%</span>rdi
<span class="token punctuation">;</span>
  <span class="token number">34</span><span class="token operator">:</span>  add    $<span class="token number">0xfffffffffffffff0</span><span class="token punctuation">,</span><span class="token operator">%</span>rdi
<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token keyword">char</span> _fmt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">;</span> <span class="token function">bpf_trace_printk_</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_fmt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">38</span><span class="token operator">:</span>  mov    $<span class="token number">0xe</span><span class="token punctuation">,</span><span class="token operator">%</span>esi
  <span class="token number">3</span>d<span class="token operator">:</span>  call   <span class="token number">0xffffffffd8c7e834</span>
<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token number">42</span><span class="token operator">:</span>  xor    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">44</span><span class="token operator">:</span>  leave
  <span class="token number">45</span><span class="token operator">:</span>  ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这些机器指令的含义跟前面的 BPF 指令是类似的，但具体的指令和寄存器都换成了 x86 的格式。你不需要掌握这些机器指令的具体含义，只要知道查询的具体方法就足够了。这是因为，就像你曾接触过的其他高级语言一样，在实际的 eBPF 使用过程中，并不需要直接使用机器指令，而是 eBPF 虚拟机帮你自动完成了转换。</p>
<h3 id="eBPF-程序是什么时候执行的"><a href="#eBPF-程序是什么时候执行的" class="headerlink" title="eBPF 程序是什么时候执行的"></a>eBPF 程序是什么时候执行的</h3><p>到这里，我想你已经理解了 BPF 指令的具体格式，以及它与  C 源代码之间的对应关系。不过，这个 eBPF 程序到底是什么时候执行的呢？接下来，我们再一起看看 BPF 指令的加载和执行过程。</p>
<p>在上一讲中我提到，BCC 负责了 eBPF 程序的编译和加载过程。因而，要了解 BPF 指令的加载过程，就可以从 BCC 执行 eBPF 程序的过程入手。</p>
<p>那么，怎么才能查看到 BCC 的执行过程呢？那就是跟踪它的系统调用过程。首先，我们打开一个终端，执行下面的命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -ebpf表示只跟踪bpf系统调用</span>
<span class="token function">sudo</span> <span class="token function">strace</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-ebpf</span> python3 ./hello.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>输出如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">bpf</span><span class="token punctuation">(</span>BPF_BTF_LOAD<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>btf<span class="token operator">=</span><span class="token string">"\237\353\1\0\30\0\0\0\0\0\0\0\230\2\0\0\230\2\0\0\340\10\0\0\0\0\0\0\0\0\0\2"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> btf_log_buf<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">,</span> btf_size<span class="token operator">=</span><span class="token number">2960</span><span class="token punctuation">,</span> btf_log_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> btf_log_level<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">bpf</span><span class="token punctuation">(</span>BPF_PROG_LOAD<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>prog_type<span class="token operator">=</span>BPF_PROG_TYPE_KPROBE<span class="token punctuation">,</span> insn_cnt<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">,</span> insns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_MOV<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0x21</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_STX<span class="token operator">|</span>BPF_H<span class="token operator">|</span>BPF_MEM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_10<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_MOV<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0x646c726f</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_STX<span class="token operator">|</span>BPF_W<span class="token operator">|</span>BPF_MEM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_10<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_LD<span class="token operator">|</span>BPF_DW<span class="token operator">|</span>BPF_IMM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0x6c6c6548</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_LD<span class="token operator">|</span>BPF_W<span class="token operator">|</span>BPF_IMM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0x57202c6f</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_STX<span class="token operator">|</span>BPF_DW<span class="token operator">|</span>BPF_MEM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_10<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_X<span class="token operator">|</span>BPF_MOV<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_10<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_ADD<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0xfffffff0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_MOV<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_2<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0xe</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_JMP<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_CALL<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0x6</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_MOV<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>code<span class="token operator">=</span>BPF_JMP<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_EXIT<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> license<span class="token operator">=</span><span class="token string">"GPL"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> log_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> log_buf<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">,</span> kern_version<span class="token operator">=</span><span class="token function">KERNEL_VERSION</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prog_flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> prog_name<span class="token operator">=</span><span class="token string">"hello_world"</span><span class="token punctuation">,</span> prog_ifindex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> expected_attach_type<span class="token operator">=</span>BPF_CGROUP_INET_INGRESS<span class="token punctuation">,</span> prog_btf_fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> func_info_rec_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> func_info<span class="token operator">=</span><span class="token number">0x1ad3af0</span><span class="token punctuation">,</span> func_info_cnt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> line_info_rec_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> line_info<span class="token operator">=</span><span class="token number">0x1ac4690</span><span class="token punctuation">,</span> line_info_cnt<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> attach_btf_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> attach_prog_fd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/straceHelloPY.png" class="">

<p>这些参数看起来很复杂，但实际上，如果你查询 bpf 系统调用的格式（执行 man bpf 命令），就可以发现，它实际上只需要三个参数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">int bpf<span class="token punctuation">(</span>int cmd, union bpf_attr *attr, unsigned int size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>对应前面的 strace 输出结果，这三个参数的具体含义如下。</p>
<ul>
<li>第一个参数是 BPF_PROG_LOAD ， 表示加载 BPF 程序。</li>
<li>第二个参数是 bpf_attr 类型的结构体，表示 BPF 程序的属性。其中，有几个需要你留意的参数，比如：<ul>
<li><code>prog_type</code> 表示 BPF 程序的类型，这儿是 <code>BPF_PROG_TYPE_KPROBE</code> ，跟我们 Python 代码中的 <code>attach_kprobe</code> 一致；</li>
<li><code>insn_cnt (instructions count)</code> 表示指令条数；insns (instructions) 包含了具体的每一条指令，这儿的 13 条指令跟我们前面 <code>bpftool prog dump</code> 的结果是一致的（具体的指令格式，你可以参考内核中 bpf_insn 的定义）；</li>
<li><code>prog_name</code> 则表示 BPF 程序的名字，即 <code>hello_world</code> 。</li>
</ul>
</li>
<li>第三个参数 120 表示属性的大小。</li>
</ul>
<p>到这里，我们已经了解了 bpf 系统调用的基本格式。对于  bpf  系统调用在内核中的实现原理，你并不需要详细了解。我们只要知道它的具体功能，就可以掌握 eBPF 的核心原理了。当然，如果你对它的实现方法有兴趣的话，可以参考内核源码 <code>kernel/bpf/syscall.c</code> 中<code> SYSCALL_DEFINE3</code> 的实现。</p>
<p>BPF 程序加载到内核后，并不会立刻执行，而是基于它的基本原理来的</p>
<blockquote>
<p>eBPF 程序并不像常规的线程那样，启动后就一直运行在那里，它需要事件触发后才会执行。这些事件包括系统调用、内核跟踪点、内核函数和用户态函数的调用退出、网络事件，等等。</p>
</blockquote>
<p>对于我们的 Hello World 来说，由于调用了 <code>attach_kprobe</code> 函数，很明显，这是一个内核跟踪事件：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">b<span class="token punctuation">.</span><span class="token function">attach_kprobe</span><span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">"do_sys_openat2"</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">"hello_world"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以，除了把 eBPF 程序加载到内核之外，还需要把加载后的程序跟具体的内核函数调用事件进行绑定。在 eBPF 的实现中，诸如内核跟踪（kprobe）、用户跟踪（uprobe）等的事件绑定，都是通过  <code>perf_event_open()</code>  来完成的。</p>
<p>为什么这么说呢？我们再用  <code>strace</code>  来确认一下。把前面  <code>strace</code>  命令中的  <code>-ebpf</code>  参数去掉，重新执行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">strace</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-f</span> python3 ./hello.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>忽略无关的输出后，会发现如下的系统调用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>.
/* <span class="token number">1</span><span class="token punctuation">)</span> 加载BPF程序 */
bpf<span class="token punctuation">(</span>BPF_PROG_LOAD,<span class="token punctuation">..</span>.<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">..</span>.

/* <span class="token number">2</span>）查询事件类型 */
openat<span class="token punctuation">(</span>AT_FDCWD, <span class="token string">"/sys/bus/event_source/devices/kprobe/type"</span>, O_RDONLY<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span>
read<span class="token punctuation">(</span><span class="token number">5</span>, <span class="token string">"6<span class="token entity" title="\n">\n</span>"</span>, <span class="token number">4096</span><span class="token punctuation">)</span>                    <span class="token operator">=</span> <span class="token number">2</span>
close<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">..</span>.

/* <span class="token number">3</span>）创建性能监控事件 */
perf_event_open<span class="token punctuation">(</span>
    <span class="token punctuation">&#123;</span>
        <span class="token assign-left variable">type</span><span class="token operator">=</span>0x6 /* PERF_TYPE_??? */,
        <span class="token assign-left variable">size</span><span class="token operator">=</span>PERF_ATTR_SIZE_VER7,
        <span class="token punctuation">..</span>.
        <span class="token assign-left variable">wakeup_events</span><span class="token operator">=</span><span class="token number">1</span>,
        <span class="token assign-left variable">config1</span><span class="token operator">=</span>0x7f275d195c50,
        <span class="token punctuation">..</span>.
    <span class="token punctuation">&#125;</span>,
    -1,
    <span class="token number">0</span>,
    -1,
    PERF_FLAG_FD_CLOEXEC<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span>

/* <span class="token number">4</span>）绑定 BPF 到 kprobe 事件 */
ioctl<span class="token punctuation">(</span><span class="token number">5</span>, PERF_EVENT_IOC_SET_BPF, <span class="token number">4</span><span class="token punctuation">)</span>     <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">..</span>.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从输出中，我们可以看出 BPF 与性能事件的绑定过程分为以下几步：</p>
<ul>
<li>首先，借助 bpf 系统调用，加载 BPF 程序，并记住返回的文件描述符；</li>
<li>然后，查询 kprobe 类型的事件编号。BCC 实际上是通过  <code>/sys/bus/event_source/devices/kprobe/type</code> 来查询的；</li>
<li>接着，调用  <code>perf_event_open</code>  创建性能监控事件。比如，事件类型（type 是上一步查询到的 6）、事件的参数（ config1 包含了内核函数 <code>do_sys_openat2</code> ）等；</li>
<li>最后，再通过 <code>ioctl</code> 的 <code>PERF_EVENT_IOC_SET_BPF</code> 命令，将 BPF 程序绑定到性能监控事件。</li>
</ul>
<h3 id="小结-eBPF-虚拟机工作原理"><a href="#小结-eBPF-虚拟机工作原理" class="headerlink" title="小结 eBPF 虚拟机工作原理"></a>小结 eBPF 虚拟机工作原理</h3><p>梳理 eBPF 在内核中的实现原理，并以上一讲的 Hello World 程序为例，借助 bpftool、strace 等工具，观察了 BPF 指令的具体格式。</p>
<p>然后，我们从 BCC 执行 eBPF 程序的过程入手，一起看了 BPF 指令的加载和执行过程。用高级语言开发的 eBPF 程序，需要首先编译为 BPF 字节码（即 BPF 指令），然后借助  bpf  系统调用加载到内核中，最后再通过性能监控等接口，与具体的内核事件进行绑定。这样，内核的性能监控模块才会在内核事件发生时，自动执行我们开发的 eBPF 程序。</p>
<h2 id="0x02-eBPF-程序是怎么跟内核进行交互的"><a href="#0x02-eBPF-程序是怎么跟内核进行交互的" class="headerlink" title="0x02 eBPF 程序是怎么跟内核进行交互的"></a>0x02 eBPF 程序是怎么跟内核进行交互的</h2><p>eBPF 程序到底是如何跟内核事件进行绑定的？又该如何跟内核中的其他模块进行交互呢？今天，一起看看 eBPF 程序的编程接口。</p>
<p>如下图（图片来自 brendangregg.com）所示，一个完整的 eBPF 程序通常包含用户态和内核态两部分。其中，用户态负责 eBPF 程序的加载、事件绑定以及 eBPF 程序运行结果的汇总输出；内核态运行在 eBPF 虚拟机中，负责定制和控制系统的运行状态。</p>
<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/CompleteProgram.png" class="">

<p>对于用户态程序来说，我想你已经了解，<strong>它们与内核进行交互时必须要通过系统调用来完成</strong>。而对应到 eBPF 程序中，我们最常用到的就是 <a class="link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/bpf.2.html" >bpf 系统调用<i class="fas fa-external-link-alt"></i></a>。</p>
<p>在命令行中输入 man bpf ，就可以查询到 BPF 系统调用的调用格式（虽然前面已经看过了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/bpf.h></span></span>

<span class="token keyword">int</span> <span class="token function">bpf</span><span class="token punctuation">(</span><span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">union</span> bpf_attr <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>BPF 系统调用接受三个参数：</p>
<ul>
<li>第一个，cmd ，代表操作命令，比如上一讲中我们看到的 <code>BPF_PROG_LOAD</code> 就是加载 eBPF 程序；</li>
<li>第二个，attr，代表 <code>bpf_attr</code> 类型的 eBPF 属性指针，不同类型的操作命令需要传入不同的属性参数；</li>
<li>第三个，size ，代表属性的大小。</li>
</ul>
<p>注意，不同版本的内核所支持的 BPF 命令是不同的，具体支持的命令列表可以参考内核头文件 <code>include/uapi/linux/bpf.h</code> 中  <code>bpf_cmd</code> 的定义。比如，v5.13 内核已经支持 36 个 BPF 命令：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">enum</span> <span class="token class-name">bpf_cmd</span> <span class="token punctuation">&#123;</span>
  BPF_MAP_CREATE<span class="token punctuation">,</span>
  BPF_MAP_LOOKUP_ELEM<span class="token punctuation">,</span>
  BPF_MAP_UPDATE_ELEM<span class="token punctuation">,</span>
  BPF_MAP_DELETE_ELEM<span class="token punctuation">,</span>
  BPF_MAP_GET_NEXT_KEY<span class="token punctuation">,</span>
  BPF_PROG_LOAD<span class="token punctuation">,</span>
  BPF_OBJ_PIN<span class="token punctuation">,</span>
  BPF_OBJ_GET<span class="token punctuation">,</span>
  BPF_PROG_ATTACH<span class="token punctuation">,</span>
  BPF_PROG_DETACH<span class="token punctuation">,</span>
  BPF_PROG_TEST_RUN<span class="token punctuation">,</span>
  BPF_PROG_GET_NEXT_ID<span class="token punctuation">,</span>
  BPF_MAP_GET_NEXT_ID<span class="token punctuation">,</span>
  BPF_PROG_GET_FD_BY_ID<span class="token punctuation">,</span>
  BPF_MAP_GET_FD_BY_ID<span class="token punctuation">,</span>
  BPF_OBJ_GET_INFO_BY_FD<span class="token punctuation">,</span>
  BPF_PROG_QUERY<span class="token punctuation">,</span>
  BPF_RAW_TRACEPOINT_OPEN<span class="token punctuation">,</span>
  BPF_BTF_LOAD<span class="token punctuation">,</span>
  BPF_BTF_GET_FD_BY_ID<span class="token punctuation">,</span>
  BPF_TASK_FD_QUERY<span class="token punctuation">,</span>
  BPF_MAP_LOOKUP_AND_DELETE_ELEM<span class="token punctuation">,</span>
  BPF_MAP_FREEZE<span class="token punctuation">,</span>
  BPF_BTF_GET_NEXT_ID<span class="token punctuation">,</span>
  BPF_MAP_LOOKUP_BATCH<span class="token punctuation">,</span>
  BPF_MAP_LOOKUP_AND_DELETE_BATCH<span class="token punctuation">,</span>
  BPF_MAP_UPDATE_BATCH<span class="token punctuation">,</span>
  BPF_MAP_DELETE_BATCH<span class="token punctuation">,</span>
  BPF_LINK_CREATE<span class="token punctuation">,</span>
  BPF_LINK_UPDATE<span class="token punctuation">,</span>
  BPF_LINK_GET_FD_BY_ID<span class="token punctuation">,</span>
  BPF_LINK_GET_NEXT_ID<span class="token punctuation">,</span>
  BPF_ENABLE_STATS<span class="token punctuation">,</span>
  BPF_ITER_CREATE<span class="token punctuation">,</span>
  BPF_LINK_DETACH<span class="token punctuation">,</span>
  BPF_PROG_BIND_MAP<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>命令对应的表格</p>
<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/CompleteProgram.png" class="">

<h3 id="BPF-辅助函数"><a href="#BPF-辅助函数" class="headerlink" title="BPF 辅助函数"></a>BPF 辅助函数</h3><p>说完用户态程序的 bpf 系统调用格式，我们再来看看内核态的 eBPF 程序。</p>
<p>eBPF 程序并不能随意调用内核函数，因此，内核定义了一系列的辅助函数，用于 eBPF 程序与内核其他模块进行交互，这一个实现方式其实是通过 eBPF helpers 来做的。</p>
<p>比如，上一讲的 Hello World 示例中使用的 <code>bpf_trace_printk()</code> 就是最常用的一个辅助函数，用于向调试文件系统（<code>/sys/kernel/debug/tracing/trace_pipe</code>）写入调试信息。</p>
<p>这里补充一个知识点：从内核 5.13 版本开始，部分内核函数（如  <code>tcp_slow_start()</code>、<code>tcp_reno_ssthresh()</code>  等）也可以被 BPF 程序直接调用了，具体你可以查看这个链接<a class="link"   target="_blank" rel="noopener" href="https://lwn.net/Articles/856005/" >这个链接<i class="fas fa-external-link-alt"></i></a>。 不过，这些函数只能在 TCP 拥塞控制算法的 BPF 程序中调用，此处不再做过多的介绍。</p>
<p>需要注意的是，并不是所有的辅助函数都可以在 eBPF 程序中随意使用，不同类型的 eBPF 程序所支持的辅助函数是不同的。比如，对于 Hello World 示例这类内核探针（kprobe）类型的 eBPF 程序，你可以在命令行中执行  <code>bpftool feature probe</code> ，来查询当前系统支持的辅助函数列表：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ bpftool feature probe
<span class="token punctuation">..</span>.
eBPF helpers supported <span class="token keyword">for</span> program <span class="token builtin class-name">type</span> kprobe:
  - bpf_map_lookup_elem
  - bpf_map_update_elem
  - bpf_map_delete_elem
  - bpf_probe_read
  - bpf_ktime_get_ns
  - bpf_get_prandom_u32
  - bpf_get_smp_processor_id
  - bpf_tail_call
  - bpf_get_current_pid_tgid
  - bpf_get_current_uid_gid
  - bpf_get_current_comm
  - bpf_perf_event_read
  - bpf_perf_event_output
  - bpf_get_stackid
  - bpf_get_current_task
  - bpf_current_task_under_cgroup
  - bpf_get_numa_node_id
  - bpf_probe_read_str
  - bpf_perf_event_read_value
  - bpf_override_return
  - bpf_get_stack
  - bpf_get_current_cgroup_id
  - bpf_map_push_elem
  - bpf_map_pop_elem
  - bpf_map_peek_elem
  - bpf_send_signal
  - bpf_probe_read_user
  - bpf_probe_read_kernel
  - bpf_probe_read_user_str
  - bpf_probe_read_kernel_str
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于这些辅助函数的详细定义，你可以在命令行中执行  man bpf-helpers ，或者参考内核头文件  <a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L1463" >bpf.h - include&#x2F;uapi&#x2F;linux&#x2F;bpf.h<i class="fas fa-external-link-alt"></i></a>，来查看它们的详细定义和使用说明。为了方便掌握，我把常用的辅助函数整理成了一个表格，可以在需要时参考：</p>
<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/bpfHelpersExcel.png" class="">

<p>这其中，需要你特别注意的是以 <code>bpf_probe_read</code>  开头的一系列函数。在上一讲中已经提到，eBPF 内部的内存空间只有寄存器和栈。所以，要访问其他的内核空间或用户空间地址，就需要借助  <code>bpf_probe_read</code>  这一系列的辅助函数。这些函数会进行安全性检查，并禁止缺页中断的发生。</p>
<p>而在 eBPF 程序需要大块存储时，就不能像常规的内核代码那样去直接分配内存了，而是必须通过 BPF 映射（BPF Map）来完成。接下来，我带你看看 BPF 映射的具体原理。</p>
<h3 id="BPF-映射"><a href="#BPF-映射" class="headerlink" title="BPF 映射"></a>BPF 映射</h3><p>BPF 映射用于提供大块的键值存储，这些存储可被用户空间程序访问，进而获取 eBPF 程序的运行状态。eBPF 程序最多可以访问 64 个不同的 BPF 映射，并且不同的 eBPF 程序也可以通过相同的 BPF 映射来共享它们的状态。下图（图片来自docs.cilium.io）展示了  BPF 映射的基本使用方法。</p>
<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/UsageOfBPFMap.png" class="">

<p>在前面的 BPF 系统调用和辅助函数小节中，你也看到，有很多系统调用命令和辅助函数都是用来访问 BPF 映射的。我相信细心的你已经发现了：BPF 辅助函数中并没有 BPF 映射的创建函数，BPF 映射只能通过用户态程序的系统调用来创建。比如，你可以通过下面的示例代码来创建一个 BPF 映射，并返回映射的文件描述符：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bpf_create_map</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">bpf_map_type</span> map_type<span class="token punctuation">,</span>
       <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key_size<span class="token punctuation">,</span>
       <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value_size<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_entries<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">union</span> bpf_attr attr <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>map_type <span class="token operator">=</span> map_type<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>key_size <span class="token operator">=</span> key_size<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>value_size <span class="token operator">=</span> value_size<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> max_entries
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">bpf</span><span class="token punctuation">(</span>BPF_MAP_CREATE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这其中，最关键的是设置映射的类型。内核头文件 <code>include/uapi/linux/bpf.h</code> 中的  <code>bpf_map_type</code> 定义了所有支持的映射类型，你可以使用如下的 bpftool 命令，来查询当前系统支持哪些映射类型：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ bpftool feature probe <span class="token operator">|</span> <span class="token function">grep</span> map_type
eBPF map_type <span class="token builtin class-name">hash</span> is available
eBPF map_type array is available
eBPF map_type prog_array is available
eBPF map_type perf_event_array is available
eBPF map_type percpu_hash is available
eBPF map_type percpu_array is available
eBPF map_type stack_trace is available
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在下面的表格中，整理了几种最常用的映射类型及其功能和使用场景：</p>
<img src="/2023/08/03/eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/UsualMapSecne.png" class="">

<p>如果你的 eBPF 程序使用了 BCC 库，你还可以使用预定义的宏来简化 BPF 映射的创建过程。比如，对哈希表映射来说，BCC 定义了  <code>BPF_HASH(name, key_type=u64, leaf_type=u64, size=10240)</code>，因此，你就可以通过下面的几种方法来创建一个哈希表映射：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 使用默认参数 key_type=u64, leaf_type=u64, size=10240</span>
<span class="token function">BPF_HASH</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用自定义key类型，保持默认 leaf_type=u64, size=10240</span>
<span class="token keyword">struct</span> <span class="token class-name">key_t</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> c<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token function">BPF_HASH</span><span class="token punctuation">(</span>counts<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">key_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义所有参数</span>
<span class="token function">BPF_HASH</span><span class="token punctuation">(</span>cpu_time<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span><span class="token punctuation">,</span> <span class="token class-name">uint64_t</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>














            </div>

            
                <div class="post-copyright-info">
                    
<div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li class="post-title">
            <span class="type">本文标题</span>：<span class="content">eBPF 运行原理</span>
        </li>
        <li class="post-author">
            <span class="type">本文作者</span>：<span class="content">Drunkbaby</span>
        </li>
        <li class="post-time">
            <span class="type">创建时间</span>：<span class="content">2023-08-03 22:48:30</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">2023/08/03/eBPF-运行原理/</span>
        </li>
        <li class="post-license">
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
    <div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/eBPF/">#eBPF</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2099/09/09/%E5%BE%80%E5%9B%9E%E7%9C%8B%EF%BC%8C%E6%96%B0%E5%90%AF%E7%A8%8B/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">往回看，新启程</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2023/08/03/2023-DASCTF-%E4%B8%83%E6%9C%88%E8%B5%9B-0x401-WP/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">2023 DASCTF 七月赛&amp;0x401 WP</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
                <div class="comment-container">
                    
<div class="comments-container">
    <div id="comments-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments"></i>&nbsp;评论
    </div>
    
        
            

    <div class="valine-container">
        <script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
          function loadValine() {

            const config = {
              el: '#vcomments',
              appId: 'mCIu9X4iLP3I0GikUoetB9bV-9Nh9j0Va',
              appKey: 'ermlV1eoB1YODT088EdXjo6C',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'just go go',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            new Valine(config)

            function getAuthor(language) {
              switch (language) {
                case 'en':
                  return 'Author'
                case 'zh-CN':
                  return '博主'
                default:
                  return 'Master'
              }
            }

            // Add "Author" identify
            const getValineDomTimer = setInterval(() => {
              const vcards = document.querySelectorAll('#vcomments .vcards .vcard')
              if (vcards.length > 0) {
                let author = 'Drunkbaby'

                if (author) {
                  for (let vcard of vcards) {
                    const vnick_dom = vcard.querySelector('.vhead .vnick')
                    const vnick = vnick_dom.innerHTML
                    if (vnick === author) {
                      vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                    }
                  }
                }
                clearInterval(getValineDomTimer)
              } else {
                clearInterval(getValineDomTimer)
              }
            }, 2000)
          }

          if ('true' === 'true') {
            const loadValineTimeout = setTimeout(() => {
              loadValine()
              clearTimeout(loadValineTimeout)
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadValine)
          }
        </script>
    </div>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#eBPF-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E7%AF%87"><span class="nav-text">eBPF 运行原理篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-eBPF-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="nav-text">0x01 eBPF 虚拟机是如何工作的</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#eBPF-%E7%9A%84%E4%BA%94%E4%B8%AA%E6%A8%A1%E5%9D%97"><span class="nav-text">eBPF 的五个模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BPF-%E6%8C%87%E4%BB%A4%E6%98%AF%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84"><span class="nav-text">BPF 指令是什么样的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#eBPF-%E7%A8%8B%E5%BA%8F%E6%98%AF%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E6%89%A7%E8%A1%8C%E7%9A%84"><span class="nav-text">eBPF 程序是什么时候执行的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-eBPF-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">小结 eBPF 虚拟机工作原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-eBPF-%E7%A8%8B%E5%BA%8F%E6%98%AF%E6%80%8E%E4%B9%88%E8%B7%9F%E5%86%85%E6%A0%B8%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92%E7%9A%84"><span class="nav-text">0x02 eBPF 程序是怎么跟内核进行交互的</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BPF-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="nav-text">BPF 辅助函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BPF-%E6%98%A0%E5%B0%84"><span class="nav-text">BPF 映射</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2021</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">Drunkbaby</a>
            
        </div>
        
            <script async data-pjax
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/code-block.js"></script>




<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/toc.js"></script>
        
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
